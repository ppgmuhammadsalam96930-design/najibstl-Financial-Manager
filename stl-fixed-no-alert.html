<!DOCTYPE html>
<html lang="id">
<head>
<script>
  // Disable browser popup 'This page says'
  window.alert = () => false;
  window.confirm = () => true;
  window.prompt = () => null;
  console.log("âœ… All browser alert/confirm/prompt popups disabled.");
</script>
  
<script>
(function(){
  'use strict';
  // ðŸ‘‡ TEMPATKAN KODE DI SINI (SETELAH 'use strict';)
  // ==================== KONSTANTA KRITIS BACKEND ====================
  const PY_BACKEND = 'http://localhost:5000'; // GANTI URL Anda
  const TOKEN_KEY = 'user_jwt_token';      
  const EMAIL_KEY = 'user_email';          
  // ==================================================================

  // Fungsi sederhana untuk memeriksa apakah pengguna sudah login
  function requireLogin() {
      if (localStorage.getItem(TOKEN_KEY)) return true;
      // ...
      return false;
  }
  
  // ========== CONFIG ==========
  const ANDROID_MIN_MAJOR = 4;
  const ANDROID_MAX_MAJOR = 26;
  const IOS_MIN_MAJOR = 3;
  const IOS_MAX_MAJOR = 26;

  const BLOCK_TITLE = 'Perangkat Tidak Didukung';
  const BLOCK_OK = 'Keluar';
  const BLOCK_BODY_ANDROID = 'Aplikasi ini membutuhkan Android 4.0 hingga Android ' + ANDROID_MAX_MAJOR + '.0. Silakan upgrade perangkat atau gunakan perangkat yang lebih baru.';
  const BLOCK_BODY_IOS = 'Aplikasi ini membutuhkan iOS 3 hingga iOS ' + IOS_MAX_MAJOR + '. Silakan upgrade perangkat atau gunakan perangkat yang lebih baru.';

  // Visual tiers thresholds (tuneable)
  const TIER_ULTRA_SCORE = 120;   // capable of 4K / epic visuals
  const TIER_HIGH_SCORE = 80;     // HD / high
  const TIER_MEDIUM_SCORE = 40;   // medium visuals
  // below medium => low

  // ========== HELPERS ==========
  function parseAndroidVersion(ua) {
    const m = ua.match(/Android\s+([\d._]+)/i);
    if (!m) return null;
    return m[1].replace(/_/g,'.');
  }
  function parseIOSVersion(ua) {
    const m = ua.match(/OS\s*([\d_]+)\s+like Mac OS X/i) || ua.match(/CPU (?:iPhone )?OS\s*([\d_]+)/i) || ua.match(/iPhone OS\s*([\d_]+)/i) || ua.match(/OS\s*([\d_]+)\s*$/i);
    if (!m) return null;
    return m[1].replace(/_/g,'.');
  }
  function majorFromVersionStr(v) {
    if (!v) return null;
    const p = String(v).split('.');
    const maj = parseInt(p[0],10);
    return Number.isNaN(maj) ? null : maj;
  }
  function createBlockOverlay(title, body, buttonText) {
    const o = document.createElement('div');
    o.id = 'stl-block-overlay';
    o.setAttribute('role','dialog');
    o.setAttribute('aria-modal','true');
    o.style.position = 'fixed';
    o.style.zIndex = '2147483647';
    o.style.left = '0';
    o.style.top = '0';
    o.style.width = '100%';
    o.style.height = '100%';
    o.style.display = 'flex';
    o.style.alignItems = 'center';
    o.style.justifyContent = 'center';
    o.style.padding = '24px';
    o.style.boxSizing = 'border-box';
    o.style.background = 'linear-gradient(180deg, rgba(2,6,23,0.95), rgba(15,23,42,0.98))';
    o.style.color = '#fff';
    o.style.fontFamily = 'system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial';
    o.innerHTML = `
      <div style="max-width:720px;text-align:center;">
        <h1 style="font-size:20px;margin:0 0 10px;">${title}</h1>
        <p style="margin:0 0 18px;line-height:1.4;font-size:15px;opacity:0.95;">${body}</p>
        <div style="display:flex;gap:12px;justify-content:center;">
          <button id="stl-block-ok" style="padding:10px 18px;border-radius:10px;border:0;cursor:pointer;font-weight:700;background:#ef4444;color:#fff;">${buttonText}</button>
        </div>
        <p style="font-size:12px;opacity:0.75;margin-top:12px;">Jika perangkatmu memenuhi syarat tapi masih ada masalah, coba buka melalui browser lain atau perbarui sistem.</p>
      </div>
    `;
    return o;
  }

  function neutralizeExternalResources() {
    try {
      Array.from(document.querySelectorAll('script[src]')).forEach(s => {
        s.type = 'javascript/blocked';
        s.setAttribute('data-stl-blocked','1');
        s.removeAttribute('src');
      });
      Array.from(document.querySelectorAll('link[rel="stylesheet"], link[rel="preload"][as="style"]')).forEach(l => {
        l.setAttribute('data-stl-blocked','1');
        l.rel = 'preload';
        l.as = 'style';
        l.removeAttribute('href');
      });
      Array.from(document.querySelectorAll('img[src]')).forEach(img => {
        img.setAttribute('data-stl-src', img.src || '');
        img.removeAttribute('src');
      });
    } catch(e){ /* best-effort */ }
  }

  function optimizeResourceLoading() {
    const heavyCandidates = ['html2canvas','jspdf','xlsx','crypto-js','tailwindcss.com','cdnjs.cloudflare.com','unpkg.com','jsdelivr.net'];
    const scripts = Array.from(document.querySelectorAll('script[src]'));
    const links = Array.from(document.querySelectorAll('link[rel="stylesheet"], link[rel="preload"][as="style"]'));
    const toLazy = [];
    scripts.forEach(s => {
      const src = s.getAttribute('src') || '';
      const heavy = heavyCandidates.some(p => src.indexOf(p) !== -1);
      if (heavy) {
        toLazy.push({type:'script', src});
        s.setAttribute('data-stl-lazy','1');
        s.removeAttribute('src');
      } else {
        try { s.setAttribute('defer',''); } catch(e){}
      }
    });
    links.forEach(l => {
      const href = l.getAttribute('href') || '';
      toLazy.push({type:'style', href});
      try {
        l.setAttribute('rel','preload'); l.setAttribute('as','style'); l.setAttribute('data-stl-lazy','1'); l.removeAttribute('href');
      } catch(e){}
    });
    function loadLazy() {
      setTimeout(() => {
        toLazy.forEach(r => {
          try {
            if (r.type === 'script' && r.src) {
              const s = document.createElement('script');
              s.src = r.src; s.async = true; s.crossOrigin = 'anonymous'; document.head.appendChild(s);
            } else if (r.type === 'style' && r.href) {
              const l = document.createElement('link'); l.rel = 'stylesheet'; l.href = r.href; document.head.appendChild(l);
            }
          } catch(e){}
        });
      }, 600);
    }
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      loadLazy();
    } else {
      document.addEventListener('DOMContentLoaded', loadLazy, {once:true});
    }
  }

  // Compute WebGL max texture size (best-effort)
  function getWebGLMaxTextureSize() {
    try {
      var canvas = document.createElement('canvas');
      var gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
      if (!gl) return 0;
      return gl.getParameter(gl.MAX_TEXTURE_SIZE) || 0;
    } catch(e){
      return 0;
    }
  }

  // Compute visual capability score (heuristic)
  function computeVisualScore() {
    const deviceMemory = (navigator.deviceMemory && Number(navigator.deviceMemory)) || 0; // GB
    const cores = (navigator.hardwareConcurrency && Number(navigator.hardwareConcurrency)) || 1;
    const dpr = window.devicePixelRatio || 1;
    const sw = (screen && screen.width) || 0;
    const sh = (screen && screen.height) || 0;
    const screenPixels = sw * sh;
    const maxTexture = getWebGLMaxTextureSize() || 0;

    // Normalize contributions (heuristic weights)
    const memScore = Math.min(deviceMemory, 16) * 6;           // up to ~96
    const coreScore = Math.min(cores, 16) * 4;                // up to ~64
    const dprScore = Math.min(dpr, 4) * 8;                    // up to ~32
    const resScore = Math.min(screenPixels / (1920*1080), 4) * 12; // scales with resolution: 1080p baseline
    const texScore = Math.min(maxTexture / 2048, 4) * 10;     // WebGL texture capability

    // Sum and clamp
    const raw = (memScore + coreScore + dprScore + resScore + texScore);
    const score = Math.round(Math.max(0, Math.min(raw, 999)));
    return {score, breakdown:{mem:memScore, cores:coreScore, dpr:dprScore, res:resScore, tex:texScore, raw}};
  }

  function applyVisualTierClasses(tier) {
    try {
      const htmlEl = document.documentElement;
      htmlEl.classList.remove('stl-visual-low','stl-visual-medium','stl-visual-high','stl-visual-ultra');
      if (tier === 'ultra') htmlEl.classList.add('stl-visual-ultra');
      else if (tier === 'high') htmlEl.classList.add('stl-visual-high');
      else if (tier === 'medium') htmlEl.classList.add('stl-visual-medium');
      else htmlEl.classList.add('stl-visual-low');
      // also set data attribute
      htmlEl.setAttribute('data-stl-visual-tier', tier);
    } catch(e){}
  }

  // Swap assets marked with data attributes based on selected tier
  function swapAssetsForTier(tier) {
    try {
      // images with src alternatives
      Array.from(document.querySelectorAll('img[data-stl-src-low], img[data-stl-src-hd], img[data-stl-src-4k]')).forEach(img => {
        let src = null;
        if (tier === 'ultra' && img.getAttribute('data-stl-src-4k')) src = img.getAttribute('data-stl-src-4k');
        if (!src && (tier === 'ultra' || tier === 'high') && img.getAttribute('data-stl-src-hd')) src = img.getAttribute('data-stl-src-hd');
        if (!src && img.getAttribute('data-stl-src-low')) src = img.getAttribute('data-stl-src-low');
        if (src) {
          // set as data attribute to avoid overriding originals if already set
          if (!img.src || img.getAttribute('data-stl-loaded') !== '1') {
            img.setAttribute('data-stl-loaded','1');
            img.src = src;
          }
        }
      });

      // elements with background images
      Array.from(document.querySelectorAll('[data-stl-bg-low], [data-stl-bg-hd], [data-stl-bg-4k]')).forEach(el => {
        let url = null;
        if (tier === 'ultra' && el.getAttribute('data-stl-bg-4k')) url = el.getAttribute('data-stl-bg-4k');
        if (!url && (tier === 'ultra' || tier === 'high') && el.getAttribute('data-stl-bg-hd')) url = el.getAttribute('data-stl-bg-hd');
        if (!url && el.getAttribute('data-stl-bg-low')) url = el.getAttribute('data-stl-bg-low');
        if (url) el.style.backgroundImage = 'url("'+url.replace(/"/g,'\\"')+'")';
      });

      // <video> sources (pick highest available)
      Array.from(document.querySelectorAll('video[data-stl-src-low], video[data-stl-src-hd], video[data-stl-src-4k]')).forEach(v => {
        try {
          let src = null;
          if (tier === 'ultra' && v.getAttribute('data-stl-src-4k')) src = v.getAttribute('data-stl-src-4k');
          if (!src && (tier === 'ultra' || tier === 'high') && v.getAttribute('data-stl-src-hd')) src = v.getAttribute('data-stl-src-hd');
          if (!src && v.getAttribute('data-stl-src-low')) src = v.getAttribute('data-stl-src-low');
          if (src) {
            // remove existing sources and set new one
            while (v.firstChild) v.removeChild(v.firstChild);
            const s = document.createElement('source');
            s.src = src;
            v.appendChild(s);
            try { v.load(); } catch(e){}
          }
        } catch(e){}
      });

    } catch(e){ console.warn('STL swapAssets', e); }
  }

  // Public helper (exposed on window) to recompute and apply tier (useful after orientation change)
  function evaluateAndApplyVisualTier() {
    const {score, breakdown} = computeVisualScore();
    let tier = 'low';
    if (score >= TIER_ULTRA_SCORE) tier = 'ultra';
    else if (score >= TIER_HIGH_SCORE) tier = 'high';
    else if (score >= TIER_MEDIUM_SCORE) tier = 'medium';
    applyVisualTierClasses(tier);
    swapAssetsForTier(tier);
    // Expose info
    window.STL_VISUAL = {score, breakdown, tier};
    return window.STL_VISUAL;
  }

  // ========== DETECTION & DECISION ==========
  try {
    const ua = (navigator.userAgent || '') + ' ' + (navigator.platform || '');
    const androidVerStr = parseAndroidVersion(ua);
    const iosVerStr = parseIOSVersion(ua);
    const isAndroid = !!androidVerStr;
    const isIOS = /iP(hone|ad|od)/i.test(ua) || !!iosVerStr;
    const androidMajor = majorFromVersionStr(androidVerStr);
    const iosMajor = majorFromVersionStr(iosVerStr);

    function androidAllowed() {
      if (androidMajor === null) return true;
      return androidMajor >= ANDROID_MIN_MAJOR && androidMajor <= ANDROID_MAX_MAJOR;
    }
    function iosAllowed() {
      if (iosMajor === null) return true;
      return iosMajor >= IOS_MIN_MAJOR && iosMajor <= IOS_MAX_MAJOR;
    }

    let allowed = true;
    let blockReason = '';
    if (isAndroid) {
      if (!androidAllowed()) { allowed = false; blockReason = 'android'; }
    } else if (isIOS) {
      if (!iosAllowed()) { allowed = false; blockReason = 'ios'; }
    }

    if (!allowed) {
      neutralizeExternalResources();
      try { document.documentElement.style.visibility = 'hidden'; } catch(e){}
      function showBlock() {
        try { document.documentElement.style.visibility = ''; } catch(e){}
        if (document.body) document.body.style.display = 'none';
        const bodyMsg = blockReason === 'android' ? BLOCK_BODY_ANDROID : BLOCK_BODY_IOS;
        const ov = createBlockOverlay(BLOCK_TITLE, bodyMsg, BLOCK_OK);
        (document.body || document.documentElement).appendChild(ov);
        const btn = document.getElementById('stl-block-ok');
        if (btn) {
          btn.addEventListener('click', function(){ try{ window.close(); }catch(e){} try{ location.href='about:blank'; }catch(e){} }, {once:true});
        }
      }
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', showBlock, {once:true}); else showBlock();
      console.warn('[STL] BLOCKED ('+blockReason+') ua='+ua+' android='+String(androidVerStr)+' ios='+String(iosVerStr));
      return;
    }

    // allowed: do optimizations and visual tiering
    try { optimizeResourceLoading(); } catch(e){}
    // apply initial visual tier as early as possible (synchronously)
    try {
      const info = evaluateAndApplyVisualTier();
      // if ultra, consider unlocking 4K heavy visuals â€” but be conservative on bandwidth: wait for user interaction to load huge blobs
      if (info.tier === 'ultra') {
        // add a small attribute to signal pages to optionally offer "EPIC 4K" experience
        document.documentElement.setAttribute('data-stl-can-4k','1');
      } else {
        document.documentElement.removeAttribute('data-stl-can-4k');
      }
    } catch(e){}
    // Re-evaluate on change of orientation/resolution or visibility
    try {
      window.addEventListener('orientationchange', function(){ setTimeout(evaluateAndApplyVisualTier, 300); });
      window.addEventListener('resize', function(){ setTimeout(evaluateAndApplyVisualTier, 300); });
      document.addEventListener('visibilitychange', function(){ if (!document.hidden) setTimeout(evaluateAndApplyVisualTier, 300); });
    } catch(e){}

    // expose helper to manually trigger swaps (for your app code)
    window.STL = window.STL || {};
    window.STL.evaluateVisualTier = evaluateAndApplyVisualTier;
    window.STL.swapAssetsForTier = swapAssetsForTier;

  } catch(err) {
    console.error('[STL] unified-visual-guard error', err);
    // fail open
  }
})();
</script>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STL - UDHIS | Manajemen Keuangan Guru</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/mongoDBjs/9.6.1/mongoDB-app-compat.js"></script>
    <script src="https://www.gstatic.com/mongoDBjs/9.6.1/mongoDB-auth-compat.js"></script>
    <script src="https://www.gstatic.com/mongoDBjs/9.6.1/mongoDB-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;600;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* ==================== VARIABEL SISTEM TEMA 8-LAYER iOS 26 ==================== */
        :root {
            --layer1: #667eea;
            --layer2: #764ba2;
            --layer3: #a78bfa;
            --layer4: #c4b5fd;
            --layer5: #ddd6fe;
            --layer6: #f3f4f6;
            --layer7: #f8fafc;
            --layer8: #ffffff;

            --theme-primary: var(--layer1);
            --theme-secondary: var(--layer2);
            --theme-accent: var(--layer3);
            --theme-bg: var(--layer7);
            --theme-card: var(--layer8);
            --theme-border: var(--layer4);
            --theme-text: #1e293b;
            --theme-glow: rgba(102, 126, 234, 0.2);

            --gradient-primary: linear-gradient(135deg, var(--layer1) 0%, var(--layer2) 100%);
            --gradient-secondary: linear-gradient(135deg, var(--layer3) 0%, var(--layer4) 100%);
            --gradient-bg: linear-gradient(135deg, var(--layer7) 0%, var(--layer6) 100%);

            --font-primary: 'Inter', 'Segoe UI', system-ui, sans-serif;
            --font-display: 'Inter', 'Segoe UI', system-ui, sans-serif;

            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 8px 25px rgba(0,0,0,0.1);
            --shadow-lg: 0 20px 50px rgba(0,0,0,0.15);
            --glow: 0 0 30px color-mix(in srgb, var(--layer1) 20%, transparent);

            --glass-bg-light: rgba(255, 255, 255, 0.1);
            --glass-border-light: rgba(255, 255, 255, 0.2);
            --glass-shadow-light: 0 8px 32px rgba(31, 38, 135, 0.37);

            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-2xl: 20px;
            
            /* iOS 26 Smooth Variables */
            --ios-blur: blur(40px);
            --ios-transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --ios-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            
            /* Aurora Background Animation */
            --aurora-1: #667eea;
            --aurora-2: #764ba2;
            --aurora-3: #a78bfa;
            --aurora-4: #c4b5fd;
        }

        body.dark {
            --theme-bg: #0f172a;
            --theme-card: #1e293b;
            --theme-border: #374151;
            --theme-text: #f8fafc;
            --theme-glow: 0 0 30px rgba(102, 126, 234, 0.3);
            --layer8: #1a2235;
        }

        /* ==================== BASE STYLES iOS 26 ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: var(--font-primary);
            background: var(--theme-bg);
            color: var(--theme-text);
            line-height: 1.6;
            overflow-x: hidden;
            height: 100vh;
            width: 100vw;
            position: fixed;
            touch-action: pan-x pan-y;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: var(--ios-transition);
        }

        /* ==================== AURORA BACKGROUND ANIMATION ==================== */
        .aurora-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .aurora-layer {
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            opacity: 0.6;
            filter: blur(60px);
            animation: aurora-flow 20s ease-in-out infinite alternate;
            border-radius: 50%;
        }

        .aurora-1 {
            background: radial-gradient(circle, var(--aurora-1) 0%, transparent 70%);
            animation-delay: 0s;
        }

        .aurora-2 {
            background: radial-gradient(circle, var(--aurora-2) 0%, transparent 70%);
            animation-delay: -5s;
        }

        .aurora-3 {
            background: radial-gradient(circle, var(--aurora-3) 0%, transparent 70%);
            animation-delay: -10s;
        }

        .aurora-4 {
            background: radial-gradient(circle, var(--aurora-4) 0%, transparent 70%);
            animation-delay: -15s;
        }

        @keyframes aurora-flow {
            0%, 100% {
                transform: translate(0, 0) rotate(0deg);
            }
            25% {
                transform: translate(5%, 10%) rotate(5deg);
            }
            50% {
                transform: translate(10%, 5%) rotate(10deg);
            }
            75% {
                transform: translate(5%, -5%) rotate(5deg);
            }
        }

        /* ==================== DYNAMIC ISLAND IPHONE STYLE ==================== */
        .dynamic-island {
            position: fixed;
            top: 25px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 14px 28px;
            border-radius: 30px;
            font-family: var(--font-display);
            font-weight: 600;
            z-index: 9999;
            backdrop-filter: var(--ios-blur);
            box-shadow: var(--ios-shadow);
            opacity: 0;
            transition: var(--ios-transition);
        }

        .dynamic-island.active {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* ==================== SIDEBAR BLUR IPHONE STYLE ==================== */
        .sidebar {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100vh;
            background: var(--glass-bg-light);
            backdrop-filter: var(--ios-blur);
            -webkit-backdrop-filter: var(--ios-blur);
            border-left: 1px solid var(--glass-border-light);
            box-shadow: var(--glass-shadow-light);
            z-index: 10000;
            transition: var(--ios-transition);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar.active {
            right: 0;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: var(--ios-transition);
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* ==================== ENHANCED UI COMPONENTS iOS 26 ==================== */
        .enhanced-card {
            background: var(--theme-card);
            border: 1px solid var(--theme-border);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            transition: var(--ios-transition);
            backdrop-filter: var(--ios-blur);
        }

        .enhanced-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .enhanced-btn {
            padding: 14px 28px;
            border-radius: var(--radius-xl);
            font-weight: 600;
            font-family: var(--font-display);
            border: none;
            cursor: pointer;
            transition: var(--ios-transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 15px;
            position: relative;
            overflow: hidden;
        }

        .enhanced-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--ios-transition);
        }

        .enhanced-btn:hover::before {
            left: 100%;
        }

        .enhanced-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--ios-shadow);
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }

        .btn-error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        .enhanced-input {
            font-size: 16px;
            padding: 16px 20px;
            border: 2px solid var(--theme-border);
            border-radius: var(--radius-lg);
            background: var(--theme-card);
            transition: var(--ios-transition);
            font-family: var(--font-display);
            width: 100%;
        }

        .enhanced-input:focus {
            outline: none;
            border-color: var(--theme-primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        /* ==================== TAB SYSTEM ==================== */
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
            scrollbar-width: none;
        }

        .tab-container::-webkit-scrollbar {
            display: none;
        }

        .tab {
            padding: 12px 24px;
            border-radius: var(--radius-xl);
            background: var(--theme-card);
            border: 1px solid var(--theme-border);
            cursor: pointer;
            transition: var(--ios-transition);
            white-space: nowrap;
            font-weight: 600;
            flex-shrink: 0;
        }

        .tab.active {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--theme-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ==================== THEME SYSTEM STYLES ==================== */
        .theme-option {
            height: 80px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--ios-transition);
            position: relative;
            overflow: hidden;
            font-weight: 700;
            font-size: 12px;
            text-align: center;
            padding: 8px;
            border: 2px solid var(--layer4);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .theme-option:hover {
            transform: translateY(-4px);
        }

        .theme-option.active {
            border-color: var(--theme-primary);
        }

        .theme-option.active::after {
            content: 'âœ“';
            position: absolute;
            top: 6px;
            right: 6px;
            background: white;
            color: var(--theme-primary);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* Main Content Area */
        .main-content {
            height: 100vh;
            width: 100vw;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }

        /* Compact UI Elements for Mobile */
        .compact-input {
            padding: 12px 16px;
            font-size: 14px;
        }

        .compact-btn {
            padding: 12px 20px;
            font-size: 14px;
        }

        /* Mobile First Adjustments */
        .mobile-optimized {
            width: 100%;
            max-width: 100%;
        }

        /* Prevent horizontal scroll */
        .no-horizontal-scroll {
            max-width: 100%;
            overflow-x: hidden;
        }

        /* iOS 26 Specific Styles */
        .ios-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: var(--ios-blur);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            transition: var(--ios-transition);
        }

        .ios-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--ios-shadow);
        }

        .ios-button {
            background: linear-gradient(135deg, #007AFF, #5856D6);
            color: white;
            border: none;
            border-radius: 14px;
            padding: 14px 24px;
            font-weight: 600;
            font-size: 16px;
            transition: var(--ios-transition);
            backdrop-filter: var(--ios-blur);
        }

        .ios-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 122, 255, 0.4);
        }

        /* Financial Dashboard Styles */
        .financial-card {
            background: var(--theme-card);
            border-radius: var(--radius-2xl);
            padding: 24px;
            box-shadow: var(--shadow-md);
            transition: var(--ios-transition);
            border: 1px solid var(--theme-border);
        }

        .financial-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .balance-display {
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            margin: 20px 0;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--theme-border);
            transition: var(--ios-transition);
        }

        .transaction-item:hover {
            background: var(--theme-bg);
            border-radius: var(--radius-lg);
        }

        .income {
            color: #10b981;
            font-weight: 700;
        }

        .expense {
            color: #ef4444;
            font-weight: 700;
        }

        /* Export Buttons */
        .export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        .export-btn {
            padding: 12px;
            border-radius: var(--radius-lg);
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: var(--ios-transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .export-btn:hover {
            transform: translateY(-3px);
        }

        /* Responsive Design */
        @media (min-width: 768px) {
            .sidebar {
                width: 450px;
                right: -450px;
            }
            
            .export-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        @media (max-width: 767px) {
            .enhanced-btn {
                padding: 12px 20px;
                font-size: 14px;
            }
            
            .tab {
                padding: 10px 16px;
                font-size: 14px;
            }
            
            .balance-display {
                font-size: 2rem;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                padding: 15px;
            }
            
            .enhanced-btn {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .export-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300 no-horizontal-scroll">
    <!-- Aurora Background Animation -->
    <div class="aurora-background">
        <div class="aurora-layer aurora-1"></div>
        <div class="aurora-layer aurora-2"></div>
        <div class="aurora-layer aurora-3"></div>
        <div class="aurora-layer aurora-4"></div>
    </div>
    
    <!-- Dynamic Island Notification -->
    <div id="dynamicIsland" class="dynamic-island"></div>
    
    <!-- Left Sidebar -->
    <div id="leftSidebar" class="left-sidebar">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center space-x-3">
                <div class="logo-container w-10 h-10 rounded-xl overflow-hidden bg-white shadow-lg">
                    <img src="https://pfst.cf2.poecdn.net/base/image/d6d81ade0a0eeac8cf2315ace4420bf84df883795c9513b9b3af822e0d0730ae?w=1563&h=1563" alt="STL Logo" class="w-full h-full object-contain">
                </div>
                <div>
                    <h2 class="text-xl font-black text-gray-800 dark:text-white">Tools Keuangan</h2>
                    <p class="text-xs text-gray-600 dark:text-gray-300">Utility Manager</p>
                </div>
            </div>
            <button id="closeLeftSidebar" class="enhanced-btn btn-error compact-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="sidebar-content space-y-4">
            <!-- Print Tabungan Section -->
            <div class="enhanced-card p-4">
                <h3 class="text-lg font-black text-gray-800 dark:text-white mb-3">
                    <i class="fas fa-print mr-2"></i>Print Laporan Tabungan
                </h3>
                <div class="space-y-3">
                    <button id="previewReport" class="enhanced-btn btn-primary compact-btn w-full">
                        <i class="fas fa-eye mr-2"></i>Preview Laporan
                    </button>
                    <div class="export-grid">
                        <button id="printPDF" class="export-btn bg-red-600 hover:bg-red-700 text-white">
                            <i class="fas fa-file-pdf text-lg"></i>
                            <span>PDF</span>
                        </button>
                        <button id="printJPG" class="export-btn bg-yellow-600 hover:bg-yellow-700 text-white">
                            <i class="fas fa-file-image text-lg"></i>
                            <span>JPG</span>
                        </button>
                        <button id="printPNG" class="export-btn bg-blue-600 hover:bg-blue-700 text-white">
                            <i class="fas fa-image text-lg"></i>
                            <span>PNG</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Backup Data Section -->
            <div class="enhanced-card p-4">
                <h3 class="text-lg font-black text-gray-800 dark:text-white mb-3">
                    <i class="fas fa-shield-alt mr-2"></i>Backup Data
                </h3>
                <div class="space-y-3">
                    <input type="password" id="backupPassword" placeholder="Masukkan password backup" class="enhanced-input compact-input w-full" value="b4ckupmyd4t4">
                    <div class="flex space-x-2">
                        <button id="backupData" class="enhanced-btn btn-success flex-1 compact-btn">
                            <i class="fas fa-download mr-2"></i>Backup
                        </button>
                        <button id="restoreData" class="enhanced-btn btn-warning compact-btn">
                            <i class="fas fa-upload"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Riwayat Penting Section -->
            <div class="enhanced-card p-4">
                <h3 class="text-lg font-black text-gray-800 dark:text-white mb-3">
                    <i class="fas fa-star mr-2"></i>Riwayat Penting
                </h3>
                <div id="importantHistoryList" class="space-y-2 max-h-40 overflow-y-auto">
                    <!-- Important transactions will appear here -->
                </div>
            </div>

            <!-- Sync & Protection Section -->
            <div class="enhanced-card p-4">
                <h3 class="text-lg font-black text-gray-800 dark:text-white mb-3">
                    <i class="fas fa-sync-alt mr-2"></i>Sync & Protection
                </h3>
                <div class="space-y-2">
                    <button id="syncData" class="enhanced-btn compact-btn w-full bg-green-600 hover:bg-green-700 text-white">
                        <i class="fas fa-sync mr-2"></i>Sync Data
                    </button>
                    <button id="optimizeProtection" class="enhanced-btn compact-btn w-full bg-purple-600 hover:bg-purple-700 text-white">
                        <i class="fas fa-shield-virus mr-2"></i>Optimize Protection
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Left Sidebar Overlay -->
    <div id="leftSidebarOverlay" class="left-sidebar-overlay"></div>

    <!-- Left Sidebar Toggle Button -->
    <button id="openLeftSidebar" class="left-sidebar-toggle">
        <i class="fas fa-tools"></i>
    </button>
    <!-- Sidebar Overlay -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <!-- Sidebar -->
    <div id="sidebar" class="sidebar">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center space-x-3">
                <div class="logo-container w-10 h-10 rounded-xl overflow-hidden bg-white shadow-lg">
                    <img id="sidebarLogo" src="https://pfst.cf2.poecdn.net/base/image/d6d81ade0a0eeac8cf2315ace4420bf84df883795c9513b9b3af822e0d0730ae?w=1563&h=1563" alt="STL Logo" class="w-full h-full object-contain">
                </div>
                <div>
                    <h2 class="text-xl font-black text-gray-800 dark:text-white">STL - UDHIS</h2>
                    <p class="text-xs text-gray-600 dark:text-gray-300">Financial Manager</p>
                </div>
            </div>
            <button id="closeSidebar" class="enhanced-btn btn-error compact-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="sidebar-content">
            <!-- Theme Toggle -->
            <div class="enhanced-card p-4 mb-4">
                <div class="flex justify-between items-center">
                    <span class="text-gray-700 dark:text-gray-300 font-medium">Mode Gelap</span>
                    <button id="themeToggle" class="enhanced-btn compact-btn bg-purple-600 hover:bg-purple-700 text-white">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>

            <!-- Theme Selection -->
            <div class="enhanced-card p-4 mb-4">
                <h3 class="text-lg font-black text-gray-800 dark:text-white mb-3">
                    <i class="fas fa-palette mr-2"></i>Pilih Tema
                </h3>
                <div class="grid grid-cols-2 gap-2" id="themeGrid">
                    <!-- Themes will be populated by JavaScript -->
                </div>
            </div>

            <!-- Font Selection -->
            <div class="enhanced-card p-4 mb-4">
                <h3 class="text-lg font-black text-gray-800 dark:text-white mb-3">
                    <i class="fas fa-font mr-2"></i>Pilih Font
                </h3>
                <select id="fontSelector" class="enhanced-input compact-input">
                    <option value="'Inter', sans-serif">Inter (Default)</option>
                    <option value="'Poppins', sans-serif">Poppins</option>
                    <option value="'Montserrat', sans-serif">Montserrat</option>
                    <option value="'Nunito Sans', sans-serif">Nunito Sans</option>
                    <option value="'Roboto', sans-serif">Roboto</option>
                    <option value="'Orbitron', sans-serif">Orbitron</option>
                    <option value="'Playfair Display', serif">Playfair Display</option>
                    <option value="'Raleway', sans-serif">Raleway</option>
                    <option value="'Urbanist', sans-serif">Urbanist</option>
                    <option value="'Open Sans', sans-serif">Open Sans</option>
                    <option value="'Lato', sans-serif">Lato</option>
                </select>
            </div>

            <!-- Custom Theme Creator -->
            <div class="enhanced-card p-4 mb-4">
                <h3 class="text-lg font-black text-gray-800 dark:text-white mb-3">
                    <i class="fas fa-magic mr-2"></i>Buat Tema Kustom
                </h3>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Layer 1</label>
                            <input type="color" id="customLayer1" class="w-full h-10 rounded" value="#667eea">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Layer 2</label>
                            <input type="color" id="customLayer2" class="w-full h-10 rounded" value="#764ba2">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Layer 3</label>
                            <input type="color" id="customLayer3" class="w-full h-10 rounded" value="#a78bfa">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Layer 4</label>
                            <input type="color" id="customLayer4" class="w-full h-10 rounded" value="#c4b5fd">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Layer 5</label>
                            <input type="color" id="customLayer5" class="w-full h-10 rounded" value="#ddd6fe">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Layer 6</label>
                            <input type="color" id="customLayer6" class="w-full h-10 rounded" value="#f3f4f6">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Layer 7</label>
                            <input type="color" id="customLayer7" class="w-full h-10 rounded" value="#f8fafc">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Layer 8</label>
                            <input type="color" id="customLayer8" class="w-full h-10 rounded" value="#ffffff">
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button id="createCustomTheme" class="enhanced-btn btn-success flex-1 compact-btn">
                            <i class="fas fa-plus mr-2"></i>Buat Tema
                        </button>
                        <button id="resetCustomTheme" class="enhanced-btn btn-warning compact-btn">
                            <i class="fas fa-undo"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Advanced Theme Settings -->
            <div class="enhanced-card p-4">
                <h3 class="text-lg font-black text-gray-800 dark:text-white mb-3">
                    <i class="fas fa-sliders-h mr-2"></i>Pengaturan Lanjutan
                </h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Intensitas Glow</label>
                        <input type="range" id="glowIntensity" min="0" max="100" value="20" class="w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Border Radius</label>
                        <input type="range" id="borderRadius" min="8" max="24" value="12" class="w-full">
                    </div>
                    <div class="flex space-x-2">
                        <button id="applyAdvanced" class="enhanced-btn btn-primary flex-1 compact-btn">
                            <i class="fas fa-check mr-2"></i>Terapkan
                        </button>
                        <button id="exportTheme" class="enhanced-btn bg-purple-600 hover:bg-purple-700 text-white compact-btn">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
        <!-- Main Application -->
    <div class="main-content">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-black text-gray-800 dark:text-white">Manajemen Keuangan Guru</h1>
                <p class="text-gray-600 dark:text-gray-300">Kelola keuangan pribadi, BOS, dan dana sekolah dengan aman</p>
            </div>
            <button id="openSidebar" class="enhanced-btn btn-primary compact-btn">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <!-- Financial Dashboard -->
        <div class="enhanced-card p-6 mb-6 mobile-optimized">
            <div class="tab-container">
                <button class="tab active" data-tab="dashboard">Dashboard</button>
                <button class="tab" data-tab="tabungan">Tabungan</button>
                <button class="tab" data-tab="laporan">Laporan</button>
                <button class="tab" data-tab="developer">Developer</button>
            </div>

            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="financial-card text-center floating-card">
                        <div class="text-2xl font-black text-blue-600 mb-2">Saldo Total</div>
                        <div class="balance-display" id="totalBalance">Rp 0</div>
                        <p class="text-gray-600 dark:text-gray-300">Seluruh dana yang dikelola</p>
                    </div>
                    <div class="financial-card text-center floating-card">
                        <div class="text-2xl font-black text-green-600 mb-2">Pemasukan Bulan Ini</div>
                        <div class="balance-display" id="monthlyIncome">Rp 0</div>
                        <p class="text-gray-600 dark:text-gray-300">Total pemasukan bulan ini</p>
                    </div>
                    <div class="financial-card text-center floating-card">
                        <div class="text-2xl font-black text-red-600 mb-2">Pengeluaran Bulan Ini</div>
                        <div class="balance-display" id="monthlyExpense">Rp 0</div>
                        <p class="text-gray-600 dark:text-gray-300">Total pengeluaran bulan ini</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="financial-card floating-card">
                        <h3 class="text-xl font-black text-gray-800 dark:text-white mb-4">
                            <i class="fas fa-wallet mr-2"></i>Saldo per Kategori
                        </h3>
                        <div id="categoryBalances" class="space-y-3">
                            <!-- Category balances will be populated here -->
                        </div>
                    </div>
                    <div class="financial-card floating-card">
                        <h3 class="text-xl font-black text-gray-800 dark:text-white mb-4">
                            <i class="fas fa-chart-pie mr-2"></i>Distribusi Dana
                        </h3>
                        <div id="distributionChart" class="h-48 flex items-center justify-center">
                            <p class="text-gray-500">Data distribusi akan muncul di sini</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabungan Tab -->
            <div id="tabungan" class="tab-content">
                <div class="financial-card mb-6 floating-card">
                    <h3 class="text-xl font-black text-gray-800 dark:text-white mb-4">
                        <i class="fas fa-plus-circle mr-2"></i>Tambah Transaksi Baru
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Jenis Dana</label>
                            <select id="transactionFund" class="enhanced-input compact-input w-full">
                                <option value="pribadi">Dana Pribadi</option>
                                <option value="bos">Dana BOS</option>
                                <option value="spp">Dana SPP</option>
                                <option value="komite">Dana Komite</option>
                                <option value="lainnya">Dana Lainnya</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Kategori</label>
                            <select id="transactionCategory" class="enhanced-input compact-input w-full">
                                <option value="gaji">Gaji</option>
                                <option value="tunjangan">Tunjangan</option>
                                <option value="honorarium">Honorarium</option>
                                <option value="pembelian">Pembelian Alat/Bahan</option>
                                <option value="perbaikan">Perbaikan Sarana</option>
                                <option value="kegiatan">Kegiatan Sekolah</option>
                                <option value="lainnya">Lainnya</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Jenis Transaksi</label>
                            <select id="transactionType" class="enhanced-input compact-input w-full">
                                <option value="debit">Pemasukan</option>
                                <option value="kredit">Pengeluaran</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Jumlah</label>
                            <input type="number" id="transactionAmount" placeholder="Jumlah" class="enhanced-input compact-input w-full">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Keterangan</label>
                        <input type="text" id="transactionDescription" placeholder="Keterangan transaksi" class="enhanced-input compact-input w-full">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tanggal</label>
                        <input type="date" id="transactionDate" class="enhanced-input compact-input w-full">
                    </div>

                    <div class="flex space-x-3">
                        <button id="addTransaction" class="enhanced-btn btn-primary flex-1 compact-btn">
                            <i class="fas fa-save mr-2"></i>Simpan Transaksi
                        </button>
                        <button id="clearTransactionForm" class="enhanced-btn btn-warning compact-btn">
                            <i class="fas fa-undo mr-2"></i>Reset
                        </button>
                    </div>
                </div>

                <div class="financial-card floating-card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-black text-gray-800 dark:text-white">
                            <i class="fas fa-list-alt mr-2"></i>Riwayat Transaksi
                        </h3>
                        <div class="flex space-x-2">
                            <select id="filterFund" class="enhanced-input compact-input text-sm">
                                <option value="">Semua Dana</option>
                                <option value="pribadi">Dana Pribadi</option>
                                <option value="bos">Dana BOS</option>
                                <option value="spp">Dana SPP</option>
                                <option value="komite">Dana Komite</option>
                                <option value="lainnya">Dana Lainnya</option>
                            </select>
                            <select id="filterMonth" class="enhanced-input compact-input text-sm">
                                <option value="">Semua Bulan</option>
                                <!-- Months will be populated by JavaScript -->
                            </select>
                        </div>
                    </div>

                    <div id="transactionList" class="space-y-2">
                        <!-- Transactions will be populated here -->
                    </div>

                    <div id="emptyTransactionState" class="text-center py-8">
                        <i class="fas fa-receipt text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-500 dark:text-gray-400">Belum ada transaksi</p>
                        <p class="text-sm text-gray-400 mt-2">Tambahkan transaksi pertama Anda menggunakan form di atas</p>
                    </div>
                </div>
            </div>

            <!-- Laporan Tab -->
            <div id="laporan" class="tab-content">
                <div class="financial-card mb-6 floating-card">
                    <h3 class="text-xl font-black text-gray-800 dark:text-white mb-4">
                        <i class="fas fa-chart-line mr-2"></i>Laporan Keuangan
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Periode Mulai</label>
                            <input type="date" id="reportStartDate" class="enhanced-input compact-input w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Periode Akhir</label>
                            <input type="date" id="reportEndDate" class="enhanced-input compact-input w-full">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Jenis Laporan</label>
                        <select id="reportType" class="enhanced-input compact-input w-full">
                            <option value="summary">Ringkasan Keuangan</option>
                            <option value="detailed">Laporan Detail</option>
                            <option value="category">Laporan per Kategori</option>
                            <option value="fund">Laporan per Dana</option>
                        </select>
                    </div>

                    <div class="export-grid">
                        <button id="exportPDF" class="export-btn bg-red-600 hover:bg-red-700 text-white">
                            <i class="fas fa-file-pdf text-lg"></i>
                            <span>PDF</span>
                        </button>
                        <button id="exportExcel" class="export-btn bg-green-600 hover:bg-green-700 text-white">
                            <i class="fas fa-file-excel text-lg"></i>
                            <span>Excel</span>
                        </button>
                        <button id="exportJPG" class="export-btn bg-yellow-600 hover:bg-yellow-700 text-white">
                            <i class="fas fa-file-image text-lg"></i>
                            <span>JPG</span>
                        </button>
                        <button id="exportPNG" class="export-btn bg-blue-600 hover:bg-blue-700 text-white">
                            <i class="fas fa-image text-lg"></i>
                            <span>PNG</span>
                        </button>
                        <button id="exportPrint" class="export-btn bg-purple-600 hover:bg-purple-700 text-white">
                            <i class="fas fa-print text-lg"></i>
                            <span>Print</span>
                        </button>
                    </div>
                </div>

                <div class="financial-card floating-card">
                    <h3 class="text-xl font-black text-gray-800 dark:text-white mb-4">
                        <i class="fas fa-chart-bar mr-2"></i>Preview Laporan
                    </h3>
                    <div id="reportPreview" class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <p class="text-gray-500 text-center">Pilih periode dan jenis laporan untuk melihat preview</p>
                    </div>
                </div>
            </div>
                        
            <!-- Developer Info Tab -->
            <div id="developer" class="tab-content">
                <h6 class="text-xl font-black text-gray-800 dark:text-white mb-4">
                    <i class="fas fa-code mr-2 text-purple-600"></i>Developer Information
                </h6>
                <div class="space-y-4">
                    <div class="text-center">
                        <div class="w-32 h-32 mx-auto mb-4 rounded-full bg-gradient-to-r from-purple-600 to-blue-600 flex items-center justify-center shadow-2xl">
                            <img src="https://pfst.cf2.poecdn.net/base/image/450b057a0166b3d912e628ec6196299c9664597953096114352df3ff0dadf34f?w=3100&h=3100"
                                 alt="NAJIB AI BRAIN Logo"
                                 class="w-full h-full object-contain rounded-full">
                        </div>
                        <h4 class="text-xl font-black text-gray-800 dark:text-white mb-2">
                            Muhammad Najib Wahidus Salam, S.Pd, Gr.
                        </h4>
                        <p class="text-lg text-purple-600 mb-3 font-semibold">
                            Quantum Mathematics Educator & AI Architect
                        </p>
                    </div>
                    
                    <div class="grid grid-cols-1 gap-3">
                        <div class="enhanced-card p-4">
                            <h5 class="text-md font-black text-blue-600 mb-2">Tentang Developer</h5>
                            <ul class="space-y-1 text-sm text-gray-700 dark:text-gray-300">
                                <li><i class="fas fa-map-marker-alt mr-2 text-blue-500"></i> Sidoarjo, Indonesia</li>
                                <li><i class="fas fa-graduation-cap mr-2 text-green-500"></i> S1-PGSD (2014-2021)</li>
                                <li><i class="fas fa-certificate mr-2 text-purple-500"></i> PPG Prajabatan 2024</li>
                                <li><i class="fas fa-briefcase mr-2 text-yellow-500"></i> Non-ASN Teacher & AI Architect</li>
                            </ul>
                        </div>
                        
                        <div class="enhanced-card p-4">
                            <h5 class="text-md font-black text-green-600 mb-2">Spesialisasi</h5>
                            <ul class="space-y-1 text-sm text-gray-700 dark:text-gray-300">
                                <li><i class="fas fa-qrcode mr-2 text-blue-500"></i> Quantum QR Educational Technology</li>
                                <li><i class="fas fa-robot mr-2 text-purple-500"></i> AI-Powered Learning Systems</li>
                                <li><i class="fas fa-music mr-2 text-yellow-500"></i> Original Music & Content Creation</li>
                                <li><i class="fas fa-code mr-2 text-green-500"></i> Full-Stack Web Development</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="enhanced-card p-4">
                        <h5 class="text-md font-black text-purple-600 mb-2">STL - UDHIS Financial Manager v2.0</h5>
                        <p class="text-sm text-gray-700 dark:text-gray-300 mb-3">
                            Aplikasi manajemen keuangan guru yang dikembangkan dengan teknologi terbaru untuk membantu guru dalam mengelola keuangan pribadi, BOS, dan dana sekolah dengan aman dan terenkripsi.
                        </p>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="text-center p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                <i class="fas fa-shield-alt text-blue-600 text-lg mb-1"></i>
                                <p class="font-medium">Enkripsi Data</p>
                            </div>
                            <div class="text-center p-2 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                <i class="fas fa-file-export text-green-600 text-lg mb-1"></i>
                                <p class="font-medium">Multi Export</p>
                            </div>
                            <div class="text-center p-2 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                                <i class="fas fa-mobile-alt text-purple-600 text-lg mb-1"></i>
                                <p class="font-medium">iOS Style</p>
                            </div>
                            <div class="text-center p-2 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                                <i class="fas fa-chart-pie text-yellow-600 text-lg mb-1"></i>
                                <p class="font-medium">Analytics</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Preview Modal -->
    <div id="printPreviewModal" class="print-preview-modal">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 class="text-lg font-black">Preview Laporan Tabungan</h3>
            <button id="closePrintPreview" class="enhanced-btn btn-error compact-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="print-preview-content" id="printContent">
            <!-- Print content will be populated here -->
        </div>
        <div class="flex justify-end p-4 border-t">
            <button id="exportAsPDF" class="enhanced-btn btn-primary compact-btn mr-2">
                <i class="fas fa-file-pdf mr-2"></i>Export PDF
            </button>
            <button id="exportAsImage" class="enhanced-btn btn-warning compact-btn">
                <i class="fas fa-image mr-2"></i>Export Image
            </button>
        </div>
    </div>

    <!-- Additional CSS for iOS 26 Enhancements -->
    <style>
        /* ==================== LEFT SIDEBAR STYLES ==================== */
        .left-sidebar {
            position: fixed;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100vh;
            background: var(--glass-bg-light);
            backdrop-filter: var(--ios-blur);
            -webkit-backdrop-filter: var(--ios-blur);
            border-right: 1px solid var(--glass-border-light);
            box-shadow: var(--glass-shadow-light);
            z-index: 10000;
            transition: var(--ios-transition);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .left-sidebar.active {
            left: 0;
        }

        .left-sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: var(--ios-transition);
        }

        .left-sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .left-sidebar-toggle {
            position: fixed;
            bottom: 10px;
            left: 8px;
            width: 28px;
            height: 28px;
            border-radius: 100%;
            background: var(--gradient-primary);
            color: white;
            border: none;
            box-shadow: var(--ios-shadow);
            z-index: 1000;
            cursor: pointer;
            transition: var(--ios-transition);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .left-sidebar-toggle:hover {
            transform: translateY(-5px) scale(1.1);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        /* Print Preview Modal */
        .print-preview-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            background: white;
            border-radius: var(--radius-2xl);
            box-shadow: var(--ios-shadow);
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: var(--ios-transition);
            overflow: hidden;
        }

        .print-preview-modal.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .print-preview-content {
            padding: 30px;
            background: white;
            color: #1e293b;
            max-height: 70vh;
            overflow-y: auto;
        }

        .print-header {
            text-align: center;
            border-bottom: 3px double #1e293b;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .print-header h2 {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .print-header .subtitle {
            font-size: 14px;
            color: #6b7280;
        }

        .print-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .print-table th,
        .print-table td {
            border: 1px solid #e5e7eb;
            padding: 12px;
            text-align: left;
        }

        .print-table th {
            background: #f8fafc;
            font-weight: 700;
        }

        .print-summary {
            margin-top: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: var(--radius-lg);
        }

        /* Floating Cards with Ambient Light Shadow */
        .floating-card {
            box-shadow: 
                0 10px 25px rgba(0, 0, 0, 0.1),
                0 5px 10px rgba(0, 0, 0, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
        }

        .floating-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.4), 
                transparent);
        }

        .floating-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.15),
                0 10px 20px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        /* Intelligent Font Color System */
        .intelligent-text {
            color: var(--theme-text);
            transition: color 0.8s ease;
        }

        /* Enhanced iOS 26 Animations */
        @keyframes gentle-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .gentle-bounce {
            animation: gentle-bounce 3s ease-in-out infinite;
        }

        @keyframes subtle-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .subtle-pulse {
            animation: subtle-pulse 4s ease-in-out infinite;
        }

        /* Enhanced Button Styles */
        .enhanced-btn-ios {
            background: linear-gradient(135deg, var(--layer1), var(--layer2));
            border: none;
            border-radius: var(--radius-xl);
            padding: 16px 28px;
            color: white;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            backdrop-filter: var(--ios-blur);
        }

        .enhanced-btn-ios::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.3), 
                transparent);
            transition: left 0.8s ease;
        }

        .enhanced-btn-ios:hover::before {
            left: 100%;
        }

        .enhanced-btn-ios:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 
                0 15px 30px rgba(0, 0, 0, 0.2),
                0 5px 15px rgba(0, 0, 0, 0.1);
        }

        /* Intelligent Color System for Dark Mode */
        @media (prefers-color-scheme: dark) {
            .intelligent-text {
                color: #f8fafc;
            }
            
            .enhanced-input {
                background: rgba(255, 255, 255, 0.05);
                border-color: rgba(255, 255, 255, 0.1);
                color: #f8fafc;
            }
            
            .enhanced-input:focus {
                background: rgba(255, 255, 255, 0.1);
                border-color: var(--theme-primary);
            }
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            .left-sidebar {
                width: 400px;
                left: -400px;
            }
        }

        @media (max-width: 480px) {
            .left-sidebar {
                padding: 15px;
            }
            
            .left-sidebar-toggle {
                width: 50px;
                height: 50px;
                bottom: 20px;
                left: 15px;
                font-size: 18px;
            }
            
            .floating-card {
                margin: 8px;
            }
        }

        /* Swipe Gestures for Mobile */
        .swipeable {
            transition: transform 0.3s ease;
        }

        .swipeable.swiping {
            transition: none;
        }

        /* Enhanced Loading States */
        .loading-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        /* Advanced Color Intelligence */
        .color-intelligent {
            background: var(--theme-card);
            color: var(--theme-text);
            border-color: var(--theme-border);
        }

        .color-intelligent:hover {
            background: color-mix(in srgb, var(--theme-card) 90%, var(--theme-primary));
        }

        /* iOS 26 Specific Glass Morphism */
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .glass-morphism-dark {
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
        <script>
        // ==================== KONFIGURASI & STATE ====================
        const CONFIG = {
            currentTheme: 'aurora-dream',
            isDarkMode: false,
            platform: 'unknown'
        };

        const FINANCIAL_STATE = {
            transactions: [],
            categories: {
                pribadi: { name: 'Dana Pribadi', balance: 0, color: '#3b82f6' },
                bos: { name: 'Dana BOS', balance: 0, color: '#10b981' },
                spp: { name: 'Dana SPP', balance: 0, color: '#f59e0b' },
                komite: { name: 'Dana Komite', balance: 0, color: '#8b5cf6' },
                lainnya: { name: 'Dana Lainnya', balance: 0, color: '#6b7280' }
            },
            currentBalance: 0,
            monthlyIncome: 0,
            monthlyExpense: 0
        };

        // ==================== SISTEM TEMA 8-LAYER ====================
        const THEMES = {
            'aurora-dream': {
                name: 'Aurora Dream',
                font: "'Inter', 'Segoe UI', system-ui, sans-serif",
                layers: {
                    layer1: '#667eea',
                    layer2: '#764ba2',
                    layer3: '#a78bfa',
                    layer4: '#c4b5fd',
                    layer5: '#ddd6fe',
                    layer6: '#f3f4f6',
                    layer7: '#f8fafc',
                    layer8: '#ffffff'
                }
            },
            'midnight-neon': {
                name: 'Midnight Neon',
                font: "'Orbitron', 'Rajdhani', 'Inter', system-ui, sans-serif",
                layers: {
                    layer1: '#0ea5e9',
                    layer2: '#8b5cf6',
                    layer3: '#06b6d4',
                    layer4: '#22d3ee',
                    layer5: '#67e8f9',
                    layer6: '#cffafe',
                    layer7: '#f0f9ff',
                    layer8: '#fefefe'
                }
            },
            'verdant-flow': {
                name: 'Verdant Flow',
                font: "'Nunito Sans', 'Open Sans', 'Inter', system-ui, sans-serif",
                layers: {
                    layer1: '#10b981',
                    layer2: '#059669',
                    layer3: '#34d399',
                    layer4: '#6ee7b7',
                    layer5: '#a7f3d0',
                    layer6: '#d1fae5',
                    layer7: '#f0fdf9',
                    layer8: '#ffffff'
                }
            },
            'ivory-luxe': {
                name: 'Ivory Luxe',
                font: "'Playfair Display', 'Merriweather', Georgia, serif",
                layers: {
                    layer1: '#d1d5db',
                    layer2: '#9ca3af',
                    layer3: '#6b7280',
                    layer4: '#f3f4f6',
                    layer5: '#f9fafb',
                    layer6: '#ffffff',
                    layer7: '#fefefe',
                    layer8: '#ffffff'
                }
            },
            'cyber-pink': {
                name: 'Cyber Pink',
                font: "'Rajdhani', 'Orbitron', 'Inter', system-ui, sans-serif",
                layers: {
                    layer1: '#ec4899',
                    layer2: '#db2777',
                    layer3: '#f472b6',
                    layer4: '#f9a8d4',
                    layer5: '#fbcfe8',
                    layer6: '#fce7f3',
                    layer7: '#fdf2f8',
                    layer8: '#ffffff'
                }
            },
            'amber-glow': {
                name: 'Amber Glow',
                font: "'Raleway', 'Lato', 'Inter', system-ui, sans-serif",
                layers: {
                    layer1: '#f59e0b',
                    layer2: '#d97706',
                    layer3: '#fbbf24',
                    layer4: '#fcd34d',
                    layer5: '#fde68a',
                    layer6: '#fef3c7',
                    layer7: '#fffbeb',
                    layer8: '#ffffff'
                }
            },
            'ocean-chrome': {
                name: 'Ocean Chrome',
                font: "'Inter', 'Roboto', 'Source Sans Pro', system-ui, sans-serif",
                layers: {
                    layer1: '#06b6d4',
                    layer2: '#0ea5e9',
                    layer3: '#3b82f6',
                    layer4: '#22d3ee',
                    layer5: '#67e8f9',
                    layer6: '#cffafe',
                    layer7: '#f0f9ff',
                    layer8: '#ffffff'
                }
            },
            'obsidian-dark': {
                name: 'Obsidian Dark',
                font: "'Urbanist', 'Montserrat', 'Inter', system-ui, sans-serif",
                layers: {
                    layer1: '#1f2937',
                    layer2: '#111827',
                    layer3: '#374151',
                    layer4: '#4b5563',
                    layer5: '#6b7280',
                    layer6: '#9ca3af',
                    layer7: '#f3f4f6',
                    layer8: '#ffffff'
                }
            }
        };

        // ==================== INISIALISASI APLIKASI ====================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            loadSavedData();
            populateThemeGrid();
            updateDynamicIsland('ðŸ’° Manajemen Keuangan Guru Siap!', 3000);
            
            // Set default dates
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;
            
            const firstDay = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            document.getElementById('reportStartDate').value = firstDay;
            document.getElementById('reportEndDate').value = today;
            
            populateMonthFilter();
            enhanceEventListeners();
        });

        function initializeApp() {
            // Load saved configuration
            const savedConfig = localStorage.getItem('stl_udhis_config');
            if (savedConfig) {
                Object.assign(CONFIG, JSON.parse(savedConfig));
                
                if (CONFIG.currentTheme) {
                    applyTheme(CONFIG.currentTheme);
                }
                
                if (CONFIG.isDarkMode) {
                    document.body.classList.add('dark');
                    document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
                }
            }
            
            // Apply default theme if none saved
            if (!CONFIG.currentTheme) {
                applyTheme('aurora-dream');
            }
            
            // Update aurora colors based on theme
            updateAuroraColors();
        }

        function setupEventListeners() {
            // Sidebar toggle
            document.getElementById('openSidebar').addEventListener('click', toggleSidebar);
            document.getElementById('closeSidebar').addEventListener('click', toggleSidebar);
            document.getElementById('sidebarOverlay').addEventListener('click', toggleSidebar);
            
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleDarkMode);
            
            // Theme selection
            document.getElementById('fontSelector').addEventListener('change', changeFont);
            document.getElementById('createCustomTheme').addEventListener('click', createCustomTheme);
            document.getElementById('resetCustomTheme').addEventListener('click', resetCustomTheme);
            document.getElementById('applyAdvanced').addEventListener('click', applyAdvancedSettings);
            document.getElementById('exportTheme').addEventListener('click', exportTheme);
            
            // Tab system
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchTab(this.getAttribute('data-tab'));
                });
            });
            
            // Transactions functionality
            document.getElementById('addTransaction').addEventListener('click', addTransaction);
            document.getElementById('clearTransactionForm').addEventListener('click', clearTransactionForm);
            
            // Filters
            document.getElementById('filterFund').addEventListener('change', renderTransactions);
            document.getElementById('filterMonth').addEventListener('change', renderTransactions);
            
            // Export functionality
            document.getElementById('exportPDF').addEventListener('click', () => exportReport('pdf'));
            document.getElementById('exportExcel').addEventListener('click', () => exportReport('excel'));
            document.getElementById('exportJPG').addEventListener('click', () => exportReport('jpg'));
            document.getElementById('exportPNG').addEventListener('click', () => exportReport('png'));
            document.getElementById('exportPrint').addEventListener('click', () => exportReport('print'));
            
            // Report generation
            document.getElementById('reportType').addEventListener('change', generateReportPreview);
            document.getElementById('reportStartDate').addEventListener('change', generateReportPreview);
            document.getElementById('reportEndDate').addEventListener('change', generateReportPreview);
        }

        // ==================== AURORA BACKGROUND FUNCTIONS ====================
        function updateAuroraColors() {
            const theme = THEMES[CONFIG.currentTheme];
            if (!theme) return;
            
            const root = document.documentElement;
            root.style.setProperty('--aurora-1', theme.layers.layer1);
            root.style.setProperty('--aurora-2', theme.layers.layer2);
            root.style.setProperty('--aurora-3', theme.layers.layer3);
            root.style.setProperty('--aurora-4', theme.layers.layer4);
        }

        // ==================== SIDEBAR FUNCTIONS ====================
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.add('active');
                overlay.classList.add('active');
            }
        }

        // ==================== THEME SYSTEM FUNCTIONS ====================
        function populateThemeGrid() {
            const themeGrid = document.getElementById('themeGrid');
            themeGrid.innerHTML = '';
            
            Object.keys(THEMES).forEach(key => {
                const theme = THEMES[key];
                const themeOption = document.createElement('div');
                themeOption.className = `theme-option ${key === CONFIG.currentTheme ? 'active' : ''}`;
                themeOption.style.background = `linear-gradient(135deg, ${theme.layers.layer1} 0%, ${theme.layers.layer2} 100%)`;
                themeOption.textContent = theme.name;
                themeOption.setAttribute('data-theme', key);
                themeOption.addEventListener('click', function() {
                    applyTheme(key);
                });
                
                themeGrid.appendChild(themeOption);
            });
        }

        function applyTheme(themeKey) {
            const theme = THEMES[themeKey];
            if (!theme) return;
            
            const root = document.documentElement;
            
            // Apply 8 layer CSS variables
            Object.entries(theme.layers).forEach(([layer, color]) => {
                root.style.setProperty(`--${layer}`, color);
            });
            
            // Apply font
            document.body.style.fontFamily = theme.font;
            
            // Update active theme in UI
            document.querySelectorAll('.theme-option').forEach(option => {
                if (option.getAttribute('data-theme') === themeKey) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
            
            // Update aurora colors
            updateAuroraColors();
            
            // Save theme preference
            CONFIG.currentTheme = themeKey;
            saveConfig();
            
            updateDynamicIsland(`ðŸŽ¨ Tema ${theme.name} Diaktifkan`, 2000);
        }

        function changeFont() {
            const fontFamily = document.getElementById('fontSelector').value;
            document.body.style.fontFamily = fontFamily;
            
            // Save font preference
            if (THEMES[CONFIG.currentTheme]) {
                THEMES[CONFIG.currentTheme].font = fontFamily;
            }
            
            saveConfig();
            updateDynamicIsland(`âœ’ï¸ Font Diubah`, 1500);
        }

        function createCustomTheme() {
            const layer1 = document.getElementById('customLayer1').value;
            const layer2 = document.getElementById('customLayer2').value;
            const layer3 = document.getElementById('customLayer3').value;
            const layer4 = document.getElementById('customLayer4').value;
            const layer5 = document.getElementById('customLayer5').value;
            const layer6 = document.getElementById('customLayer6').value;
            const layer7 = document.getElementById('customLayer7').value;
            const layer8 = document.getElementById('customLayer8').value;
            
            const customTheme = {
                name: 'Tema Kustom',
                font: document.getElementById('fontSelector').value,
                layers: {
                    layer1: layer1,
                    layer2: layer2,
                    layer3: layer3,
                    layer4: layer4,
                    layer5: layer5,
                    layer6: layer6,
                    layer7: layer7,
                    layer8: layer8
                }
            };
            
            // Add to themes
            const themeKey = 'custom-theme-' + Date.now();
            THEMES[themeKey] = customTheme;
            
            // Apply the theme
            applyTheme(themeKey);
            
            // Update theme grid
            populateThemeGrid();
            
            updateDynamicIsland('ðŸŽ¨ Tema Kustom Dibuat!', 2000);
        }

        function resetCustomTheme() {
            document.getElementById('customLayer1').value = '#667eea';
            document.getElementById('customLayer2').value = '#764ba2';
            document.getElementById('customLayer3').value = '#a78bfa';
            document.getElementById('customLayer4').value = '#c4b5fd';
            document.getElementById('customLayer5').value = '#ddd6fe';
            document.getElementById('customLayer6').value = '#f3f4f6';
            document.getElementById('customLayer7').value = '#f8fafc';
            document.getElementById('customLayer8').value = '#ffffff';
            
            updateDynamicIsland('ðŸ”„ Tema Kustom Direset', 1500);
        }

        function applyAdvancedSettings() {
            const glowIntensity = document.getElementById('glowIntensity').value;
            const borderRadius = document.getElementById('borderRadius').value;
            
            // Apply glow intensity
            document.documentElement.style.setProperty('--glow', `0 0 30px color-mix(in srgb, var(--layer1) ${glowIntensity}%, transparent)`);
            
            // Apply border radius
            document.documentElement.style.setProperty('--radius-lg', `${borderRadius}px`);
            document.documentElement.style.setProperty('--radius-xl', `${parseInt(borderRadius) + 4}px`);
            document.documentElement.style.setProperty('--radius-2xl', `${parseInt(borderRadius) + 8}px`);
            
            updateDynamicIsland('âš™ï¸ Pengaturan Lanjutan Diterapkan', 1500);
        }

        function exportTheme() {
            const currentTheme = THEMES[CONFIG.currentTheme];
            const themeData = {
                name: currentTheme.name,
                font: currentTheme.font,
                layers: currentTheme.layers
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(themeData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `stl-theme-${currentTheme.name}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            updateDynamicIsland('ðŸ“¥ Tema Diekspor', 1500);
        }

        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark');
            CONFIG.isDarkMode = isDark;
            
            const themeToggle = document.getElementById('themeToggle');
            if (isDark) {
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
            
            saveConfig();
            updateDynamicIsland(isDark ? 'ðŸŒ™ Mode Gelap Diaktifkan' : 'â˜€ï¸ Mode Terang Diaktifkan', 1500);
        }

        // ==================== TAB SYSTEM FUNCTIONS ====================
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Update data if needed
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'laporan') {
                generateReportPreview();
            }
        }

        // ==================== TRANSACTIONS FUNCTIONS ====================
        function addTransaction() {
            const fund = document.getElementById('transactionFund').value;
            const category = document.getElementById('transactionCategory').value;
            const type = document.getElementById('transactionType').value;
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            const description = document.getElementById('transactionDescription').value;
            const date = document.getElementById('transactionDate').value;
            
            if (!amount || amount <= 0 || !description || !date) {
                updateDynamicIsland('âš ï¸ Lengkapi semua field transaksi', 2000);
                return;
            }
            
            const transaction = {
                id: Date.now(),
                fund,
                category,
                type,
                amount,
                description,
                date,
                timestamp: new Date().toISOString()
            };
            
            FINANCIAL_STATE.transactions.unshift(transaction);
            
            // Update balances
            if (type === 'debit') {
                FINANCIAL_STATE.categories[fund].balance += amount;
                FINANCIAL_STATE.currentBalance += amount;
                
                // Update monthly income if transaction is from current month
                const transactionDate = new Date(date);
                const currentDate = new Date();
                if (transactionDate.getMonth() === currentDate.getMonth() && 
                    transactionDate.getFullYear() === currentDate.getFullYear()) {
                    FINANCIAL_STATE.monthlyIncome += amount;
                }
            } else {
                FINANCIAL_STATE.categories[fund].balance -= amount;
                FINANCIAL_STATE.currentBalance -= amount;
                
                // Update monthly expense if transaction is from current month
                const transactionDate = new Date(date);
                const currentDate = new Date();
                if (transactionDate.getMonth() === currentDate.getMonth() && 
                    transactionDate.getFullYear() === currentDate.getFullYear()) {
                    FINANCIAL_STATE.monthlyExpense += amount;
                }
            }
            
            renderTransactions();
            updateDashboard();
            clearTransactionForm();
            saveData();
            
            updateDynamicIsland('ðŸ’° Transaksi ditambahkan', 1500);
        }

        function renderTransactions() {
            const transactionList = document.getElementById('transactionList');
            const emptyState = document.getElementById('emptyTransactionState');
            
            if (!transactionList || !emptyState) return;
            
            const filteredTransactions = getFilteredTransactions();
            
            if (filteredTransactions.length === 0) {
                transactionList.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            transactionList.innerHTML = filteredTransactions.map(transaction => `
                <div class="transaction-item swipeable" data-id="${transaction.id}">
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-black text-gray-800 dark:text-white text-sm">${transaction.description}</h4>
                                <div class="flex items-center space-x-2 mt-1">
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">${FINANCIAL_STATE.categories[transaction.fund].name}</span>
                                    <span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs">${transaction.category}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="font-bold ${transaction.type === 'debit' ? 'text-green-600' : 'text-red-600'}">
                                    ${transaction.type === 'debit' ? '+' : '-'} Rp ${formatCurrency(transaction.amount)}
                                </span>
                                <p class="text-xs text-gray-500 mt-1">${new Date(transaction.date).toLocaleDateString('id-ID')}</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-1">
                        <button class="enhanced-btn bg-yellow-500 hover:bg-yellow-600 text-white text-xs compact-btn star-transaction" data-id="${transaction.id}">
                            <i class="fas fa-star"></i>
                        </button>
                        <button class="enhanced-btn btn-error text-xs compact-btn delete-transaction" data-id="${transaction.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Add event listeners to delete buttons
            document.querySelectorAll('.delete-transaction').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    deleteTransaction(id);
                });
            });
            
            // Add event listeners to star buttons
            document.querySelectorAll('.star-transaction').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    addToImportantHistory(id);
                });
            });
        }

        function getFilteredTransactions() {
            const fundFilter = document.getElementById('filterFund').value;
            const monthFilter = document.getElementById('filterMonth').value;
            
            return FINANCIAL_STATE.transactions.filter(transaction => {
                const fundMatch = !fundFilter || transaction.fund === fundFilter;
                const monthMatch = !monthFilter || transaction.date.startsWith(monthFilter);
                return fundMatch && monthMatch;
            });
        }

        function deleteTransaction(id) {
            const transactionIndex = FINANCIAL_STATE.transactions.findIndex(t => t.id === id);
            if (transactionIndex !== -1) {
                const transaction = FINANCIAL_STATE.transactions[transactionIndex];
                
                // Reverse balance update
                if (transaction.type === 'debit') {
                    FINANCIAL_STATE.categories[transaction.fund].balance -= transaction.amount;
                    FINANCIAL_STATE.currentBalance -= transaction.amount;
                    
                    // Update monthly income if transaction is from current month
                    const transactionDate = new Date(transaction.date);
                    const currentDate = new Date();
                    if (transactionDate.getMonth() === currentDate.getMonth() && 
                        transactionDate.getFullYear() === currentDate.getFullYear()) {
                        FINANCIAL_STATE.monthlyIncome -= transaction.amount;
                    }
                } else {
                    FINANCIAL_STATE.categories[transaction.fund].balance += transaction.amount;
                    FINANCIAL_STATE.currentBalance += transaction.amount;
                    
                    // Update monthly expense if transaction is from current month
                    const transactionDate = new Date(transaction.date);
                    const currentDate = new Date();
                    if (transactionDate.getMonth() === currentDate.getMonth() && 
                        transactionDate.getFullYear() === currentDate.getFullYear()) {
                        FINANCIAL_STATE.monthlyExpense -= transaction.amount;
                    }
                }
                
                FINANCIAL_STATE.transactions.splice(transactionIndex, 1);
                renderTransactions();
                updateDashboard();
                saveData();
                
                updateDynamicIsland('ðŸ—‘ï¸ Transaksi dihapus', 1500);
            }
        }

        function clearTransactionForm() {
            document.getElementById('transactionAmount').value = '';
            document.getElementById('transactionDescription').value = '';
            
            // Set date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;
        }

        // ==================== DASHBOARD FUNCTIONS ====================
        function updateDashboard() {
            // Update balance displays
            document.getElementById('totalBalance').textContent = `Rp ${formatCurrency(FINANCIAL_STATE.currentBalance)}`;
            document.getElementById('monthlyIncome').textContent = `Rp ${formatCurrency(FINANCIAL_STATE.monthlyIncome)}`;
            document.getElementById('monthlyExpense').textContent = `Rp ${formatCurrency(FINANCIAL_STATE.monthlyExpense)}`;
            
            // Update category balances
            const categoryBalances = document.getElementById('categoryBalances');
            categoryBalances.innerHTML = '';
            
            Object.entries(FINANCIAL_STATE.categories).forEach(([key, category]) => {
                const balanceElement = document.createElement('div');
                balanceElement.className = 'flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700';
                balanceElement.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${category.color}"></div>
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">${category.name}</span>
                    </div>
                    <span class="font-bold text-gray-800 dark:text-white">Rp ${formatCurrency(category.balance)}</span>
                `;
                categoryBalances.appendChild(balanceElement);
            });
            
            // Update distribution chart (simple implementation)
            const distributionChart = document.getElementById('distributionChart');
            if (FINANCIAL_STATE.currentBalance > 0) {
                let chartHTML = '<div class="w-full h-full flex items-center justify-center flex-wrap">';
                Object.entries(FINANCIAL_STATE.categories).forEach(([key, category]) => {
                    if (category.balance > 0) {
                        const percentage = (category.balance / FINANCIAL_STATE.currentBalance * 100).toFixed(1);
                        chartHTML += `
                            <div class="text-center m-2">
                                <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-2" style="background: conic-gradient(${category.color} 0% ${percentage}%, #e5e7eb ${percentage}% 100%)">
                                    <div class="w-12 h-12 bg-white dark:bg-gray-800 rounded-full flex items-center justify-center">
                                        <span class="text-xs font-bold">${percentage}%</span>
                                    </div>
                                </div>
                                <span class="text-xs font-medium">${category.name}</span>
                            </div>
                        `;
                    }
                });
                chartHTML += '</div>';
                distributionChart.innerHTML = chartHTML;
            } else {
                distributionChart.innerHTML = '<p class="text-gray-500">Belum ada data keuangan</p>';
            }
        }

        // ==================== REPORT FUNCTIONS ====================
        function generateReportPreview() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const reportType = document.getElementById('reportType').value;
            
            if (!startDate || !endDate) {
                document.getElementById('reportPreview').innerHTML = '<p class="text-gray-500 text-center">Pilih periode laporan terlebih dahulu</p>';
                return;
            }
            
            const filteredTransactions = FINANCIAL_STATE.transactions.filter(transaction => {
                return transaction.date >= startDate && transaction.date <= endDate;
            });
            
            let reportHTML = '';
            
            switch (reportType) {
                case 'summary':
                    reportHTML = generateSummaryReport(filteredTransactions, startDate, endDate);
                    break;
                case 'detailed':
                    reportHTML = generateDetailedReport(filteredTransactions, startDate, endDate);
                    break;
                case 'category':
                    reportHTML = generateCategoryReport(filteredTransactions, startDate, endDate);
                    break;
                case 'fund':
                    reportHTML = generateFundReport(filteredTransactions, startDate, endDate);
                    break;
            }
            
            document.getElementById('reportPreview').innerHTML = reportHTML;
        }

        function generateSummaryReport(transactions, startDate, endDate) {
            const totalIncome = transactions
                .filter(t => t.type === 'debit')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const totalExpense = transactions
                .filter(t => t.type === 'kredit')
                .reduce((sum, t) => sum + t.amount, 0);
                
            const netBalance = totalIncome - totalExpense;
            
            return `
                <div class="space-y-4">
                    <h4 class="text-lg font-black text-center">Laporan Ringkasan Keuangan</h4>
                    <p class="text-center text-gray-600">Periode: ${new Date(startDate).toLocaleDateString('id-ID')} - ${new Date(endDate).toLocaleDateString('id-ID')}</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                        <div class="text-center p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                            <div class="text-2xl font-black text-green-600">Rp ${formatCurrency(totalIncome)}</div>
                            <p class="text-sm text-gray-600">Total Pemasukan</p>
                        </div>
                        <div class="text-center p-4 bg-red-50 dark:bg-red-900/20 rounded-lg">
                            <div class="text-2xl font-black text-red-600">Rp ${formatCurrency(totalExpense)}</div>
                            <p class="text-sm text-gray-600">Total Pengeluaran</p>
                        </div>
                        <div class="text-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                            <div class="text-2xl font-black ${netBalance >= 0 ? 'text-blue-600' : 'text-red-600'}">Rp ${formatCurrency(Math.abs(netBalance))}</div>
                            <p class="text-sm text-gray-600">${netBalance >= 0 ? 'Surplus' : 'Defisit'}</p>
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h5 class="font-black mb-2">Statistik per Kategori Dana</h5>
                        ${Object.entries(FINANCIAL_STATE.categories).map(([key, category]) => {
                            const categoryTransactions = transactions.filter(t => t.fund === key);
                            const categoryIncome = categoryTransactions.filter(t => t.type === 'debit').reduce((sum, t) => sum + t.amount, 0);
                            const categoryExpense = categoryTransactions.filter(t => t.type === 'kredit').reduce((sum, t) => sum + t.amount, 0);
                            
                            return `
                                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                                    <span class="font-medium">${category.name}</span>
                                    <div class="text-right">
                                        <div class="text-green-600 text-sm">+Rp ${formatCurrency(categoryIncome)}</div>
                                        <div class="text-red-600 text-sm">-Rp ${formatCurrency(categoryExpense)}</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function generateDetailedReport(transactions, startDate, endDate) {
            return `
                <div class="space-y-4">
                    <h4 class="text-lg font-black text-center">Laporan Detail Transaksi</h4>
                    <p class="text-center text-gray-600">Periode: ${new Date(startDate).toLocaleDateString('id-ID')} - ${new Date(endDate).toLocaleDateString('id-ID')}</p>
                    
                    <div class="mt-4 space-y-2 max-h-96 overflow-y-auto">
                        ${transactions.length > 0 ? transactions.map(transaction => `
                            <div class="flex justify-between items-center p-3 border-b border-gray-200">
                                <div>
                                    <div class="font-medium">${transaction.description}</div>
                                    <div class="text-xs text-gray-500">
                                        ${FINANCIAL_STATE.categories[transaction.fund].name} â€¢ ${transaction.category} â€¢ ${new Date(transaction.date).toLocaleDateString('id-ID')}
                                    </div>
                                </div>
                                <span class="font-bold ${transaction.type === 'debit' ? 'text-green-600' : 'text-red-600'}">
                                    ${transaction.type === 'debit' ? '+' : '-'} Rp ${formatCurrency(transaction.amount)}
                                </span>
                            </div>
                        `).join('') : '<p class="text-center text-gray-500">Tidak ada transaksi pada periode ini</p>'}
                    </div>
                </div>
            `;
        }

        function generateCategoryReport(transactions, startDate, endDate) {
            const categoryStats = {};
            
            transactions.forEach(transaction => {
                if (!categoryStats[transaction.category]) {
                    categoryStats[transaction.category] = { income: 0, expense: 0 };
                }
                
                if (transaction.type === 'debit') {
                    categoryStats[transaction.category].income += transaction.amount;
                } else {
                    categoryStats[transaction.category].expense += transaction.amount;
                }
            });
            
            return `
                <div class="space-y-4">
                    <h4 class="text-lg font-black text-center">Laporan per Kategori</h4>
                    <p class="text-center text-gray-600">Periode: ${new Date(startDate).toLocaleDateString('id-ID')} - ${new Date(endDate).toLocaleDateString('id-ID')}</p>
                    
                    <div class="mt-4 space-y-3">
                        ${Object.entries(categoryStats).length > 0 ? Object.entries(categoryStats).map(([category, stats]) => `
                            <div class="p-3 border border-gray-200 rounded-lg">
                                <div class="font-black mb-2">${category}</div>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div class="text-green-600">
                                        <div class="font-medium">Pemasukan</div>
                                        <div>Rp ${formatCurrency(stats.income)}</div>
                                    </div>
                                    <div class="text-red-600">
                                        <div class="font-medium">Pengeluaran</div>
                                        <div>Rp ${formatCurrency(stats.expense)}</div>
                                    </div>
                                </div>
                                <div class="mt-2 text-xs text-gray-500">
                                    Saldo: Rp ${formatCurrency(stats.income - stats.expense)}
                                </div>
                            </div>
                        `).join('') : '<p class="text-center text-gray-500">Tidak ada transaksi pada periode ini</p>'}
                    </div>
                </div>
            `;
        }

        function generateFundReport(transactions, startDate, endDate) {
            return `
                <div class="space-y-4">
                    <h4 class="text-lg font-black text-center">Laporan per Dana</h4>
                    <p class="text-center text-gray-600">Periode: ${new Date(startDate).toLocaleDateString('id-ID')} - ${new Date(endDate).toLocaleDateString('id-ID')}</p>
                    
                    <div class="mt-4 space-y-3">
                        ${Object.entries(FINANCIAL_STATE.categories).map(([key, category]) => {
                            const fundTransactions = transactions.filter(t => t.fund === key);
                            const fundIncome = fundTransactions.filter(t => t.type === 'debit').reduce((sum, t) => sum + t.amount, 0);
                            const fundExpense = fundTransactions.filter(t => t.type === 'kredit').reduce((sum, t) => sum + t.amount, 0);
                            const fundBalance = fundIncome - fundExpense;
                            
                            return `
                                <div class="p-3 border border-gray-200 rounded-lg">
                                    <div class="flex items-center mb-2">
                                        <div class="w-3 h-3 rounded-full mr-2" style="background-color: ${category.color}"></div>
                                        <div class="font-black">${category.name}</div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div class="text-green-600">
                                            <div class="font-medium">Pemasukan</div>
                                            <div>Rp ${formatCurrency(fundIncome)}</div>
                                        </div>
                                        <div class="text-red-600">
                                            <div class="font-medium">Pengeluaran</div>
                                            <div>Rp ${formatCurrency(fundExpense)}</div>
                                        </div>
                                    </div>
                                    <div class="mt-2 text-xs ${fundBalance >= 0 ? 'text-green-600' : 'text-red-600'}">
                                        Saldo: Rp ${formatCurrency(Math.abs(fundBalance))} (${fundBalance >= 0 ? 'Positif' : 'Negatif'})
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function exportReport(format) {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const reportType = document.getElementById('reportType').value;
            
            if (!startDate || !endDate) {
                updateDynamicIsland('âš ï¸ Pilih periode laporan terlebih dahulu', 2000);
                return;
            }
            
            let content = document.getElementById('reportPreview').innerHTML;
            const title = `Laporan Keuangan - ${new Date().toLocaleDateString('id-ID')}`;
            
            switch (format) {
                case 'pdf':
                    exportToPDF(content, title);
                    break;
                case 'excel':
                    exportToExcel(startDate, endDate, reportType);
                    break;
                case 'jpg':
                case 'png':
                    exportToImage(content, title, format);
                    break;
                case 'print':
                    window.print();
                    break;
            }
            
            updateDynamicIsland(`ðŸ“Š Laporan diekspor sebagai ${format.toUpperCase()}`, 3000);
        }

        function exportToPDF(content, title) {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .content { margin-top: 20px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>${title}</h1>
                    </div>
                    <div class="content">${content}</div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function exportToExcel(startDate, endDate, reportType) {
            const filteredTransactions = FINANCIAL_STATE.transactions.filter(transaction => {
                return transaction.date >= startDate && transaction.date <= endDate;
            });
            
            let csvContent = "Tanggal,Jenis Dana,Kategori,Jenis,Jumlah,Keterangan\n";
            
            filteredTransactions.forEach(transaction => {
                csvContent += `"${transaction.date}","${FINANCIAL_STATE.categories[transaction.fund].name}","${transaction.category}","${transaction.type === 'debit' ? 'Pemasukan' : 'Pengeluaran'}","${transaction.amount}","${transaction.description}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `laporan-keuangan-${startDate}-${endDate}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function exportToImage(content, title, format) {
            // Simple implementation - in a real app you might use html2canvas
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; background: white; }
                        .header { text-align: center; margin-bottom: 20px; }
                        .content { margin-top: 20px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>${title}</h1>
                    </div>
                    <div class="content">${content}</div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // ==================== UTILITY FUNCTIONS ====================
        function formatCurrency(amount) {
            return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function updateDynamicIsland(message, duration = 3000) {
            const island = document.getElementById('dynamicIsland');
            island.textContent = message;
            island.classList.add('active');
            
            setTimeout(() => {
                island.classList.remove('active');
            }, duration);
        }

        function populateMonthFilter() {
            const monthFilter = document.getElementById('filterMonth');
            const months = [];
            
            // Get unique months from transactions
            FINANCIAL_STATE.transactions.forEach(transaction => {
                const month = transaction.date.substring(0, 7); // YYYY-MM format
                if (!months.includes(month)) {
                    months.push(month);
                }
            });
            
            // Add current month if no transactions
            const currentMonth = new Date().toISOString().substring(0, 7);
            if (months.length === 0) {
                months.push(currentMonth);
            }
            
            // Sort months in descending order
            months.sort().reverse();
            
            // Populate dropdown
            months.forEach(month => {
                const date = new Date(month + '-01');
                const option = document.createElement('option');
                option.value = month;
                option.textContent = date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long' });
                monthFilter.appendChild(option);
            });
        }

        function saveConfig() {
            localStorage.setItem('stl_udhis_config', JSON.stringify(CONFIG));
        }

        function saveData() {
            const data = {
                transactions: FINANCIAL_STATE.transactions,
                categories: FINANCIAL_STATE.categories,
                currentBalance: FINANCIAL_STATE.currentBalance,
                monthlyIncome: FINANCIAL_STATE.monthlyIncome,
                monthlyExpense: FINANCIAL_STATE.monthlyExpense
            };
            
            // Encrypt data before saving
            const encryptedData = btoa(JSON.stringify(data));
            localStorage.setItem('stl_udhis_financial_data', encryptedData);
        }

        function loadSavedData() {
            const encryptedData = localStorage.getItem('stl_udhis_financial_data');
            if (encryptedData) {
                try {
                    const data = JSON.parse(atob(encryptedData));
                    
                    FINANCIAL_STATE.transactions = data.transactions || [];
                    FINANCIAL_STATE.categories = data.categories || FINANCIAL_STATE.categories;
                    FINANCIAL_STATE.currentBalance = data.currentBalance || 0;
                    FINANCIAL_STATE.monthlyIncome = data.monthlyIncome || 0;
                    FINANCIAL_STATE.monthlyExpense = data.monthlyExpense || 0;
                    
                    renderTransactions();
                    updateDashboard();
                    populateMonthFilter();
                } catch (error) {
                    console.error('Error loading financial data:', error);
                }
            }
        }

        // ==================== LEFT SIDEBAR FUNCTIONS ====================
        function toggleLeftSidebar() {
            const sidebar = document.getElementById('leftSidebar');
            const overlay = document.getElementById('leftSidebarOverlay');
            
            if (sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.add('active');
                overlay.classList.add('active');
                loadImportantHistory();
            }
        }

        // ==================== PRINT & REPORT FUNCTIONS ====================
        function generatePrintPreview() {
            const transactions = FINANCIAL_STATE.transactions;
            if (transactions.length === 0) {
                updateDynamicIsland('âš ï¸ Tidak ada data untuk dicetak', 2000);
                return;
            }
            
            const printHTML = `
                <div class="print-header">
                    <h2>LAPORAN TABUNGAN GURU</h2>
                    <p class="subtitle">STL - UDHIS Financial Manager</p>
                    <p class="subtitle">Periode: ${new Date().toLocaleDateString('id-ID')}</p>
                </div>
                
                <div class="print-summary">
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="text-center">
                            <div class="font-black text-lg">Rp ${formatCurrency(FINANCIAL_STATE.currentBalance)}</div>
                            <p class="text-sm">Saldo Total</p>
                        </div>
                        <div class="text-center">
                            <div class="font-black text-lg text-green-600">Rp ${formatCurrency(FINANCIAL_STATE.monthlyIncome)}</div>
                            <p class="text-sm">Pemasukan Bulan Ini</p>
                        </div>
                        <div class="text-center">
                            <div class="font-black text-lg text-red-600">Rp ${formatCurrency(FINANCIAL_STATE.monthlyExpense)}</div>
                            <p class="text-sm">Pengeluaran Bulan Ini</p>
                        </div>
                    </div>
                </div>
                
                <table class="print-table">
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Keterangan</th>
                            <th>Jenis Dana</th>
                            <th>Jenis</th>
                            <th>Jumlah</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${transactions.map(transaction => `
                            <tr>
                                <td>${new Date(transaction.date).toLocaleDateString('id-ID')}</td>
                                <td>${transaction.description}</td>
                                <td>${FINANCIAL_STATE.categories[transaction.fund].name}</td>
                                <td>${transaction.type === 'debit' ? 'Pemasukan' : 'Pengeluaran'}</td>
                                <td class="${transaction.type === 'debit' ? 'text-green-600' : 'text-red-600'}">
                                    ${transaction.type === 'debit' ? '+' : '-'} Rp ${formatCurrency(transaction.amount)}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                <div class="print-summary mt-6">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-sm">Dicetak pada: ${new Date().toLocaleString('id-ID')}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-black">Mengetahui,</p>
                            <p class="mt-8">Guru/Pengelola</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('printContent').innerHTML = printHTML;
            document.getElementById('printPreviewModal').classList.add('active');
        }

        function closePrintPreview() {
            document.getElementById('printPreviewModal').classList.remove('active');
        }

        function exportPrintContent(format) {
            const element = document.getElementById('printContent');
            
            if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                doc.html(element, {
                    callback: function (doc) {
                        doc.save(`laporan-tabungan-${new Date().toISOString().split('T')[0]}.pdf`);
                    },
                    margin: [10, 10, 10, 10],
                    autoPaging: 'text',
                    x: 0,
                    y: 0,
                    width: 190,
                    windowWidth: 800
                });
            } else if (format === 'image') {
                html2canvas(element).then(canvas => {
                    canvas.toBlob(blob => {
                        saveAs(blob, `laporan-tabungan-${new Date().toISOString().split('T')[0]}.png`);
                    });
                });
            }
            
            closePrintPreview();
            updateDynamicIsland('ðŸ“„ Laporan berhasil diexport', 2000);
        }

        // ==================== BACKUP & ENCRYPTION FUNCTIONS ====================
        function backupData() {
            const password = document.getElementById('backupPassword').value;
            if (password !== 'b4ckupmyd4t4') {
                updateDynamicIsland('âŒ Password backup salah', 2000);
                return;
            }
            
            const data = {
                transactions: FINANCIAL_STATE.transactions,
                categories: FINANCIAL_STATE.categories,
                config: CONFIG,
                timestamp: new Date().toISOString()
            };
            
            // Encrypt data
            const encryptedData = CryptoJS.AES.encrypt(JSON.stringify(data), password).toString();
            const blob = new Blob([encryptedData], { type: 'application/octet-stream' });
            
            saveAs(blob, `stl-backup-${new Date().toISOString().split('T')[0]}.enc`);
            updateDynamicIsland('âœ… Backup data berhasil', 2000);
        }

        function restoreData() {
            const password = document.getElementById('backupPassword').value;
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.enc';
            
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    try {
                        const encryptedData = event.target.result;
                        const decryptedData = CryptoJS.AES.decrypt(encryptedData, password).toString(CryptoJS.enc.Utf8);
                        
                        if (!decryptedData) {
                            updateDynamicIsland('âŒ Password restore salah', 2000);
                            return;
                        }
                        
                        const data = JSON.parse(decryptedData);
                        
                        // Restore data
                        FINANCIAL_STATE.transactions = data.transactions || [];
                        Object.assign(FINANCIAL_STATE.categories, data.categories || {});
                        Object.assign(CONFIG, data.config || {});
                        
                        // Recalculate balances
                        recalculateBalances();
                        renderTransactions();
                        updateDashboard();
                        saveData();
                        
                        updateDynamicIsland('âœ… Data berhasil direstore', 2000);
                    } catch (error) {
                        updateDynamicIsland('âŒ Gagal restore data', 2000);
                    }
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        function recalculateBalances() {
            // Reset balances
            FINANCIAL_STATE.currentBalance = 0;
            FINANCIAL_STATE.monthlyIncome = 0;
            FINANCIAL_STATE.monthlyExpense = 0;
            
            Object.keys(FINANCIAL_STATE.categories).forEach(key => {
                FINANCIAL_STATE.categories[key].balance = 0;
            });
            
            // Recalculate from transactions
            FINANCIAL_STATE.transactions.forEach(transaction => {
                if (transaction.type === 'debit') {
                    FINANCIAL_STATE.categories[transaction.fund].balance += transaction.amount;
                    FINANCIAL_STATE.currentBalance += transaction.amount;
                } else {
                    FINANCIAL_STATE.categories[transaction.fund].balance -= transaction.amount;
                    FINANCIAL_STATE.currentBalance -= transaction.amount;
                }
            });
        }

        // ==================== IMPORTANT HISTORY FUNCTIONS ====================
        function loadImportantHistory() {
            const importantHistory = JSON.parse(localStorage.getItem('stl_important_history') || '[]');
            const container = document.getElementById('importantHistoryList');
            
            if (importantHistory.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center text-sm">Belum ada riwayat penting</p>';
                return;
            }
            
            container.innerHTML = importantHistory.map(item => `
                <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-800 rounded-lg">
                    <div class="flex-1">
                        <div class="font-medium text-sm">${item.description}</div>
                        <div class="text-xs text-gray-500">Rp ${formatCurrency(item.amount)} â€¢ ${new Date(item.date).toLocaleDateString('id-ID')}</div>
                    </div>
                    <button class="enhanced-btn btn-error text-xs compact-btn ml-2 remove-important" data-id="${item.id}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
            
            // Add event listeners for remove buttons
            document.querySelectorAll('.remove-important').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    removeFromImportantHistory(id);
                });
            });
        }

        function addToImportantHistory(transactionId) {
            const transaction = FINANCIAL_STATE.transactions.find(t => t.id == transactionId);
            if (!transaction) return;
            
            const importantHistory = JSON.parse(localStorage.getItem('stl_important_history') || '[]');
            
            // Check if already exists
            if (!importantHistory.find(item => item.id === transactionId)) {
                importantHistory.unshift({
                    id: transactionId,
                    ...transaction
                });
                
                // Keep only last 10 items
                if (importantHistory.length > 10) {
                    importantHistory.pop();
                }
                
                localStorage.setItem('stl_important_history', JSON.stringify(importantHistory));
                updateDynamicIsland('â­ Ditambahkan ke riwayat penting', 1500);
            }
        }

        function removeFromImportantHistory(transactionId) {
            let importantHistory = JSON.parse(localStorage.getItem('stl_important_history') || '[]');
            importantHistory = importantHistory.filter(item => item.id != transactionId);
            localStorage.setItem('stl_important_history', JSON.stringify(importantHistory));
            loadImportantHistory();
            updateDynamicIsland('ðŸ—‘ï¸ Dihapus dari riwayat penting', 1500);
        }

        // ==================== SYNC & PROTECTION FUNCTIONS ====================
        function syncData() {
            updateDynamicIsland('ðŸ”„ Menyinkronisasi data...', 2000);
            
            // Simulate sync process
            setTimeout(() => {
                saveData();
                updateDynamicIsland('âœ… Data tersinkronisasi', 1500);
            }, 1000);
        }

        function optimizeProtection() {
            // Clear sensitive data from memory
            const passwordInputs = document.querySelectorAll('input[type="password"]');
            passwordInputs.forEach(input => {
                if (input.value !== 'b4ckupmyd4t4') {
                    input.value = '';
                }
            });
            
            // Force save current state
            saveData();
            
            updateDynamicIsland('ðŸ›¡ï¸ Proteksi dioptimalkan', 1500);
        }

        // ==================== ENHANCE EXISTING EVENT LISTENERS ====================
        function enhanceEventListeners() {
            // Left sidebar toggle
            document.getElementById('openLeftSidebar').addEventListener('click', toggleLeftSidebar);
            document.getElementById('closeLeftSidebar').addEventListener('click', toggleLeftSidebar);
            document.getElementById('leftSidebarOverlay').addEventListener('click', toggleLeftSidebar);
            
            // Print functions
            document.getElementById('previewReport').addEventListener('click', generatePrintPreview);
            document.getElementById('printPDF').addEventListener('click', generatePrintPreview);
            document.getElementById('printJPG').addEventListener('click', generatePrintPreview);
            document.getElementById('printPNG').addEventListener('click', generatePrintPreview);
            
            // Backup functions
            document.getElementById('backupData').addEventListener('click', backupData);
            document.getElementById('restoreData').addEventListener('click', restoreData);
            
            // Sync & protection
            document.getElementById('syncData').addEventListener('click', syncData);
            document.getElementById('optimizeProtection').addEventListener('click', optimizeProtection);
            
            // Print preview modal
            document.getElementById('closePrintPreview').addEventListener('click', closePrintPreview);
            document.getElementById('exportAsPDF').addEventListener('click', () => exportPrintContent('pdf'));
            document.getElementById('exportAsImage').addEventListener('click', () => exportPrintContent('image'));
            
            // Add ambient light effect to cards on mouse move
            document.addEventListener('mousemove', function(e) {
                const cards = document.querySelectorAll('.floating-card');
                cards.forEach(card => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    card.style.setProperty('--mouse-x', `${x}px`);
                    card.style.setProperty('--mouse-y', `${y}px`);
                });
            });
        }
    </script>
<!-- Tambahkan kode ini di atas tombol left sidebar toggle yang sudah ada -->
<button id="openGamePanel" class="game-panel-toggle">
    <i class="fas fa-gamepad"></i>
</button>

<!-- Tambahkan kode ini di akhir body sebelum penutup tag body -->
<div id="gamePanel" class="game-panel">
    <div class="game-header">
        <h3><i class="fas fa-puzzle-piece"></i> Mini Games: Tebak Kata</h3>
        <button id="closeGamePanel" class="enhanced-btn btn-error compact-btn">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div class="game-content">
        <div class="game-info">
            <p>Tebak kata berdasarkan pertanyaan! Dapatkan bantuan <span id="hintCount">1-3</span> huruf acak!</p>
            <div class="difficulty-info">
                <span class="difficulty-tag">50% Esensi Cak Lontong</span>
            </div>
        </div>
        
        <div class="game-area">
            <div id="questionDisplay" class="question-display">
                <span class="placeholder">Pertanyaan akan muncul di sini</span>
            </div>
            
            <div id="wordDisplay" class="word-display">
                <span class="placeholder">Kata akan muncul di sini</span>
            </div>
            
            <div id="hintDisplay" class="hint-display">
                <p>Huruf bantuan: <span id="hintLetters">-</span></p>
            </div>
            
            <div class="game-controls">
                <input type="text" id="guessInput" class="enhanced-input compact-input" placeholder="Masukkan tebakan Anda...">
                <button id="submitGuess" class="enhanced-btn btn-primary compact-btn">
                    <i class="fas fa-paper-plane"></i> Tebak
                </button>
            </div>
            
            <div class="game-stats">
                <div class="stat-item">
                    <span class="stat-label">Percobaan:</span>
                    <span id="attemptCount" class="stat-value">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Skor:</span>
                    <span id="scoreCount" class="stat-value">0</span>
                </div>
            </div>
            
            <div id="gameMessage" class="game-message">
                <!-- Pesan game akan muncul di sini -->
            </div>
        </div>
        
        <div class="game-actions">
            <button id="newGame" class="enhanced-btn btn-success compact-btn">
                <i class="fas fa-plus-circle"></i> Game Baru
            </button>
            <button id="showHint" class="enhanced-btn btn-warning compact-btn">
                <i class="fas fa-lightbulb"></i> Bantuan Huruf
            </button>
        </div>
    </div>
</div>

<style>
    /* ==================== GAME PANEL STYLES ==================== */
    .game-panel-toggle {
        position: fixed;
        bottom: 40px;
        left: 8px;
        width: 28px;
        height: 28px;
        border-radius: 100%;
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        border: none;
        box-shadow: var(--ios-shadow);
        z-index: 1000;
        cursor: pointer;
        transition: var(--ios-transition);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }

    .game-panel-toggle:hover {
        transform: translateY(-5px) scale(1.1);
        box-shadow: 0 15px 40px rgba(245, 158, 11, 0.4);
    }

    .game-panel {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        background: var(--theme-card);
        border-radius: var(--radius-2xl);
        box-shadow: var(--ios-shadow);
        z-index: 10001;
        opacity: 0;
        visibility: hidden;
        transition: var(--ios-transition);
        overflow: hidden;
        border: 1px solid var(--theme-border);
    }

    .game-panel.active {
        opacity: 1;
        visibility: visible;
        transform: translate(-50%, -50%) scale(1);
    }

    .game-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }

    .game-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
    }

    .game-content {
        padding: 20px;
        overflow-y: auto;
        max-height: calc(80vh - 70px);
    }

    .game-info {
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--theme-border);
    }

    .game-info p {
        margin-bottom: 10px;
        color: var(--theme-text);
    }

    .difficulty-info {
        display: flex;
        justify-content: center;
    }

    .difficulty-tag {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .game-area {
        margin-bottom: 20px;
    }

    .question-display {
        background: rgba(59, 130, 246, 0.1);
        border-radius: var(--radius-lg);
        padding: 15px;
        margin-bottom: 15px;
        text-align: center;
        border: 1px solid rgba(59, 130, 246, 0.2);
        font-style: italic;
        color: var(--theme-text);
    }

    .word-display {
        background: var(--theme-bg);
        border: 2px solid var(--theme-border);
        border-radius: var(--radius-lg);
        padding: 20px;
        text-align: center;
        margin-bottom: 15px;
        min-height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .word-display .placeholder {
        color: var(--theme-text);
        opacity: 0.7;
    }

    .hint-display {
        background: rgba(16, 185, 129, 0.1);
        border-radius: var(--radius-lg);
        padding: 12px 15px;
        margin-bottom: 15px;
        text-align: center;
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .hint-display p {
        margin: 0;
        font-size: 14px;
        color: var(--theme-text);
    }

    #hintLetters {
        font-weight: 700;
        color: #10b981;
        letter-spacing: 3px;
    }

    .game-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }

    .game-controls input {
        flex: 1;
    }

    .game-stats {
        display: flex;
        justify-content: space-around;
        margin-bottom: 15px;
        padding: 10px;
        background: var(--theme-bg);
        border-radius: var(--radius-lg);
    }

    .stat-item {
        text-align: center;
    }

    .stat-label {
        display: block;
        font-size: 12px;
        color: var(--theme-text);
        opacity: 0.7;
    }

    .stat-value {
        display: block;
        font-size: 18px;
        font-weight: 700;
        color: var(--theme-primary);
    }

    .game-message {
        padding: 10px 15px;
        border-radius: var(--radius-lg);
        text-align: center;
        font-weight: 600;
        min-height: 20px;
    }

    .game-message.success {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .game-message.error {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .game-message.info {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
        border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .game-actions {
        display: flex;
        gap: 10px;
    }

    .game-actions button {
        flex: 1;
    }

    /* Responsive adjustments */
    @media (max-width: 480px) {
        .game-panel {
            width: 95%;
        }
        
        .game-controls {
            flex-direction: column;
        }
        
        .game-stats {
            flex-direction: column;
            gap: 10px;
        }
    }
</style>

<script>
    // ==================== GAME LOGIC ====================
    const GAME_STATE = {
        currentWord: '',
        currentQuestion: '',
        revealedLetters: [],
        attempts: 0,
        score: 0,
        isGameActive: false
    };

    // Daftar kata dengan pertanyaan ala Cak Lontong (50% esensi teka-teki sulit)
    const WORD_LIST = [
        { 
            word: "KOMPUTER", 
            question: "Alat ini bisa berpikir tapi tidak punya otak, bisa menghitung tapi tidak bisa berhitung. Apa itu?" 
        },
        { 
            word: "PENDIDIKAN", 
            question: "Proses ini membuat orang bijak, tapi kadang membuat kantong tipis. Apa namanya?" 
        },
        { 
            word: "KREATIVITAS", 
            question: "Kemampuan membuat sesuatu dari yang tidak ada menjadi ada, seperti tukang sulap. Disebut apa?" 
        },
        { 
            word: "INOVASI", 
            question: "Perubahan yang membuat hal biasa jadi luar biasa, seperti telur jadi ayam. Apa istilahnya?" 
        },
        { 
            word: "LITERASI", 
            question: "Kemampuan ini membuat orang tidak mudah ditipu, tapi kadang malas mempelajarinya. Apa itu?" 
        },
        { 
            word: "KURIKULUM", 
            question: "Dokumen ini tebalnya seperti novel, tapi isinya bikin pusing tujuh keliling. Apa namanya?" 
        },
        { 
            word: "EVALUASI", 
            question: "Kegiatan ini bikin deg-degan, tapi hasilnya menentukan nasib. Disebut apa?" 
        },
        { 
            word: "MOTIVASI", 
            question: "Daya dorong ini seperti bensin untuk mobil, tanpa ini kita diam di tempat. Apa itu?" 
        },
        { 
            word: "KOMPETENSI", 
            question: "Kemampuan yang membuat seseorang dihargai, seperti pisau yang tajam. Disebut apa?" 
        },
        { 
            word: "APRESIASI", 
            question: "Ucapan ini lebih berharga dari uang, tapi sering dilupakan. Apa namanya?" 
        },
        { 
            word: "INSPIRASI", 
            question: "Datangnya tak diundang, perginya tak diketahui, tapi bisa ubah segalanya. Apa itu?" 
        },
        { 
            word: "PRODUKTIF", 
            question: "Keadaan di waktu yang sama bisa hasilkan banyak, seperti pohon yang berbuah lebat. Disebut apa?" 
        },
        { 
            word: "EFISIENSI", 
            question: "Prinsip kerja sedikit dapat banyak, seperti semut yang rajin. Apa istilahnya?" 
        },
        { 
            word: "STRATEGI", 
            question: "Rencana ini seperti peta harta karun, tanpa ini kita tersesat. Apa namanya?" 
        },
        { 
            word: "KOLABORASI", 
            question: "Kerja sama yang hasilnya 1+1=3, seperti ganda campuran bulutangkis. Disebut apa?" 
        },
        { 
            word: "KONSISTEN", 
            question: "Sikap ini seperti matahari terbit, selalu sama setiap pagi. Apa istilahnya?" 
        },
        { 
            word: "ADAPTASI", 
            question: "Kemampuan berubah seperti bunglon, supaya bisa bertahan hidup. Disebut apa?" 
        },
        { 
            word: "REVOLUSI", 
            question: "Perubahan besar yang seperti gempa bumi, mengguncang segalanya. Apa namanya?" 
        },
        { 
            word: "TRANSFORMASI", 
            question: "Proses berubah total, seperti ulat jadi kupu-kupu. Disebut apa?" 
        },
        { 
            word: "OPTIMALISASI", 
            question: "Membuat sesuatu jadi paling bagus, seperti menyetel radio sampai frekuensi tepat. Apa istilahnya?" 
        },
        { 
            word: "IMPLEMENTASI", 
            question: "Menerapkan rencana jadi kenyataan, seperti memasak dari resep. Disebut apa?" 
        },
        { 
            word: "AKSELERASI", 
            question: "Mempercepat proses, seperti pedal gas di mobil. Apa namanya?" 
        },
        { 
            word: "REGENERASI", 
            question: "Proses pergantian generasi, seperti batang padi yang tumbuh baru. Disebut apa?" 
        },
        { 
            word: "MODERNISASI", 
            question: "Proses menuju zaman now, yang bikin yang jadul ditinggalkan. Apa istilahnya?" 
        },
        { 
            word: "HARMONISASI", 
            question: "Menyelaraskan perbedaan, seperti orkestra yang indah. Disebut apa?" 
        }
    ];

    // Inisialisasi game
    document.addEventListener('DOMContentLoaded', function() {
        setupGameEventListeners();
    });

    function setupGameEventListeners() {
        // Toggle game panel
        document.getElementById('openGamePanel').addEventListener('click', openGamePanel);
        document.getElementById('closeGamePanel').addEventListener('click', closeGamePanel);
        
        // Game controls
        document.getElementById('newGame').addEventListener('click', startNewGame);
        document.getElementById('showHint').addEventListener('click', showRandomHint);
        document.getElementById('submitGuess').addEventListener('click', submitGuess);
        
        // Allow pressing Enter to submit guess
        document.getElementById('guessInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitGuess();
            }
        });
    }

    function openGamePanel() {
        document.getElementById('gamePanel').classList.add('active');
        if (!GAME_STATE.isGameActive) {
            startNewGame();
        }
    }

    function closeGamePanel() {
        document.getElementById('gamePanel').classList.remove('active');
    }

    function startNewGame() {
        // Reset game state
        GAME_STATE.attempts = 0;
        GAME_STATE.revealedLetters = [];
        GAME_STATE.isGameActive = true;
        
        // Pilih kata acak
        const randomIndex = Math.floor(Math.random() * WORD_LIST.length);
        const selectedWord = WORD_LIST[randomIndex];
        
        GAME_STATE.currentWord = selectedWord.word;
        GAME_STATE.currentQuestion = selectedWord.question;
        
        // Reset UI
        document.getElementById('questionDisplay').innerHTML = `<i class="fas fa-question-circle"></i> ${GAME_STATE.currentQuestion}`;
        document.getElementById('wordDisplay').innerHTML = '';
        document.getElementById('hintLetters').textContent = '-';
        document.getElementById('attemptCount').textContent = '0';
        document.getElementById('guessInput').value = '';
        clearGameMessage();
        
        // Tampilkan kata dengan garis bawah untuk setiap huruf
        displayWordWithPlaceholders();
        
        // Berikan 1-3 huruf bantuan secara acak
        showRandomHint();
    }

    function displayWordWithPlaceholders() {
        const wordDisplay = document.getElementById('wordDisplay');
        wordDisplay.innerHTML = '';
        
        for (let i = 0; i < GAME_STATE.currentWord.length; i++) {
            const letterSpan = document.createElement('span');
            letterSpan.className = 'letter';
            
            if (GAME_STATE.revealedLetters.includes(i)) {
                letterSpan.textContent = GAME_STATE.currentWord[i];
                letterSpan.style.color = '#10b981';
            } else {
                letterSpan.textContent = '_';
                letterSpan.style.color = '#6b7280';
            }
            
            letterSpan.style.margin = '0 5px';
            letterSpan.style.fontSize = '24px';
            letterSpan.style.fontWeight = '700';
            wordDisplay.appendChild(letterSpan);
        }
    }

    function showRandomHint() {
        if (!GAME_STATE.isGameActive) return;
        
        // Tentukan berapa banyak huruf yang akan ditampilkan (1-3)
        const hintCount = Math.floor(Math.random() * 3) + 1;
        
        // Dapatkan indeks huruf yang belum terungkap
        const hiddenIndices = [];
        for (let i = 0; i < GAME_STATE.currentWord.length; i++) {
            if (!GAME_STATE.revealedLetters.includes(i)) {
                hiddenIndices.push(i);
            }
        }
        
        // Jika semua huruf sudah terungkap, tidak perlu memberikan petunjuk
        if (hiddenIndices.length === 0) return;
        
        // Pilih indeks acak untuk diungkap
        const indicesToReveal = [];
        for (let i = 0; i < Math.min(hintCount, hiddenIndices.length); i++) {
            const randomIndex = Math.floor(Math.random() * hiddenIndices.length);
            indicesToReveal.push(hiddenIndices[randomIndex]);
            hiddenIndices.splice(randomIndex, 1);
        }
        
        // Tambahkan ke revealed letters
        GAME_STATE.revealedLetters.push(...indicesToReveal);
        
        // Perbarui tampilan
        displayWordWithPlaceholders();
        
        // Tampilkan huruf bantuan
        const hintLetters = indicesToReveal.map(index => GAME_STATE.currentWord[index]).join(', ');
        document.getElementById('hintLetters').textContent = hintLetters;
        
        showGameMessage(`Anda mendapatkan bantuan huruf: ${hintLetters}`, 'info');
        
        // Periksa apakah semua huruf sudah terungkap
        checkGameCompletion();
    }

    function submitGuess() {
        if (!GAME_STATE.isGameActive) return;
        
        const guessInput = document.getElementById('guessInput');
        const userGuess = guessInput.value.trim().toUpperCase();
        
        if (userGuess === '') {
            showGameMessage('Masukkan tebakan Anda!', 'error');
            return;
        }
        
        GAME_STATE.attempts++;
        document.getElementById('attemptCount').textContent = GAME_STATE.attempts;
        
        if (userGuess === GAME_STATE.currentWord) {
            // Tebakan benar
            GAME_STATE.score += 10;
            document.getElementById('scoreCount').textContent = GAME_STATE.score;
            
            // Tampilkan semua huruf
            for (let i = 0; i < GAME_STATE.currentWord.length; i++) {
                if (!GAME_STATE.revealedLetters.includes(i)) {
                    GAME_STATE.revealedLetters.push(i);
                }
            }
            
            displayWordWithPlaceholders();
            showGameMessage('Selamat! Tebakan Anda benar! ðŸŽ‰', 'success');
            GAME_STATE.isGameActive = false;
        } else {
            // Tebakan salah
            showGameMessage('Tebakan salah, coba lagi!', 'error');
            guessInput.value = '';
            guessInput.focus();
        }
    }

    function checkGameCompletion() {
        if (GAME_STATE.revealedLetters.length === GAME_STATE.currentWord.length) {
            // Semua huruf sudah terungkap
            showGameMessage('Selamat! Anda berhasil mengungkap semua huruf! ðŸŽ‰', 'success');
            GAME_STATE.score += 5;
            document.getElementById('scoreCount').textContent = GAME_STATE.score;
            GAME_STATE.isGameActive = false;
        }
    }

    function showGameMessage(message, type) {
        const messageElement = document.getElementById('gameMessage');
        messageElement.textContent = message;
        messageElement.className = 'game-message ' + type;
    }

    function clearGameMessage() {
        const messageElement = document.getElementById('gameMessage');
        messageElement.textContent = '';
        messageElement.className = 'game-message';
    }
</script>
<!-- ==================== STORAGE MANAGEMENT PANEL DENGAN MONGODB INTEGRATION ==================== -->
<button id="openStoragePanel" class="storage-panel-toggle">
    <i class="fas fa-database"></i>
</button>

<div id="storagePanel" class="storage-panel">
    <div class="storage-header">
        <h3><i class="fas fa-database"></i> Manajemen Penyimpanan</h3>
        <button id="closeStoragePanel" class="enhanced-btn btn-error compact-btn">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div class="storage-content">
        <div class="storage-info">
            <p>MongoDB Cloud Protection: Data Anda diamankan dengan database cloud modern</p>
            <div class="status-info">
                <span id="storageStatus" class="status-tag">Status: -</span>
                <span id="cloudStatus" class="status-cloud">Database: MongoDB Atlas</span>
            </div>
        </div>
        
        <div class="security-notice">
            <div class="security-badge">
                <i class="fas fa-shield-alt"></i>
                <span>MongoDB Cloud Protection Active</span>
            </div>
            <p class="security-desc">Data di-backup secara real-time ke MongoDB Atlas Cloud untuk keamanan maksimal</p>
        </div>
        
        <div class="storage-dashboard">
            <!-- Storage Usage Overview -->
            <div class="storage-overview">
                <h4>Penggunaan Penyimpanan</h4>
                <div class="usage-meter">
                    <div class="meter-background">
                        <div class="meter-fill" id="storageMeterFill"></div>
                    </div>
                    <div class="usage-stats">
                        <span id="storageUsageText">0 KB / 5 MB digunakan</span>
                        <span id="storagePercentage">0%</span>
                    </div>
                </div>
                
                <div class="usage-breakdown">
                    <div class="breakdown-item">
                        <span class="breakdown-label">Data Keuangan</span>
                        <span class="breakdown-value" id="financeDataSize">0 KB</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Pengaturan</span>
                        <span class="breakdown-value" id="configDataSize">0 KB</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Backup</span>
                        <span class="breakdown-value" id="backupDataSize">0 KB</span>
                    </div>
                    <div class="breakdown-item">
                        <span class="breakdown-label">Cache</span>
                        <span class="breakdown-value" id="cacheDataSize">0 KB</span>
                    </div>
                </div>
            </div>
            
            <!-- MongoDB Cloud Storage Section -->
            <div class="cloud-storage">
                <h4><i class="fas fa-cloud-shield-alt"></i> MongoDB Cloud Protection</h4>
                
                <div class="mongodb-connection">
                    <div class="connection-status">
                        <div class="status-indicator">
                            <span class="status-dot" id="mongoStatus"></span>
                            <span id="mongoStatusText">Menghubungkan ke MongoDB...</span>
                        </div>
                        <div class="connection-info">
                            <small>Cluster: Cluster0 | Database: stl_financial</small>
                        </div>
                    </div>
                    
                    <!-- Password Input untuk Backup -->
                    <div class="password-section">
                        <label>Password Backup:</label>
                        <input type="password" id="mongoBackupPassword" 
                               class="enhanced-input compact-input" 
                               placeholder="Masukkan password backup"
                               value="b4ckupmyd4t4">
                        <small class="password-hint">Password default: b4ckupmyd4t4</small>
                    </div>
                </div>
                
                <div class="cloud-controls">
                    <button id="backupToMongoDB" class="enhanced-btn btn-primary compact-btn">
                        <i class="fas fa-database"></i> Backup ke MongoDB
                    </button>
                    <button id="restoreFromMongoDB" class="enhanced-btn btn-success compact-btn">
                        <i class="fas fa-download"></i> Restore dari MongoDB
                    </button>
                    <button id="syncToMongoDB" class="enhanced-btn btn-warning compact-btn">
                        <i class="fas fa-sync"></i> Sync ke MongoDB
                    </button>
                </div>
                
                <div class="sync-status">
                    <div class="status-item">
                        <i class="fas fa-sync-alt"></i>
                        <span>Last Sync: <span id="lastSyncTime">Belum pernah</span></span>
                    </div>
                    <div class="status-item">
                        <i class="fas fa-shield-check"></i>
                        <span>Security: <span id="securityLevel">MongoDB Encryption Active</span></span>
                    </div>
                </div>
            </div>
            
            <!-- Quick Actions dengan Integrasi Sidebar -->
            <div class="quick-actions">
                <h4>Aksi Cepat (Terintegrasi Sidebar)</h4>
                <div class="actions-grid" id="quickActions">
                    <div class="action-item" data-action="starSync">
                        <i class="fas fa-star"></i>
                        <span>Sync Bintang</span>
                    </div>
                    <div class="action-item" data-action="sidebarBackup">
                        <i class="fas fa-shield-alt"></i>
                        <span>Backup Brangkas</span>
                    </div>
                    <div class="action-item" data-action="importantHistory">
                        <i class="fas fa-history"></i>
                        <span>Riwayat Penting</span>
                    </div>
                    <div class="action-item" data-action="mongoBackup">
                        <i class="fas fa-database"></i>
                        <span>MongoDB</span>
                    </div>
                </div>
            </div>
            
            <!-- Data Management dengan Enhanced Features -->
            <div class="data-management">
                <h4>Manajemen Data & Riwayat Penting</h4>
                <div class="management-actions">
                    <button id="syncStarred" class="enhanced-btn btn-primary compact-btn">
                        <i class="fas fa-star"></i> Sync Transaksi Penting
                    </button>
                    <button id="deepScan" class="enhanced-btn btn-info compact-btn">
                        <i class="fas fa-search-plus"></i> Deep Scan Data
                    </button>
                    <button id="exportEncrypted" class="enhanced-btn btn-success compact-btn">
                        <i class="fas fa-file-export"></i> Export Encrypted
                    </button>
                </div>
                
                <!-- Important Transactions List -->
                <div class="important-section">
                    <h5>Transaksi Penting (Auto-Sync ke Cloud)</h5>
                    <div class="important-list" id="importantCloudList">
                        <!-- Daftar transaksi penting akan diisi di sini -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="storage-actions">
            <button id="fullProtection" class="enhanced-btn btn-primary compact-btn">
                <i class="fas fa-shield-alt"></i> Aktifkan Full Protection
            </button>
            <button id="emergencyBackup" class="enhanced-btn btn-error compact-btn">
                <i class="fas fa-exclamation-triangle"></i> Emergency Backup
            </button>
        </div>
    </div>
</div>

<style>
    /* ==================== STORAGE PANEL STYLES DENGAN MONGODB ==================== */
    .storage-panel-toggle {
        position: fixed;
        bottom: 10px;
        right: 20px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--gradient-primary);
        color: white;
        border: none;
        box-shadow: var(--ios-shadow);
        z-index: 1000;
        cursor: pointer;
        transition: var(--ios-transition);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .storage-panel-toggle:hover {
        transform: translateY(-5px) scale(1.1);
        box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
    }

    .storage-panel {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        width: 95%;
        max-width: 900px;
        max-height: 90vh;
        background: var(--theme-card);
        border-radius: var(--radius-2xl);
        box-shadow: var(--ios-shadow);
        z-index: 10001;
        opacity: 0;
        visibility: hidden;
        transition: var(--ios-transition);
        overflow: hidden;
        border: 1px solid var(--theme-border);
    }

    .storage-panel.active {
        opacity: 1;
        visibility: visible;
        transform: translate(-50%, -50%) scale(1);
    }

    .storage-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .storage-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
    }

    .storage-content {
        padding: 20px;
        overflow-y: auto;
        max-height: calc(90vh - 70px);
    }

    .storage-info {
        text-align: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--theme-border);
    }

    .storage-info p {
        margin-bottom: 10px;
        color: var(--theme-text);
        font-weight: 600;
    }

    .status-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .status-tag {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .status-cloud {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    /* Security Notice */
    .security-notice {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1));
        border: 1px solid rgba(16, 185, 129, 0.2);
        border-radius: var(--radius-lg);
        padding: 15px;
        margin-bottom: 20px;
        text-align: center;
    }

    .security-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 14px;
        margin-bottom: 10px;
    }

    .security-desc {
        font-size: 13px;
        color: var(--theme-text);
        margin: 0;
        opacity: 0.9;
    }

    /* MongoDB Connection Section */
    .mongodb-connection {
        background: var(--theme-bg);
        border-radius: var(--radius-lg);
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid rgba(16, 185, 129, 0.1);
    }

    .connection-status {
        margin-bottom: 15px;
    }

    .status-indicator {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 5px;
    }

    .connection-info {
        font-size: 12px;
        color: var(--theme-text);
        opacity: 0.7;
    }

    .password-section {
        margin-top: 15px;
    }

    .password-section label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: var(--theme-text);
    }

    .password-hint {
        display: block;
        margin-top: 5px;
        font-size: 11px;
        color: #6b7280;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #6b7280;
    }

    .status-dot.connected {
        background: #10b981;
        animation: pulse 2s infinite;
    }

    .status-dot.error {
        background: #ef4444;
    }

    .cloud-controls {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
    }

    .sync-status {
        display: flex;
        justify-content: space-between;
        padding: 12px;
        background: rgba(16, 185, 129, 0.05);
        border-radius: var(--radius-lg);
        border: 1px solid rgba(16, 185, 129, 0.1);
    }

    .status-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: var(--theme-text);
    }

    /* Important Section */
    .important-section {
        margin-top: 15px;
    }

    .important-section h5 {
        margin-bottom: 10px;
        color: var(--theme-text);
        font-size: 14px;
    }

    .important-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--theme-border);
        border-radius: var(--radius-lg);
        padding: 10px;
        background: var(--theme-bg);
    }

    .important-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--theme-border);
    }

    .important-item:last-child {
        border-bottom: none;
    }

    .important-desc {
        font-size: 12px;
        color: var(--theme-text);
    }

    .important-amount {
        font-size: 12px;
        font-weight: 700;
    }

    .important-amount.income {
        color: #10b981;
    }

    .important-amount.expense {
        color: #ef4444;
    }

    /* Enhanced Quick Actions */
    .quick-actions .action-item {
        position: relative;
    }

    .quick-actions .action-item::after {
        content: '';
        position: absolute;
        top: 5px;
        right: 5px;
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: #10b981;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .quick-actions .action-item.synced::after {
        opacity: 1;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .cloud-controls {
            grid-template-columns: 1fr;
        }
        
        .sync-status {
            flex-direction: column;
            gap: 10px;
        }
    }

    @media (max-width: 480px) {
        .storage-panel {
            width: 98%;
        }
        
        .storage-content {
            padding: 15px;
        }
    }
</style>

<script>
// ==================== MONGODB STORAGE MANAGEMENT ====================
const MONGODB_STORAGE_MANAGER = {
    // Konfigurasi MongoDB
    config: {
        maxLocalSize: 5 * 1024 * 1024, // 5MB local
        mongoURI: "mongodb+srv://najibwahidussalam938_db_user:your_password@cluster0.aadsm5v.mongodb.net/stl_financial?retryWrites=true&w=majority&appName=Cluster0",
        databaseName: "stl_financial",
        collectionName: "financial_backups",
        autoStarSync: true,
        encryptionEnabled: true,
        lastBackup: null
    },

    // State Management
    state: {
        isConnected: false,
        mongoClient: null,
        lastSync: null,
        starredTransactions: [],
        importantHistory: []
    },

    // Inisialisasi Sistem MongoDB
    async init() {
        console.log('[MONGODB-STORAGE] Initializing MongoDB system...');
        
        this.loadConfig();
        await this.initializeMongoDB();
        this.setupEventListeners();
        this.setupSidebarIntegration();
        this.updateStorageInfo();
        this.loadImportantHistory();
        
        console.log('[MONGODB-STORAGE] System initialized successfully');
    },

    // Setup Integrasi dengan Sidebar yang sudah ada
    setupSidebarIntegration() {
        // Integrasi dengan tombol backup di sidebar kiri
        const originalBackup = window.backupCloud;
        window.backupCloud = () => {
            this.backupToMongoDB();
        };

        // Integrasi dengan tombol restore di sidebar kiri
        const originalRestore = window.restoreData;
        window.restoreCloud = () => {
            this.restoreFromMongoDB();
        };

        // Auto-sync ketika transaksi ditandai bintang
        this.setupStarSync();

        console.log('[SIDEBAR] MongoDB integration completed');
    },

    // Setup auto-sync untuk transaksi berbintang
    setupStarSync() {
        // Override fungsi addToImportantHistory yang sudah ada
        const originalAddToImportant = window.addToImportantHistory;
        window.addToImportantHistory = (transactionId) => {
            if (originalAddToImportant) {
                originalAddToImportant(transactionId);
            }
            this.syncStarredTransaction(transactionId);
        };

        // Listen untuk klik tombol bintang
        document.addEventListener('click', (e) => {
            if (e.target.closest('.star-transaction')) {
                const transactionId = e.target.closest('.star-transaction').getAttribute('data-id');
                setTimeout(() => this.syncStarredTransaction(parseInt(transactionId)), 100);
            }
        });
    },

    // Sync transaksi berbintang ke MongoDB
    async syncStarredTransaction(transactionId) {
        if (!this.config.autoStarSync) return;

        const transaction = FINANCIAL_STATE.transactions.find(t => t.id === transactionId);
        if (!transaction) return;

        // Tambah ke daftar starred
        if (!this.state.starredTransactions.find(t => t.id === transactionId)) {
            this.state.starredTransactions.push({
                ...transaction,
                starredAt: new Date().toISOString(),
                syncedToCloud: false
            });
        }

        // Sync ke MongoDB
        await this.syncImportantToMongoDB();
        this.updateImportantCloudList();
        
        this.updateDynamicIsland('â­ Transaksi penting disinkronisasi ke MongoDB', 2000);
    },

    // Inisialisasi Koneksi MongoDB
    async initializeMongoDB() {
        try {
            // Update status connection
            this.updateMongoDBStatus('Menghubungkan ke MongoDB Atlas...', 'connecting');
            
            // Simulasi koneksi MongoDB (dalam implementasi real, gunakan MongoDB driver)
            // Untuk frontend, kita akan menggunakan API endpoint sebagai perantara
            setTimeout(() => {
                this.state.isConnected = true;
                this.updateMongoDBStatus('Terhubung ke MongoDB Atlas', 'connected');
                this.updateDynamicIsland('âœ… Terhubung ke MongoDB Cloud', 2000);
            }, 2000);

        } catch (error) {
            console.error('[MONGODB] Connection error:', error);
            this.updateMongoDBStatus('Gagal terhubung ke MongoDB', 'error');
        }
    },

    // Setup Event Listeners
    setupEventListeners() {
        // Panel toggle
        document.getElementById('openStoragePanel').addEventListener('click', this.openPanel.bind(this));
        document.getElementById('closeStoragePanel').addEventListener('click', this.closePanel.bind(this));
        
        // MongoDB actions
        document.getElementById('backupToMongoDB').addEventListener('click', this.backupToMongoDB.bind(this));
        document.getElementById('restoreFromMongoDB').addEventListener('click', this.restoreFromMongoDB.bind(this));
        document.getElementById('syncToMongoDB').addEventListener('click', this.syncToMongoDB.bind(this));
        
        // Quick actions dengan integrasi sidebar
        document.querySelectorAll('.action-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const action = e.currentTarget.getAttribute('data-action');
                this.handleIntegratedAction(action);
            });
        });

        // Enhanced actions
        document.getElementById('syncStarred').addEventListener('click', this.syncAllStarred.bind(this));
        document.getElementById('deepScan').addEventListener('click', this.deepScanData.bind(this));
        document.getElementById('exportEncrypted').addEventListener('click', this.exportEncryptedData.bind(this));
        document.getElementById('fullProtection').addEventListener('click', this.enableFullProtection.bind(this));
        document.getElementById('emergencyBackup').addEventListener('click', this.emergencyBackup.bind(this));
    },

    // Handle integrated actions dengan sidebar
    handleIntegratedAction(action) {
        switch(action) {
            case 'starSync':
                this.syncAllStarred();
                break;
            case 'sidebarBackup':
                // Trigger backup dari sidebar
                if (window.backupCloud) window.backupCloud();
                break;
            case 'importantHistory':
                this.showImportantHistory();
                break;
            case 'mongoBackup':
                this.backupToMongoDB();
                break;
        }
    },

    // Backup ke MongoDB dengan password protection
    async backupToMongoDB() {
        const password = document.getElementById('mongoBackupPassword').value;
        if (password !== 'b4ckupmyd4t4') {
            this.updateDynamicIsland('âŒ Password backup salah', 2000);
            return;
        }

        if (!this.state.isConnected) {
            this.updateDynamicIsland('âŒ Tidak terhubung ke MongoDB', 2000);
            return;
        }

        this.updateDynamicIsland('ðŸ”„ Memulai backup ke MongoDB...', 3000);

        try {
            const backupData = this.prepareBackupData();
            const encryptedData = this.encryptData(backupData);
            
            // Simulasi backup ke MongoDB
            const success = await this.simulateMongoDBBackup(encryptedData);

            if (success) {
                this.state.lastSync = new Date().toISOString();
                this.config.lastBackup = new Date().toISOString();
                this.updateMongoDBStatus();
                
                this.updateDynamicIsland('âœ… Backup ke MongoDB berhasil', 4000);
            } else {
                this.updateDynamicIsland('âŒ Backup ke MongoDB gagal', 3000);
            }

        } catch (error) {
            console.error('[MONGODB-BACKUP] Error:', error);
            this.updateDynamicIsland('âŒ Error selama backup ke MongoDB', 3000);
        }
    },

    // Siapkan data untuk backup
    prepareBackupData() {
        const allData = {};
        const stlKeys = Object.keys(localStorage).filter(key => key.startsWith('stl_'));
        
        stlKeys.forEach(key => {
            allData[key] = localStorage.getItem(key);
        });

        // Tambahkan metadata penting
        allData.metadata = {
            timestamp: new Date().toISOString(),
            version: '3.0',
            mongoBackup: true,
            starredCount: this.state.starredTransactions.length,
            importantCount: this.state.importantHistory.length,
            totalTransactions: FINANCIAL_STATE.transactions.length,
            totalBalance: FINANCIAL_STATE.currentBalance,
            checksum: this.generateChecksum(JSON.stringify(allData))
        };

        return allData;
    },

    // Simulasi backup ke MongoDB (dalam real implementation, gunakan MongoDB driver)
    async simulateMongoDBBackup(data) {
        return new Promise((resolve) => {
            setTimeout(() => {
                // Simpan ke localStorage sebagai simulasi
                const backupKey = `stl_mongodb_backup_${new Date().getTime()}`;
                localStorage.setItem(backupKey, JSON.stringify({
                    data: data,
                    timestamp: new Date().toISOString(),
                    source: 'mongodb_simulation'
                }));
                
                // Simpan info backup terakhir
                localStorage.setItem('stl_last_mongodb_backup', new Date().toISOString());
                
                console.log('[MONGODB-BACKUP] Backup simulation completed');
                resolve(true);
            }, 2000);
        });
    },

    // Sync important data ke MongoDB
    async syncImportantToMongoDB() {
        const importantData = {
            starredTransactions: this.state.starredTransactions,
            importantHistory: this.state.importantHistory,
            lastUpdated: new Date().toISOString()
        };

        try {
            // Simulasi sync ke MongoDB
            const syncKey = `stl_mongodb_sync_${new Date().getTime()}`;
            localStorage.setItem(syncKey, JSON.stringify(importantData));
            
            console.log('[MONGODB-SYNC] Important data synced to MongoDB simulation');
        } catch (error) {
            console.error('[MONGODB-SYNC] Error:', error);
        }
    },

    // Restore dari MongoDB
    async restoreFromMongoDB() {
        const password = document.getElementById('mongoBackupPassword').value;
        if (password !== 'b4ckupmyd4t4') {
            this.updateDynamicIsland('âŒ Password restore salah', 2000);
            return;
        }

        if (!this.state.isConnected) {
            this.updateDynamicIsland('âŒ Tidak terhubung ke MongoDB', 2000);
            return;
        }

        try {
            this.updateDynamicIsland('ðŸ”„ Memulihkan dari MongoDB...', 3000);

            // Simulasi restore dari MongoDB
            const backupData = await this.simulateMongoDBRestore();
            
            if (backupData) {
                const decryptedData = this.decryptData(backupData);
                this.restoreData(decryptedData);
                this.updateDynamicIsland('âœ… Data berhasil dipulihkan dari MongoDB', 3000);
            } else {
                this.updateDynamicIsland('âŒ Tidak ada backup ditemukan di MongoDB', 3000);
            }

        } catch (error) {
            console.error('[MONGODB-RESTORE] Error:', error);
            this.updateDynamicIsland('âŒ Gagal memulihkan dari MongoDB', 3000);
        }
    },

    // Simulasi restore dari MongoDB
    async simulateMongoDBRestore() {
        return new Promise((resolve) => {
            setTimeout(() => {
                // Cari backup terbaru dari localStorage
                const backupKeys = Object.keys(localStorage)
                    .filter(key => key.startsWith('stl_mongodb_backup_'))
                    .sort()
                    .reverse();
                
                if (backupKeys.length > 0) {
                    const latestBackup = localStorage.getItem(backupKeys[0]);
                    const backupData = JSON.parse(latestBackup);
                    resolve(backupData.data);
                } else {
                    resolve(null);
                }
            }, 1500);
        });
    },

    // Sync data ke MongoDB
    async syncToMongoDB() {
        const password = document.getElementById('mongoBackupPassword').value;
        if (password !== 'b4ckupmyd4t4') {
            this.updateDynamicIsland('âŒ Password sync salah', 2000);
            return;
        }

        this.updateDynamicIsland('ðŸ”„ Menyinkronisasi data ke MongoDB...', 3000);
        
        try {
            await this.backupToMongoDB();
            await this.syncImportantToMongoDB();
            this.updateDynamicIsland('âœ… Semua data tersinkronisasi dengan MongoDB', 2000);
        } catch (error) {
            console.error('[MONGODB-SYNC] Error:', error);
            this.updateDynamicIsland('âŒ Gagal sync ke MongoDB', 2000);
        }
    },

    // Restore data ke localStorage
    restoreData(data) {
        // Hapus data lama
        const stlKeys = Object.keys(localStorage).filter(key => key.startsWith('stl_'));
        stlKeys.forEach(key => localStorage.removeItem(key));

        // Restore data baru
        Object.keys(data).forEach(key => {
            if (key !== 'metadata') {
                localStorage.setItem(key, data[key]);
            }
        });

        this.updateStorageInfo();
        
        // Refresh aplikasi
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    },

    // Deep Scan Data
    async deepScanData() {
        this.updateDynamicIsland('ðŸ” Memindai data secara mendalam...', 3000);
        
        // Scan localStorage
        const scanResults = {
            totalItems: 0,
            totalSize: 0,
            corrupted: 0,
            sensitiveData: [],
            recommendations: []
        };

        const stlKeys = Object.keys(localStorage).filter(key => key.startsWith('stl_'));
        scanResults.totalItems = stlKeys.length;

        stlKeys.forEach(key => {
            const data = localStorage.getItem(key);
            scanResults.totalSize += data.length;

            // Cek data corrupted
            try {
                JSON.parse(data);
            } catch (e) {
                scanResults.corrupted++;
                scanResults.recommendations.push(`Data ${key} mungkin corrupted`);
            }

            // Cek data sensitif
            if (this.containsSensitiveData(data)) {
                scanResults.sensitiveData.push(key);
            }
        });

        // Tampilkan hasil scan
        this.showScanResults(scanResults);
    },

    // Encrypt data untuk keamanan
    encryptData(data) {
        if (!this.config.encryptionEnabled) return data;
        
        try {
            // Simple encryption - dalam production gunakan library encryption yang kuat
            const dataStr = JSON.stringify(data);
            return btoa(unescape(encodeURIComponent(dataStr)));
        } catch (error) {
            console.warn('[ENCRYPTION] Failed to encrypt, returning plain data');
            return data;
        }
    },

    // Decrypt data
    decryptData(encryptedData) {
        if (typeof encryptedData === 'string' && encryptedData.includes('{')) {
            return encryptedData; // Already decrypted
        }

        try {
            const decrypted = decodeURIComponent(escape(atob(encryptedData)));
            return JSON.parse(decrypted);
        } catch (error) {
            console.warn('[DECRYPTION] Failed to decrypt, returning original data');
            return encryptedData;
        }
    },

    // Update MongoDB Status UI
    updateMongoDBStatus(message = null, status = null) {
        const mongoStatus = document.getElementById('mongoStatus');
        const mongoStatusText = document.getElementById('mongoStatusText');
        
        if (status === 'connected') {
            mongoStatus.className = 'status-dot connected';
            mongoStatusText.textContent = message || 'Terhubung ke MongoDB Atlas';
        } else if (status === 'error') {
            mongoStatus.className = 'status-dot error';
            mongoStatusText.textContent = message || 'Terputus dari MongoDB';
        } else if (status === 'connecting') {
            mongoStatus.className = 'status-dot';
            mongoStatusText.textContent = message || 'Menghubungkan...';
        } else {
            // Auto-detect based on state
            if (this.state.isConnected) {
                mongoStatus.className = 'status-dot connected';
                mongoStatusText.textContent = 'Terhubung ke MongoDB Atlas';
            } else {
                mongoStatus.className = 'status-dot error';
                mongoStatusText.textContent = 'Terputus dari MongoDB';
            }
        }

        // Update last sync time
        const lastSyncElement = document.getElementById('lastSyncTime');
        if (this.state.lastSync) {
            lastSyncElement.textContent = new Date(this.state.lastSync).toLocaleString('id-ID');
        } else {
            lastSyncElement.textContent = 'Belum pernah';
        }
    },

    // Load Important History dari localStorage
    loadImportantHistory() {
        try {
            const savedHistory = localStorage.getItem('stl_important_history');
            if (savedHistory) {
                this.state.importantHistory = JSON.parse(savedHistory);
            }
            this.updateImportantCloudList();
        } catch (error) {
            console.warn('[IMPORTANT-HISTORY] Failed to load important history');
        }
    },

    // Update Important Cloud List
    updateImportantCloudList() {
        const container = document.getElementById('importantCloudList');
        const importantItems = [...this.state.starredTransactions, ...this.state.importantHistory.slice(0, 5)];
        
        if (importantItems.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 py-4">Belum ada transaksi penting</div>';
            return;
        }

        container.innerHTML = importantItems.map(item => `
            <div class="important-item">
                <div class="important-desc">${item.description || 'Transaksi penting'}</div>
                <div class="important-amount ${item.type === 'debit' ? 'income' : 'expense'}">
                    ${item.type === 'debit' ? '+' : '-'} Rp ${this.formatCurrency(item.amount || 0)}
                </div>
            </div>
        `).join('');
    },

    // Enhanced Functions
    async syncAllStarred() {
        this.updateDynamicIsland('â­ Menyinkronisasi semua transaksi penting...', 3000);
        await this.syncImportantToMongoDB();
        this.updateImportantCloudList();
        this.updateDynamicIsland('âœ… Semua transaksi penting tersinkronisasi', 2000);
    },

    async enableFullProtection() {
        this.config.autoStarSync = true;
        this.config.encryptionEnabled = true;
        
        await this.syncToMongoDB();
        this.updateDynamicIsland('ðŸ›¡ï¸ Full Protection Diaktifkan', 3000);
    },

    async emergencyBackup() {
        this.updateDynamicIsland('ðŸš¨ Memulai emergency backup...', 3000);
        // Force backup tanpa pengecekan connection
        await this.backupToMongoDB();
    },

    exportEncryptedData() {
        const data = this.prepareBackupData();
        const encrypted = this.encryptData(data);
        const blob = new Blob([encrypted], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `stl-mongodb-backup-${new Date().toISOString().split('T')[0]}.enc`;
        a.click();
        URL.revokeObjectURL(url);
        
        this.updateDynamicIsland('ðŸ” Data terenkripsi diexport', 2000);
    },

    showImportantHistory() {
        // Trigger show important history dari sidebar kiri
        if (window.toggleLeftSidebar) {
            window.toggleLeftSidebar();
            setTimeout(() => {
                const importantSection = document.querySelector('.enhanced-card:nth-child(3)');
                if (importantSection) {
                    importantSection.scrollIntoView({ behavior: 'smooth' });
                }
            }, 500);
        }
    },

    showScanResults(results) {
        const resultText = `
Total Items: ${results.totalItems}
Total Size: ${this.formatSize(results.totalSize)}
Data Corrupted: ${results.corrupted}
Data Sensitif: ${results.sensitiveData.length}

Rekomendasi:
${results.recommendations.join('\n') || 'Tidak ada masalah ditemukan'}
        `.trim();

        alert(`Hasil Deep Scan:\n\n${resultText}`);
    },

    // Utility Functions
    formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / 1048576).toFixed(1) + ' MB';
    },

    formatCurrency(amount) {
        return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    },

    generateChecksum(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return hash;
    },

    containsSensitiveData(data) {
        const sensitivePatterns = [
            'password', 'token', 'secret', 'key', 'auth',
            'username', 'email', 'phone', 'address'
        ];
        const dataStr = JSON.stringify(data).toLowerCase();
        return sensitivePatterns.some(pattern => dataStr.includes(pattern));
    },

    updateDynamicIsland(message, duration = 3000) {
        if (typeof window.updateDynamicIsland === 'function') {
            window.updateDynamicIsland(message, duration);
        } else {
            console.log('Dynamic Island:', message);
        }
    },

    // Panel Controls
    openPanel() {
        document.getElementById('storagePanel').classList.add('active');
        this.updateStorageInfo();
        this.updateMongoDBStatus();
        this.updateImportantCloudList();
    },

    closePanel() {
        document.getElementById('storagePanel').classList.remove('active');
    },

    // Load config
    loadConfig() {
        const savedConfig = localStorage.getItem('stl_mongodb_storage_config');
        if (savedConfig) {
            try {
                this.config = { ...this.config, ...JSON.parse(savedConfig) };
            } catch (e) {
                console.warn('Failed to load MongoDB storage config');
            }
        }
    },

    // Update storage info
    updateStorageInfo() {
        this.calculateStorageUsage();
        this.updateUI();
    },

    calculateStorageUsage() {
        let totalSize = 0;
        const stlKeys = Object.keys(localStorage).filter(key => key.startsWith('stl_'));
        
        stlKeys.forEach(key => {
            totalSize += localStorage[key].length;
        });

        this.state.totalSize = totalSize;
    },

    updateUI() {
        const usagePercent = this.state.totalSize / this.config.maxLocalSize;
        const usageText = `${this.formatSize(this.state.totalSize)} / ${this.formatSize(this.config.maxLocalSize)} digunakan`;
        
        const meterFill = document.getElementById('storageMeterFill');
        if (meterFill) {
            meterFill.style.width = `${Math.min(usagePercent * 100, 100)}%`;
        }
        
        const usageTextElement = document.getElementById('storageUsageText');
        if (usageTextElement) {
            usageTextElement.textContent = usageText;
        }
        
        const percentageElement = document.getElementById('storagePercentage');
        if (percentageElement) {
            percentageElement.textContent = `${Math.round(usagePercent * 100)}%`;
        }
    }
};

// Inisialisasi saat DOM ready
document.addEventListener('DOMContentLoaded', function() {
    MONGODB_STORAGE_MANAGER.init();
});

// Expose ke global scope untuk integrasi
window.MONGODB_STORAGE_MANAGER = MONGODB_STORAGE_MANAGER;
</script>
<script>
// ==================== INJEKSI MONGODB FRONTEND DEDICATED MAX ====================
const MongoDBInjector = {
    // Ganti dengan URL Vercel Anda (misal: https://stl-small-bank.vercel.app)
    BASE_API_URL: window.location.origin + '/api/sync',
    
    // Simulasikan Auth/Login untuk mendapatkan User ID yang unik (Anda bisa gunakan Google Login di sini)
    getUserId() {
        // PERHATIAN: Diimplementasi nyata, Anda harus menggunakan Google Sign-In
        // seperti yang saya jelaskan untuk mendapatkan User ID yang AMAN.
        // Untuk saat ini, kita akan pakai ID dummy.
        return localStorage.getItem('user_id_v2') || 'GUEST-12345';
    },

    // Pengganti utama untuk window.saveData() dan window.loadSavedData()
    async saveToCloud() {
        const uid = this.getUserId();
        if (uid === 'GUEST-12345') {
            alert('');
            return;
        }

        // Ambil data dari state global aplikasi Anda
        const payload = {
            FINANCIAL_STATE: window.FINANCIAL_STATE,
            ACCOUNT_STATE: window.ACCOUNT_STATE,
        };

        try {
            // KIRIM data ke perantara aman (Vercel Function)
            const response = await fetch(this.BASE_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ uid: uid, data: payload })
            });

            const result = await response.json();

            if (response.ok) {
                console.log('âœ… MongoDB Sync Sukses:', result.message);
                if(window.updateDynamicIsland) updateDynamicIsland('â˜ï¸ Data tersinkronisasi ke MongoDB', 1500);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('âŒ Sync Gagal:', error);
            if(window.showAccountMessage) showAccountMessage('Gagal sinkronisasi MongoDB: ' + error.message, 'error');
        }
    }
};

// GANTI FUNGSI SAVE DATA GLOBAL
document.addEventListener('DOMContentLoaded', () => {
    // Ganti fungsi saveData yang ada
    window.saveData = function() {
        // Pertama, simpan ke localStorage sebagai backup (opsional)
        // [Kode localStorage lama Anda di sini]
        
        // Kedua, kirim ke cloud
        MongoDBInjector.saveToCloud();
    };
    
    // Ganti tombol sinkronisasi (jika ada)
    const syncBtn = document.getElementById('syncData');
    if(syncBtn) {
        syncBtn.addEventListener('click', window.saveData);
        syncBtn.innerHTML = '<i class="fas fa-database"></i> Sync MongoDB';
    }
});
</script>
<script>
    const mongoDBConfig = {
        apiKey: "API_KEY_ANDA_DI_SINI", 
        authDomain: "AUTH_DOMAIN_ANDA_DI_SINI",
        projectId: "PROJECT_ID_ANDA_DI_SINI",
        // ... detail konfigurasi lainnya
    };

    let fb_auth, fb_db;

    try {
        const mongoDBApp = mongoDB.initializeApp(mongoDBConfig);
        fb_auth = mongoDB.auth();
        fb_db = mongoDB.firestore();
        console.log('ðŸ”¥ mongoDB Injected and Initialized.');
    } catch (e) {
        console.error('âŒ Gagal Inisialisasi mongoDB:', e);
        // Tampilkan pesan error jika inisialisasi gagal (misal: config salah)
        if(window.showSystemAlert) showSystemAlert('Koneksi mongoDB Gagal. Cek konfigurasi Anda.', 'error');
    }

    // ========== AUTHENTICATOR (MENGGANTIKAN unlockRekening LAMA) ==========
    const mongoDBAuthenticator = {
        currentUser: null,

        // Panggil fungsi ini dari tombol "Login" Anda
        signInWithGoogle() {
            const provider = new mongoDB.auth.GoogleAuthProvider();
            // Minta mongoDB untuk menggunakan mode pop-up
            fb_auth.signInWithPopup(provider)
                .then((result) => {
                    console.log('Login sukses:', result.user.displayName);
                    // Tidak perlu melakukan apa-apa lagi di sini, onAuthStateChanged yang akan menangani
                })
                .catch((error) => {
                    console.error('Login Gagal:', error);
                    // Tampilkan pesan error login di UI (jika ada fungsi notifikasi)
                    if(window.showAccountMessage) showAccountMessage('Login Google Gagal: ' + error.message, 'error');
                });
        },

        // Panggil fungsi ini dari tombol "Kunci" atau "Logout"
        signOut() {
            fb_auth.signOut().then(() => {
                // Clear state lokal setelah logout
                this.currentUser = null;
                // Panggil fungsi bawaan aplikasi Anda untuk membersihkan/mengunci UI
                if(typeof window.lockRekening === 'function') window.lockRekening();
                if(window.showAccountMessage) showAccountMessage('Berhasil Logout.', 'success');
            });
        },
        
        // Listener utama yang berjalan saat status login berubah
        initAuthListener() {
            fb_auth.onAuthStateChanged((user) => {
                if (user) {
                    // Pengguna SUDAH login
                    this.currentUser = user;
                    console.log('ðŸ‡¬ User logged in:', user.displayName, user.uid);
                    
                    // Ganti UI ke mode "unlocked"
                    document.getElementById('rekeningAuth').style.display = 'none';
                    document.getElementById('rekeningContent').style.display = 'block';
                    
                    // --- FUNGSI PENTING: MUAT DATA ---
                    mongoDBDataManager.loadAllData(user.uid);
                    
                    // Update Dynamic Island
                    if(window.updateDynamicIsland) updateDynamicIsland(`Selamat datang, ${user.displayName}!`, 3000);
                } else {
                    // Pengguna TIDAK login
                    this.currentUser = null;
                    console.log('ðŸ‡¬ User logged out or not signed in.');
                    
                    // Ganti UI ke mode "locked"
                    document.getElementById('rekeningAuth').style.display = 'block';
                    document.getElementById('rekeningContent').style.display = 'none';
                }
            });
        }
    };

    // ========== DATA MANAGER (PENGGANTI saveData/loadSavedData) ==========
    const mongoDBDataManager = {

        // Menggantikan window.saveData()
        async saveAllData(uid) {
            if (!uid) {
                if(window.showAccountMessage) showAccountMessage('Harap login untuk menyimpan ke cloud.', 'warning');
                return;
            }
            
            const userDocRef = fb_db.collection('userData').doc(uid);
            
            try {
                // Ambil state terbaru dari variabel global aplikasi Anda
                const dataToSave = {
                    FINANCIAL_STATE: window.FINANCIAL_STATE, // Asumsi variabel global Anda ada
                    ACCOUNT_STATE: window.ACCOUNT_STATE,     // Asumsi variabel global Anda ada
                };

                await userDocRef.set({
                    payload: dataToSave,
                    lastUpdated: mongoDB.firestore.FieldValue.serverTimestamp()
                });
                console.log('â˜ï¸ Data berhasil disimpan ke mongoDB');
                if(window.updateDynamicIsland) updateDynamicIsland('â˜ï¸ Data tersinkronisasi ke cloud', 1500);
                
            } catch (error) {
                console.error('Error saving to Firestore:', error);
                if(window.showAccountMessage) showAccountMessage('Gagal sinkronisasi data: ' + error.message, 'error');
            }
        },

        // Menggantikan window.loadSavedData()
        async loadAllData(uid) {
            const userDocRef = fb_db.collection('userData').doc(uid);
            
            try {
                const doc = await userDocRef.get();
                
                if (doc.exists && doc.data().payload) {
                    const data = doc.data().payload;
                    
                    // Muat data ke variabel global Anda
                    Object.assign(window.FINANCIAL_STATE, data.FINANCIAL_STATE);
                    Object.assign(window.ACCOUNT_STATE, data.ACCOUNT_STATE);
                    
                    console.log('â˜ï¸ Data berhasil dimuat dari mongoDB');
                } else {
                    console.log('â˜ï¸ Data cloud kosong, menggunakan data lokal/kosong.');
                    // Di sini Anda bisa memanggil fungsi inisialisasi data kosong jika perlu.
                }
                
                // Panggil semua fungsi render ulang aplikasi Anda
                if(window.updateDashboard) updateDashboard();
                if(window.renderTransactions) renderTransactions();
                if(window.updateAccountsDisplay) updateAccountsDisplay();
                
            } catch (error) {
                console.error('Error loading from Firestore:', error);
                if(window.showAccountMessage) showAccountMessage('Gagal memuat data cloud: ' + error.message, 'error');
            }
        }
    };


    // ========== INJEKSI DOM DAN WRAPPER ==========
    document.addEventListener('DOMContentLoaded', () => {
        // 1. MULAI LISTENER AUTHENTIKASI
        if (fb_auth) mongoDBAuthenticator.initAuthListener();
        
        // 2. GANTI FUNGSI SAVE DATA GLOBAL
        const oldSaveData = window.saveData; // Simpan fungsi lama jika Anda ingin tetap menyimpan ke localStorage
        window.saveData = function() {
            // Pertama, tetap panggil fungsi simpan data lama (untuk backup lokal)
            if (typeof oldSaveData === 'function') oldSaveData();

            // Kedua, simpan ke cloud jika sudah login
            const uid = mongoDBAuthenticator.currentUser?.uid;
            if (uid) {
                mongoDBDataManager.saveAllData(uid);
            }
        };

        // 3. WIRE TOMBOL LOGIN/LOGOUT
        const unlockButton = document.getElementById('unlockRekening');
        if(unlockButton) {
            // Hapus listener lama jika ada (penting untuk mencegah double-call)
            unlockButton.replaceWith(unlockButton.cloneNode(true));
            const newUnlockButton = document.getElementById('unlockRekening');
            
            // Ganti teks dan event ke Google Login
            newUnlockButton.innerHTML = '<i class="fab fa-google mr-2"></i> Login dengan Google';
            newUnlockButton.addEventListener('click', () => {
                // Notifikasi browser akan hilang jika diakses via HTTPS
                mongoDBAuthenticator.signInWithGoogle();
            });
            
            // Sembunyikan input passphrase lama
            const passInput = document.getElementById('rekeningPassphrase');
            if(passInput) passInput.style.display = 'none';
        }

        const lockButton = document.getElementById('lockRekening');
        if(lockButton) {
            lockButton.replaceWith(lockButton.cloneNode(true));
            const newLockButton = document.getElementById('lockRekening');
            newLockButton.innerHTML = '<i class="fas fa-sign-out-alt mr-2"></i> Logout';
            newLockButton.addEventListener('click', mongoDBAuthenticator.signOut);
        }
    });

    // ==================== AKHIR DARI INJEKSI mongoDB ====================
</script>
<script>
// Anda harus mendapatkan token ini saat login berhasil!
const userToken = localStorage.getItem('user_jwt_token'); 

async function syncDataToPythonBackend() {
    const backupData = prepareBackupData(); // Fungsi Anda untuk mengumpulkan data
    const backendUrl = 'http://localhost:5000'; // Ganti dengan URL domain Anda saat deployment

    try {
        const response = await fetch(`${backendUrl}/api/sync/upload`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // Kunci keamanan: kirim token yang didapat saat login
                'x-access-token': userToken 
            },
            body: JSON.stringify(backupData)
        });

        const result = await response.json();

        if (response.ok) {
            console.log('Sync Berhasil:', result.message);
            // Tampilkan notifikasi berhasil
        } else {
            console.error('Sync Gagal:', result.message);
            // Tampilkan notifikasi gagal, minta login ulang jika token expired
        }
    } catch (error) {
        console.error('Koneksi Error:', error);
    }
}
</script>
<script>
async function loginToBackend(email, password) {
    const BACKEND_URL = 'mongodb+srv://najibwahidussalam938_db_user:your_password@cluster0.aadsm5v.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0'; // Ganti dengan URL server Python Anda

    const response = await fetch(`${BACKEND_URL}/auth/login`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
    });

    const result = await response.json();

    if (response.ok) {
        // ðŸš¨ Simpan Token JWT yang diterima
        localStorage.setItem('user_jwt_token', result.token); 
        console.log('Login Python Berhasil!');
        // Lanjutkan ke alur aplikasi utama
    } else {
        console.error('Login Gagal:', result.message);
    }
}
</script>
<script>
async function syncDataToPythonBackend() {
    const BACKEND_URL = 'https://api.domain-anda.com';
    const userToken = localStorage.getItem('user_jwt_token'); 

    if (!userToken) {
        console.error('Harap login terlebih dahulu.');
        return;
    }

    // Ganti dengan fungsi yang mengumpulkan semua data dari localStorage
    const backupData = prepareAllLocalStorageData(); 

    try {
        const response = await fetch(`${BACKEND_URL}/api/sync/upload`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // ðŸ” WAJIB: Kirim token ke backend
                'x-access-token': userToken 
            },
            body: JSON.stringify(backupData)
        });

        // Tangani hasil...
        // ...
        
    } catch (error) {
        console.error('Koneksi Error:', error);
    }
}
</script>
<script>
  // Cuplikan dari bagian akhir stl-small bank.txt:
// ...

// Ganti tombol-tombol ini untuk memanggil fungsi koneksi Python yang baru
const backupBtn = document.getElementById('backupData');
if(backupBtn) backupBtn.addEventListener('click', syncDataToPythonBackend);

const restoreBtn = document.getElementById('restoreData');
if(restoreBtn) restoreBtn.addEventListener('click', restoreDataFromPythonBackend); // Fungsi restore juga harus dibuat

const syncBtn = document.getElementById('syncData');
if(syncBtn) syncBtn.addEventListener('click', syncDataToPythonBackend);
</script>
<!-- Tambahkan tombol game dinosaurus di atas tombol currency -->
<button id="openDinoGame" class="dino-game-toggle">
    <i class="fas fa-dragon"></i>
</button>

<!-- Tambahkan panel game dinosaurus -->
<div id="dinoGamePanel" class="dino-game-panel">
    <div class="dino-header">
        <h3><i class="fas fa-gamepad"></i> Dino Runner Game</h3>
        <button id="closeDinoGame" class="enhanced-btn btn-error compact-btn">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div class="dino-content">
        <div class="game-container">
            <canvas id="dinoCanvas" width="600" height="150"></canvas>
            <div class="game-controls">
                <div class="game-info">
                    <div class="score-display">
                        <span>Score: <span id="currentScore">0</span></span>
                        <span>High Score: <span id="highScore">0</span></span>
                    </div>
                    <div class="speed-display">
                        Kecepatan: <span id="currentSpeed">1.0</span>x
                    </div>
                </div>
                <div class="game-buttons">
                    <button id="startDinoGame" class="enhanced-btn btn-success compact-btn">
                        <i class="fas fa-play"></i> Mulai Game
                    </button>
                    <button id="pauseDinoGame" class="enhanced-btn btn-warning compact-btn">
                        <i class="fas fa-pause"></i> Jeda
                    </button>
                    <button id="resetDinoScores" class="enhanced-btn btn-error compact-btn">
                        <i class="fas fa-trash"></i> Hapus Skor
                    </button>
                </div>
            </div>
        </div>
        
        <div class="game-instructions">
            <h4>Cara Bermain:</h4>
            <ul>
                <li>Tekan <strong>SPACE</strong> atau <strong>KLIK</strong> untuk melompati rintangan</li>
                <li>Kecepatan bertambah setiap 100 meter</li>
                <li>Hindari tabrakan dengan kaktus!</li>
            </ul>
        </div>
        
        <div class="score-history">
            <h4>Riwayat Skor Terbaik:</h4>
            <div id="scoreHistory" class="score-list">
                <!-- Riwayat skor akan ditampilkan di sini -->
            </div>
        </div>
    </div>
</div>

<style>
    /* ==================== DINO GAME PANEL STYLES ==================== */
    .dino-game-toggle {
        position: fixed;
        bottom: 40px;
        right: 20px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        border: none;
        box-shadow: var(--ios-shadow);
        z-index: 1000;
        cursor: pointer;
        transition: var(--ios-transition);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .dino-game-toggle:hover {
        transform: translateY(-5px) scale(1.1);
        box-shadow: 0 15px 40px rgba(245, 158, 11, 0.4);
    }

    .dino-game-panel {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        width: 95%;
        max-width: 650px;
        max-height: 90vh;
        background: var(--theme-card);
        border-radius: var(--radius-2xl);
        box-shadow: var(--ios-shadow);
        z-index: 10001;
        opacity: 0;
        visibility: hidden;
        transition: var(--ios-transition);
        overflow: hidden;
        border: 1px solid var(--theme-border);
    }

    .dino-game-panel.active {
        opacity: 1;
        visibility: visible;
        transform: translate(-50%, -50%) scale(1);
    }

    .dino-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }

    .dino-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
    }

    .dino-content {
        padding: 20px;
        overflow-y: auto;
        max-height: calc(90vh - 70px);
    }

    .game-container {
        margin-bottom: 20px;
        border: 2px solid var(--theme-border);
        border-radius: var(--radius-lg);
        overflow: hidden;
    }

    #dinoCanvas {
        display: block;
        width: 100%;
        background-color: #f7f7f7;
        border-bottom: 1px solid var(--theme-border);
    }

    .game-controls {
        padding: 15px;
        background: var(--theme-bg);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }

    .game-info {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .score-display {
        display: flex;
        gap: 15px;
        font-weight: 600;
    }

    .speed-display {
        font-size: 14px;
        color: var(--theme-text);
    }

    .game-buttons {
        display: flex;
        gap: 10px;
    }

    .game-instructions {
        margin-bottom: 20px;
        padding: 15px;
        background: var(--theme-bg);
        border-radius: var(--radius-lg);
    }

    .game-instructions h4 {
        margin-bottom: 10px;
        color: var(--theme-text);
    }

    .game-instructions ul {
        padding-left: 20px;
        color: var(--theme-text);
    }

    .game-instructions li {
        margin-bottom: 5px;
    }

    .score-history {
        margin-bottom: 20px;
    }

    .score-history h4 {
        margin-bottom: 10px;
        color: var(--theme-text);
    }

    .score-list {
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid var(--theme-border);
        border-radius: var(--radius-lg);
        padding: 10px;
        background: var(--theme-bg);
    }

    .score-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid var(--theme-border);
    }

    .score-item:last-child {
        border-bottom: none;
    }

    .score-value {
        font-weight: 700;
        color: var(--theme-primary);
    }

    .score-date {
        font-size: 12px;
        color: var(--theme-text);
        opacity: 0.7;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .game-controls {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .game-buttons {
            width: 100%;
            justify-content: space-between;
        }
    }

    @media (max-width: 480px) {
        .dino-game-panel {
            width: 98%;
        }
        
        .dino-content {
            padding: 15px;
        }
        
        .score-display {
            flex-direction: column;
            gap: 5px;
        }
    }
</style>

<script>
    // ==================== DINO GAME LOGIC ====================
    const DINO_STATE = {
        isPlaying: false,
        isPaused: false,
        score: 0,
        highScore: 0,
        speed: 1.0,
        speedIncrement: 0.2,
        scoreHistory: []
    };

    // Game elements
    let dinoCanvas, dinoCtx;
    let dino, obstacles;
    let gameSpeed;
    let gravity;
    let isJumping = false;
    let jumpVelocity = 0;
    let gameAnimationId;

    // Initialize dino game
    document.addEventListener('DOMContentLoaded', function() {
        setupDinoGameEventListeners();
        initializeDinoGame();
        loadDinoGameData();
    });

    function setupDinoGameEventListeners() {
        // Toggle dino game panel
        document.getElementById('openDinoGame').addEventListener('click', openDinoGame);
        document.getElementById('closeDinoGame').addEventListener('click', closeDinoGame);
        
        // Game controls
        document.getElementById('startDinoGame').addEventListener('click', startDinoGame);
        document.getElementById('pauseDinoGame').addEventListener('click', togglePauseDinoGame);
        document.getElementById('resetDinoScores').addEventListener('click', resetDinoScores);
        
        // Keyboard controls
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space' && DINO_STATE.isPlaying && !DINO_STATE.isPaused) {
                e.preventDefault();
                jumpDino();
            }
        });
        
        // Touch/click controls
        document.getElementById('dinoCanvas').addEventListener('click', function() {
            if (DINO_STATE.isPlaying && !DINO_STATE.isPaused) {
                jumpDino();
            }
        });
    }

    function initializeDinoGame() {
        dinoCanvas = document.getElementById('dinoCanvas');
        dinoCtx = dinoCanvas.getContext('2d');
        
        // Set canvas dimensions
        dinoCanvas.width = dinoCanvas.offsetWidth;
        dinoCanvas.height = 150;
        
        // Initialize game variables
        gameSpeed = 5;
        gravity = 0.5;
        
        // Initialize dino
        dino = {
            x: 50,
            y: dinoCanvas.height - 40,
            width: 40,
            height: 40,
            color: '#2D3748'
        };
        
        // Initialize obstacles
        obstacles = [];
        
        // Draw initial game state
        drawDinoGame();
    }

    function openDinoGame() {
        document.getElementById('dinoGamePanel').classList.add('active');
        initializeDinoGame();
        updateScoreHistoryDisplay();
    }

    function closeDinoGame() {
        document.getElementById('dinoGamePanel').classList.remove('active');
        stopDinoGame();
    }

    function startDinoGame() {
        if (DINO_STATE.isPlaying) return;
        
        // Reset game state
        DINO_STATE.isPlaying = true;
        DINO_STATE.isPaused = false;
        DINO_STATE.score = 0;
        DINO_STATE.speed = 1.0;
        gameSpeed = 5;
        
        // Reset dino and obstacles
        dino.y = dinoCanvas.height - 40;
        isJumping = false;
        jumpVelocity = 0;
        obstacles = [];
        
        // Update UI
        document.getElementById('currentScore').textContent = '0';
        document.getElementById('currentSpeed').textContent = DINO_STATE.speed.toFixed(1);
        document.getElementById('startDinoGame').innerHTML = '<i class="fas fa-redo"></i> Mulai Ulang';
        
        // Start game loop
        gameAnimationId = requestAnimationFrame(updateDinoGame);
    }

    function stopDinoGame() {
        DINO_STATE.isPlaying = false;
        DINO_STATE.isPaused = false;
        
        if (gameAnimationId) {
            cancelAnimationFrame(gameAnimationId);
        }
        
        // Update UI
        document.getElementById('startDinoGame').innerHTML = '<i class="fas fa-play"></i> Mulai Game';
    }

    function togglePauseDinoGame() {
        if (!DINO_STATE.isPlaying) return;
        
        DINO_STATE.isPaused = !DINO_STATE.isPaused;
        
        if (DINO_STATE.isPaused) {
            if (gameAnimationId) {
                cancelAnimationFrame(gameAnimationId);
            }
            document.getElementById('pauseDinoGame').innerHTML = '<i class="fas fa-play"></i> Lanjut';
        } else {
            gameAnimationId = requestAnimationFrame(updateDinoGame);
            document.getElementById('pauseDinoGame').innerHTML = '<i class="fas fa-pause"></i> Jeda';
        }
    }

    function resetDinoScores() {
        // Reset state
        DINO_STATE.highScore = 0;
        DINO_STATE.scoreHistory = [];
        
        // Update UI
        document.getElementById('highScore').textContent = '0';
        updateScoreHistoryDisplay();
        
        // Clear from localStorage
        localStorage.removeItem('stl_dino_game_data');
        
        // Show confirmation message
        updateDynamicIsland('ðŸ—‘ï¸ Semua skor telah dihapus!', 2000);
    }

    function jumpDino() {
        if (!isJumping) {
            isJumping = true;
            jumpVelocity = -12;
        }
    }

    function updateDinoGame() {
        if (!DINO_STATE.isPlaying || DINO_STATE.isPaused) return;
        
        // Clear canvas
        dinoCtx.clearRect(0, 0, dinoCanvas.width, dinoCanvas.height);
        
        // Update dino position
        if (isJumping) {
            dino.y += jumpVelocity;
            jumpVelocity += gravity;
            
            // Check if dino landed
            if (dino.y >= dinoCanvas.height - 40) {
                dino.y = dinoCanvas.height - 40;
                isJumping = false;
                jumpVelocity = 0;
            }
        }
        
        // Update obstacles
        updateObstacles();
        
        // Check collisions
        if (checkCollisions()) {
            gameOver();
            return;
        }
        
        // Update score and speed
        updateScore();
        
        // Draw game elements
        drawDinoGame();
        
        // Continue game loop
        gameAnimationId = requestAnimationFrame(updateDinoGame);
    }

    function updateObstacles() {
        // Randomly add new obstacles
        if (Math.random() < 0.02 * DINO_STATE.speed) {
            const obstacleTypes = [
                { width: 20, height: 40 }, // Small cactus
                { width: 30, height: 50 }, // Medium cactus
                { width: 40, height: 40 }  // Wide cactus
            ];
            
            const type = Math.floor(Math.random() * obstacleTypes.length);
            obstacles.push({
                x: dinoCanvas.width,
                y: dinoCanvas.height - obstacleTypes[type].height,
                width: obstacleTypes[type].width,
                height: obstacleTypes[type].height,
                color: '#2F855A'
            });
        }
        
        // Move and remove obstacles
        for (let i = obstacles.length - 1; i >= 0; i--) {
            obstacles[i].x -= gameSpeed;
            
            // Remove obstacles that are off screen
            if (obstacles[i].x + obstacles[i].width < 0) {
                obstacles.splice(i, 1);
            }
        }
    }

    function updateScore() {
        DINO_STATE.score += Math.floor(DINO_STATE.speed);
        document.getElementById('currentScore').textContent = DINO_STATE.score;
        
        // Increase speed every 100 points
        if (DINO_STATE.score > 0 && DINO_STATE.score % 100 === 0) {
            DINO_STATE.speed += DINO_STATE.speedIncrement;
            gameSpeed = 5 * DINO_STATE.speed;
            document.getElementById('currentSpeed').textContent = DINO_STATE.speed.toFixed(1);
        }
    }

    function checkCollisions() {
        for (let obstacle of obstacles) {
            if (
                dino.x < obstacle.x + obstacle.width &&
                dino.x + dino.width > obstacle.x &&
                dino.y < obstacle.y + obstacle.height &&
                dino.y + dino.height > obstacle.y
            ) {
                return true;
            }
        }
        return false;
    }

    function drawDinoGame() {
        // Draw ground
        dinoCtx.fillStyle = '#E2E8F0';
        dinoCtx.fillRect(0, dinoCanvas.height - 10, dinoCanvas.width, 10);
        
        // Draw dino
        dinoCtx.fillStyle = dino.color;
        dinoCtx.fillRect(dino.x, dino.y, dino.width, dino.height);
        
        // Draw dino details (simple face)
        dinoCtx.fillStyle = '#FFFFFF';
        dinoCtx.fillRect(dino.x + 25, dino.y + 10, 8, 8); // Eye
        
        // Draw obstacles
        for (let obstacle of obstacles) {
            dinoCtx.fillStyle = obstacle.color;
            dinoCtx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
            
            // Add cactus details
            dinoCtx.fillStyle = '#276749';
            dinoCtx.fillRect(obstacle.x + 5, obstacle.y, 5, 10);
            if (obstacle.width > 25) {
                dinoCtx.fillRect(obstacle.x + obstacle.width - 10, obstacle.y, 5, 10);
            }
        }
        
        // Draw score
        dinoCtx.fillStyle = '#2D3748';
        dinoCtx.font = '16px Arial';
        dinoCtx.fillText(`Score: ${DINO_STATE.score}`, 10, 20);
        dinoCtx.fillText(`Speed: ${DINO_STATE.speed.toFixed(1)}x`, 10, 40);
    }

    function gameOver() {
        DINO_STATE.isPlaying = false;
        
        // Update high score if needed
        if (DINO_STATE.score > DINO_STATE.highScore) {
            DINO_STATE.highScore = DINO_STATE.score;
            document.getElementById('highScore').textContent = DINO_STATE.highScore;
        }
        
        // Add to score history
        addToScoreHistory(DINO_STATE.score);
        
        // Draw game over message
        dinoCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        dinoCtx.fillRect(0, 0, dinoCanvas.width, dinoCanvas.height);
        
        dinoCtx.fillStyle = '#FFFFFF';
        dinoCtx.font = '24px Arial';
        dinoCtx.textAlign = 'center';
        dinoCtx.fillText('GAME OVER', dinoCanvas.width / 2, dinoCanvas.height / 2 - 20);
        dinoCtx.font = '16px Arial';
        dinoCtx.fillText(`Score: ${DINO_STATE.score}`, dinoCanvas.width / 2, dinoCanvas.height / 2 + 10);
        dinoCtx.fillText('Klik untuk bermain lagi', dinoCanvas.width / 2, dinoCanvas.height / 2 + 40);
        dinoCtx.textAlign = 'left';
        
        // Update UI
        document.getElementById('startDinoGame').innerHTML = '<i class="fas fa-play"></i> Mulai Game';
        
        // Save game data
        saveDinoGameData();
        
        updateDynamicIsland(`ðŸ¦– Game Over! Skor: ${DINO_STATE.score}`, 3000);
    }

    function addToScoreHistory(score) {
        const scoreEntry = {
            score: score,
            date: new Date().toLocaleString('id-ID')
        };
        
        DINO_STATE.scoreHistory.unshift(scoreEntry);
        
        // Keep only top 5 scores
        if (DINO_STATE.scoreHistory.length > 5) {
            DINO_STATE.scoreHistory = DINO_STATE.scoreHistory.slice(0, 5);
        }
        
        updateScoreHistoryDisplay();
    }

    function updateScoreHistoryDisplay() {
        const scoreHistoryElement = document.getElementById('scoreHistory');
        
        if (DINO_STATE.scoreHistory.length === 0) {
            scoreHistoryElement.innerHTML = '<p class="text-gray-500 text-center">Belum ada riwayat skor</p>';
            return;
        }
        
        scoreHistoryElement.innerHTML = DINO_STATE.scoreHistory.map((entry, index) => `
            <div class="score-item">
                <div>
                    <span class="score-value">${entry.score}</span> poin
                </div>
                <div class="score-date">${entry.date}</div>
            </div>
        `).join('');
    }

    function saveDinoGameData() {
        const data = {
            highScore: DINO_STATE.highScore,
            scoreHistory: DINO_STATE.scoreHistory
        };
        
        localStorage.setItem('stl_dino_game_data', JSON.stringify(data));
    }

    function loadDinoGameData() {
        const savedData = localStorage.getItem('stl_dino_game_data');
        
        if (savedData) {
            try {
                const data = JSON.parse(savedData);
                DINO_STATE.highScore = data.highScore || 0;
                DINO_STATE.scoreHistory = data.scoreHistory || [];
                
                document.getElementById('highScore').textContent = DINO_STATE.highScore;
                updateScoreHistoryDisplay();
            } catch (error) {
                console.error('Error loading dino game data:', error);
            }
        }
    }
</script>
<!-- Tambahkan tombol canvas drawing di atas tombol game dino -->
<button id="openCanvasPanel" class="canvas-panel-toggle">
    <i class="fas fa-paint-brush"></i>
</button>

<!-- Tambahkan panel canvas drawing -->
<div id="canvasPanel" class="canvas-panel">
    <div class="canvas-header">
        <h3><i class="fas fa-paint-brush"></i> Professional Drawing Canvas</h3>
        <button id="closeCanvasPanel" class="enhanced-btn btn-error compact-btn">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div class="canvas-content">
        <div class="canvas-tools">
            <div class="tool-group">
                <label>Brush Size</label>
                <input type="range" id="brushSize" min="1" max="50" value="5" class="w-full">
                <span id="brushSizeValue">5px</span>
            </div>
            <div class="tool-group">
                <label>Brush Color</label>
                <input type="color" id="brushColor" value="#000000">
            </div>
            <div class="tool-group">
                <label>Canvas Color</label>
                <input type="color" id="canvasColor" value="#ffffff">
            </div>
            <div class="tool-group">
                <label>Drawing Mode</label>
                <select id="drawingMode" class="enhanced-input compact-input">
                    <option value="freehand">Freehand</option>
                    <option value="signature">Signature (TTD)</option>
                    <option value="line">Straight Line</option>
                    <option value="rectangle">Rectangle</option>
                    <option value="circle">Circle</option>
                    <option value="text">Text</option>
                </select>
            </div>
        </div>
        
        <div class="canvas-container">
            <canvas id="drawingCanvas" width="800" height="500"></canvas>
        </div>
        
        <div class="canvas-actions">
            <button id="clearCanvas" class="enhanced-btn btn-warning compact-btn">
                <i class="fas fa-trash"></i> Clear
            </button>
            <button id="saveDrawing" class="enhanced-btn btn-success compact-btn">
                <i class="fas fa-save"></i> Save to Important
            </button>
            <button id="undoDrawing" class="enhanced-btn btn-primary compact-btn">
                <i class="fas fa-undo"></i> Undo
            </button>
            <button id="redoDrawing" class="enhanced-btn btn-primary compact-btn">
                <i class="fas fa-redo"></i> Redo
            </button>
        </div>
        
        <div class="drawing-history">
            <h4>Recent Drawings</h4>
            <div id="drawingThumbnails" class="thumbnails-container">
                <!-- Thumbnails will be populated here -->
            </div>
        </div>
    </div>
</div>

<style>
    /* ==================== CANVAS PANEL STYLES ==================== */
    .canvas-panel-toggle {
        position: fixed;
        bottom: 70px;
        right: 20px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        border: none;
        box-shadow: var(--ios-shadow);
        z-index: 1000;
        cursor: pointer;
        transition: var(--ios-transition);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .canvas-panel-toggle:hover {
        transform: translateY(-5px) scale(1.1);
        box-shadow: 0 15px 40px rgba(139, 92, 246, 0.4);
    }

    .canvas-panel {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        width: 95%;
        max-width: 900px;
        max-height: 90vh;
        background: var(--theme-card);
        border-radius: var(--radius-2xl);
        box-shadow: var(--ios-shadow);
        z-index: 10001;
        opacity: 0;
        visibility: hidden;
        transition: var(--ios-transition);
        overflow: hidden;
        border: 1px solid var(--theme-border);
    }

    .canvas-panel.active {
        opacity: 1;
        visibility: visible;
        transform: translate(-50%, -50%) scale(1);
    }

    .canvas-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
    }

    .canvas-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
    }

    .canvas-content {
        padding: 20px;
        overflow-y: auto;
        max-height: calc(90vh - 70px);
    }

    .canvas-tools {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px;
        background: var(--theme-bg);
        border-radius: var(--radius-lg);
    }

    .tool-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .tool-group label {
        font-weight: 600;
        font-size: 14px;
        color: var(--theme-text);
    }

    .canvas-container {
        margin-bottom: 20px;
        border: 2px solid var(--theme-border);
        border-radius: var(--radius-lg);
        overflow: hidden;
        background: white;
        box-shadow: var(--shadow-md);
    }

    #drawingCanvas {
        display: block;
        width: 100%;
        cursor: crosshair;
        background-color: #ffffff;
    }

    .canvas-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .canvas-actions button {
        flex: 1;
        min-width: 120px;
    }

    .drawing-history {
        margin-bottom: 10px;
    }

    .drawing-history h4 {
        margin-bottom: 10px;
        color: var(--theme-text);
    }

    .thumbnails-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        max-height: 150px;
        overflow-y: auto;
        padding: 10px;
        background: var(--theme-bg);
        border-radius: var(--radius-lg);
    }

    .drawing-thumbnail {
        position: relative;
        border: 2px solid var(--theme-border);
        border-radius: var(--radius-lg);
        overflow: hidden;
        cursor: pointer;
        transition: var(--ios-transition);
    }

    .drawing-thumbnail:hover {
        transform: translateY(-3px);
        border-color: var(--theme-primary);
    }

    .drawing-thumbnail img {
        width: 100%;
        height: 80px;
        object-fit: contain;
        background: white;
    }

    .thumbnail-actions {
        position: absolute;
        top: 5px;
        right: 5px;
        display: flex;
        gap: 5px;
    }

    .thumbnail-btn {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        cursor: pointer;
        transition: var(--ios-transition);
    }

    .thumbnail-btn.delete {
        background: #ef4444;
        color: white;
    }

    .thumbnail-btn.load {
        background: #10b981;
        color: white;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .canvas-tools {
            grid-template-columns: 1fr;
        }
        
        .canvas-actions {
            flex-direction: column;
        }
        
        .canvas-actions button {
            min-width: auto;
        }
    }

    @media (max-width: 480px) {
        .canvas-panel {
            width: 98%;
        }
        
        .canvas-content {
            padding: 15px;
        }
        
        .thumbnails-container {
            grid-template-columns: repeat(3, 1fr);
        }
    }
</style>

<script>
    // ==================== CANVAS DRAWING LOGIC ====================
    const CANVAS_STATE = {
        isDrawing: false,
        lastX: 0,
        lastY: 0,
        history: [],
        historyIndex: -1,
        currentMode: 'freehand',
        drawings: []
    };

    // Canvas elements
    let canvas, ctx;
    let currentColor = '#000000';
    let currentBrushSize = 5;
    let canvasBackground = '#ffffff';

    // Initialize canvas
    document.addEventListener('DOMContentLoaded', function() {
        setupCanvasEventListeners();
        initializeCanvas();
        loadSavedDrawings();
    });

    function setupCanvasEventListeners() {
        // Toggle canvas panel
        document.getElementById('openCanvasPanel').addEventListener('click', openCanvasPanel);
        document.getElementById('closeCanvasPanel').addEventListener('click', closeCanvasPanel);
        
        // Canvas tools
        document.getElementById('brushSize').addEventListener('input', updateBrushSize);
        document.getElementById('brushColor').addEventListener('input', updateBrushColor);
        document.getElementById('canvasColor').addEventListener('input', updateCanvasColor);
        document.getElementById('drawingMode').addEventListener('change', updateDrawingMode);
        
        // Canvas actions
        document.getElementById('clearCanvas').addEventListener('click', clearCanvas);
        document.getElementById('saveDrawing').addEventListener('click', saveDrawing);
        document.getElementById('undoDrawing').addEventListener('click', undoDrawing);
        document.getElementById('redoDrawing').addEventListener('click', redoDrawing);
        
        // Canvas mouse events
        document.getElementById('drawingCanvas').addEventListener('mousedown', startDrawing);
        document.getElementById('drawingCanvas').addEventListener('mousemove', draw);
        document.getElementById('drawingCanvas').addEventListener('mouseup', stopDrawing);
        document.getElementById('drawingCanvas').addEventListener('mouseout', stopDrawing);
        
        // Canvas touch events for mobile
        document.getElementById('drawingCanvas').addEventListener('touchstart', handleTouchStart);
        document.getElementById('drawingCanvas').addEventListener('touchmove', handleTouchMove);
        document.getElementById('drawingCanvas').addEventListener('touchend', handleTouchEnd);
    }

    function initializeCanvas() {
        canvas = document.getElementById('drawingCanvas');
        ctx = canvas.getContext('2d');
        
        // Set canvas dimensions
        canvas.width = canvas.offsetWidth;
        canvas.height = 500;
        
        // Set initial canvas background
        ctx.fillStyle = canvasBackground;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Set initial drawing styles
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = currentBrushSize;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        // Save initial state to history
        saveToHistory();
    }

    function openCanvasPanel() {
        document.getElementById('canvasPanel').classList.add('active');
        updateThumbnails();
    }

    function closeCanvasPanel() {
        document.getElementById('canvasPanel').classList.remove('active');
    }

    function updateBrushSize() {
        const brushSize = document.getElementById('brushSize').value;
        currentBrushSize = parseInt(brushSize);
        document.getElementById('brushSizeValue').textContent = brushSize + 'px';
        ctx.lineWidth = currentBrushSize;
    }

    function updateBrushColor() {
        currentColor = document.getElementById('brushColor').value;
        ctx.strokeStyle = currentColor;
    }

    function updateCanvasColor() {
        canvasBackground = document.getElementById('canvasColor').value;
        
        // Redraw canvas with new background
        const currentDrawing = ctx.getImageData(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = canvasBackground;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.putImageData(currentDrawing, 0, 0);
        
        saveToHistory();
    }

    function updateDrawingMode() {
        CANVAS_STATE.currentMode = document.getElementById('drawingMode').value;
        
        // Change cursor based on mode
        switch(CANVAS_STATE.currentMode) {
            case 'freehand':
            case 'signature':
                canvas.style.cursor = 'crosshair';
                break;
            case 'line':
            case 'rectangle':
            case 'circle':
                canvas.style.cursor = 'crosshair';
                break;
            case 'text':
                canvas.style.cursor = 'text';
                break;
        }
    }

    function startDrawing(e) {
        CANVAS_STATE.isDrawing = true;
        const pos = getMousePos(canvas, e);
        [CANVAS_STATE.lastX, CANVAS_STATE.lastY] = [pos.x, pos.y];
        
        // For shape modes, we need to save the starting position
        if (['line', 'rectangle', 'circle'].includes(CANVAS_STATE.currentMode)) {
            saveToHistory();
        }
    }

    function draw(e) {
        if (!CANVAS_STATE.isDrawing) return;
        
        const pos = getMousePos(canvas, e);
        const currentX = pos.x;
        const currentY = pos.y;
        
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = currentBrushSize;
        
        switch(CANVAS_STATE.currentMode) {
            case 'freehand':
                ctx.beginPath();
                ctx.moveTo(CANVAS_STATE.lastX, CANVAS_STATE.lastY);
                ctx.lineTo(currentX, currentY);
                ctx.stroke();
                [CANVAS_STATE.lastX, CANVAS_STATE.lastY] = [currentX, currentY];
                break;
                
            case 'signature':
                // Signature mode with smoother curves
                ctx.beginPath();
                ctx.moveTo(CANVAS_STATE.lastX, CANVAS_STATE.lastY);
                ctx.quadraticCurveTo(
                    CANVAS_STATE.lastX, CANVAS_STATE.lastY,
                    (CANVAS_STATE.lastX + currentX) / 2, (CANVAS_STATE.lastY + currentY) / 2
                );
                ctx.stroke();
                [CANVAS_STATE.lastX, CANVAS_STATE.lastY] = [currentX, currentY];
                break;
                
            case 'line':
                // Redraw canvas from history to show preview
                restoreFromHistory(CANVAS_STATE.historyIndex);
                ctx.beginPath();
                ctx.moveTo(CANVAS_STATE.lastX, CANVAS_STATE.lastY);
                ctx.lineTo(currentX, currentY);
                ctx.stroke();
                break;
                
            case 'rectangle':
                restoreFromHistory(CANVAS_STATE.historyIndex);
                const width = currentX - CANVAS_STATE.lastX;
                const height = currentY - CANVAS_STATE.lastY;
                ctx.strokeRect(CANVAS_STATE.lastX, CANVAS_STATE.lastY, width, height);
                break;
                
            case 'circle':
                restoreFromHistory(CANVAS_STATE.historyIndex);
                const radius = Math.sqrt(
                    Math.pow(currentX - CANVAS_STATE.lastX, 2) + 
                    Math.pow(currentY - CANVAS_STATE.lastY, 2)
                );
                ctx.beginPath();
                ctx.arc(CANVAS_STATE.lastX, CANVAS_STATE.lastY, radius, 0, Math.PI * 2);
                ctx.stroke();
                break;
                
            case 'text':
                // Text mode - handled on mouse up
                break;
        }
    }

    function stopDrawing(e) {
        if (!CANVAS_STATE.isDrawing) return;
        
        const pos = getMousePos(canvas, e);
        const currentX = pos.x;
        const currentY = pos.y;
        
        // For text mode, prompt for text input
        if (CANVAS_STATE.currentMode === 'text') {
            const text = prompt('Enter text:');
            if (text) {
                ctx.font = `${currentBrushSize * 3}px Arial`;
                ctx.fillStyle = currentColor;
                ctx.fillText(text, currentX, currentY);
                saveToHistory();
            }
        } else if (['line', 'rectangle', 'circle'].includes(CANVAS_STATE.currentMode)) {
            // For shape modes, the drawing is already complete
            saveToHistory();
        } else {
            // For freehand and signature, save to history
            saveToHistory();
        }
        
        CANVAS_STATE.isDrawing = false;
    }

    function handleTouchStart(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousedown', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    }

    function handleTouchMove(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent('mousemove', {
            clientX: touch.clientX,
            clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
    }

    function handleTouchEnd(e) {
        e.preventDefault();
        const mouseEvent = new MouseEvent('mouseup', {});
        canvas.dispatchEvent(mouseEvent);
    }

    function getMousePos(canvas, evt) {
        const rect = canvas.getBoundingClientRect();
        let clientX, clientY;
        
        if (evt.type.includes('touch')) {
            clientX = evt.touches[0].clientX;
            clientY = evt.touches[0].clientY;
        } else {
            clientX = evt.clientX;
            clientY = evt.clientY;
        }
        
        return {
            x: clientX - rect.left,
            y: clientY - rect.top
        };
    }

    function clearCanvas() {
        ctx.fillStyle = canvasBackground;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        saveToHistory();
        updateDynamicIsland('ðŸ—‘ï¸ Canvas cleared', 1500);
    }

    function saveDrawing() {
        const dataURL = canvas.toDataURL('image/png');
        const drawingId = 'drawing-' + Date.now();
        
        const drawingData = {
            id: drawingId,
            type: 'drawing',
            dataUrl: dataURL,
            description: 'Drawing ' + new Date().toLocaleString('id-ID'),
            date: new Date().toISOString(),
            timestamp: Date.now()
        };
        
        // Add to important history
        addToImportantHistory(drawingData);
        
        // Save to local storage for thumbnails
        CANVAS_STATE.drawings.unshift(drawingData);
        if (CANVAS_STATE.drawings.length > 10) {
            CANVAS_STATE.drawings.pop();
        }
        
        localStorage.setItem('stl_canvas_drawings', JSON.stringify(CANVAS_STATE.drawings));
        updateThumbnails();
        
        updateDynamicIsland('ðŸ’¾ Drawing saved to important history', 2000);
    }

    function undoDrawing() {
        if (CANVAS_STATE.historyIndex > 0) {
            CANVAS_STATE.historyIndex--;
            restoreFromHistory(CANVAS_STATE.historyIndex);
        }
    }

    function redoDrawing() {
        if (CANVAS_STATE.historyIndex < CANVAS_STATE.history.length - 1) {
            CANVAS_STATE.historyIndex++;
            restoreFromHistory(CANVAS_STATE.historyIndex);
        }
    }

    function saveToHistory() {
        // Remove any future states if we're not at the end
        if (CANVAS_STATE.historyIndex < CANVAS_STATE.history.length - 1) {
            CANVAS_STATE.history = CANVAS_STATE.history.slice(0, CANVAS_STATE.historyIndex + 1);
        }
        
        // Save current canvas state
        CANVAS_STATE.history.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
        CANVAS_STATE.historyIndex = CANVAS_STATE.history.length - 1;
        
        // Limit history size
        if (CANVAS_STATE.history.length > 50) {
            CANVAS_STATE.history.shift();
            CANVAS_STATE.historyIndex--;
        }
    }

    function restoreFromHistory(index) {
        if (index >= 0 && index < CANVAS_STATE.history.length) {
            ctx.putImageData(CANVAS_STATE.history[index], 0, 0);
        }
    }

    function loadSavedDrawings() {
        const savedDrawings = localStorage.getItem('stl_canvas_drawings');
        if (savedDrawings) {
            try {
                CANVAS_STATE.drawings = JSON.parse(savedDrawings);
            } catch (error) {
                console.error('Error loading saved drawings:', error);
                CANVAS_STATE.drawings = [];
            }
        }
    }

    function updateThumbnails() {
        const thumbnailsContainer = document.getElementById('drawingThumbnails');
        
        if (CANVAS_STATE.drawings.length === 0) {
            thumbnailsContainer.innerHTML = '<p class="text-gray-500 text-center">No saved drawings</p>';
            return;
        }
        
        thumbnailsContainer.innerHTML = CANVAS_STATE.drawings.map(drawing => `
            <div class="drawing-thumbnail" data-id="${drawing.id}">
                <img src="${drawing.dataUrl}" alt="${drawing.description}">
                <div class="thumbnail-actions">
                    <button class="thumbnail-btn load" onclick="loadDrawing('${drawing.id}')">
                        <i class="fas fa-upload"></i>
                    </button>
                    <button class="thumbnail-btn delete" onclick="deleteDrawing('${drawing.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }

    function loadDrawing(drawingId) {
        const drawing = CANVAS_STATE.drawings.find(d => d.id === drawingId);
        if (drawing) {
            const img = new Image();
            img.onload = function() {
                ctx.fillStyle = canvasBackground;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                saveToHistory();
            };
            img.src = drawing.dataUrl;
            updateDynamicIsland('ðŸ–¼ï¸ Drawing loaded', 1500);
        }
    }

    function deleteDrawing(drawingId) {
        CANVAS_STATE.drawings = CANVAS_STATE.drawings.filter(d => d.id !== drawingId);
        localStorage.setItem('stl_canvas_drawings', JSON.stringify(CANVAS_STATE.drawings));
        updateThumbnails();
        updateDynamicIsland('ðŸ—‘ï¸ Drawing deleted', 1500);
    }

    // Modify the existing addToImportantHistory function to handle drawings
    const originalAddToImportantHistory = window.addToImportantHistory;
    window.addToImportantHistory = function(data) {
        if (data.type === 'drawing') {
            const importantHistory = JSON.parse(localStorage.getItem('stl_important_history') || '[]');
            
            // Check if already exists
            if (!importantHistory.find(item => item.id === data.id)) {
                importantHistory.unshift(data);
                
                // Keep only last 10 items
                if (importantHistory.length > 10) {
                    importantHistory.pop();
                }
                
                localStorage.setItem('stl_important_history', JSON.stringify(importantHistory));
                
                // Update the important history list if the left sidebar is open
                if (document.getElementById('leftSidebar').classList.contains('active')) {
                    loadImportantHistory();
                }
            }
        } else {
            // Call the original function for transaction data
            if (originalAddToImportantHistory) {
                originalAddToImportantHistory(data);
            }
        }
    };

    // Modify the existing loadImportantHistory function to display drawings
    const originalLoadImportantHistory = window.loadImportantHistory;
    window.loadImportantHistory = function() {
        const importantHistory = JSON.parse(localStorage.getItem('stl_important_history') || '[]');
        const container = document.getElementById('importantHistoryList');
        
        if (importantHistory.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-center text-sm">Belum ada riwayat penting</p>';
            return;
        }
        
        container.innerHTML = importantHistory.map(item => {
            if (item.type === 'drawing') {
                return `
                    <div class="flex flex-col p-2 bg-gray-50 dark:bg-gray-800 rounded-lg mb-2 drawing-item" draggable="true" data-id="${item.id}">
                        <div class="flex justify-between items-center mb-2">
                            <div class="font-medium text-sm">${item.description}</div>
                            <button class="enhanced-btn btn-error text-xs compact-btn remove-important" data-id="${item.id}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <img src="${item.dataUrl}" alt="${item.description}" class="w-full h-20 object-contain bg-white rounded border">
                        <div class="text-xs text-gray-500 mt-1">${new Date(item.date).toLocaleDateString('id-ID')}</div>
                    </div>
                `;
            } else {
                // Original transaction item
                return `
                    <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-800 rounded-lg mb-2 transaction-item" draggable="true" data-id="${item.id}">
                        <div class="flex-1">
                            <div class="font-medium text-sm">${item.description}</div>
                            <div class="text-xs text-gray-500">Rp ${formatCurrency(item.amount)} â€¢ ${new Date(item.date).toLocaleDateString('id-ID')}</div>
                        </div>
                        <button class="enhanced-btn btn-error text-xs compact-btn remove-important" data-id="${item.id}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }
        }).join('');
        
        // Add event listeners for remove buttons
        document.querySelectorAll('.remove-important').forEach(button => {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                removeFromImportantHistory(id);
            });
        });
        
        // Add drag and drop functionality
        document.querySelectorAll('.drawing-item, .transaction-item').forEach(item => {
            item.addEventListener('dragstart', handleDragStart);
        });
    };

    // Drag and drop functionality for printing
    function handleDragStart(e) {
        const itemId = e.target.getAttribute('data-id');
        e.dataTransfer.setData('text/plain', itemId);
        e.dataTransfer.effectAllowed = 'copy';
    }

    // Add drop zone to print preview modal
    document.addEventListener('DOMContentLoaded', function() {
        const printContent = document.getElementById('printContent');
        if (printContent) {
            printContent.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
            });
            
            printContent.addEventListener('drop', function(e) {
                e.preventDefault();
                const itemId = e.dataTransfer.getData('text/plain');
                addItemToPrintPreview(itemId);
            });
        }
    });

    function addItemToPrintPreview(itemId) {
        const importantHistory = JSON.parse(localStorage.getItem('stl_important_history') || '[]');
        const item = importantHistory.find(i => i.id === itemId);
        
        if (!item) return;
        
        const printContent = document.getElementById('printContent');
        
        if (item.type === 'drawing') {
            const imgElement = document.createElement('img');
            imgElement.src = item.dataUrl;
            imgElement.style.maxWidth = '100%';
            imgElement.style.height = 'auto';
            imgElement.style.marginBottom = '10px';
            
            const description = document.createElement('p');
            description.textContent = item.description;
            description.style.textAlign = 'center';
            description.style.marginBottom = '10px';
            
            printContent.appendChild(description);
            printContent.appendChild(imgElement);
        } else {
            // For transaction items, create a table row
            const transactionRow = document.createElement('tr');
            transactionRow.innerHTML = `
                <td>${new Date(item.date).toLocaleDateString('id-ID')}</td>
                <td>${item.description}</td>
                <td>${FINANCIAL_STATE.categories[item.fund].name}</td>
                <td>${item.type === 'debit' ? 'Pemasukan' : 'Pengeluaran'}</td>
                <td class="${item.type === 'debit' ? 'text-green-600' : 'text-red-600'}">
                    ${item.type === 'debit' ? '+' : '-'} Rp ${formatCurrency(item.amount)}
                </td>
            `;
            
            // Find or create the table
            let table = printContent.querySelector('.print-table');
            if (!table) {
                table = document.createElement('table');
                table.className = 'print-table';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Keterangan</th>
                            <th>Jenis Dana</th>
                            <th>Jenis</th>
                            <th>Jumlah</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                printContent.appendChild(table);
            }
            
            const tbody = table.querySelector('tbody');
            tbody.appendChild(transactionRow);
        }
        
        updateDynamicIsland('ðŸ“„ Item added to print preview', 1500);
    }
</script>
<!-- Tambahkan tombol kalkulator di atas tombol canvas -->
<button id="openCalculatorPanel" class="calculator-panel-toggle">
    <i class="fas fa-calculator"></i>
</button>

<!-- Tambahkan panel kalkulator -->
<div id="calculatorPanel" class="calculator-panel">
    <div class="calculator-header">
        <h3><i class="fas fa-calculator"></i> Financial Calculator Pro</h3>
        <button id="closeCalculatorPanel" class="enhanced-btn btn-error compact-btn">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div class="calculator-content">
        <div class="calculator-tabs">
            <button class="calc-tab active" data-tab="basic">Basic</button>
            <button class="calc-tab" data-tab="finance">Finance</button>
            <button class="calc-tab" data-tab="loan">Loan</button>
            <button class="calc-tab" data-tab="investment">Investment</button>
            <button class="calc-tab" data-tab="tax">Tax</button>
            <button class="calc-tab" data-tab="currency">Currency</button>
        </div>
        
        <!-- Basic Calculator Tab -->
        <div id="basic" class="calc-tab-content active">
            <div class="calculator-display">
                <input type="text" id="calcDisplay" readonly value="0" class="calc-display-input">
            </div>
            <div class="calculator-buttons">
                <button class="calc-btn func-btn" data-action="clear">C</button>
                <button class="calc-btn func-btn" data-action="clear-entry">CE</button>
                <button class="calc-btn func-btn" data-action="backspace">âŒ«</button>
                <button class="calc-btn op-btn" data-action="divide">Ã·</button>
                
                <button class="calc-btn num-btn" data-number="7">7</button>
                <button class="calc-btn num-btn" data-number="8">8</button>
                <button class="calc-btn num-btn" data-number="9">9</button>
                <button class="calc-btn op-btn" data-action="multiply">Ã—</button>
                
                <button class="calc-btn num-btn" data-number="4">4</button>
                <button class="calc-btn num-btn" data-number="5">5</button>
                <button class="calc-btn num-btn" data-number="6">6</button>
                <button class="calc-btn op-btn" data-action="subtract">âˆ’</button>
                
                <button class="calc-btn num-btn" data-number="1">1</button>
                <button class="calc-btn num-btn" data-number="2">2</button>
                <button class="calc-btn num-btn" data-number="3">3</button>
                <button class="calc-btn op-btn" data-action="add">+</button>
                
                <button class="calc-btn num-btn" data-number="0">0</button>
                <button class="calc-btn num-btn" data-number=".">.</button>
                <button class="calc-btn op-btn" data-action="equals">=</button>
                <button class="calc-btn op-btn" data-action="percentage">%</button>
            </div>
        </div>
        
        <!-- Financial Calculator Tab -->
        <div id="finance" class="calc-tab-content">
            <div class="finance-calculator">
                <div class="calc-form">
                    <div class="form-group">
                        <label>Future Value (FV) Calculator</label>
                        <div class="input-grid">
                            <div>
                                <input type="number" id="pv" placeholder="Present Value" class="enhanced-input compact-input">
                                <small>Present Value</small>
                            </div>
                            <div>
                                <input type="number" id="rate" placeholder="Interest Rate %" class="enhanced-input compact-input">
                                <small>Annual Rate (%)</small>
                            </div>
                            <div>
                                <input type="number" id="periods" placeholder="Periods" class="enhanced-input compact-input">
                                <small>Number of Periods</small>
                            </div>
                        </div>
                        <button id="calculateFV" class="enhanced-btn btn-primary compact-btn">Calculate FV</button>
                        <div class="result-display">
                            Future Value: <span id="fvResult">-</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Present Value (PV) Calculator</label>
                        <div class="input-grid">
                            <div>
                                <input type="number" id="fv" placeholder="Future Value" class="enhanced-input compact-input">
                                <small>Future Value</small>
                            </div>
                            <div>
                                <input type="number" id="pvRate" placeholder="Interest Rate %" class="enhanced-input compact-input">
                                <small>Annual Rate (%)</small>
                            </div>
                            <div>
                                <input type="number" id="pvPeriods" placeholder="Periods" class="enhanced-input compact-input">
                                <small>Number of Periods</small>
                            </div>
                        </div>
                        <button id="calculatePV" class="enhanced-btn btn-primary compact-btn">Calculate PV</button>
                        <div class="result-display">
                            Present Value: <span id="pvResult">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Loan Calculator Tab -->
        <div id="loan" class="calc-tab-content">
            <div class="loan-calculator">
                <div class="calc-form">
                    <div class="form-group">
                        <label>Loan Calculator</label>
                        <div class="input-grid">
                            <div>
                                <input type="number" id="loanAmount" placeholder="Loan Amount" class="enhanced-input compact-input">
                                <small>Loan Amount</small>
                            </div>
                            <div>
                                <input type="number" id="loanRate" placeholder="Interest Rate %" class="enhanced-input compact-input">
                                <small>Annual Interest Rate (%)</small>
                            </div>
                            <div>
                                <input type="number" id="loanTerm" placeholder="Loan Term" class="enhanced-input compact-input">
                                <small>Term (years)</small>
                            </div>
                        </div>
                        <button id="calculateLoan" class="enhanced-btn btn-primary compact-btn">Calculate Loan</button>
                        <div class="result-display loan-results">
                            <div>Monthly Payment: <span id="monthlyPayment">-</span></div>
                            <div>Total Payment: <span id="totalPayment">-</span></div>
                            <div>Total Interest: <span id="totalInterest">-</span></div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Mortgage Calculator</label>
                        <div class="input-grid">
                            <div>
                                <input type="number" id="mortgageAmount" placeholder="Mortgage Amount" class="enhanced-input compact-input">
                                <small>Mortgage Amount</small>
                            </div>
                            <div>
                                <input type="number" id="mortgageRate" placeholder="Interest Rate %" class="enhanced-input compact-input">
                                <small>Annual Interest Rate (%)</small>
                            </div>
                            <div>
                                <input type="number" id="mortgageTerm" placeholder="Loan Term" class="enhanced-input compact-input">
                                <small>Term (years)</small>
                            </div>
                        </div>
                        <button id="calculateMortgage" class="enhanced-btn btn-primary compact-btn">Calculate Mortgage</button>
                        <div class="result-display">
                            Monthly Payment: <span id="mortgagePayment">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Investment Calculator Tab -->
        <div id="investment" class="calc-tab-content">
            <div class="investment-calculator">
                <div class="calc-form">
                    <div class="form-group">
                        <label>Compound Interest Calculator</label>
                        <div class="input-grid">
                            <div>
                                <input type="number" id="principal" placeholder="Principal" class="enhanced-input compact-input">
                                <small>Initial Investment</small>
                            </div>
                            <div>
                                <input type="number" id="annualRate" placeholder="Annual Rate %" class="enhanced-input compact-input">
                                <small>Annual Interest Rate (%)</small>
                            </div>
                            <div>
                                <input type="number" id="years" placeholder="Years" class="enhanced-input compact-input">
                                <small>Number of Years</small>
                            </div>
                            <div>
                                <input type="number" id="compoundFreq" placeholder="Compound Freq" value="12" class="enhanced-input compact-input">
                                <small>Compound Frequency</small>
                            </div>
                        </div>
                        <button id="calculateCompound" class="enhanced-btn btn-primary compact-btn">Calculate</button>
                        <div class="result-display">
                            Future Value: <span id="compoundResult">-</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>ROI (Return on Investment) Calculator</label>
                        <div class="input-grid">
                            <div>
                                <input type="number" id="investmentGain" placeholder="Gain from Investment" class="enhanced-input compact-input">
                                <small>Gain from Investment</small>
                            </div>
                            <div>
                                <input type="number" id="investmentCost" placeholder="Cost of Investment" class="enhanced-input compact-input">
                                <small>Cost of Investment</small>
                            </div>
                        </div>
                        <button id="calculateROI" class="enhanced-btn btn-primary compact-btn">Calculate ROI</button>
                        <div class="result-display">
                            ROI: <span id="roiResult">-</span>%
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tax Calculator Tab -->
        <div id="tax" class="calc-tab-content">
            <div class="tax-calculator">
                <div class="calc-form">
                    <div class="form-group">
                        <label>Income Tax Calculator (Indonesia)</label>
                        <div class="input-grid">
                            <div>
                                <input type="number" id="annualIncome" placeholder="Annual Income" class="enhanced-input compact-input">
                                <small>Annual Income (IDR)</small>
                            </div>
                            <div>
                                <input type="number" id="taxDeductions" placeholder="Deductions" class="enhanced-input compact-input">
                                <small>Tax Deductions (IDR)</small>
                            </div>
                        </div>
                        <button id="calculateTax" class="enhanced-btn btn-primary compact-btn">Calculate Tax</button>
                        <div class="result-display tax-results">
                            <div>Taxable Income: <span id="taxableIncome">-</span></div>
                            <div>Income Tax: <span id="incomeTax">-</span></div>
                            <div>Effective Tax Rate: <span id="effectiveTaxRate">-</span>%</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>PPN (VAT) Calculator</label>
                        <div class="input-grid">
                            <div>
                                <input type="number" id="priceBeforeTax" placeholder="Price before Tax" class="enhanced-input compact-input">
                                <small>Price before Tax (IDR)</small>
                            </div>
                            <div>
                                <input type="number" id="vatRate" placeholder="VAT Rate %" value="11" class="enhanced-input compact-input">
                                <small>VAT Rate (%)</small>
                            </div>
                        </div>
                        <button id="calculateVAT" class="enhanced-btn btn-primary compact-btn">Calculate VAT</button>
                        <div class="result-display">
                            Price after VAT: <span id="priceAfterVAT">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Currency Calculator Tab -->
        <div id="currency" class="calc-tab-content">
            <div class="currency-calculator">
                <div class="calc-form">
                    <div class="form-group">
                        <label>Currency Converter</label>
                        <div class="input-grid">
                            <div>
                                <input type="number" id="currencyAmount" placeholder="Amount" class="enhanced-input compact-input">
                                <small>Amount</small>
                            </div>
                            <div>
                                <select id="fromCurrencyCalc" class="enhanced-input compact-input">
                                    <option value="IDR">IDR - Rupiah</option>
                                    <option value="USD">USD - Dolar AS</option>
                                    <option value="EUR">EUR - Euro</option>
                                    <option value="GBP">GBP - Pound</option>
                                    <option value="JPY">JPY - Yen</option>
                                </select>
                                <small>From Currency</small>
                            </div>
                            <div>
                                <select id="toCurrencyCalc" class="enhanced-input compact-input">
                                    <option value="USD">USD - Dolar AS</option>
                                    <option value="IDR">IDR - Rupiah</option>
                                    <option value="EUR">EUR - Euro</option>
                                    <option value="GBP">GBP - Pound</option>
                                    <option value="JPY">JPY - Yen</option>
                                </select>
                                <small>To Currency</small>
                            </div>
                        </div>
                        <button id="convertCurrency" class="enhanced-btn btn-primary compact-btn">Convert</button>
                        <div class="result-display">
                            Converted Amount: <span id="convertedAmount">-</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Exchange Rates (1 IDR = )</label>
                        <div class="exchange-rates">
                            <div class="rate-item">
                                <span>USD:</span>
                                <span id="usdRate">0.000064</span>
                            </div>
                            <div class="rate-item">
                                <span>EUR:</span>
                                <span id="eurRate">0.000059</span>
                            </div>
                            <div class="rate-item">
                                <span>GBP:</span>
                                <span id="gbpRate">0.000050</span>
                            </div>
                            <div class="rate-item">
                                <span>JPY:</span>
                                <span id="jpyRate">0.0096</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="calculator-history">
            <h4>Calculation History</h4>
            <div id="calcHistory" class="history-list">
                <!-- History items will appear here -->
            </div>
            <button id="clearHistory" class="enhanced-btn btn-warning compact-btn">Clear History</button>
        </div>
    </div>
</div>

<style>
    /* ==================== CALCULATOR PANEL STYLES ==================== */
    .calculator-panel-toggle {
        position: fixed;
        bottom: 100px;
        right: 20px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        box-shadow: var(--ios-shadow);
        z-index: 1000;
        cursor: pointer;
        transition: var(--ios-transition);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .calculator-panel-toggle:hover {
        transform: translateY(-5px) scale(1.1);
        box-shadow: 0 15px 40px rgba(16, 185, 129, 0.4);
    }

    .calculator-panel {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        width: 95%;
        max-width: 500px;
        max-height: 90vh;
        background: var(--theme-card);
        border-radius: var(--radius-2xl);
        box-shadow: var(--ios-shadow);
        z-index: 10001;
        opacity: 0;
        visibility: hidden;
        transition: var(--ios-transition);
        overflow: hidden;
        border: 1px solid var(--theme-border);
    }

    .calculator-panel.active {
        opacity: 1;
        visibility: visible;
        transform: translate(-50%, -50%) scale(1);
    }

    .calculator-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .calculator-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
    }

    .calculator-content {
        padding: 20px;
        overflow-y: auto;
        max-height: calc(90vh - 70px);
    }

    .calculator-tabs {
        display: flex;
        gap: 5px;
        margin-bottom: 15px;
        overflow-x: auto;
        scrollbar-width: none;
    }

    .calculator-tabs::-webkit-scrollbar {
        display: none;
    }

    .calc-tab {
        padding: 8px 12px;
        border-radius: var(--radius-lg);
        background: var(--theme-bg);
        border: 1px solid var(--theme-border);
        cursor: pointer;
        transition: var(--ios-transition);
        white-space: nowrap;
        font-weight: 600;
        font-size: 12px;
        flex-shrink: 0;
    }

    .calc-tab.active {
        background: var(--gradient-primary);
        color: white;
        border-color: var(--theme-primary);
    }

    .calc-tab-content {
        display: none;
        margin-bottom: 15px;
    }

    .calc-tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    /* Basic Calculator Styles */
    .calculator-display {
        margin-bottom: 15px;
    }

    .calc-display-input {
        width: 100%;
        padding: 15px;
        font-size: 24px;
        text-align: right;
        border: 2px solid var(--theme-border);
        border-radius: var(--radius-lg);
        background: var(--theme-card);
        color: var(--theme-text);
        font-family: monospace;
    }

    .calculator-buttons {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
        margin-bottom: 15px;
    }

    .calc-btn {
        padding: 15px;
        border: none;
        border-radius: var(--radius-lg);
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--ios-transition);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .num-btn {
        background: var(--theme-bg);
        color: var(--theme-text);
        border: 1px solid var(--theme-border);
    }

    .num-btn:hover {
        background: color-mix(in srgb, var(--theme-bg) 90%, var(--theme-primary));
    }

    .op-btn {
        background: var(--gradient-primary);
        color: white;
    }

    .op-btn:hover {
        opacity: 0.9;
        transform: translateY(-2px);
    }

    .func-btn {
        background: var(--theme-border);
        color: var(--theme-text);
    }

    .func-btn:hover {
        background: color-mix(in srgb, var(--theme-border) 80%, #000);
    }

    /* Advanced Calculator Styles */
    .calc-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .form-group {
        padding: 15px;
        background: var(--theme-bg);
        border-radius: var(--radius-lg);
        border: 1px solid var(--theme-border);
    }

    .form-group label {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        color: var(--theme-text);
    }

    .input-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        margin-bottom: 10px;
    }

    .input-grid input, .input-grid select {
        margin-bottom: 5px;
    }

    .input-grid small {
        display: block;
        font-size: 10px;
        color: var(--theme-text);
        opacity: 0.7;
    }

    .result-display {
        margin-top: 10px;
        padding: 10px;
        background: rgba(16, 185, 129, 0.1);
        border-radius: var(--radius-lg);
        border: 1px solid rgba(16, 185, 129, 0.2);
        font-weight: 600;
        color: #10b981;
    }

    .loan-results, .tax-results {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .exchange-rates {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin-top: 10px;
    }

    .rate-item {
        display: flex;
        justify-content: space-between;
        padding: 5px 10px;
        background: var(--theme-bg);
        border-radius: var(--radius-lg);
        font-size: 12px;
    }

    .calculator-history {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid var(--theme-border);
    }

    .calculator-history h4 {
        margin-bottom: 10px;
        color: var(--theme-text);
    }

    .history-list {
        max-height: 150px;
        overflow-y: auto;
        margin-bottom: 10px;
        padding: 10px;
        background: var(--theme-bg);
        border-radius: var(--radius-lg);
    }

    .history-item {
        padding: 8px;
        border-bottom: 1px solid var(--theme-border);
        font-family: monospace;
        font-size: 12px;
    }

    .history-item:last-child {
        border-bottom: none;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .calculator-buttons {
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        
        .calc-btn {
            padding: 12px;
            font-size: 16px;
        }
        
        .input-grid {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 480px) {
        .calculator-panel {
            width: 98%;
        }
        
        .calculator-content {
            padding: 15px;
        }
        
        .calculator-tabs {
            gap: 3px;
        }
        
        .calc-tab {
            padding: 6px 8px;
            font-size: 10px;
        }
        
        .calc-display-input {
            font-size: 20px;
            padding: 12px;
        }
    }
</style>

<script>
    // ==================== CALCULATOR LOGIC ====================
    const CALC_STATE = {
        currentValue: '0',
        previousValue: '',
        operation: null,
        waitingForNewValue: false,
        calculationHistory: []
    };

    // Initialize calculator
    document.addEventListener('DOMContentLoaded', function() {
        setupCalculatorEventListeners();
        initializeCalculator();
        loadCalculationHistory();
        updateExchangeRates();
    });

    function setupCalculatorEventListeners() {
        // Toggle calculator panel
        document.getElementById('openCalculatorPanel').addEventListener('click', openCalculatorPanel);
        document.getElementById('closeCalculatorPanel').addEventListener('click', closeCalculatorPanel);
        
        // Calculator tabs
        document.querySelectorAll('.calc-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                switchCalcTab(this.getAttribute('data-tab'));
            });
        });
        
        // Basic calculator buttons
        document.querySelectorAll('.num-btn').forEach(button => {
            button.addEventListener('click', function() {
                inputNumber(this.getAttribute('data-number'));
            });
        });
        
        document.querySelectorAll('.op-btn').forEach(button => {
            button.addEventListener('click', function() {
                inputOperation(this.getAttribute('data-action'));
            });
        });
        
        document.querySelectorAll('.func-btn').forEach(button => {
            button.addEventListener('click', function() {
                inputFunction(this.getAttribute('data-action'));
            });
        });
        
        // Advanced calculator functions
        document.getElementById('calculateFV').addEventListener('click', calculateFutureValue);
        document.getElementById('calculatePV').addEventListener('click', calculatePresentValue);
        document.getElementById('calculateLoan').addEventListener('click', calculateLoan);
        document.getElementById('calculateMortgage').addEventListener('click', calculateMortgage);
        document.getElementById('calculateCompound').addEventListener('click', calculateCompoundInterest);
        document.getElementById('calculateROI').addEventListener('click', calculateROI);
        document.getElementById('calculateTax').addEventListener('click', calculateTax);
        document.getElementById('calculateVAT').addEventListener('click', calculateVAT);
        document.getElementById('convertCurrency').addEventListener('click', convertCurrency);
        document.getElementById('clearHistory').addEventListener('click', clearCalculationHistory);
        
        // Keyboard support for basic calculator
        document.addEventListener('keydown', handleKeyboardInput);
    }

    function initializeCalculator() {
        updateDisplay();
    }

    function openCalculatorPanel() {
        document.getElementById('calculatorPanel').classList.add('active');
        updateCalculationHistoryDisplay();
    }

    function closeCalculatorPanel() {
        document.getElementById('calculatorPanel').classList.remove('active');
    }

    function switchCalcTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.calc-tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // Remove active class from all tabs
        document.querySelectorAll('.calc-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Show selected tab content
        document.getElementById(tabName).classList.add('active');
        
        // Add active class to clicked tab
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    }

    // ==================== BASIC CALCULATOR FUNCTIONS ====================
    function inputNumber(num) {
        if (CALC_STATE.waitingForNewValue) {
            CALC_STATE.currentValue = num;
            CALC_STATE.waitingForNewValue = false;
        } else {
            CALC_STATE.currentValue = CALC_STATE.currentValue === '0' ? num : CALC_STATE.currentValue + num;
        }
        updateDisplay();
    }

    function inputOperation(action) {
        const inputValue = parseFloat(CALC_STATE.currentValue);
        
        if (CALC_STATE.previousValue === '') {
            CALC_STATE.previousValue = inputValue;
        } else if (CALC_STATE.operation) {
            const result = calculate();
            CALC_STATE.currentValue = `${parseFloat(result.toFixed(7))}`;
            CALC_STATE.previousValue = result;
        }
        
        CALC_STATE.waitingForNewValue = true;
        CALC_STATE.operation = action;
    }

    function inputFunction(action) {
        switch(action) {
            case 'clear':
                CALC_STATE.currentValue = '0';
                CALC_STATE.previousValue = '';
                CALC_STATE.operation = null;
                CALC_STATE.waitingForNewValue = false;
                break;
            case 'clear-entry':
                CALC_STATE.currentValue = '0';
                break;
            case 'backspace':
                if (CALC_STATE.currentValue.length > 1) {
                    CALC_STATE.currentValue = CALC_STATE.currentValue.slice(0, -1);
                } else {
                    CALC_STATE.currentValue = '0';
                }
                break;
            case 'percentage':
                CALC_STATE.currentValue = `${parseFloat(CALC_STATE.currentValue) / 100}`;
                break;
            case 'equals':
                if (CALC_STATE.operation) {
                    const result = calculate();
                    
                    // Add to history
                    addToCalculationHistory(
                        `${CALC_STATE.previousValue} ${getOperationSymbol(CALC_STATE.operation)} ${parseFloat(CALC_STATE.currentValue)} = ${result}`
                    );
                    
                    CALC_STATE.currentValue = `${parseFloat(result.toFixed(7))}`;
                    CALC_STATE.previousValue = '';
                    CALC_STATE.operation = null;
                    CALC_STATE.waitingForNewValue = true;
                }
                break;
        }
        updateDisplay();
    }

    function calculate() {
        const prev = parseFloat(CALC_STATE.previousValue);
        const current = parseFloat(CALC_STATE.currentValue);
        
        if (isNaN(prev) || isNaN(current)) return 0;
        
        switch(CALC_STATE.operation) {
            case 'add':
                return prev + current;
            case 'subtract':
                return prev - current;
            case 'multiply':
                return prev * current;
            case 'divide':
                return prev / current;
            default:
                return current;
        }
    }

    function getOperationSymbol(operation) {
        switch(operation) {
            case 'add': return '+';
            case 'subtract': return 'âˆ’';
            case 'multiply': return 'Ã—';
            case 'divide': return 'Ã·';
            default: return '';
        }
    }

    function updateDisplay() {
        document.getElementById('calcDisplay').value = CALC_STATE.currentValue;
    }

    function handleKeyboardInput(e) {
        if (!document.getElementById('calculatorPanel').classList.contains('active')) return;
        
        if (e.key >= '0' && e.key <= '9') {
            inputNumber(e.key);
        } else if (e.key === '.') {
            inputNumber('.');
        } else if (e.key === '+') {
            inputOperation('add');
        } else if (e.key === '-') {
            inputOperation('subtract');
        } else if (e.key === '*') {
            inputOperation('multiply');
        } else if (e.key === '/') {
            e.preventDefault();
            inputOperation('divide');
        } else if (e.key === 'Enter' || e.key === '=') {
            inputOperation('equals');
        } else if (e.key === 'Escape') {
            inputFunction('clear');
        } else if (e.key === 'Backspace') {
            inputFunction('backspace');
        } else if (e.key === '%') {
            inputFunction('percentage');
        }
    }

    // ==================== FINANCIAL CALCULATOR FUNCTIONS ====================
    function calculateFutureValue() {
        const pv = parseFloat(document.getElementById('pv').value);
        const rate = parseFloat(document.getElementById('rate').value) / 100;
        const periods = parseFloat(document.getElementById('periods').value);
        
        if (isNaN(pv) || isNaN(rate) || isNaN(periods)) {
            alert('Please fill in all fields');
            return;
        }
        
        const fv = pv * Math.pow(1 + rate, periods);
        document.getElementById('fvResult').textContent = formatCurrency(fv);
        
        addToCalculationHistory(`FV: PV=${pv}, Rate=${rate*100}%, Periods=${periods} = ${fv}`);
    }

    function calculatePresentValue() {
        const fv = parseFloat(document.getElementById('fv').value);
        const rate = parseFloat(document.getElementById('pvRate').value) / 100;
        const periods = parseFloat(document.getElementById('pvPeriods').value);
        
        if (isNaN(fv) || isNaN(rate) || isNaN(periods)) {
            alert('Please fill in all fields');
            return;
        }
        
        const pv = fv / Math.pow(1 + rate, periods);
        document.getElementById('pvResult').textContent = formatCurrency(pv);
        
        addToCalculationHistory(`PV: FV=${fv}, Rate=${rate*100}%, Periods=${periods} = ${pv}`);
    }

    // ==================== LOAN CALCULATOR FUNCTIONS ====================
    function calculateLoan() {
        const amount = parseFloat(document.getElementById('loanAmount').value);
        const rate = parseFloat(document.getElementById('loanRate').value) / 100 / 12;
        const term = parseFloat(document.getElementById('loanTerm').value) * 12;
        
        if (isNaN(amount) || isNaN(rate) || isNaN(term)) {
            alert('Please fill in all fields');
            return;
        }
        
        const monthlyPayment = (amount * rate) / (1 - Math.pow(1 + rate, -term));
        const totalPayment = monthlyPayment * term;
        const totalInterest = totalPayment - amount;
        
        document.getElementById('monthlyPayment').textContent = formatCurrency(monthlyPayment);
        document.getElementById('totalPayment').textContent = formatCurrency(totalPayment);
        document.getElementById('totalInterest').textContent = formatCurrency(totalInterest);
        
        addToCalculationHistory(`Loan: Amount=${amount}, Rate=${rate*12*100}%, Term=${term/12}yr = ${monthlyPayment}/month`);
    }

    function calculateMortgage() {
        // For this demo, mortgage calculation is the same as loan
        calculateLoan();
        const monthlyPayment = document.getElementById('monthlyPayment').textContent;
        document.getElementById('mortgagePayment').textContent = monthlyPayment;
    }

    // ==================== INVESTMENT CALCULATOR FUNCTIONS ====================
    function calculateCompoundInterest() {
        const principal = parseFloat(document.getElementById('principal').value);
        const rate = parseFloat(document.getElementById('annualRate').value) / 100;
        const years = parseFloat(document.getElementById('years').value);
        const compoundFreq = parseFloat(document.getElementById('compoundFreq').value);
        
        if (isNaN(principal) || isNaN(rate) || isNaN(years) || isNaN(compoundFreq)) {
            alert('Please fill in all fields');
            return;
        }
        
        const amount = principal * Math.pow(1 + rate / compoundFreq, compoundFreq * years);
        document.getElementById('compoundResult').textContent = formatCurrency(amount);
        
        addToCalculationHistory(`Compound: P=${principal}, Rate=${rate*100}%, Years=${years}, Freq=${compoundFreq} = ${amount}`);
    }

    function calculateROI() {
        const gain = parseFloat(document.getElementById('investmentGain').value);
        const cost = parseFloat(document.getElementById('investmentCost').value);
        
        if (isNaN(gain) || isNaN(cost)) {
            alert('Please fill in all fields');
            return;
        }
        
        const roi = ((gain - cost) / cost) * 100;
        document.getElementById('roiResult').textContent = roi.toFixed(2);
        
        addToCalculationHistory(`ROI: Gain=${gain}, Cost=${cost} = ${roi.toFixed(2)}%`);
    }

    // ==================== TAX CALCULATOR FUNCTIONS ====================
    function calculateTax() {
        const annualIncome = parseFloat(document.getElementById('annualIncome').value);
        const deductions = parseFloat(document.getElementById('taxDeductions').value) || 0;
        
        if (isNaN(annualIncome)) {
            alert('Please fill in annual income');
            return;
        }
        
        // Simplified Indonesian tax calculation (2023 rates)
        const taxableIncome = annualIncome - deductions - 54000000; // PTKP for single person
        
        if (taxableIncome <= 0) {
            document.getElementById('taxableIncome').textContent = '0';
            document.getElementById('incomeTax').textContent = '0';
            document.getElementById('effectiveTaxRate').textContent = '0';
            return;
        }
        
        let tax = 0;
        
        // Tax brackets (simplified)
        if (taxableIncome <= 60000000) {
            tax = taxableIncome * 0.05;
        } else if (taxableIncome <= 250000000) {
            tax = 60000000 * 0.05 + (taxableIncome - 60000000) * 0.15;
        } else if (taxableIncome <= 500000000) {
            tax = 60000000 * 0.05 + 190000000 * 0.15 + (taxableIncome - 250000000) * 0.25;
        } else if (taxableIncome <= 5000000000) {
            tax = 60000000 * 0.05 + 190000000 * 0.15 + 250000000 * 0.25 + (taxableIncome - 500000000) * 0.30;
        } else {
            tax = taxableIncome * 0.30;
        }
        
        const effectiveRate = (tax / annualIncome) * 100;
        
        document.getElementById('taxableIncome').textContent = formatCurrency(taxableIncome);
        document.getElementById('incomeTax').textContent = formatCurrency(tax);
        document.getElementById('effectiveTaxRate').textContent = effectiveRate.toFixed(2);
        
        addToCalculationHistory(`Tax: Income=${annualIncome}, Deductions=${deductions} = Tax ${tax}`);
    }

    function calculateVAT() {
        const priceBeforeTax = parseFloat(document.getElementById('priceBeforeTax').value);
        const vatRate = parseFloat(document.getElementById('vatRate').value) / 100;
        
        if (isNaN(priceBeforeTax) || isNaN(vatRate)) {
            alert('Please fill in all fields');
            return;
        }
        
        const priceAfterVAT = priceBeforeTax * (1 + vatRate);
        document.getElementById('priceAfterVAT').textContent = formatCurrency(priceAfterVAT);
        
        addToCalculationHistory(`VAT: Price=${priceBeforeTax}, Rate=${vatRate*100}% = ${priceAfterVAT}`);
    }

    // ==================== CURRENCY CALCULATOR FUNCTIONS ====================
    function convertCurrency() {
        const amount = parseFloat(document.getElementById('currencyAmount').value);
        const fromCurrency = document.getElementById('fromCurrencyCalc').value;
        const toCurrency = document.getElementById('toCurrencyCalc').value;
        
        if (isNaN(amount)) {
            alert('Please enter an amount');
            return;
        }
        
        // Simplified exchange rates (in reality, you would use an API)
        const rates = {
            'IDR': 1,
            'USD': 0.000064,
            'EUR': 0.000059,
            'GBP': 0.000050,
            'JPY': 0.0096
        };
        
        // Convert to IDR first, then to target currency
        const amountInIDR = fromCurrency === 'IDR' ? amount : amount / rates[fromCurrency];
        const convertedAmount = toCurrency === 'IDR' ? amountInIDR : amountInIDR * rates[toCurrency];
        
        document.getElementById('convertedAmount').textContent = formatCurrency(convertedAmount);
        
        addToCalculationHistory(`Currency: ${amount} ${fromCurrency} = ${convertedAmount.toFixed(2)} ${toCurrency}`);
    }

    function updateExchangeRates() {
        // In a real application, you would fetch these from an API
        document.getElementById('usdRate').textContent = '0.000064';
        document.getElementById('eurRate').textContent = '0.000059';
        document.getElementById('gbpRate').textContent = '0.000050';
        document.getElementById('jpyRate').textContent = '0.0096';
    }

    // ==================== HISTORY FUNCTIONS ====================
    function addToCalculationHistory(calculation) {
        CALC_STATE.calculationHistory.unshift({
            calculation: calculation,
            timestamp: new Date().toLocaleString('id-ID')
        });
        
        // Keep only last 20 calculations
        if (CALC_STATE.calculationHistory.length > 20) {
            CALC_STATE.calculationHistory.pop();
        }
        
        updateCalculationHistoryDisplay();
        saveCalculationHistory();
    }

    function updateCalculationHistoryDisplay() {
        const historyList = document.getElementById('calcHistory');
        
        if (CALC_STATE.calculationHistory.length === 0) {
            historyList.innerHTML = '<div class="text-gray-500 text-center">No calculation history</div>';
            return;
        }
        
        historyList.innerHTML = CALC_STATE.calculationHistory.map(item => `
            <div class="history-item">
                <div>${item.calculation}</div>
                <small class="text-gray-500">${item.timestamp}</small>
            </div>
        `).join('');
    }

    function clearCalculationHistory() {
        CALC_STATE.calculationHistory = [];
        updateCalculationHistoryDisplay();
        saveCalculationHistory();
        updateDynamicIsland('ðŸ—‘ï¸ Calculation history cleared', 1500);
    }

    function saveCalculationHistory() {
        localStorage.setItem('stl_calc_history', JSON.stringify(CALC_STATE.calculationHistory));
    }

    function loadCalculationHistory() {
        const savedHistory = localStorage.getItem('stl_calc_history');
        if (savedHistory) {
            try {
                CALC_STATE.calculationHistory = JSON.parse(savedHistory);
            } catch (error) {
                console.error('Error loading calculation history:', error);
                CALC_STATE.calculationHistory = [];
            }
        }
    }

    // Utility function for formatting currency (reuse from existing code)
    function formatCurrency(amount) {
        if (typeof amount !== 'number') return '0';
        
        // For large numbers, use the existing format function if available
        if (typeof window.formatCurrency === 'function') {
            return window.formatCurrency(amount);
        }
        
        // Fallback formatting
        return amount.toLocaleString('id-ID', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
</script>
<!-- Tambahkan tombol catatan penting di atas tombol tebak kata -->
<button id="openNotesPanel" class="notes-panel-toggle">
    <i class="fas fa-sticky-note"></i>
</button>

<!-- Tambahkan panel catatan penting -->
<div id="notesPanel" class="notes-panel">
    <div class="notes-header">
        <h3><i class="fas fa-sticky-note"></i> Catatan Penting</h3>
        <button id="closeNotesPanel" class="enhanced-btn btn-error compact-btn">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div class="notes-content">
        <div class="notes-form">
            <div class="input-group">
                <label for="noteTitle">Judul Catatan</label>
                <input type="text" id="noteTitle" class="enhanced-input compact-input" placeholder="Masukkan judul catatan...">
            </div>
            <div class="input-group">
                <label for="noteContent">Isi Catatan</label>
                <textarea id="noteContent" class="enhanced-input compact-input" rows="5" placeholder="Tulis catatan penting Anda di sini..."></textarea>
            </div>
            <div class="notes-actions">
                <button id="saveNote" class="enhanced-btn btn-primary compact-btn">
                    <i class="fas fa-save"></i> Simpan Catatan
                </button>
                <button id="clearNoteForm" class="enhanced-btn btn-warning compact-btn">
                    <i class="fas fa-eraser"></i> Bersihkan
                </button>
            </div>
        </div>
        
        <div class="notes-list">
            <h4>Daftar Catatan</h4>
            <div id="notesContainer" class="notes-container">
                <!-- Catatan akan ditampilkan di sini -->
            </div>
        </div>
    </div>
</div>

<style>
    /* ==================== NOTES PANEL STYLES ==================== */
    .notes-panel-toggle {
        position: fixed;
        bottom: 70px; /* Di atas tombol game tebak kata */
        left: 8px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        box-shadow: var(--ios-shadow);
        z-index: 1001; /* Lebih tinggi dari tombol lain */
        cursor: pointer;
        transition: var(--ios-transition);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px; /* Ukuran lebih kecil */
    }

    .notes-panel-toggle:hover {
        transform: translateY(-5px) scale(1.1);
        box-shadow: 0 15px 40px rgba(16, 185, 129, 0.4);
    }

    .notes-panel {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        width: 95%;
        max-width: 600px;
        max-height: 90vh;
        background: var(--theme-card);
        border-radius: var(--radius-2xl);
        box-shadow: var(--ios-shadow);
        z-index: 10002; /* Lebih tinggi dari panel lain */
        opacity: 0;
        visibility: hidden;
        transition: var(--ios-transition);
        overflow: hidden;
        border: 1px solid var(--theme-border);
    }

    .notes-panel.active {
        opacity: 1;
        visibility: visible;
        transform: translate(-50%, -50%) scale(1);
    }

    .notes-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .notes-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
    }

    .notes-content {
        padding: 20px;
        overflow-y: auto;
        max-height: calc(90vh - 70px);
    }

    .notes-form {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--theme-border);
    }

    .input-group {
        margin-bottom: 15px;
    }

    .input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--theme-text);
    }

    .notes-actions {
        display: flex;
        gap: 10px;
    }

    .notes-actions button {
        flex: 1;
    }

    .notes-list h4 {
        margin-bottom: 10px;
        color: var(--theme-text);
    }

    .notes-container {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--theme-border);
        border-radius: var(--radius-lg);
        padding: 10px;
        background: var(--theme-bg);
    }

    .note-item {
        background: var(--theme-card);
        border: 1px solid var(--theme-border);
        border-radius: var(--radius-lg);
        padding: 15px;
        margin-bottom: 10px;
        transition: var(--ios-transition);
        position: relative;
    }

    .note-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
    }

    .note-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
    }

    .note-title {
        font-weight: 700;
        font-size: 16px;
        color: var(--theme-text);
        margin: 0;
        flex: 1;
        margin-right: 10px;
    }

    .note-actions {
        display: flex;
        gap: 5px;
    }

    .note-btn {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        cursor: pointer;
        transition: var(--ios-transition);
    }

    .note-btn.star {
        background: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
    }

    .note-btn.star:hover {
        background: #f59e0b;
        color: white;
    }

    .note-btn.star.active {
        background: #f59e0b;
        color: white;
    }

    .note-btn.delete {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .note-btn.delete:hover {
        background: #ef4444;
        color: white;
    }

    .note-content {
        color: var(--theme-text);
        font-size: 14px;
        line-height: 1.5;
        margin-bottom: 10px;
        white-space: pre-wrap;
    }

    .note-date {
        font-size: 12px;
        color: var(--theme-text);
        opacity: 0.7;
    }

    .empty-notes {
        text-align: center;
        padding: 20px;
        color: var(--theme-text);
        opacity: 0.7;
    }

    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Responsive adjustments */
    @media (max-width: 480px) {
        .notes-panel {
            width: 98%;
        }
        
        .notes-content {
            padding: 15px;
        }
        
        .notes-actions {
            flex-direction: column;
        }
        
        .notes-panel-toggle {
            bottom: 70px;
            left: 8px;
        }
    }

    /* Pastikan tombol tidak bertumpuk di mobile */
    @media (max-width: 768px) {
        .notes-panel-toggle {
            bottom: 70px;
            left: 8px;
        }
        
        .game-panel-toggle {
            bottom: 40px;
            left: 8px;
        }
        
        .left-sidebar-toggle {
            bottom: 10px;
            left: 8px;
        }
    }
</style>

<script>
    // ==================== NOTES PANEL LOGIC ====================
    // Pastikan variabel global dideklarasikan
    if (typeof NOTES_STATE === 'undefined') {
        var NOTES_STATE = {
            notes: [],
            isPanelOpen: false
        };
    }

    // Initialize notes panel setelah DOM siap
    document.addEventListener('DOMContentLoaded', function() {
        // Tunggu sebentar untuk memastikan semua elemen sudah terload
        setTimeout(function() {
            setupNotesEventListeners();
            loadSavedNotes();
            console.log('Notes panel initialized');
        }, 100);
    });

    function setupNotesEventListeners() {
        // Pastikan elemen ada sebelum menambahkan event listener
        const openBtn = document.getElementById('openNotesPanel');
        const closeBtn = document.getElementById('closeNotesPanel');
        const saveBtn = document.getElementById('saveNote');
        const clearBtn = document.getElementById('clearNoteForm');
        
        if (openBtn) {
            openBtn.addEventListener('click', openNotesPanel);
        } else {
            console.error('openNotesPanel button not found');
        }
        
        if (closeBtn) {
            closeBtn.addEventListener('click', closeNotesPanel);
        }
        
        if (saveBtn) {
            saveBtn.addEventListener('click', saveNote);
        }
        
        if (clearBtn) {
            clearBtn.addEventListener('click', clearNoteForm);
        }
    }

    function openNotesPanel() {
        const panel = document.getElementById('notesPanel');
        if (panel) {
            panel.classList.add('active');
            NOTES_STATE.isPanelOpen = true;
            renderNotes();
        } else {
            console.error('notesPanel not found');
        }
    }

    function closeNotesPanel() {
        const panel = document.getElementById('notesPanel');
        if (panel) {
            panel.classList.remove('active');
            NOTES_STATE.isPanelOpen = false;
        }
    }

    function saveNote() {
        const titleInput = document.getElementById('noteTitle');
        const contentInput = document.getElementById('noteContent');
        
        if (!titleInput || !contentInput) {
            console.error('Note form elements not found');
            return;
        }
        
        const title = titleInput.value.trim();
        const content = contentInput.value.trim();
        
        if (!title || !content) {
            if (typeof updateDynamicIsland !== 'undefined') {
                updateDynamicIsland('âš ï¸ Judul dan isi catatan tidak boleh kosong', 2000);
            } else {
                alert('Judul dan isi catatan tidak boleh kosong');
            }
            return;
        }
        
        const note = {
            id: 'note-' + Date.now(),
            type: 'note',
            title: title,
            content: content,
            date: new Date().toISOString(),
            timestamp: Date.now(),
            isImportant: false
        };
        
        NOTES_STATE.notes.unshift(note);
        saveNotesToStorage();
        renderNotes();
        clearNoteForm();
        
        if (typeof updateDynamicIsland !== 'undefined') {
            updateDynamicIsland('ðŸ“ Catatan disimpan', 1500);
        }
    }

    function clearNoteForm() {
        const titleInput = document.getElementById('noteTitle');
        const contentInput = document.getElementById('noteContent');
        
        if (titleInput) titleInput.value = '';
        if (contentInput) contentInput.value = '';
    }

    function renderNotes() {
        const notesContainer = document.getElementById('notesContainer');
        if (!notesContainer) return;
        
        if (NOTES_STATE.notes.length === 0) {
            notesContainer.innerHTML = `
                <div class="empty-notes">
                    <i class="fas fa-sticky-note fa-2x mb-3"></i>
                    <p>Belum ada catatan</p>
                    <p class="text-sm">Tambahkan catatan pertama Anda menggunakan form di atas</p>
                </div>
            `;
            return;
        }
        
        notesContainer.innerHTML = NOTES_STATE.notes.map(note => `
            <div class="note-item" data-id="${note.id}">
                <div class="note-header">
                    <h4 class="note-title">${escapeHtml(note.title)}</h4>
                    <div class="note-actions">
                        <button class="note-btn star ${note.isImportant ? 'active' : ''}" onclick="toggleNoteImportance('${note.id}')">
                            <i class="fas fa-star"></i>
                        </button>
                        <button class="note-btn delete" onclick="deleteNote('${note.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="note-content">${escapeHtml(note.content)}</div>
                <div class="note-date">${new Date(note.date).toLocaleString('id-ID')}</div>
            </div>
        `).join('');
    }

    // Fungsi helper untuk escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Fungsi global untuk diakses dari onclick
    window.toggleNoteImportance = function(noteId) {
        const noteIndex = NOTES_STATE.notes.findIndex(note => note.id === noteId);
        if (noteIndex === -1) return;
        
        const note = NOTES_STATE.notes[noteIndex];
        note.isImportant = !note.isImportant;
        
        if (note.isImportant) {
            // Add to important history
            addToImportantHistory(note);
            if (typeof updateDynamicIsland !== 'undefined') {
                updateDynamicIsland('â­ Catatan ditambahkan ke riwayat penting', 1500);
            }
        } else {
            // Remove from important history
            removeFromImportantHistory(note.id);
            if (typeof updateDynamicIsland !== 'undefined') {
                updateDynamicIsland('ðŸ—‘ï¸ Catatan dihapus dari riwayat penting', 1500);
            }
        }
        
        saveNotesToStorage();
        renderNotes();
        
        // Update important history display if sidebar is open
        if (document.getElementById('leftSidebar') && document.getElementById('leftSidebar').classList.contains('active')) {
            if (typeof loadImportantHistory !== 'undefined') {
                loadImportantHistory();
            }
        }
    };

    window.deleteNote = function(noteId) {
        NOTES_STATE.notes = NOTES_STATE.notes.filter(note => note.id !== noteId);
        saveNotesToStorage();
        renderNotes();
        
        // Also remove from important history if it was there
        removeFromImportantHistory(noteId);
        
        if (typeof updateDynamicIsland !== 'undefined') {
            updateDynamicIsland('ðŸ—‘ï¸ Catatan dihapus', 1500);
        }
    };

    function saveNotesToStorage() {
        try {
            localStorage.setItem('stl_notes_data', JSON.stringify(NOTES_STATE.notes));
        } catch (error) {
            console.error('Error saving notes:', error);
        }
    }

    function loadSavedNotes() {
        try {
            const savedNotes = localStorage.getItem('stl_notes_data');
            if (savedNotes) {
                NOTES_STATE.notes = JSON.parse(savedNotes);
            }
        } catch (error) {
            console.error('Error loading notes:', error);
            NOTES_STATE.notes = [];
        }
    }

    // Modify the existing addToImportantHistory function to handle notes
    if (typeof addToImportantHistory === 'undefined') {
        var addToImportantHistory = function(data) {
            if (data.type === 'note') {
                const importantHistory = JSON.parse(localStorage.getItem('stl_important_history') || '[]');
                
                // Check if already exists
                if (!importantHistory.find(item => item.id === data.id)) {
                    importantHistory.unshift(data);
                    
                    // Keep only last 10 items
                    if (importantHistory.length > 10) {
                        importantHistory.pop();
                    }
                    
                    localStorage.setItem('stl_important_history', JSON.stringify(importantHistory));
                    
                    // Update the important history list if the left sidebar is open
                    const leftSidebar = document.getElementById('leftSidebar');
                    if (leftSidebar && leftSidebar.classList.contains('active')) {
                        if (typeof loadImportantHistory !== 'undefined') {
                            loadImportantHistory();
                        }
                    }
                }
            }
        };
    } else {
        // Backup original function
        const originalAddToImportantHistory = window.addToImportantHistory;
        window.addToImportantHistory = function(data) {
            if (data.type === 'note') {
                const importantHistory = JSON.parse(localStorage.getItem('stl_important_history') || '[]');
                
                if (!importantHistory.find(item => item.id === data.id)) {
                    importantHistory.unshift(data);
                    
                    if (importantHistory.length > 10) {
                        importantHistory.pop();
                    }
                    
                    localStorage.setItem('stl_important_history', JSON.stringify(importantHistory));
                    
                    const leftSidebar = document.getElementById('leftSidebar');
                    if (leftSidebar && leftSidebar.classList.contains('active')) {
                        if (typeof loadImportantHistory !== 'undefined') {
                            loadImportantHistory();
                        }
                    }
                }
            } else {
                // Call the original function for other data types
                originalAddToImportantHistory(data);
            }
        };
    }

    // Modify the existing loadImportantHistory function to display notes
    if (typeof loadImportantHistory === 'undefined') {
        var loadImportantHistory = function() {
            const importantHistory = JSON.parse(localStorage.getItem('stl_important_history') || '[]');
            const container = document.getElementById('importantHistoryList');
            
            if (!container) return;
            
            if (importantHistory.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center text-sm">Belum ada riwayat penting</p>';
                return;
            }
            
            container.innerHTML = importantHistory.map(item => {
                if (item.type === 'note') {
                    return `
                        <div class="flex flex-col p-2 bg-gray-50 dark:bg-gray-800 rounded-lg mb-2 note-item" draggable="true" data-id="${item.id}">
                            <div class="flex justify-between items-center mb-2">
                                <div class="font-medium text-sm">${escapeHtml(item.title)}</div>
                                <button class="enhanced-btn btn-error text-xs compact-btn remove-important" data-id="${item.id}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="text-xs text-gray-600 mb-2 line-clamp-2">${escapeHtml(item.content)}</div>
                            <div class="text-xs text-gray-500">${new Date(item.date).toLocaleDateString('id-ID')}</div>
                        </div>
                    `;
                } else if (item.type === 'drawing') {
                    return `
                        <div class="flex flex-col p-2 bg-gray-50 dark:bg-gray-800 rounded-lg mb-2 drawing-item" draggable="true" data-id="${item.id}">
                            <div class="flex justify-between items-center mb-2">
                                <div class="font-medium text-sm">${escapeHtml(item.description)}</div>
                                <button class="enhanced-btn btn-error text-xs compact-btn remove-important" data-id="${item.id}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <img src="${item.dataUrl}" alt="${escapeHtml(item.description)}" class="w-full h-20 object-contain bg-white rounded border">
                            <div class="text-xs text-gray-500 mt-1">${new Date(item.date).toLocaleDateString('id-ID')}</div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-800 rounded-lg mb-2 transaction-item" draggable="true" data-id="${item.id}">
                            <div class="flex-1">
                                <div class="font-medium text-sm">${escapeHtml(item.description)}</div>
                                <div class="text-xs text-gray-500">Rp ${typeof formatCurrency !== 'undefined' ? formatCurrency(item.amount) : item.amount} â€¢ ${new Date(item.date).toLocaleDateString('id-ID')}</div>
                            </div>
                            <button class="enhanced-btn btn-error text-xs compact-btn remove-important" data-id="${item.id}">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                }
            }).join('');
            
            // Add event listeners for remove buttons
            container.querySelectorAll('.remove-important').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    removeFromImportantHistory(id);
                });
            });
        };
    } else {
        // Backup original function
        const originalLoadImportantHistory = window.loadImportantHistory;
        window.loadImportantHistory = function() {
            const importantHistory = JSON.parse(localStorage.getItem('stl_important_history') || '[]');
            const container = document.getElementById('importantHistoryList');
            
            if (!container) return;
            
            if (importantHistory.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center text-sm">Belum ada riwayat penting</p>';
                return;
            }
            
            container.innerHTML = importantHistory.map(item => {
                if (item.type === 'note') {
                    return `
                        <div class="flex flex-col p-2 bg-gray-50 dark:bg-gray-800 rounded-lg mb-2 note-item" draggable="true" data-id="${item.id}">
                            <div class="flex justify-between items-center mb-2">
                                <div class="font-medium text-sm">${escapeHtml(item.title)}</div>
                                <button class="enhanced-btn btn-error text-xs compact-btn remove-important" data-id="${item.id}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="text-xs text-gray-600 mb-2 line-clamp-2">${escapeHtml(item.content)}</div>
                            <div class="text-xs text-gray-500">${new Date(item.date).toLocaleDateString('id-ID')}</div>
                        </div>
                    `;
                } else if (item.type === 'drawing') {
                    return originalLoadImportantHistory.call(this, item);
                } else {
                    return originalLoadImportantHistory.call(this, item);
                }
            }).join('');
            
            container.querySelectorAll('.remove-important').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    removeFromImportantHistory(id);
                });
            });
        };
    }

    // Update the removeFromImportantHistory function to handle notes
    if (typeof removeFromImportantHistory === 'undefined') {
        var removeFromImportantHistory = function(itemId) {
            // Remove from important history
            let importantHistory = JSON.parse(localStorage.getItem('stl_important_history') || '[]');
            importantHistory = importantHistory.filter(item => item.id !== itemId);
            localStorage.setItem('stl_important_history', JSON.stringify(importantHistory));
            
            // Also update the note's isImportant status if it's a note
            const noteIndex = NOTES_STATE.notes.findIndex(note => note.id === itemId);
            if (noteIndex !== -1) {
                NOTES_STATE.notes[noteIndex].isImportant = false;
                saveNotesToStorage();
                
                // Re-render notes if panel is open
                if (NOTES_STATE.isPanelOpen) {
                    renderNotes();
                }
            }
            
            // Update important history display
            const leftSidebar = document.getElementById('leftSidebar');
            if (leftSidebar && leftSidebar.classList.contains('active')) {
                if (typeof loadImportantHistory !== 'undefined') {
                    loadImportantHistory();
                }
            }
        };
    } else {
        // Backup original function
        const originalRemoveFromImportantHistory = window.removeFromImportantHistory;
        window.removeFromImportantHistory = function(itemId) {
            // Remove from important history
            let importantHistory = JSON.parse(localStorage.getItem('stl_important_history') || '[]');
            importantHistory = importantHistory.filter(item => item.id !== itemId);
            localStorage.setItem('stl_important_history', JSON.stringify(importantHistory));
            
            // Also update the note's isImportant status if it's a note
            const noteIndex = NOTES_STATE.notes.findIndex(note => note.id === itemId);
            if (noteIndex !== -1) {
                NOTES_STATE.notes[noteIndex].isImportant = false;
                saveNotesToStorage();
                
                if (NOTES_STATE.isPanelOpen) {
                    renderNotes();
                }
            }
            
            const leftSidebar = document.getElementById('leftSidebar');
            if (leftSidebar && leftSidebar.classList.contains('active')) {
                if (typeof loadImportantHistory !== 'undefined') {
                    loadImportantHistory();
                }
            }
            
            // Call original function
            originalRemoveFromImportantHistory(itemId);
        };
    }

    // Add drag and drop functionality
    document.addEventListener('DOMContentLoaded', function() {
        const printContent = document.getElementById('printContent');
        if (printContent) {
            printContent.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
            });
            
            printContent.addEventListener('drop', function(e) {
                e.preventDefault();
                const itemId = e.dataTransfer.getData('text/plain');
                addItemToPrintPreview(itemId);
            });
        }
    });

    function addItemToPrintPreview(itemId) {
        const importantHistory = JSON.parse(localStorage.getItem('stl_important_history') || '[]');
        const item = importantHistory.find(i => i.id === itemId);
        
        if (!item) return;
        
        const printContent = document.getElementById('printContent');
        if (!printContent) return;
        
        if (item.type === 'note') {
            const noteElement = document.createElement('div');
            noteElement.style.marginBottom = '20px';
            noteElement.style.padding = '15px';
            noteElement.style.border = '1px solid #e5e7eb';
            noteElement.style.borderRadius = '8px';
            noteElement.innerHTML = `
                <h4 style="margin: 0 0 10px 0; font-weight: bold;">${escapeHtml(item.title)}</h4>
                <p style="margin: 0; white-space: pre-wrap;">${escapeHtml(item.content)}</p>
                <div style="margin-top: 10px; font-size: 12px; color: #6b7280;">
                    ${new Date(item.date).toLocaleString('id-ID')}
                </div>
            `;
            printContent.appendChild(noteElement);
        }
    }
</script>
<!-- Tambahkan tombol game lawan kata di atas tombol notes -->
<button id="openWordGame" class="word-game-toggle">
    <i class="fas fa-brain"></i>
</button>

<!-- Tambahkan panel game lawan kata -->
<div id="wordGamePanel" class="word-game-panel">
    <div class="word-game-header">
        <h3><i class="fas fa-brain"></i> Game Lawan Kata - Penyegar Otak</h3>
        <button id="closeWordGame" class="enhanced-btn btn-error compact-btn">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div class="word-game-content">
        <div class="game-info">
            <p>Tebak lawan kata yang tepat! Biar otak tetap fresh sambil urus keuangan ðŸ˜Ž</p>
            <div class="game-stats">
                <div class="stat">
                    <span class="stat-label">Level</span>
                    <span id="currentLevel" class="stat-value">1/25</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Skor</span>
                    <span id="currentScoreWord" class="stat-value">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Nyawa</span>
                    <span id="livesCount" class="stat-value">â¤ï¸â¤ï¸â¤ï¸</span>
                </div>
            </div>
        </div>
        
        <div class="game-area">
            <div id="questionContainer" class="question-container">
                <div class="word-card">
                    <span id="currentWord" class="main-word">Kata</span>
                    <div class="word-meaning" id="wordMeaning">Arti kata</div>
                </div>
            </div>
            
            <div class="options-container" id="optionsContainer">
                <!-- Opsi jawaban akan diisi oleh JavaScript -->
            </div>
            
            <div class="game-feedback" id="gameFeedback">
                <!-- Feedback akan muncul di sini -->
            </div>
        </div>
        
        <div class="game-actions">
            <button id="nextQuestion" class="enhanced-btn btn-primary compact-btn" disabled>
                <i class="fas fa-forward"></i> Soal Selanjutnya
            </button>
            <button id="hintWord" class="enhanced-btn btn-warning compact-btn">
                <i class="fas fa-lightbulb"></i> Petunjuk
            </button>
            <button id="restartWordGame" class="enhanced-btn btn-success compact-btn">
                <i class="fas fa-redo"></i> Main Lagi
            </button>
        </div>
        
        <div class="game-tips">
            <h4>Tips Main:</h4>
            <ul>
                <li>Pilih lawan kata yang paling tepat</li>
                <li>Gunakan petunjuk jika bingung</li>
                <li>Jaga nyawa untuk bisa lanjut ke level berikutnya</li>
                <li>Santai aja, yang penting otak tetap jalan! ðŸ§ </li>
            </ul>
        </div>
    </div>
</div>
<style>
    /* ==================== WORD GAME PANEL STYLES ==================== */
    .word-game-toggle {
        position: fixed;
        bottom: 100px; /* Di atas tombol notes */
        left: 8px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
        border: none;
        box-shadow: var(--ios-shadow);
        z-index: 1001;
        cursor: pointer;
        transition: var(--ios-transition);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }

    .word-game-toggle:hover {
        transform: translateY(-5px) scale(1.1);
        box-shadow: 0 15px 40px rgba(139, 92, 246, 0.4);
    }

    .word-game-panel {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        width: 95%;
        max-width: 500px;
        max-height: 90vh;
        background: var(--theme-card);
        border-radius: var(--radius-2xl);
        box-shadow: var(--ios-shadow);
        z-index: 10002;
        opacity: 0;
        visibility: hidden;
        transition: var(--ios-transition);
        overflow: hidden;
        border: 1px solid var(--theme-border);
    }

    .word-game-panel.active {
        opacity: 1;
        visibility: visible;
        transform: translate(-50%, -50%) scale(1);
    }

    .word-game-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        color: white;
    }

    .word-game-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
    }

    .word-game-content {
        padding: 20px;
        overflow-y: auto;
        max-height: calc(90vh - 70px);
    }

    .game-info {
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--theme-border);
    }

    .game-info p {
        margin-bottom: 15px;
        color: var(--theme-text);
        font-style: italic;
    }

    .game-stats {
        display: flex;
        justify-content: space-around;
        margin-top: 10px;
    }

    .stat {
        text-align: center;
    }

    .stat-label {
        display: block;
        font-size: 12px;
        color: var(--theme-text);
        opacity: 0.7;
    }

    .stat-value {
        display: block;
        font-size: 16px;
        font-weight: 700;
        color: var(--theme-primary);
    }

    .game-area {
        margin-bottom: 20px;
    }

    .question-container {
        margin-bottom: 20px;
    }

    .word-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: var(--radius-2xl);
        padding: 25px;
        text-align: center;
        box-shadow: var(--shadow-lg);
        transition: var(--ios-transition);
    }

    .word-card:hover {
        transform: translateY(-5px);
    }

    .main-word {
        font-size: 28px;
        font-weight: 800;
        display: block;
        margin-bottom: 10px;
    }

    .word-meaning {
        font-size: 14px;
        opacity: 0.9;
        font-style: italic;
    }

    .options-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
        margin-bottom: 15px;
    }

    .option-btn {
        padding: 15px;
        border: 2px solid var(--theme-border);
        border-radius: var(--radius-xl);
        background: var(--theme-card);
        color: var(--theme-text);
        font-weight: 600;
        cursor: pointer;
        transition: var(--ios-transition);
        text-align: left;
    }

    .option-btn:hover {
        background: var(--theme-bg);
        transform: translateY(-2px);
    }

    .option-btn.correct {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border-color: #10b981;
    }

    .option-btn.incorrect {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border-color: #ef4444;
    }

    .option-btn.disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .game-feedback {
        padding: 15px;
        border-radius: var(--radius-lg);
        text-align: center;
        font-weight: 600;
        min-height: 20px;
        margin-bottom: 15px;
        transition: var(--ios-transition);
    }

    .game-feedback.correct {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .game-feedback.incorrect {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .game-feedback.info {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
        border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .game-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .game-actions button {
        flex: 1;
        min-width: 120px;
    }

    .game-tips {
        background: var(--theme-bg);
        border-radius: var(--radius-lg);
        padding: 15px;
    }

    .game-tips h4 {
        margin-bottom: 10px;
        color: var(--theme-text);
    }

    .game-tips ul {
        padding-left: 20px;
        color: var(--theme-text);
    }

    .game-tips li {
        margin-bottom: 5px;
        font-size: 14px;
    }

    /* Animasi untuk feedback */
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .pulse {
        animation: pulse 0.5s ease-in-out;
    }

    /* Responsive adjustments */
    @media (max-width: 480px) {
        .word-game-panel {
            width: 98%;
        }
        
        .word-game-content {
            padding: 15px;
        }
        
        .game-actions {
            flex-direction: column;
        }
        
        .game-actions button {
            min-width: auto;
        }
        
        .word-game-toggle {
            bottom: 100px;
            left: 8px;
        }
    }

    /* Pastikan tombol tidak bertumpuk di mobile */
    @media (max-width: 768px) {
        .word-game-toggle {
            bottom: 100px;
            left: 8px;
        }
        
        .notes-panel-toggle {
            bottom: 70px;
            left: 8px;
        }
        
        .game-panel-toggle {
            bottom: 40px;
            left: 8px;
        }
        
        .left-sidebar-toggle {
            bottom: 10px;
            left: 8px;
        }
    }
</style>

<script>
    // ==================== WORD GAME LOGIC ====================
    const WORD_GAME_STATE = {
        currentQuestion: 0,
        score: 0,
        lives: 3,
        isGameActive: false,
        questions: [],
        usedQuestions: []
    };

    // 25 Soal lawan kata dengan bahasa santai
    const WORD_QUESTIONS = [
        {
            word: "PANAS",
            meaning: "Suhu tinggi, bikin gerah",
            options: ["DINGIN", "HANGAT", "SEJUK", "LEMBAB"],
            correct: 0,
            hint: "Yang bikin pengen pakai jaket"
        },
        {
            word: "TINGGI",
            meaning: "Jauh dari tanah, kayak gunung",
            options: ["PANDAI", "RENDAH", "JAUH", "DEKAT"],
            correct: 1,
            hint: "Kalau badan ini, cocok buat main basket"
        },
        {
            word: "MAHAL",
            meaning: "Harganya bikin kantong kempes",
            options: ["MURAH", "BAIK", "INDAH", "BAGUS"],
            correct: 0,
            hint: "Tukang jualan ***** bilang: 'ga mahal-mahal amat kok'"
        },
        {
            word: "CEPAT",
            meaning: "Kayak kilat, gesit banget",
            options: ["LAMBAT", "KUAT", "TAHAN", "PANJANG"],
            correct: 0,
            hint: "Kayak kejar tayang, tapi pelan-pelan"
        },
        {
            word: "BESAR",
            meaning: "Ukurannya gede, ga muat di tas",
            options: ["TINGGI", "LEBAR", "KECIL", "PANJANG"],
            correct: 2,
            hint: "Kayak anak TK vs guru"
        },
        {
            word: "KUAT",
            meaning: "Tenaganya buat angkat barbel",
            options: ["BERAT", "LEMAH", "RINGAN", "CEPAT"],
            correct: 1,
            hint: "Pas habis sakit biasanya gini"
        },
        {
            word: "KAYA",
            meaning: "Hartanya banyak, bisa beli apa aja",
            options: ["MISKIN", "BAIK", "PINTAR", "SUKSES"],
            correct: 0,
            hint: "Kondisi yang pengen banget dicapai"
        },
        {
            word: "PANDANG",
            meaning: "Lihat dengan mata",
            options: ["DENGAR", "SENTUH", "PEGANG", "DENGAR"],
            correct: 0,
            hint: "Pake telinga, bukan mata"
        },
        {
            word: "SEDIH",
            meaning: "Perasaan kayak habis putus",
            options: ["SENANG", "MARAH", "TAKUT", "KAGET"],
            correct: 0,
            hint: "Pas dapat THR biasanya ngerasain ini"
        },
        {
            word: "MASUK",
            meaning: "Dari luar ke dalam",
            options: ["KELUAR", "NAIK", "TURUN", "HILANG"],
            correct: 0,
            hint: "Kayak murid yang pulang sekolah"
        },
        {
            word: "AWAL",
            meaning: "Permulaan, bagian pertama",
            options: ["AKHIR", "TENGAH", "PUSAT", "SELESAI"],
            correct: 0,
            hint: "Kayak episode terakhir series favorit"
        },
        {
            word: "TUA",
            meaning: "Udah berumur, banyak pengalaman",
            options: ["MUDA", "SEHAT", "BUGAR", "SEGER"],
            correct: 0,
            hint: "Umur yang pengen dipertahankan"
        },
        {
            word: "KERAS",
            meaning: "Ga lentur, kayak batu",
            options: ["LEMBUT", "BERAT", "KUAT", "KOKOH"],
            correct: 0,
            hint: "Kayak bantal yang empuk"
        },
        {
            word: "TERANG",
            meaning: "Cahayanya bikin silau",
            options: ["GELAP", "REDUP", "TEMARAM", "REMANG"],
            correct: 0,
            hint: "Pas mati lampu malam hari"
        },
        {
            word: "BAIK",
            meaning: "***** menolong, hatinya bersih",
            options: ["JAHAT", "NAKAL", "USIL", "ISENG"],
            correct: 0,
            hint: "Sifat antagonis di sinetron"
        },
        {
            word: "HIDUP",
            meaning: "Masih bernapas, masih beraktivitas",
            options: ["MATI", "Diam", "TIDUR", "PIATU"],
            correct: 0,
            hint: "Kondisi yang pasti dialami semua makhluk"
        },
        {
            word: "ATAS",
            meaning: "Posisinya lebih tinggi",
            options: ["BAWAH", "SAMPING", "DEPAN", "BELAKANG"],
            correct: 0,
            hint: "Kayak lantai dasar gedung"
        },
        {
            word: "DEPAN",
            meaning: "Arah yang kamu hadap",
            options: ["BELAKANG", "KANAN", "KIRI", "SAMPING"],
            correct: 0,
            hint: "Tempat biasanya ada spion"
        },
        {
            word: "SEDIKIT",
            meaning: "Jumlahnya ga banyak",
            options: ["BANYAK", "CUKUP", "PAS", "SEIMBANG"],
            correct: 0,
            hint: "Kayak gaji sebelum tanggal tua"
        },
        {
            word: "PAGI",
            meaning: "Waktu matahari baru terbit",
            options: ["MALAM", "SIANG", "SORE", "PETANG"],
            correct: 0,
            hint: "Waktu yang cocok buat begadang"
        },
        {
            word: "KERING",
            meaning: "Ga basah, ga ada airnya",
            options: ["BASAH", "LEMBAB", "BEKAS", "SEGAR"],
            correct: 0,
            hint: "Kayak baju habis dijemur"
        },
        {
            word: "PENUH",
            meaning: "Ga ada tempat kosong lagi",
            options: ["KOSONG", "LONGGA", "LAPANG", "LUAS"],
            correct: 0,
            hint: "Kayak kelas pas jam kosong"
        },
        {
            word: "JAUH",
            meaning: "Jaraknya panjang, butuh waktu lama",
            options: ["DEKAT", "CEPAT", "SEBELAH", "SAMPING"],
            correct: 0,
            hint: "Kayak rumah tetangga"
        },
        {
            word: "NAIK",
            meaning: "Pindah ke posisi lebih tinggi",
            options: ["TURUN", "DATAR", "MENDATAR", "LANDAT"],
            correct: 0,
            hint: "Kayak elevator ke lantai dasar"
        },
        {
            word: "MURAH",
            meaning: "Harganya bersahabat dengan dompet",
            options: ["MAHAL", "TINGGI", "FANTASTIS", "SELANGIT"],
            correct: 0,
            hint: "Kayak harga properti di Jakarta"
        }
    ];

    // Initialize word game
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(function() {
            setupWordGameEventListeners();
            console.log('Word game initialized');
        }, 100);
    });

    function setupWordGameEventListeners() {
        // Toggle word game panel
        const openBtn = document.getElementById('openWordGame');
        const closeBtn = document.getElementById('closeWordGame');
        
        if (openBtn) {
            openBtn.addEventListener('click', openWordGame);
        } else {
            console.error('openWordGame button not found');
        }
        
        if (closeBtn) {
            closeBtn.addEventListener('click', closeWordGame);
        }
        
        // Game actions
        document.getElementById('nextQuestion').addEventListener('click', nextQuestion);
        document.getElementById('hintWord').addEventListener('click', showHint);
        document.getElementById('restartWordGame').addEventListener('click', restartWordGame);
    }

    function openWordGame() {
        const panel = document.getElementById('wordGamePanel');
        if (panel) {
            panel.classList.add('active');
            if (!WORD_GAME_STATE.isGameActive) {
                startWordGame();
            }
        } else {
            console.error('wordGamePanel not found');
        }
    }

    function closeWordGame() {
        const panel = document.getElementById('wordGamePanel');
        if (panel) {
            panel.classList.remove('active');
        }
    }

    function startWordGame() {
        WORD_GAME_STATE.currentQuestion = 0;
        WORD_GAME_STATE.score = 0;
        WORD_GAME_STATE.lives = 3;
        WORD_GAME_STATE.isGameActive = true;
        WORD_GAME_STATE.usedQuestions = [];
        
        // Acak soal
        WORD_GAME_STATE.questions = [...WORD_QUESTIONS].sort(() => Math.random() - 0.5);
        
        updateGameStats();
        loadQuestion();
        
        // Update UI
        document.getElementById('nextQuestion').disabled = true;
        document.getElementById('gameFeedback').className = 'game-feedback';
        document.getElementById('gameFeedback').innerHTML = '';
    }

    function loadQuestion() {
        if (WORD_GAME_STATE.currentQuestion >= WORD_GAME_STATE.questions.length) {
            endWordGame();
            return;
        }
        
        const question = WORD_GAME_STATE.questions[WORD_GAME_STATE.currentQuestion];
        
        // Update question display
        document.getElementById('currentWord').textContent = question.word;
        document.getElementById('wordMeaning').textContent = question.meaning;
        
        // Update level indicator
        document.getElementById('currentLevel').textContent = `${WORD_GAME_STATE.currentQuestion + 1}/25`;
        
        // Create options
        const optionsContainer = document.getElementById('optionsContainer');
        optionsContainer.innerHTML = '';
        
        question.options.forEach((option, index) => {
            const button = document.createElement('button');
            button.className = 'option-btn';
            button.textContent = option;
            button.onclick = () => selectAnswer(index);
            optionsContainer.appendChild(button);
        });
        
        // Reset feedback
        document.getElementById('gameFeedback').className = 'game-feedback';
        document.getElementById('gameFeedback').innerHTML = '';
        
        // Disable next button until answer is selected
        document.getElementById('nextQuestion').disabled = true;
    }

    function selectAnswer(selectedIndex) {
        if (!WORD_GAME_STATE.isGameActive) return;
        
        const question = WORD_GAME_STATE.questions[WORD_GAME_STATE.currentQuestion];
        const options = document.querySelectorAll('.option-btn');
        const feedback = document.getElementById('gameFeedback');
        
        // Disable all options
        options.forEach(btn => {
            btn.classList.add('disabled');
            btn.onclick = null;
        });
        
        // Check answer
        if (selectedIndex === question.correct) {
            // Correct answer
            options[selectedIndex].classList.add('correct');
            WORD_GAME_STATE.score += 10;
            
            feedback.className = 'game-feedback correct pulse';
            feedback.innerHTML = `
                <i class="fas fa-check-circle"></i> 
                <strong>Bener banget!</strong> 
                <br>
                <small>Lawan kata dari "${question.word}" memang "${question.options[question.correct]}"</small>
            `;
            
            if (typeof updateDynamicIsland !== 'undefined') {
                updateDynamicIsland('ðŸŽ‰ Jawaban benar! +10 poin', 1500);
            }
        } else {
            // Wrong answer
            options[selectedIndex].classList.add('incorrect');
            options[question.correct].classList.add('correct');
            WORD_GAME_STATE.lives--;
            
            feedback.className = 'game-feedback incorrect pulse';
            feedback.innerHTML = `
                <i class="fas fa-times-circle"></i> 
                <strong>Yah, kurang tepat!</strong> 
                <br>
                <small>Lawan kata yang benar: "${question.options[question.correct]}"</small>
            `;
            
            if (typeof updateDynamicIsland !== 'undefined') {
                updateDynamicIsland('ðŸ’” Salah! Nyawa berkurang', 1500);
            }
        }
        
        updateGameStats();
        
        // Enable next button
        document.getElementById('nextQuestion').disabled = false;
        
        // Check if game over
        if (WORD_GAME_STATE.lives <= 0) {
            setTimeout(endWordGame, 1500);
        }
    }

    function nextQuestion() {
        WORD_GAME_STATE.currentQuestion++;
        loadQuestion();
    }

    function showHint() {
        if (!WORD_GAME_STATE.isGameActive) return;
        
        const question = WORD_GAME_STATE.questions[WORD_GAME_STATE.currentQuestion];
        const feedback = document.getElementById('gameFeedback');
        
        feedback.className = 'game-feedback info pulse';
        feedback.innerHTML = `
            <i class="fas fa-lightbulb"></i> 
            <strong>Petunjuk:</strong> 
            <br>
            <small>${question.hint}</small>
        `;
        
        if (typeof updateDynamicIsland !== 'undefined') {
            updateDynamicIsland('ðŸ’¡ Petunjuk: ' + question.hint, 2000);
        }
    }

    function restartWordGame() {
        startWordGame();
        
        if (typeof updateDynamicIsland !== 'undefined') {
            updateDynamicIsland('ðŸ”„ Game dimulai ulang!', 1500);
        }
    }

    function updateGameStats() {
        document.getElementById('currentScoreWord').textContent = WORD_GAME_STATE.score;
        
        // Update lives display
        let livesDisplay = '';
        for (let i = 0; i < 3; i++) {
            livesDisplay += i < WORD_GAME_STATE.lives ? 'â¤ï¸' : 'â™¡';
        }
        document.getElementById('livesCount').textContent = livesDisplay;
    }

    function endWordGame() {
        WORD_GAME_STATE.isGameActive = false;
        
        const feedback = document.getElementById('gameFeedback');
        feedback.className = 'game-feedback info';
        
        if (WORD_GAME_STATE.lives <= 0) {
            feedback.innerHTML = `
                <i class="fas fa-gamepad"></i> 
                <strong>Game Over!</strong> 
                <br>
                <small>Skor akhir: ${WORD_GAME_STATE.score}</small>
                <br>
                <small>Nyawa habis, coba lagi ya!</small>
            `;
            
            if (typeof updateDynamicIsland !== 'undefined') {
                updateDynamicIsland(`ðŸ•¹ï¸ Game Over! Skor: ${WORD_GAME_STATE.score}`, 3000);
            }
        } else {
            feedback.innerHTML = `
                <i class="fas fa-trophy"></i> 
                <strong>Selamat!</strong> 
                <br>
                <small>Kamu menyelesaikan semua soal!</small>
                <br>
                <small>Skor akhir: ${WORD_GAME_STATE.score}</small>
            `;
            
            if (typeof updateDynamicIsland !== 'undefined') {
                updateDynamicIsland(`ðŸ† Level selesai! Skor: ${WORD_GAME_STATE.score}`, 3000);
            }
        }
        
        // Disable next button
        document.getElementById('nextQuestion').disabled = true;
    }

    // Make functions globally available
    window.openWordGame = openWordGame;
    window.closeWordGame = closeWordGame;
    window.startWordGame = startWordGame;
    window.nextQuestion = nextQuestion;
    window.showHint = showHint;
    window.restartWordGame = restartWordGame;
</script>
<script>
// ==================== SCRIPT INJEKSI OPTIMASI SIDEBAR KIRI ====================
(function() {
    'use strict';
    
    // State untuk optimasi
    const OPTIMIZATION_STATE = {
        isDragging: false,
        currentDragItem: null,
        dropZones: {},
        viewportHeight: window.innerHeight,
        viewportWidth: window.innerWidth
    };

    // Inisialisasi setelah DOM siap
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initializeEnhancedSidebar, 500);
        setupViewportOptimization();
    });

    function setupViewportOptimization() {
        // Optimasi viewport untuk mobile
        const viewportMeta = document.querySelector('meta[name="viewport"]');
        if (viewportMeta) {
            viewportMeta.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover');
        }

        // Fullscreen optimization untuk mobile
        document.documentElement.style.height = '100%';
        document.body.style.height = '100%';
        
        // Handle resize untuk mobile
        window.addEventListener('resize', function() {
            OPTIMIZATION_STATE.viewportHeight = window.innerHeight;
            OPTIMIZATION_STATE.viewportWidth = window.innerWidth;
            adjustMobileViewport();
        });

        adjustMobileViewport();
    }

    function adjustMobileViewport() {
        const isMobile = OPTIMIZATION_STATE.viewportWidth < 768;
        const mainContent = document.querySelector('.main-content');
        
        if (isMobile && mainContent) {
            // Optimasi tinggi konten untuk mobile
            mainContent.style.height = 'calc(100vh - 20px)';
            mainContent.style.overflowY = 'auto';
            mainContent.style.webkitOverflowScrolling = 'touch';
            
            // Sembunyikan elemen yang tidak perlu di mobile
            document.querySelectorAll('.desktop-only').forEach(el => {
                el.style.display = 'none';
            });
        }
    }

    function initializeEnhancedSidebar() {
        console.log('ðŸ”„ Mengoptimasi Sidebar Kiri dengan Sistem Drag & Drop...');
        
        // Enhanced fungsi loadImportantHistory yang sudah ada
        enhanceImportantHistoryFunctions();
        
        // Setup drop zones untuk tombol print
        setupPrintDropZones();
        
        // Enhanced modal print preview
        enhancePrintPreviewModal();
        
        // Setup drag and drop untuk items
        setupDragAndDropSystem();
        
        console.log('âœ… Sidebar Kiri telah dioptimasi dengan sistem Drag & Drop');
    }

    function enhanceImportantHistoryFunctions() {
        // Simpan fungsi asli
        const originalLoadImportantHistory = window.loadImportantHistory;
        const originalAddToImportantHistory = window.addToImportantHistory;
        const originalRemoveFromImportantHistory = window.removeFromImportantHistory;

        // Enhanced loadImportantHistory
        window.loadImportantHistory = function() {
            if (originalLoadImportantHistory) {
                originalLoadImportantHistory();
            }
            
            // Tambahkan kemampuan drag ke items
            setTimeout(() => {
                const importantItems = document.querySelectorAll('#importantHistoryList .transaction-item, #importantHistoryList .drawing-item');
                importantItems.forEach(item => {
                    if (!item.hasAttribute('draggable')) {
                        item.setAttribute('draggable', 'true');
                        item.style.cursor = 'grab';
                        
                        item.addEventListener('dragstart', handleImportantItemDragStart);
                        item.addEventListener('dragend', handleImportantItemDragEnd);
                        
                        // Touch support untuk mobile
                        item.addEventListener('touchstart', handleImportantItemTouchStart, { passive: false });
                        item.addEventListener('touchend', handleImportantItemTouchEnd, { passive: true });
                    }
                });
            }, 100);
        };

        // Enhanced addToImportantHistory
        window.addToImportantHistory = function(data) {
            if (originalAddToImportantHistory) {
                originalAddToImportantHistory(data);
            }
            
            // Refresh drag capabilities
            setTimeout(() => {
                window.loadImportantHistory();
            }, 200);
        };

        // Enhanced removeFromImportantHistory  
        window.removeFromImportantHistory = function(id) {
            if (originalRemoveFromImportantHistory) {
                originalRemoveFromImportantHistory(id);
            }
            
            // Refresh UI
            setTimeout(() => {
                window.loadImportantHistory();
            }, 200);
        };

        console.log('âœ… Fungsi Riwayat Penting telah ditingkatkan');
    }

    function setupPrintDropZones() {
        // Identifikasi tombol print di sidebar kiri
        const printButtons = {
            preview: document.getElementById('previewReport'),
            pdf: document.getElementById('printPDF'),
            jpg: document.getElementById('printJPG'),
            png: document.getElementById('printPNG')
        };

        // Setup drop zones untuk setiap tombol
        Object.keys(printButtons).forEach(format => {
            const button = printButtons[format];
            if (button) {
                OPTIMIZATION_STATE.dropZones[format] = button;
                
                button.addEventListener('dragover', handleDropZoneDragOver);
                button.addEventListener('dragenter', handleDropZoneDragEnter);
                button.addEventListener('dragleave', handleDropZoneDragLeave);
                button.addEventListener('drop', (e) => handleDropZoneDrop(e, format));
                
                // Touch events untuk mobile
                button.addEventListener('touchend', (e) => handleDropZoneTouchDrop(e, format));
                
                // Tambahkan visual feedback
                button.style.transition = 'all 0.3s ease';
            }
        });

        console.log('âœ… Drop zones untuk tombol print telah disetup');
    }

    function setupDragAndDropSystem() {
        // Global event listeners untuk drag and drop
        document.addEventListener('dragover', function(e) {
            e.preventDefault();
        });

        document.addEventListener('drop', function(e) {
            e.preventDefault();
        });

        // Visual feedback untuk seluruh aplikasi saat drag
        document.addEventListener('dragstart', function() {
            document.body.classList.add('drag-active');
        });

        document.addEventListener('dragend', function() {
            document.body.classList.remove('drag-active');
            resetAllDropZones();
        });

        console.log('âœ… Sistem Drag & Drop global telah disetup');
    }

    function enhancePrintPreviewModal() {
        const printModal = document.getElementById('printPreviewModal');
        const printContent = document.getElementById('printContent');

        if (printModal && printContent) {
            // Jadikan print content sebagai drop zone juga
            printContent.addEventListener('dragover', handleDropZoneDragOver);
            printContent.addEventListener('dragenter', handleDropZoneDragEnter);
            printContent.addEventListener('dragleave', handleDropZoneDragLeave);
            printContent.addEventListener('drop', handlePrintContentDrop);

            // Enhanced close functionality
            const closeBtn = document.getElementById('closePrintPreview');
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    printModal.classList.remove('active');
                    // Reset content untuk next use
                    setTimeout(() => {
                        printContent.innerHTML = '';
                    }, 300);
                });
            }

            console.log('âœ… Modal Print Preview telah ditingkatkan');
        }
    }

    // ==================== EVENT HANDLERS DRAG & DROP ====================

    function handleImportantItemDragStart(e) {
        OPTIMIZATION_STATE.isDragging = true;
        OPTIMIZATION_STATE.currentDragItem = e.target.closest('[data-id]');
        
        const itemId = OPTIMIZATION_STATE.currentDragItem.getAttribute('data-id');
        e.dataTransfer.setData('text/plain', itemId);
        e.dataTransfer.effectAllowed = 'copy';
        
        // Visual feedback
        e.target.style.opacity = '0.6';
        e.target.style.transform = 'scale(0.95)';
        
        // Show drop zones
        showAllDropZones();
        
        console.log('ðŸ”„ Mulai drag item:', itemId);
    }

    function handleImportantItemDragEnd(e) {
        OPTIMIZATION_STATE.isDragging = false;
        OPTIMIZATION_STATE.currentDragItem = null;
        
        // Reset visual feedback
        e.target.style.opacity = '1';
        e.target.style.transform = 'scale(1)';
        
        // Hide drop zones
        hideAllDropZones();
        
        console.log('âœ… Selesai drag item');
    }

    function handleImportantItemTouchStart(e) {
        const item = e.target.closest('[data-id]');
        if (item) {
            OPTIMIZATION_STATE.isDragging = true;
            OPTIMIZATION_STATE.currentDragItem = item;
            
            // Visual feedback untuk touch
            item.style.transform = 'scale(0.95)';
            item.style.transition = 'transform 0.2s ease';
            
            // Show drop zones
            showAllDropZones();
            
            e.preventDefault();
        }
    }

    function handleImportantItemTouchEnd(e) {
        if (OPTIMIZATION_STATE.isDragging && OPTIMIZATION_STATE.currentDragItem) {
            OPTIMIZATION_STATE.currentDragItem.style.transform = 'scale(1)';
            OPTIMIZATION_STATE.isDragging = false;
            OPTIMIZATION_STATE.currentDragItem = null;
            
            // Hide drop zones
            hideAllDropZones();
        }
    }

    function handleDropZoneDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
    }

    function handleDropZoneDragEnter(e) {
        e.preventDefault();
        e.target.classList.add('drop-zone-active');
        e.target.style.transform = 'scale(1.05)';
        e.target.style.boxShadow = '0 0 20px rgba(102, 126, 234, 0.6)';
    }

    function handleDropZoneDragLeave(e) {
        e.target.classList.remove('drop-zone-active');
        e.target.style.transform = 'scale(1)';
        e.target.style.boxShadow = '';
    }

    function handleDropZoneDrop(e, format) {
        e.preventDefault();
        
        const itemId = e.dataTransfer.getData('text/plain');
        processDroppedItem(itemId, format);
        
        // Reset visual
        e.target.classList.remove('drop-zone-active');
        e.target.style.transform = 'scale(1)';
        e.target.style.boxShadow = '';
    }

    function handleDropZoneTouchDrop(e, format) {
        if (OPTIMIZATION_STATE.isDragging && OPTIMIZATION_STATE.currentDragItem) {
            const itemId = OPTIMIZATION_STATE.currentDragItem.getAttribute('data-id');
            processDroppedItem(itemId, format);
            
            // Reset state
            OPTIMIZATION_STATE.isDragging = false;
            OPTIMIZATION_STATE.currentDragItem = null;
        }
    }

    function handlePrintContentDrop(e) {
        e.preventDefault();
        
        const itemId = e.dataTransfer.getData('text/plain');
        addItemToPrintPreview(itemId);
        
        // Reset visual
        e.target.classList.remove('drop-zone-active');
    }

    // ==================== PROCESSING FUNCTIONS ====================

    function processDroppedItem(itemId, format) {
        console.log(`ðŸ“¥ Memproses item ${itemId} untuk format ${format}`);
        
        // Dapatkan data item dari important history
        const importantHistory = JSON.parse(localStorage.getItem('stl_important_history') || '[]');
        const item = importantHistory.find(i => i.id == itemId);
        
        if (!item) {
            console.error('âŒ Item tidak ditemukan di riwayat penting');
            updateDynamicIsland('âŒ Item tidak ditemukan', 2000);
            return;
        }

        switch(format) {
            case 'preview':
                generatePrintPreviewWithItem(item);
                break;
            case 'pdf':
                exportItemAsPDF(item);
                break;
            case 'jpg':
                exportItemAsImage(item, 'jpg');
                break;
            case 'png':
                exportItemAsImage(item, 'png');
                break;
            default:
                console.error('âŒ Format tidak dikenali:', format);
        }
        
        updateDynamicIsland(`âœ… Item diproses sebagai ${format.toUpperCase()}`, 2000);
    }

    function generatePrintPreviewWithItem(item) {
        // Buka modal print preview
        const printModal = document.getElementById('printPreviewModal');
        const printContent = document.getElementById('printContent');
        
        if (printModal && printContent) {
            // Generate content berdasarkan jenis item
            let contentHTML = '';
            
            if (item.type === 'drawing') {
                contentHTML = `
                    <div class="print-header">
                        <h2>GAMBAR TTD/DRAWING</h2>
                        <p class="subtitle">STL - UDHIS Financial Manager</p>
                        <p class="subtitle">${item.description}</p>
                        <p class="subtitle">Tanggal: ${new Date(item.date).toLocaleDateString('id-ID')}</p>
                    </div>
                    <div style="text-align: center; margin: 20px 0;">
                        <img src="${item.dataUrl}" style="max-width: 100%; height: auto; border: 1px solid #ccc;" alt="${item.description}">
                    </div>
                `;
            } else {
                // Transaction item
                contentHTML = `
                    <div class="print-header">
                        <h2>LAPORAN TRANSAKSI PENTING</h2>
                        <p class="subtitle">STL - UDHIS Financial Manager</p>
                        <p class="subtitle">${item.description}</p>
                    </div>
                    <table class="print-table">
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Keterangan</th>
                                <th>Jenis Dana</th>
                                <th>Jenis</th>
                                <th>Jumlah</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>${new Date(item.date).toLocaleDateString('id-ID')}</td>
                                <td>${item.description}</td>
                                <td>${window.FINANCIAL_STATE?.categories?.[item.fund]?.name || item.fund}</td>
                                <td>${item.type === 'debit' ? 'Pemasukan' : 'Pengeluaran'}</td>
                                <td class="${item.type === 'debit' ? 'text-green-600' : 'text-red-600'}">
                                    ${item.type === 'debit' ? '+' : '-'} Rp ${formatCurrency(item.amount)}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                `;
            }
            
            printContent.innerHTML = contentHTML;
            printModal.classList.add('active');
        }
    }

    function exportItemAsPDF(item) {
        // Gunakan fungsi export yang sudah ada
        if (window.exportPrintContent) {
            generatePrintPreviewWithItem(item);
            setTimeout(() => {
                window.exportPrintContent('pdf');
            }, 1000);
        } else {
            console.error('âŒ Fungsi export PDF tidak tersedia');
            updateDynamicIsland('âŒ Export PDF tidak tersedia', 2000);
        }
    }

    function exportItemAsImage(item, format) {
        // Gunakan fungsi export yang sudah ada
        if (window.exportPrintContent) {
            generatePrintPreviewWithItem(item);
            setTimeout(() => {
                window.exportPrintContent('image');
            }, 1000);
        } else {
            console.error(`âŒ Fungsi export ${format} tidak tersedia`);
            updateDynamicIsland(`âŒ Export ${format.toUpperCase()} tidak tersedia`, 2000);
        }
    }

    function addItemToPrintPreview(itemId) {
        // Implementasi untuk menambahkan item ke print preview yang sudah ada
        const importantHistory = JSON.parse(localStorage.getItem('stl_important_history') || '[]');
        const item = importantHistory.find(i => i.id == itemId);
        
        if (item) {
            const printContent = document.getElementById('printContent');
            if (printContent) {
                let itemHTML = '';
                
                if (item.type === 'drawing') {
                    itemHTML = `
                        <div style="page-break-inside: avoid; margin-bottom: 20px;">
                            <h4>${item.description}</h4>
                            <img src="${item.dataUrl}" style="max-width: 100%; height: auto;" alt="${item.description}">
                            <p style="text-align: center; font-size: 12px; color: #666;">
                                ${new Date(item.date).toLocaleDateString('id-ID')}
                            </p>
                        </div>
                    `;
                } else {
                    itemHTML = `
                        <tr>
                            <td>${new Date(item.date).toLocaleDateString('id-ID')}</td>
                            <td>${item.description}</td>
                            <td>${window.FINANCIAL_STATE?.categories?.[item.fund]?.name || item.fund}</td>
                            <td>${item.type === 'debit' ? 'Pemasukan' : 'Pengeluaran'}</td>
                            <td class="${item.type === 'debit' ? 'text-green-600' : 'text-red-600'}">
                                ${item.type === 'debit' ? '+' : '-'} Rp ${formatCurrency(item.amount)}
                            </td>
                        </tr>
                    `;
                }
                
                printContent.innerHTML += itemHTML;
            }
        }
    }

    // ==================== HELPER FUNCTIONS ====================

    function showAllDropZones() {
        Object.values(OPTIMIZATION_STATE.dropZones).forEach(zone => {
            if (zone) {
                zone.style.opacity = '1';
                zone.style.visibility = 'visible';
                zone.style.transform = 'scale(1)';
            }
        });
    }

    function hideAllDropZones() {
        Object.values(OPTIMIZATION_STATE.dropZones).forEach(zone => {
            if (zone) {
                zone.style.opacity = '0.7';
            }
        });
    }

    function resetAllDropZones() {
        Object.values(OPTIMIZATION_STATE.dropZones).forEach(zone => {
            if (zone) {
                zone.classList.remove('drop-zone-active');
                zone.style.transform = 'scale(1)';
                zone.style.boxShadow = '';
                zone.style.opacity = '0.7';
            }
        });
    }

    function formatCurrency(amount) {
        // Gunakan fungsi format currency yang sudah ada atau buat yang sederhana
        if (window.formatCurrency) {
            return window.formatCurrency(amount);
        }
        return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function updateDynamicIsland(message, duration) {
        // Gunakan fungsi dynamic island yang sudah ada
        if (window.updateDynamicIsland) {
            window.updateDynamicIsland(message, duration);
        } else {
            console.log('ðŸ“¢ ' + message);
        }
    }

    // ==================== CSS INJEKSI UNTUK STYLING ====================
    const style = document.createElement('style');
    style.textContent = `
        /* Enhanced Drag & Drop Styles */
        .drag-active {
            cursor: grabbing !important;
        }

        .drop-zone-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(102, 126, 234, 0.6) !important;
            z-index: 1000;
        }

        [draggable="true"] {
            cursor: grab;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            user-select: none;
        }

        [draggable="true"]:active {
            cursor: grabbing;
        }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            .main-content {
                height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom)) !important;
                padding-bottom: env(safe-area-inset-bottom) !important;
            }
            
            .sidebar, .left-sidebar {
                height: calc(100vh - env(safe-area-inset-top)) !important;
                padding-top: env(safe-area-inset-top) !important;
            }
            
            /* Hide browser UI elements */
            body {
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
        }

        /* Print Button Enhanced States */
        .export-btn.drag-over {
            animation: pulse-glow 1s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(102, 126, 234, 0.5); }
            50% { box-shadow: 0 0 20px rgba(102, 126, 234, 0.8); }
        }

        /* Safe area support for modern mobile browsers */
        @supports(padding: max(0px)) {
            .main-content {
                padding-left: max(20px, env(safe-area-inset-left));
                padding-right: max(20px, env(safe-area-inset-right));
            }
        }
    `;
    document.head.appendChild(style);

    console.log('ðŸŽ¯ Script injeksi Sidebar Kiri siap!');
})();
</script>
<script>
// ==================== FITUR REKENING PRIVAT ====================
const ACCOUNT_STATE = {
    accounts: [],
    currentAccount: null,
    isAuthenticated: false,
    passphrase: '',
    deviceLock: ''
};

// Inisialisasi fitur rekening
document.addEventListener('DOMContentLoaded', function() {
    initializeAccountFeature();
    setupAccountEventListeners();
    loadAccountData();
});

function initializeAccountFeature() {
    // Tambahkan tab REKENING ke dalam tab container
    const tabContainer = document.querySelector('.tab-container');
    const developerTab = document.querySelector('[data-tab="developer"]');
    
    const rekeningTab = document.createElement('button');
    rekeningTab.className = 'tab';
    rekeningTab.setAttribute('data-tab', 'rekening');
    rekeningTab.innerHTML = '<i class="fas fa-lock"></i> REKENING';
    
    tabContainer.insertBefore(rekeningTab, developerTab.nextSibling);
    
    // Tambahkan konten tab REKENING
    const tabContents = document.querySelector('.enhanced-card.p-6.mb-6.mobile-optimized');
    const developerContent = document.getElementById('developer');
    
    const rekeningContent = document.createElement('div');
    rekeningContent.id = 'rekening';
    rekeningContent.className = 'tab-content';
    rekeningContent.innerHTML = generateRekeningContent();
    
    tabContents.insertBefore(rekeningContent, developerContent.nextSibling);
}

function generateRekeningContent() {
    return `
        <div id="rekeningAuth" class="rekening-auth-section">
            <div class="financial-card text-center floating-card mb-6">
                <h3 class="text-xl font-black text-gray-800 dark:text-white mb-4">
                    <i class="fas fa-shield-alt mr-2"></i>Akses REKENING Privat
                </h3>
                <p class="text-gray-600 dark:text-gray-300 mb-4">
                    Masukkan passphrase untuk mengakses ruang rekening privat Anda
                </p>
                
                <div class="space-y-4 max-w-md mx-auto">
                    <input type="password" id="rekeningPassphrase" 
                           class="enhanced-input compact-input w-full" 
                           placeholder="Masukkan passphrase privat"
                           autocomplete="off">
                    
                    <button id="unlockRekening" class="enhanced-btn btn-primary compact-btn w-full">
                        <i class="fas fa-unlock mr-2"></i>Buka REKENING
                    </button>
                    
                    <div class="flex justify-between items-center mt-4">
                        <button id="forgotPassphrase" class="text-sm text-blue-600 hover:text-blue-800">
                            <i class="fas fa-question-circle mr-1"></i>Lupa Passphrase?
                        </button>
                        <button id="createNewPassphrase" class="text-sm text-green-600 hover:text-green-800">
                            <i class="fas fa-plus-circle mr-1"></i>Buat Baru
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="rekeningContent" class="rekening-content-section" style="display: none;">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-gray-800 dark:text-white">
                    <i class="fas fa-piggy-bank mr-2"></i>REKENING Privat
                </h3>
                <button id="lockRekening" class="enhanced-btn btn-warning compact-btn">
                    <i class="fas fa-lock mr-2"></i>Kunci
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="financial-card floating-card">
                    <h4 class="text-lg font-black text-gray-800 dark:text-white mb-4">
                        <i class="fas fa-plus-circle mr-2"></i>Tambah Rekening Baru
                    </h4>
                    
                    <div class="space-y-4">
                        <input type="text" id="newAccountName" 
                               class="enhanced-input compact-input w-full"
                               placeholder="Nama Rekening (misal: Tabungan Pendidikan)">
                        
                        <input type="number" id="initialBalance" 
                               class="enhanced-input compact-input w-full"
                               placeholder="Saldo Awal (Rp)">
                        
                        <textarea id="accountDescription" 
                                  class="enhanced-input compact-input w-full"
                                  placeholder="Deskripsi rekening"
                                  rows="3"></textarea>
                        
                        <button id="addNewAccount" class="enhanced-btn btn-success compact-btn w-full">
                            <i class="fas fa-save mr-2"></i>Simpan Rekening
                        </button>
                    </div>
                </div>
                
                <div class="financial-card floating-card">
                    <h4 class="text-lg font-black text-gray-800 dark:text-white mb-4">
                        <i class="fas fa-chart-line mr-2"></i>Ringkasan Total
                    </h4>
                    
                    <div class="space-y-4">
                        <div class="text-center">
                            <div class="balance-display" id="totalPrivateBalance">Rp 0</div>
                            <p class="text-gray-600 dark:text-gray-300">Total Seluruh Rekening</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                <div class="text-lg font-black text-blue-600" id="totalAccounts">0</div>
                                <p class="text-sm">Jumlah Rekening</p>
                            </div>
                            <div class="text-center p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                <div class="text-lg font-black text-green-600" id="activeAccounts">0</div>
                                <p class="text-sm">Rekening Aktif</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="financial-card floating-card">
                <h4 class="text-lg font-black text-gray-800 dark:text-white mb-4">
                    <i class="fas fa-wallet mr-2"></i>Daftar Rekening
                </h4>
                
                <div id="accountsList" class="space-y-3">
                    <!-- Daftar rekening akan ditampilkan di sini -->
                </div>
                
                <div id="emptyAccountsState" class="text-center py-8">
                    <i class="fas fa-piggy-bank text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500 dark:text-gray-400">Belum ada rekening</p>
                    <p class="text-sm text-gray-400 mt-2">Tambahkan rekening pertama Anda menggunakan form di atas</p>
                </div>
            </div>
        </div>
        
        <!-- Modal untuk verifikasi perangkat -->
        <div id="deviceVerificationModal" class="device-verification-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-mobile-alt mr-2"></i>Verifikasi Perangkat</h3>
                    <button id="closeDeviceModal" class="enhanced-btn btn-error compact-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="modal-body">
                    <p class="mb-4">Masukkan informasi perangkat Anda untuk memulihkan akses:</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Jenis/Merk HP Anda
                            </label>
                            <input type="text" id="deviceBrandInput" 
                                   class="enhanced-input compact-input w-full"
                                   placeholder="Contoh: Samsung Galaxy, iPhone, Xiaomi, dll.">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Model HP (jika diketahui)
                            </label>
                            <input type="text" id="deviceModelInput" 
                                   class="enhanced-input compact-input w-full"
                                   placeholder="Contoh: A12, S21, Redmi Note 10, dll.">
                        </div>
                        
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 p-3 rounded-lg">
                            <p class="text-sm text-yellow-800 dark:text-yellow-200">
                                <i class="fas fa-info-circle mr-2"></i>
                                Informasi ini harus sesuai dengan perangkat yang Anda gunakan saat membuat passphrase.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button id="verifyDevice" class="enhanced-btn btn-primary compact-btn">
                        <i class="fas fa-check mr-2"></i>Verifikasi
                    </button>
                    <button id="cancelDeviceVerification" class="enhanced-btn btn-warning compact-btn">
                        <i class="fas fa-times mr-2"></i>Batal
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Modal untuk buat passphrase baru -->
        <div id="newPassphraseModal" class="new-passphrase-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-key mr-2"></i>Buat Passphrase Baru</h3>
                    <button id="closeNewPassphraseModal" class="enhanced-btn btn-error compact-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="modal-body">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Passphrase Baru
                            </label>
                            <input type="password" id="newPassphrase" 
                                   class="enhanced-input compact-input w-full"
                                   placeholder="Minimal 8 karakter, kombinasi huruf, angka, dan simbol">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Konfirmasi Passphrase
                            </label>
                            <input type="password" id="confirmPassphrase" 
                                   class="enhanced-input compact-input w-full"
                                   placeholder="Ketik ulang passphrase">
                        </div>
                        
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg">
                            <p class="text-sm text-blue-800 dark:text-blue-200">
                                <i class="fas fa-shield-alt mr-2"></i>
                                Passphrase akan dienkripsi dan dilindungi dengan teknologi HTML5. 
                                Data rekening Anda akan aman dari akses tidak sah.
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button id="saveNewPassphrase" class="enhanced-btn btn-success compact-btn">
                        <i class="fas fa-save mr-2"></i>Simpan Passphrase
                    </button>
                    <button id="cancelNewPassphrase" class="enhanced-btn btn-warning compact-btn">
                        <i class="fas fa-times mr-2"></i>Batal
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Modal untuk transaksi rekening -->
        <div id="accountTransactionModal" class="account-transaction-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="transactionModalTitle"><i class="fas fa-exchange-alt mr-2"></i>Transaksi Rekening</h3>
                    <button id="closeTransactionModal" class="enhanced-btn btn-error compact-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="modal-body">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Jenis Transaksi
                                </label>
                                <select id="transactionTypeSelect" class="enhanced-input compact-input w-full">
                                    <option value="debit">Setoran/Pemasukan</option>
                                    <option value="kredit">Penarikan/Pengeluaran</option>
                                    <option value="transfer">Transfer Antar Rekening</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Jumlah (Rp)
                                </label>
                                <input type="number" id="transactionAmount" 
                                       class="enhanced-input compact-input w-full"
                                       placeholder="0">
                            </div>
                        </div>
                        
                        <div id="transferTargetSection" style="display: none;">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Rekening Tujuan
                            </label>
                            <select id="transferTarget" class="enhanced-input compact-input w-full">
                                <!-- Opsi rekening akan diisi oleh JavaScript -->
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Keterangan
                            </label>
                            <input type="text" id="transactionDescription" 
                                   class="enhanced-input compact-input w-full"
                                   placeholder="Deskripsi transaksi">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Tanggal
                            </label>
                            <input type="date" id="transactionDate" 
                                   class="enhanced-input compact-input w-full">
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button id="saveTransaction" class="enhanced-btn btn-success compact-btn">
                        <i class="fas fa-save mr-2"></i>Simpan Transaksi
                    </button>
                    <button id="cancelTransaction" class="enhanced-btn btn-warning compact-btn">
                        <i class="fas fa-times mr-2"></i>Batal
                    </button>
                </div>
            </div>
        </div>
    `;
}

function setupAccountEventListeners() {
    // Event listener untuk tab
    document.addEventListener('click', function(e) {
        if (e.target.closest('[data-tab="rekening"]')) {
            switchTab('rekening');
        }
    });
    
    // Autentikasi rekening
    document.getElementById('unlockRekening')?.addEventListener('click', unlockRekening);
    document.getElementById('lockRekening')?.addEventListener('click', lockRekening);
    document.getElementById('forgotPassphrase')?.addEventListener('click', showDeviceVerification);
    document.getElementById('createNewPassphrase')?.addEventListener('click', showNewPassphraseModal);
    
    // Modal verifikasi perangkat
    document.getElementById('closeDeviceModal')?.addEventListener('click', closeDeviceVerification);
    document.getElementById('verifyDevice')?.addEventListener('click', verifyDevice);
    document.getElementById('cancelDeviceVerification')?.addEventListener('click', closeDeviceVerification);
    
    // Modal passphrase baru
    document.getElementById('closeNewPassphraseModal')?.addEventListener('click', closeNewPassphraseModal);
    document.getElementById('saveNewPassphrase')?.addEventListener('click', saveNewPassphrase);
    document.getElementById('cancelNewPassphrase')?.addEventListener('click', closeNewPassphraseModal);
    
    // Manajemen rekening
    document.getElementById('addNewAccount')?.addEventListener('click', addNewAccount);
    
    // Modal transaksi
    document.getElementById('closeTransactionModal')?.addEventListener('click', closeTransactionModal);
    document.getElementById('saveTransaction')?.addEventListener('click', saveTransaction);
    document.getElementById('cancelTransaction')?.addEventListener('click', closeTransactionModal);
    document.getElementById('transactionTypeSelect')?.addEventListener('change', toggleTransferSection);
    
    // Proteksi cache - bersihkan data saat tab/tutup browser
    window.addEventListener('beforeunload', function() {
        if (ACCOUNT_STATE.isAuthenticated) {
            lockRekening();
        }
    });
    
    // Deteksi perubahan tab
    document.addEventListener('visibilitychange', function() {
        if (document.hidden && ACCOUNT_STATE.isAuthenticated) {
            // Otomatis kunci saat pindah tab
            setTimeout(lockRekening, 30000); // Kunci setelah 30 detik
        }
    });
}

// ==================== FUNGSI AUTENTIKASI ====================
function unlockRekening() {
    const passphraseInput = document.getElementById('rekeningPassphrase');
    const passphrase = passphraseInput.value.trim();
    
    if (!passphrase) {
        showAccountMessage('Masukkan passphrase terlebih dahulu', 'error');
        return;
    }
    
    // Verifikasi passphrase
    const savedHash = localStorage.getItem('stl_rekening_passphrase_hash');
    const inputHash = CryptoJS.SHA256(passphrase).toString();
    
    if (savedHash === inputHash) {
        ACCOUNT_STATE.isAuthenticated = true;
        ACCOUNT_STATE.passphrase = passphrase;
        
        // Dekripsi data rekening
        loadAndDecryptAccounts();
        
        // Tampilkan konten rekening
        document.getElementById('rekeningAuth').style.display = 'none';
        document.getElementById('rekeningContent').style.display = 'block';
        
        // Update UI
        updateAccountsDisplay();
        
        showAccountMessage('Akses REKENING berhasil dibuka', 'success');
        
        // Bersihkan input
        passphraseInput.value = '';
    } else {
        showAccountMessage('Passphrase salah. Coba lagi.', 'error');
        passphraseInput.value = '';
        passphraseInput.focus();
    }
}

function lockRekening() {
    ACCOUNT_STATE.isAuthenticated = false;
    ACCOUNT_STATE.passphrase = '';
    
    // Sembunyikan konten rekening
    document.getElementById('rekeningAuth').style.display = 'block';
    document.getElementById('rekeningContent').style.display = 'none';
    
    // Clear sensitive data from memory
    document.getElementById('rekeningPassphrase').value = '';
    
    showAccountMessage('REKENING berhasil dikunci', 'info');
}

function showDeviceVerification() {
    document.getElementById('deviceVerificationModal').classList.add('active');
}

function closeDeviceVerification() {
    document.getElementById('deviceVerificationModal').classList.remove('active');
    document.getElementById('deviceBrandInput').value = '';
    document.getElementById('deviceModelInput').value = '';
}

function verifyDevice() {
    const brand = document.getElementById('deviceBrandInput').value.trim().toLowerCase();
    const model = document.getElementById('deviceModelInput').value.trim().toLowerCase();
    
    if (!brand) {
        showAccountMessage('Masukkan merk HP Anda', 'error');
        return;
    }
    
    // Ambil informasi perangkat dari browser
    const userAgent = navigator.userAgent.toLowerCase();
    const platform = navigator.platform.toLowerCase();
    
    // Deteksi perangkat secara otomatis
    let detectedDevice = '';
    
    if (userAgent.includes('iphone') || userAgent.includes('ipad')) {
        detectedDevice = 'apple ios';
    } else if (userAgent.includes('samsung')) {
        detectedDevice = 'samsung android';
    } else if (userAgent.includes('xiaomi') || userAgent.includes('redmi')) {
        detectedDevice = 'xiaomi android';
    } else if (userAgent.includes('oppo')) {
        detectedDevice = 'oppo android';
    } else if (userAgent.includes('vivo')) {
        detectedDevice = 'vivo android';
    } else if (userAgent.includes('huawei') || userAgent.includes('honor')) {
        detectedDevice = 'huawei android';
    } else if (userAgent.includes('motorola')) {
        detectedDevice = 'motorola android';
    } else if (userAgent.includes('nokia')) {
        detectedDevice = 'nokia android';
    } else if (userAgent.includes('oneplus')) {
        detectedDevice = 'oneplus android';
    } else if (userAgent.includes('realme')) {
        detectedDevice = 'realme android';
    } else if (userAgent.includes('pixel')) {
        detectedDevice = 'google android';
    } else {
        detectedDevice = 'unknown device';
    }
    
    // Verifikasi dengan data yang disimpan
    const savedDeviceHash = localStorage.getItem('stl_rekening_device_hash');
    const inputDeviceInfo = `${brand} ${model}`.trim().toLowerCase();
    const inputDeviceHash = CryptoJS.SHA256(inputDeviceInfo).toString();
    
    // Juga verifikasi dengan deteksi otomatis
    const autoDetectedHash = CryptoJS.SHA256(detectedDevice).toString();
    
    if (savedDeviceHash === inputDeviceHash || savedDeviceHash === autoDetectedHash) {
        // Berhasil verifikasi, reset passphrase
        showNewPassphraseModal();
        closeDeviceVerification();
        showAccountMessage('Verifikasi perangkat berhasil. Silakan buat passphrase baru.', 'success');
    } else {
        showAccountMessage('Informasi perangkat tidak sesuai. Coba lagi atau gunakan perangkat yang sama saat membuat passphrase.', 'error');
    }
}

function showNewPassphraseModal() {
    document.getElementById('newPassphraseModal').classList.add('active');
}

function closeNewPassphraseModal() {
    document.getElementById('newPassphraseModal').classList.remove('active');
    document.getElementById('newPassphrase').value = '';
    document.getElementById('confirmPassphrase').value = '';
}

function saveNewPassphrase() {
    const newPassphrase = document.getElementById('newPassphrase').value;
    const confirmPassphrase = document.getElementById('confirmPassphrase').value;
    
    if (!newPassphrase || newPassphrase.length < 8) {
        showAccountMessage('Passphrase minimal 8 karakter', 'error');
        return;
    }
    
    if (newPassphrase !== confirmPassphrase) {
        showAccountMessage('Konfirmasi passphrase tidak sesuai', 'error');
        return;
    }
    
    // Simpan hash passphrase
    const passphraseHash = CryptoJS.SHA256(newPassphrase).toString();
    localStorage.setItem('stl_rekening_passphrase_hash', passphraseHash);
    
    // Deteksi dan simpan informasi perangkat
    const userAgent = navigator.userAgent.toLowerCase();
    let deviceInfo = '';
    
    if (userAgent.includes('iphone') || userAgent.includes('ipad')) {
        deviceInfo = 'apple ios';
    } else if (userAgent.includes('samsung')) {
        deviceInfo = 'samsung android';
    } else if (userAgent.includes('xiaomi') || userAgent.includes('redmi')) {
        deviceInfo = 'xiaomi android';
    } else if (userAgent.includes('oppo')) {
        deviceInfo = 'oppo android';
    } else if (userAgent.includes('vivo')) {
        deviceInfo = 'vivo android';
    } else if (userAgent.includes('huawei') || userAgent.includes('honor')) {
        deviceInfo = 'huawei android';
    } else {
        deviceInfo = 'unknown android';
    }
    
    const deviceHash = CryptoJS.SHA256(deviceInfo).toString();
    localStorage.setItem('stl_rekening_device_hash', deviceHash);
    
    // Enkripsi ulang data rekening dengan passphrase baru (jika ada)
    if (ACCOUNT_STATE.accounts.length > 0) {
        encryptAndSaveAccounts(newPassphrase);
    }
    
    closeNewPassphraseModal();
    showAccountMessage('Passphrase berhasil disimpan', 'success');
    
    // Auto login dengan passphrase baru
    ACCOUNT_STATE.passphrase = newPassphrase;
    ACCOUNT_STATE.isAuthenticated = true;
    document.getElementById('rekeningAuth').style.display = 'none';
    document.getElementById('rekeningContent').style.display = 'block';
}

// ==================== MANAJEMEN REKENING ====================
function addNewAccount() {
    if (!ACCOUNT_STATE.isAuthenticated) {
        showAccountMessage('Silakan buka akses REKENING terlebih dahulu', 'error');
        return;
    }
    
    const name = document.getElementById('newAccountName').value.trim();
    const balance = parseFloat(document.getElementById('initialBalance').value) || 0;
    const description = document.getElementById('accountDescription').value.trim();
    
    if (!name) {
        showAccountMessage('Masukkan nama rekening', 'error');
        return;
    }
    
    const newAccount = {
        id: Date.now(),
        name: name,
        balance: balance,
        description: description,
        createdAt: new Date().toISOString(),
        transactions: []
    };
    
    // Tambahkan transaksi awal jika ada saldo
    if (balance > 0) {
        newAccount.transactions.push({
            id: Date.now() + 1,
            type: 'debit',
            amount: balance,
            description: 'Saldo awal',
            date: new Date().toISOString().split('T')[0],
            timestamp: new Date().toISOString()
        });
    }
    
    ACCOUNT_STATE.accounts.push(newAccount);
    
    // Simpan data
    encryptAndSaveAccounts();
    
    // Update UI
    updateAccountsDisplay();
    clearAccountForm();
    
    showAccountMessage('Rekening berhasil ditambahkan', 'success');
}

function clearAccountForm() {
    document.getElementById('newAccountName').value = '';
    document.getElementById('initialBalance').value = '';
    document.getElementById('accountDescription').value = '';
}

function updateAccountsDisplay() {
    const accountsList = document.getElementById('accountsList');
    const emptyState = document.getElementById('emptyAccountsState');
    const totalBalanceElement = document.getElementById('totalPrivateBalance');
    const totalAccountsElement = document.getElementById('totalAccounts');
    const activeAccountsElement = document.getElementById('activeAccounts');
    
    if (ACCOUNT_STATE.accounts.length === 0) {
        accountsList.innerHTML = '';
        emptyState.style.display = 'block';
        totalBalanceElement.textContent = 'Rp 0';
        totalAccountsElement.textContent = '0';
        activeAccountsElement.textContent = '0';
        return;
    }
    
    emptyState.style.display = 'none';
    
    // Hitung total
    let totalBalance = 0;
    let activeAccounts = 0;
    
    ACCOUNT_STATE.accounts.forEach(account => {
        totalBalance += account.balance;
        if (account.balance > 0) activeAccounts++;
    });
    
    // Update summary
    totalBalanceElement.textContent = `Rp ${formatCurrency(totalBalance)}`;
    totalAccountsElement.textContent = ACCOUNT_STATE.accounts.length;
    activeAccountsElement.textContent = activeAccounts;
    
    // Render daftar rekening
    accountsList.innerHTML = ACCOUNT_STATE.accounts.map(account => `
        <div class="account-item enhanced-card p-4">
            <div class="flex justify-between items-start mb-3">
                <div class="flex-1">
                    <h5 class="font-black text-lg text-gray-800 dark:text-white">${account.name}</h5>
                    <p class="text-sm text-gray-600 dark:text-gray-300">${account.description || 'Tidak ada deskripsi'}</p>
                </div>
                <div class="text-right">
                    <div class="text-xl font-black ${account.balance >= 0 ? 'text-green-600' : 'text-red-600'}">
                        Rp ${formatCurrency(account.balance)}
                    </div>
                    <p class="text-xs text-gray-500">${new Date(account.createdAt).toLocaleDateString('id-ID')}</p>
                </div>
            </div>
            
            <div class="flex justify-between items-center">
                <div class="flex space-x-2">
                    <button class="enhanced-btn btn-primary compact-btn view-transactions" data-id="${account.id}">
                        <i class="fas fa-list mr-1"></i> Riwayat
                    </button>
                    <button class="enhanced-btn btn-success compact-btn add-transaction" data-id="${account.id}">
                        <i class="fas fa-plus mr-1"></i> Transaksi
                    </button>
                </div>
                <div class="flex space-x-1">
                    <button class="enhanced-btn bg-purple-600 hover:bg-purple-700 text-white compact-btn edit-account" data-id="${account.id}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="enhanced-btn btn-error compact-btn delete-account" data-id="${account.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            
            <div id="transactions-${account.id}" class="account-transactions mt-3 hidden">
                <!-- Riwayat transaksi akan ditampilkan di sini -->
            </div>
        </div>
    `).join('');
    
    // Tambahkan event listeners untuk tombol
    addAccountEventListeners();
}

function addAccountEventListeners() {
    // Tombol lihat riwayat
    document.querySelectorAll('.view-transactions').forEach(button => {
        button.addEventListener('click', function() {
            const accountId = parseInt(this.getAttribute('data-id'));
            toggleTransactions(accountId);
        });
    });
    
    // Tombol tambah transaksi
    document.querySelectorAll('.add-transaction').forEach(button => {
        button.addEventListener('click', function() {
            const accountId = parseInt(this.getAttribute('data-id'));
            showTransactionModal(accountId);
        });
    });
    
    // Tombol edit rekening
    document.querySelectorAll('.edit-account').forEach(button => {
        button.addEventListener('click', function() {
            const accountId = parseInt(this.getAttribute('data-id'));
            editAccount(accountId);
        });
    });
    
    // Tombol hapus rekening
    document.querySelectorAll('.delete-account').forEach(button => {
        button.addEventListener('click', function() {
            const accountId = parseInt(this.getAttribute('data-id'));
            deleteAccount(accountId);
        });
    });
}

function toggleTransactions(accountId) {
    const transactionsElement = document.getElementById(`transactions-${accountId}`);
    const account = ACCOUNT_STATE.accounts.find(acc => acc.id === accountId);
    
    if (!account) return;
    
    if (transactionsElement.classList.contains('hidden')) {
        // Tampilkan transaksi
        transactionsElement.classList.remove('hidden');
        transactionsElement.innerHTML = `
            <div class="border-t pt-3">
                <h6 class="font-bold text-gray-700 dark:text-gray-300 mb-2">Riwayat Transaksi:</h6>
                ${account.transactions.length > 0 ? 
                    account.transactions.map(transaction => `
                        <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                            <div>
                                <span class="font-medium ${transaction.type === 'debit' ? 'text-green-600' : 'text-red-600'}">
                                    ${transaction.type === 'debit' ? '+' : '-'} Rp ${formatCurrency(transaction.amount)}
                                </span>
                                <p class="text-sm text-gray-600">${transaction.description}</p>
                            </div>
                            <span class="text-xs text-gray-500">${new Date(transaction.date).toLocaleDateString('id-ID')}</span>
                        </div>
                    `).join('') : 
                    '<p class="text-gray-500 text-center py-2">Belum ada transaksi</p>'
                }
            </div>
        `;
    } else {
        // Sembunyikan transaksi
        transactionsElement.classList.add('hidden');
    }
}

function showTransactionModal(accountId) {
    const account = ACCOUNT_STATE.accounts.find(acc => acc.id === accountId);
    if (!account) return;
    
    ACCOUNT_STATE.currentAccount = account;
    
    document.getElementById('transactionModalTitle').textContent = `Transaksi - ${account.name}`;
    document.getElementById('transactionAmount').value = '';
    document.getElementById('transactionDescription').value = '';
    document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
    
    // Update opsi transfer
    updateTransferTargets(accountId);
    
    document.getElementById('accountTransactionModal').classList.add('active');
}

function closeTransactionModal() {
    document.getElementById('accountTransactionModal').classList.remove('active');
    ACCOUNT_STATE.currentAccount = null;
}

function toggleTransferSection() {
    const type = document.getElementById('transactionTypeSelect').value;
    const transferSection = document.getElementById('transferTargetSection');
    
    if (type === 'transfer') {
        transferSection.style.display = 'block';
    } else {
        transferSection.style.display = 'none';
    }
}

function updateTransferTargets(currentAccountId) {
    const transferTarget = document.getElementById('transferTarget');
    transferTarget.innerHTML = '';
    
    ACCOUNT_STATE.accounts.forEach(account => {
        if (account.id !== currentAccountId) {
            const option = document.createElement('option');
            option.value = account.id;
            option.textContent = account.name;
            transferTarget.appendChild(option);
        }
    });
}

function saveTransaction() {
    const account = ACCOUNT_STATE.currentAccount;
    if (!account) return;
    
    const type = document.getElementById('transactionTypeSelect').value;
    const amount = parseFloat(document.getElementById('transactionAmount').value);
    const description = document.getElementById('transactionDescription').value.trim();
    const date = document.getElementById('transactionDate').value;
    
    if (!amount || amount <= 0) {
        showAccountMessage('Masukkan jumlah transaksi yang valid', 'error');
        return;
    }
    
    if (!description) {
        showAccountMessage('Masukkan keterangan transaksi', 'error');
        return;
    }
    
    const transaction = {
        id: Date.now(),
        type: type,
        amount: amount,
        description: description,
        date: date,
        timestamp: new Date().toISOString()
    };
    
    // Proses transaksi berdasarkan jenis
    if (type === 'debit') {
        // Setoran
        account.balance += amount;
        account.transactions.push(transaction);
    } else if (type === 'kredit') {
        // Penarikan
        if (account.balance < amount) {
            showAccountMessage('Saldo tidak mencukupi', 'error');
            return;
        }
        account.balance -= amount;
        account.transactions.push(transaction);
    } else if (type === 'transfer') {
        // Transfer antar rekening
        const targetAccountId = parseInt(document.getElementById('transferTarget').value);
        const targetAccount = ACCOUNT_STATE.accounts.find(acc => acc.id === targetAccountId);
        
        if (!targetAccount) {
            showAccountMessage('Pilih rekening tujuan', 'error');
            return;
        }
        
        if (account.balance < amount) {
            showAccountMessage('Saldo tidak mencukupi untuk transfer', 'error');
            return;
        }
        
        // Kurangi dari rekening asal
        account.balance -= amount;
        account.transactions.push({
            ...transaction,
            description: `Transfer ke ${targetAccount.name}: ${description}`,
            transferTo: targetAccountId
        });
        
        // Tambah ke rekening tujuan
        targetAccount.balance += amount;
        targetAccount.transactions.push({
            id: Date.now() + 1,
            type: 'debit',
            amount: amount,
            description: `Transfer dari ${account.name}: ${description}`,
            date: date,
            timestamp: new Date().toISOString(),
            transferFrom: account.id
        });
    }
    
    // Simpan data
    encryptAndSaveAccounts();
    
    // Update UI
    updateAccountsDisplay();
    closeTransactionModal();
    
    showAccountMessage('Transaksi berhasil disimpan', 'success');
}

function editAccount(accountId) {
    const account = ACCOUNT_STATE.accounts.find(acc => acc.id === accountId);
    if (!account) return;
    
    const newName = prompt('Edit nama rekening:', account.name);
    if (newName && newName.trim()) {
        account.name = newName.trim();
        encryptAndSaveAccounts();
        updateAccountsDisplay();
        showAccountMessage('Nama rekening berhasil diubah', 'success');
    }
}

function deleteAccount(accountId) {
    if (!confirm('Apakah Anda yakin ingin menghapus rekening ini? Semua riwayat transaksi akan hilang.')) {
        return;
    }
    
    ACCOUNT_STATE.accounts = ACCOUNT_STATE.accounts.filter(acc => acc.id !== accountId);
    encryptAndSaveAccounts();
    updateAccountsDisplay();
    showAccountMessage('Rekening berhasil dihapus', 'success');
}

// ==================== ENKRIPSI DAN PENYIMPANAN ====================
function encryptAndSaveAccounts(passphrase = ACCOUNT_STATE.passphrase) {
    if (!passphrase) return;
    
    const data = {
        accounts: ACCOUNT_STATE.accounts,
        lastUpdated: new Date().toISOString()
    };
    
    const encryptedData = CryptoJS.AES.encrypt(JSON.stringify(data), passphrase).toString();
    localStorage.setItem('stl_rekening_data', encryptedData);
}

function loadAndDecryptAccounts() {
    const encryptedData = localStorage.getItem('stl_rekening_data');
    
    if (!encryptedData) {
        ACCOUNT_STATE.accounts = [];
        return;
    }
    
    try {
        const decryptedData = CryptoJS.AES.decrypt(encryptedData, ACCOUNT_STATE.passphrase).toString(CryptoJS.enc.Utf8);
        
        if (!decryptedData) {
            showAccountMessage('Gagal memuat data rekening. Passphrase mungkin salah.', 'error');
            ACCOUNT_STATE.accounts = [];
            return;
        }
        
        const data = JSON.parse(decryptedData);
        ACCOUNT_STATE.accounts = data.accounts || [];
    } catch (error) {
        console.error('Error decrypting account data:', error);
        ACCOUNT_STATE.accounts = [];
        showAccountMessage('Terjadi kesalahan saat memuat data rekening', 'error');
    }
}

function loadAccountData() {
    // Cek apakah passphrase sudah ada
    const passphraseHash = localStorage.getItem('stl_rekening_passphrase_hash');
    
    if (!passphraseHash) {
        // First time user, show create passphrase option
        document.getElementById('rekeningAuth').style.display = 'block';
        document.getElementById('rekeningContent').style.display = 'none';
    }
}

// ==================== UTILITY FUNCTIONS ====================
function showAccountMessage(message, type) {
    // Gunakan dynamic island yang sudah ada
    updateDynamicIsland(message, 3000);
}

function formatCurrency(amount) {
    return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

// ==================== STYLING TAMBAHAN ====================
const additionalStyles = `
    /* Styling untuk fitur REKENING */
    .rekening-auth-section {
        transition: all 0.5s ease;
    }
    
    .rekening-content-section {
        animation: fadeIn 0.5s ease;
    }
    
    .account-item {
        transition: all 0.3s ease;
        border-left: 4px solid var(--theme-primary);
    }
    
    .account-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }
    
    .account-transactions {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .hidden {
        display: none !important;
    }
    
    /* Modal Styling */
    .device-verification-modal,
    .new-passphrase-modal,
    .account-transaction-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10002;
        opacity: 0;
        visibility: hidden;
        transition: var(--ios-transition);
    }
    
    .device-verification-modal.active,
    .new-passphrase-modal.active,
    .account-transaction-modal.active {
        opacity: 1;
        visibility: visible;
    }
    
    .modal-content {
        background: var(--theme-card);
        border-radius: var(--radius-2xl);
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--ios-shadow);
        border: 1px solid var(--theme-border);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid var(--theme-border);
    }
    
    .modal-header h3 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        color: var(--theme-text);
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .modal-footer {
        display: flex;
        gap: 10px;
        padding: 20px;
        border-top: 1px solid var(--theme-border);
        justify-content: flex-end;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .modal-content {
            width: 95%;
            margin: 20px;
        }
        
        .modal-footer {
            flex-direction: column;
        }
        
        .account-item .flex.justify-between {
            flex-direction: column;
            gap: 10px;
        }
        
        .account-item .flex.space-x-2 {
            justify-content: flex-start;
        }
    }
    
    @media (max-width: 480px) {
        .modal-header,
        .modal-body,
        .modal-footer {
            padding: 15px;
        }
    }
    
    /* Security Indicators */
    .security-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 8px;
    }
    
    .security-high {
        background: #10b981;
    }
    
    .security-medium {
        background: #f59e0b;
    }
    
    .security-low {
        background: #ef4444;
    }
`;

// Inject additional styles
const styleSheet = document.createElement('style');
styleSheet.textContent = additionalStyles;
document.head.appendChild(styleSheet);
</script>
<script>
// ==================== FITUR SCAN DEVICE & OPTIMASI REAL-TIME ====================
function initializeDeviceScan() {
    // Tambahkan tombol SCAN DEVICE ke dalam tab container setelah REKENING
    const tabContainer = document.querySelector('.tab-container');
    const rekeningTab = document.querySelector('[data-tab="rekening"]');
    
    const scanDeviceTab = document.createElement('button');
    scanDeviceTab.className = 'tab';
    scanDeviceTab.setAttribute('data-tab', 'scandevice');
    scanDeviceTab.innerHTML = '<i class="fas fa-microchip"></i> SCAN DEVICE';
    
    // Tambahkan setelah tombol REKENING
    tabContainer.insertBefore(scanDeviceTab, rekeningTab.nextSibling);
    
    // Tambahkan konten tab SCAN DEVICE
    const tabContents = document.querySelector('.enhanced-card.p-6.mb-6.mobile-optimized');
    const rekeningContent = document.getElementById('rekening');
    
    const scanDeviceContent = document.createElement('div');
    scanDeviceContent.id = 'scandevice';
    scanDeviceContent.className = 'tab-content';
    scanDeviceContent.innerHTML = generateDeviceScanContent();
    
    tabContents.insertBefore(scanDeviceContent, rekeningContent.nextSibling);
    
    // Inisialisasi event listener untuk tab baru
    scanDeviceTab.addEventListener('click', function() {
        switchTab('scandevice');
        setTimeout(() => {
            performQuickDeviceScan();
        }, 300);
    });
}

function generateDeviceScanContent() {
    return `
        <div class="financial-card floating-card mb-6">
            <h3 class="text-xl font-black text-gray-800 dark:text-white mb-4">
                <i class="fas fa-rocket mr-2"></i>Device Optimizer
            </h3>
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                        <div class="text-2xl font-black text-blue-600" id="deviceScore">-</div>
                        <p class="text-sm text-gray-600">Performance Score</p>
                    </div>
                    <div class="text-center p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                        <div class="text-2xl font-black text-green-600" id="deviceTier">-</div>
                        <p class="text-sm text-gray-600">Optimization Level</p>
                    </div>
                    <div class="text-center p-4 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                        <div class="text-2xl font-black text-purple-600" id="batteryImpact">-</div>
                        <p class="text-sm text-gray-600">Battery Impact</p>
                    </div>
                </div>
                
                <div id="quickScanResult" class="space-y-3">
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                        <span class="font-medium">Auto-Detected Device:</span>
                        <span class="font-bold text-blue-600" id="detectedDevice">Scanning...</span>
                    </div>
                </div>

                <div class="optimization-controls space-y-3">
                    <h4 class="font-black text-lg">Optimization Settings:</h4>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="tool-group">
                            <label class="flex items-center justify-between">
                                <span>Pixel Density</span>
                                <span id="pixelValue" class="text-sm font-bold">Auto</span>
                            </label>
                            <input type="range" id="pixelOptimizer" min="1" max="3" step="0.5" value="1.5" class="w-full">
                        </div>
                        
                        <div class="tool-group">
                            <label class="flex items-center justify-between">
                                <span>Animation Level</span>
                                <span id="animationValue" class="text-sm font-bold">Medium</span>
                            </label>
                            <input type="range" id="animationOptimizer" min="0" max="2" step="1" value="1" class="w-full">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="tool-group">
                            <label class="flex items-center justify-between">
                                <span>Graphics Quality</span>
                                <span id="graphicsValue" class="text-sm font-bold">Balanced</span>
                            </label>
                            <input type="range" id="graphicsOptimizer" min="1" max="3" step="1" value="2" class="w-full">
                        </div>
                        
                        <div class="tool-group">
                            <label class="flex items-center justify-between">
                                <span>Memory Usage</span>
                                <span id="memoryValue" class="text-sm font-bold">Efficient</span>
                            </label>
                            <input type="range" id="memoryOptimizer" min="1" max="3" step="1" value="2" class="w-full">
                        </div>
                    </div>
                </div>

                <div class="optimization-actions grid grid-cols-2 gap-3">
                    <button id="applyOptimization" class="enhanced-btn btn-success">
                        <i class="fas fa-bolt mr-2"></i>Apply Now
                    </button>
                    <button id="refreshOptimization" class="enhanced-btn btn-primary">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>

                <div id="optimizationResult" class="hidden mt-4 p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
                    <h5 class="font-black text-green-800 dark:text-green-200 mb-2">
                        <i class="fas fa-check-circle mr-2"></i>Optimization Applied!
                    </h5>
                    <p id="resultDetails" class="text-sm text-green-700 dark:text-green-300">
                        Your device has been optimized for better performance and battery life.
                    </p>
                </div>
            </div>
        </div>
        
        <div class="financial-card floating-card">
            <h3 class="text-xl font-black text-gray-800 dark:text-white mb-4">
                <i class="fas fa-tachometer-alt mr-2"></i>Performance Monitor
            </h3>
            <div class="space-y-3">
                <div class="performance-item">
                    <div class="flex justify-between text-sm mb-1">
                        <span>CPU Usage</span>
                        <span id="cpuUsage" class="font-bold">-</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="cpuBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="performance-item">
                    <div class="flex justify-between text-sm mb-1">
                        <span>Memory Usage</span>
                        <span id="memoryUsage" class="font-bold">-</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="memoryBar" class="bg-green-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="performance-item">
                    <div class="flex justify-between text-sm mb-1">
                        <span>Battery Impact</span>
                        <span id="batteryLevel" class="font-bold">-</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="batteryBar" class="bg-yellow-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function performQuickDeviceScan() {
    const deviceInfo = detectDeviceCapabilities();
    const visualInfo = window.STL_VISUAL || computeVisualScore();
    
    // Update device info
    document.getElementById('detectedDevice').textContent = deviceInfo.name;
    document.getElementById('deviceScore').textContent = visualInfo.score + '/999';
    document.getElementById('deviceTier').textContent = visualInfo.tier.toUpperCase();
    document.getElementById('batteryImpact').textContent = deviceInfo.batteryImpact;
    
    // Set optimal defaults based on device capabilities
    setOptimalDefaults(visualInfo.tier);
    
    // Start performance monitoring
    startPerformanceMonitoring();
    
    updateDynamicIsland('ðŸ“± Device scan completed!', 2000);
}

function detectDeviceCapabilities() {
    const ua = navigator.userAgent;
    let deviceName = 'Unknown Device';
    let batteryImpact = 'Low';
    
    // Detect device type
    if (/iPhone|iPad|iPod/.test(ua)) {
        deviceName = 'Apple Device';
        batteryImpact = 'Medium';
    } else if (/Android/.test(ua)) {
        deviceName = 'Android Device';
        batteryImpact = 'Medium';
    } else if (/Windows/.test(ua)) {
        deviceName = 'Windows PC';
        batteryImpact = 'Low';
    } else if (/Mac/.test(ua)) {
        deviceName = 'Mac Device';
        batteryImpact = 'Low';
    }
    
    // Detect low-end devices
    const cores = navigator.hardwareConcurrency || 1;
    const memory = navigator.deviceMemory || 2;
    
    if (cores <= 2 || memory <= 2) {
        batteryImpact = 'High';
        deviceName += ' (Low-end)';
    } else if (cores >= 6 && memory >= 6) {
        batteryImpact = 'Very Low';
        deviceName += ' (High-end)';
    }
    
    return { name: deviceName, batteryImpact: batteryImpact };
}

function setOptimalDefaults(tier) {
    const pixelSlider = document.getElementById('pixelOptimizer');
    const animationSlider = document.getElementById('animationOptimizer');
    const graphicsSlider = document.getElementById('graphicsOptimizer');
    const memorySlider = document.getElementById('memoryOptimizer');
    
    switch(tier) {
        case 'low':
            pixelSlider.value = 1;
            animationSlider.value = 0;
            graphicsSlider.value = 1;
            memorySlider.value = 1;
            break;
        case 'medium':
            pixelSlider.value = 1.5;
            animationSlider.value = 1;
            graphicsSlider.value = 2;
            memorySlider.value = 2;
            break;
        case 'high':
            pixelSlider.value = 2;
            animationSlider.value = 1;
            graphicsSlider.value = 2;
            memorySlider.value = 2;
            break;
        case 'ultra':
            pixelSlider.value = 2.5;
            animationSlider.value = 2;
            graphicsSlider.value = 3;
            memorySlider.value = 3;
            break;
    }
    
    // Update display values
    updateSliderValues();
}

function updateSliderValues() {
    const pixelValue = document.getElementById('pixelOptimizer').value;
    const animationValue = document.getElementById('animationOptimizer').value;
    const graphicsValue = document.getElementById('graphicsOptimizer').value;
    const memoryValue = document.getElementById('memoryOptimizer').value;
    
    document.getElementById('pixelValue').textContent = 
        pixelValue == 1 ? 'Low' : pixelValue == 2 ? 'High' : pixelValue == 3 ? 'Ultra' : 'Medium';
    
    document.getElementById('animationValue').textContent = 
        animationValue == 0 ? 'Off' : animationValue == 1 ? 'Medium' : 'High';
    
    document.getElementById('graphicsValue').textContent = 
        graphicsValue == 1 ? 'Low' : graphicsValue == 2 ? 'Balanced' : 'High';
    
    document.getElementById('memoryValue').textContent = 
        memoryValue == 1 ? 'Efficient' : memoryValue == 2 ? 'Balanced' : 'Performance';
}

function applyOptimizationSettings() {
    const pixelValue = parseFloat(document.getElementById('pixelOptimizer').value);
    const animationValue = parseInt(document.getElementById('animationOptimizer').value);
    const graphicsValue = parseInt(document.getElementById('graphicsOptimizer').value);
    const memoryValue = parseInt(document.getElementById('memoryOptimizer').value);
    
    // Apply pixel density optimization (50% optimization target)
    optimizePixelDensity(pixelValue);
    
    // Apply animation optimization
    optimizeAnimations(animationValue);
    
    // Apply graphics optimization
    optimizeGraphics(graphicsValue);
    
    // Apply memory optimization
    optimizeMemoryUsage(memoryValue);
    
    // Show success message
    const resultDiv = document.getElementById('optimizationResult');
    const resultDetails = document.getElementById('resultDetails');
    
    resultDetails.textContent = `Optimized for ${getOptimizationLevel(pixelValue, animationValue, graphicsValue, memoryValue)} performance with 50% efficiency target.`;
    resultDiv.classList.remove('hidden');
    
    updateDynamicIsland('âš¡ Optimization applied successfully!', 3000);
    
    // Refresh performance metrics
    setTimeout(startPerformanceMonitoring, 1000);
}

function optimizePixelDensity(level) {
    const root = document.documentElement;
    
    switch(level) {
        case 1: // Low
            root.style.setProperty('--ios-blur', 'blur(10px)');
            root.style.setProperty('--shadow-md', '0 4px 12px rgba(0,0,0,0.1)');
            break;
        case 1.5: // Medium (50% target)
            root.style.setProperty('--ios-blur', 'blur(20px)');
            root.style.setProperty('--shadow-md', '0 6px 18px rgba(0,0,0,0.12)');
            break;
        case 2: // High
            root.style.setProperty('--ios-blur', 'blur(30px)');
            root.style.setProperty('--shadow-md', '0 8px 25px rgba(0,0,0,0.15)');
            break;
        case 2.5: // Ultra
            root.style.setProperty('--ios-blur', 'blur(40px)');
            root.style.setProperty('--shadow-md', '0 10px 30px rgba(0,0,0,0.18)');
            break;
        case 3: // Maximum
            root.style.setProperty('--ios-blur', 'blur(50px)');
            root.style.setProperty('--shadow-md', '0 12px 35px rgba(0,0,0,0.2)');
            break;
    }
}

function optimizeAnimations(level) {
    const root = document.documentElement;
    
    switch(level) {
        case 0: // Off
            root.style.setProperty('--ios-transition', 'all 0.1s ease');
            // Disable complex animations
            document.querySelectorAll('.aurora-layer').forEach(layer => {
                layer.style.animation = 'none';
            });
            break;
        case 1: // Medium (50% target)
            root.style.setProperty('--ios-transition', 'all 0.3s ease');
            // Reduce animation intensity
            document.querySelectorAll('.aurora-layer').forEach(layer => {
                layer.style.animationDuration = '15s';
            });
            break;
        case 2: // High
            root.style.setProperty('--ios-transition', 'all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94)');
            // Full animations
            document.querySelectorAll('.aurora-layer').forEach(layer => {
                layer.style.animationDuration = '20s';
            });
            break;
    }
}

function optimizeGraphics(level) {
    // Adjust visual complexity based on level
    const cards = document.querySelectorAll('.enhanced-card, .financial-card');
    
    cards.forEach(card => {
        switch(level) {
            case 1: // Low
                card.style.backdropFilter = 'none';
                card.style.background = 'var(--theme-card)';
                break;
            case 2: // Medium (50% target)
                card.style.backdropFilter = 'blur(10px)';
                card.style.background = 'rgba(255, 255, 255, 0.1)';
                break;
            case 3: // High
                card.style.backdropFilter = 'var(--ios-blur)';
                card.style.background = 'var(--glass-bg-light)';
                break;
        }
    });
}

function optimizeMemoryUsage(level) {
    // Optimize resource loading based on memory level
    const images = document.querySelectorAll('img');
    const scripts = document.querySelectorAll('script[src]');
    
    switch(level) {
        case 1: // Efficient
            images.forEach(img => {
                if (!img.loading) img.loading = 'lazy';
            });
            break;
        case 2: // Balanced (50% target)
            images.forEach(img => {
                if (!img.loading) img.loading = 'lazy';
            });
            break;
        case 3: // Performance
            // Preload critical resources
            images.forEach(img => {
                if (img.loading === 'lazy') img.loading = 'eager';
            });
            break;
    }
}

function getOptimizationLevel(pixel, animation, graphics, memory) {
    const total = pixel + animation + graphics + memory;
    const average = total / 4;
    
    if (average <= 1.5) return 'Lightweight';
    if (average <= 2.5) return 'Balanced';
    return 'Performance';
}

function startPerformanceMonitoring() {
    // Simulate performance metrics (in real app, these would be actual measurements)
    const cpuUsage = Math.min(100, Math.max(10, Math.random() * 80));
    const memoryUsage = Math.min(100, Math.max(20, Math.random() * 70));
    const batteryLevel = Math.min(100, Math.max(30, 100 - Math.random() * 40));
    
    document.getElementById('cpuUsage').textContent = Math.round(cpuUsage) + '%';
    document.getElementById('memoryUsage').textContent = Math.round(memoryUsage) + '%';
    document.getElementById('batteryLevel').textContent = Math.round(batteryLevel) + '%';
    
    document.getElementById('cpuBar').style.width = cpuUsage + '%';
    document.getElementById('memoryBar').style.width = memoryUsage + '%';
    document.getElementById('batteryBar').style.width = batteryLevel + '%';
    
    // Update every 3 seconds
    setTimeout(startPerformanceMonitoring, 3000);
}

// Initialize device scan when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Wait for rekening system to initialize
    setTimeout(() => {
        initializeDeviceScan();
        
        // Add event listeners
        document.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'applyOptimization') {
                applyOptimizationSettings();
            }
            if (e.target && e.target.id === 'refreshOptimization') {
                performQuickDeviceScan();
                updateDynamicIsland('ðŸ”„ Settings refreshed!', 1500);
            }
        });
        
        // Add slider event listeners
        const sliders = ['pixelOptimizer', 'animationOptimizer', 'graphicsOptimizer', 'memoryOptimizer'];
        sliders.forEach(sliderId => {
            document.getElementById(sliderId).addEventListener('input', updateSliderValues);
        });
        
    }, 1500);
});

// Reuse existing functions from original code
function computeVisualScore() {
    // This function already exists in the original code, so we just reference it
    if (window.STL && window.STL.evaluateVisualTier) {
        return window.STL.evaluateVisualTier();
    }
    return { score: 50, tier: 'medium', breakdown: {} };
}
</script>
<script>
// ==================== GLOBAL PERFORMANCE & BUG FIX INJECTION ====================
(function() {
    'use strict';
    
    console.log('ðŸ”§ STL UDHIS Performance & Bug Fix Injection Activated');
    
    // ==================== MEMORY LEAK PREVENTION ====================
    let performanceCache = new Map();
    let transactionCache = null;
    let lastRenderTime = 0;
    const RENDER_DEBOUNCE = 100; // ms
    
    // ==================== ENHANCED TRANSACTION SYSTEM ====================
    const EnhancedTransactionSystem = {
        init() {
            this.setupEnhancedListeners();
            this.patchTransactionBugs();
            this.optimizeRendering();
            this.setupAutoRecovery();
        },
        
        setupEnhancedListeners() {
            // Enhanced transaction submission
            const originalAddTransaction = window.addTransaction;
            window.addTransaction = function() {
                const result = originalAddTransaction?.apply(this, arguments);
                EnhancedTransactionSystem.handleNewTransaction();
                return result;
            };
            
            // Enhanced filter system
            const originalRenderTransactions = window.renderTransactions;
            window.renderTransactions = function() {
                const now = Date.now();
                if (now - lastRenderTime < RENDER_DEBOUNCE) {
                    return;
                }
                lastRenderTime = now;
                return originalRenderTransactions?.apply(this, arguments);
            };
        },
        
        patchTransactionBugs() {
            // Fix transaction date parsing
            const originalDateHandler = window.handleTransactionDate;
            window.handleTransactionDate = function(dateString) {
                if (!dateString) {
                    const today = new Date();
                    return today.toISOString().split('T')[0];
                }
                return originalDateHandler?.(dateString) || dateString;
            };
            
            // Fix balance calculation
            const originalUpdateDashboard = window.updateDashboard;
            window.updateDashboard = function() {
                try {
                    EnhancedTransactionSystem.recalculateAllBalances();
                    return originalUpdateDashboard?.apply(this, arguments);
                } catch (error) {
                    console.error('Dashboard update error:', error);
                    EnhancedTransactionSystem.emergencyBalanceRecovery();
                }
            };
        },
        
        handleNewTransaction() {
            // Immediate cache invalidation
            transactionCache = null;
            performanceCache.delete('transactions');
            performanceCache.delete('balances');
            
            // Force UI update
            setTimeout(() => {
                this.forceRenderUpdates();
            }, 50);
        },
        
        recalculateAllBalances() {
            if (!window.FINANCIAL_STATE) return;
            
            const state = window.FINANCIAL_STATE;
            let totalBalance = 0;
            let monthlyIncome = 0;
            let monthlyExpense = 0;
            
            // Reset category balances
            Object.keys(state.categories).forEach(key => {
                state.categories[key].balance = 0;
            });
            
            // Recalculate from transactions
            state.transactions.forEach(transaction => {
                const amount = parseFloat(transaction.amount) || 0;
                
                if (transaction.type === 'debit') {
                    state.categories[transaction.fund].balance += amount;
                    totalBalance += amount;
                    
                    // Monthly calculation
                    if (this.isCurrentMonth(transaction.date)) {
                        monthlyIncome += amount;
                    }
                } else {
                    state.categories[transaction.fund].balance -= amount;
                    totalBalance -= amount;
                    
                    // Monthly calculation
                    if (this.isCurrentMonth(transaction.date)) {
                        monthlyExpense += amount;
                    }
                }
            });
            
            state.currentBalance = totalBalance;
            state.monthlyIncome = monthlyIncome;
            state.monthlyExpense = monthlyExpense;
        },
        
        isCurrentMonth(dateString) {
            const transactionDate = new Date(dateString);
            const currentDate = new Date();
            return transactionDate.getMonth() === currentDate.getMonth() && 
                   transactionDate.getFullYear() === currentDate.getFullYear();
        },
        
        optimizeRendering() {
            // Optimize transaction list rendering
            const originalRender = window.renderTransactions;
            window.renderTransactions = function() {
                const now = performance.now();
                const result = originalRender?.apply(this, arguments);
                const duration = performance.now() - now;
                
                if (duration > 16) { // 60fps threshold
                    console.warn(`Slow render: ${duration.toFixed(2)}ms`);
                    EnhancedTransactionSystem.optimizeTransactionDOM();
                }
                
                return result;
            };
        },
        
        optimizeTransactionDOM() {
            const transactionList = document.getElementById('transactionList');
            if (!transactionList) return;
            
            // Use requestAnimationFrame for smooth rendering
            requestAnimationFrame(() => {
                const items = transactionList.querySelectorAll('.transaction-item');
                if (items.length > 50) {
                    console.log('Large transaction list detected, optimizing...');
                    this.virtualizeLongList(items);
                }
            });
        },
        
        virtualizeLongList(items) {
            // Simple virtualization for large lists
            const visibleCount = 20;
            for (let i = visibleCount; i < items.length; i++) {
                items[i].style.display = 'none';
            }
            
            // Setup intersection observer for lazy loading
            if ('IntersectionObserver' in window) {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.style.display = '';
                        }
                    });
                });
                
                items.forEach(item => observer.observe(item));
            }
        },
        
        setupAutoRecovery() {
            // Auto-save enhancement
            setInterval(() => {
                if (window.saveData) {
                    window.saveData();
                }
            }, 30000); // Every 30 seconds
            
            // Data integrity check
            setInterval(() => {
                this.validateDataIntegrity();
            }, 60000); // Every minute
        },
        
        validateDataIntegrity() {
            if (!window.FINANCIAL_STATE) return;
            
            const state = window.FINANCIAL_STATE;
            let issues = [];
            
            // Check for NaN values
            if (isNaN(state.currentBalance)) {
                issues.push('Invalid current balance');
                state.currentBalance = 0;
            }
            
            // Validate transactions
            state.transactions = state.transactions.filter(transaction => 
                transaction && 
                transaction.id && 
                !isNaN(parseFloat(transaction.amount))
            );
            
            if (issues.length > 0) {
                console.warn('Data integrity issues found:', issues);
                this.emergencyDataRecovery();
            }
        },
        
        emergencyDataRecovery() {
            console.log('ðŸ”„ Emergency data recovery initiated');
            
            // Reload from localStorage
            if (window.loadSavedData) {
                window.loadSavedData();
            }
            
            // Force UI refresh
            setTimeout(() => {
                this.forceRenderUpdates();
            }, 100);
        },
        
        emergencyBalanceRecovery() {
            console.log('ðŸ”„ Emergency balance recovery');
            
            if (window.FINANCIAL_STATE) {
                const state = window.FINANCIAL_STATE;
                state.currentBalance = state.currentBalance || 0;
                state.monthlyIncome = state.monthlyIncome || 0;
                state.monthlyExpense = state.monthlyExpense || 0;
                
                Object.keys(state.categories).forEach(key => {
                    state.categories[key].balance = state.categories[key].balance || 0;
                });
            }
        },
        
        forceRenderUpdates() {
            // Force all components to re-render
            if (window.renderTransactions) window.renderTransactions();
            if (window.updateDashboard) window.updateDashboard();
            if (window.generateReportPreview) window.generateReportPreview();
            if (window.loadImportantHistory) window.loadImportantHistory();
        }
    };
    
    // ==================== MEMORY MANAGEMENT ====================
    const MemoryManager = {
        init() {
            this.setupMemoryMonitoring();
            this.cleanupOrphanedEvents();
        },
        
        setupMemoryMonitoring() {
            if (window.performance && performance.memory) {
                setInterval(() => {
                    const memory = performance.memory;
                    const used = memory.usedJSHeapSize / 1048576;
                    const limit = memory.jsHeapSizeLimit / 1048576;
                    
                    if (used > limit * 0.8) {
                        console.warn('High memory usage detected:', used.toFixed(2), 'MB');
                        this.forceGarbageCollection();
                    }
                }, 30000);
            }
        },
        
        forceGarbageCollection() {
            if (window.gc) {
                window.gc();
            } else {
                // Alternative memory cleanup
                performanceCache.clear();
                transactionCache = null;
                
                // Force DOM cleanup
                const unusedElements = document.querySelectorAll('[data-temp]');
                unusedElements.forEach(el => el.remove());
            }
        },
        
        cleanupOrphanedEvents() {
            // Clean up potential memory leaks from event listeners
            const elements = document.querySelectorAll('[data-listener]');
            elements.forEach(el => {
                if (!document.body.contains(el)) {
                    el.remove();
                }
            });
        }
    };
    
    // ==================== DOM OPTIMIZATION ====================
    const DOMOptimizer = {
        init() {
            this.optimizeEventDelegation();
            this.setupMutationObserver();
            this.optimizeAnimations();
        },
        
        optimizeEventDelegation() {
            // Use event delegation for better performance
            document.addEventListener('click', (e) => {
                this.handleDelegatedClick(e);
            });
            
            document.addEventListener('input', (e) => {
                this.handleDelegatedInput(e);
            });
        },
        
        handleDelegatedClick(e) {
            const target = e.target;
            
            // Transaction actions
            if (target.closest('.delete-transaction')) {
                e.preventDefault();
                const id = target.closest('.delete-transaction').dataset.id;
                if (window.deleteTransaction) {
                    window.deleteTransaction(parseInt(id));
                }
            }
            
            if (target.closest('.star-transaction')) {
                e.preventDefault();
                const id = target.closest('.star-transaction').dataset.id;
                if (window.addToImportantHistory) {
                    window.addToImportantHistory(parseInt(id));
                }
            }
            
            // Tab switching
            if (target.closest('.tab')) {
                e.preventDefault();
                const tabName = target.closest('.tab').dataset.tab;
                if (window.switchTab) {
                    window.switchTab(tabName);
                }
            }
        },
        
        handleDelegatedInput(e) {
            const target = e.target;
            
            // Real-time filter updates
            if (target.id === 'filterFund' || target.id === 'filterMonth') {
                if (window.renderTransactions) {
                    clearTimeout(this.filterTimeout);
                    this.filterTimeout = setTimeout(() => {
                        window.renderTransactions();
                    }, 300);
                }
            }
        },
        
        setupMutationObserver() {
            // Watch for DOM changes and optimize
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList') {
                        this.optimizeNewNodes(mutation.addedNodes);
                    }
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        },
        
        optimizeNewNodes(nodes) {
            nodes.forEach(node => {
                if (node.nodeType === 1) { // Element node
                    // Optimize new transaction items
                    if (node.classList?.contains('transaction-item')) {
                        this.optimizeTransactionNode(node);
                    }
                    
                    // Optimize new cards
                    if (node.classList?.contains('enhanced-card')) {
                        this.optimizeCardNode(node);
                    }
                }
            });
        },
        
        optimizeTransactionNode(node) {
            // Add performance optimizations
            node.style.willChange = 'transform';
            node.setAttribute('data-optimized', 'true');
        },
        
        optimizeCardNode(node) {
            // Optimize card animations
            node.style.transform = 'translateZ(0)';
        },
        
        optimizeAnimations() {
            // Use transform and opacity for better performance
            const style = document.createElement('style');
            style.textContent = `
                .transaction-item {
                    will-change: transform;
                    transform: translateZ(0);
                }
                .enhanced-card {
                    transform: translateZ(0);
                    backface-visibility: hidden;
                }
                .tab-content {
                    transform: translateZ(0);
                }
            `;
            document.head.appendChild(style);
        }
    };
    
    // ==================== DATA PERSISTENCE ENHANCEMENT ====================
    const DataPersistence = {
        init() {
            this.enhanceLocalStorage();
            this.setupAutoBackup();
            this.improveErrorHandling();
        },
        
        enhanceLocalStorage() {
            const originalSetItem = localStorage.setItem;
            localStorage.setItem = function(key, value) {
                try {
                    // Compression for large data
                    if (value.length > 1024) {
                        value = DataPersistence.compressData(value);
                    }
                    return originalSetItem.call(this, key, value);
                } catch (error) {
                    console.error('Storage error:', error);
                    DataPersistence.handleStorageFull(error);
                }
            };
            
            const originalGetItem = localStorage.getItem;
            localStorage.getItem = function(key) {
                const value = originalGetItem.call(this, key);
                if (value && value.startsWith('compressed:')) {
                    return DataPersistence.decompressData(value);
                }
                return value;
            };
        },
        
        compressData(data) {
            // Simple compression for demo (in real app, use proper compression)
            return 'compressed:' + btoa(unescape(encodeURIComponent(data)));
        },
        
        decompressData(data) {
            try {
                return decodeURIComponent(escape(atob(data.replace('compressed:', ''))));
            } catch (error) {
                return data;
            }
        },
        
        handleStorageFull(error) {
            console.error('Storage full, cleaning up...');
            
            // Remove old backup data
            const keys = Object.keys(localStorage);
            const backupKeys = keys.filter(key => key.includes('backup') || key.includes('temp'));
            
            backupKeys.forEach(key => {
                localStorage.removeItem(key);
            });
            
            // Retry operation
            setTimeout(() => {
                if (window.saveData) {
                    window.saveData();
                }
            }, 1000);
        },
        
        setupAutoBackup() {
            // Backup every 5 minutes
            setInterval(() => {
                if (window.FINANCIAL_STATE) {
                    this.createAutoBackup();
                }
            }, 300000);
        },
        
        createAutoBackup() {
            try {
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const backupKey = `stl_backup_${timestamp}`;
                const data = {
                    transactions: window.FINANCIAL_STATE.transactions,
                    categories: window.FINANCIAL_STATE.categories,
                    config: window.CONFIG,
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem(backupKey, JSON.stringify(data));
                
                // Keep only last 10 backups
                this.cleanupOldBackups();
            } catch (error) {
                console.error('Backup failed:', error);
            }
        },
        
        cleanupOldBackups() {
            const keys = Object.keys(localStorage).filter(key => key.startsWith('stl_backup_'));
            if (keys.length > 10) {
                keys.sort().slice(0, keys.length - 10).forEach(key => {
                    localStorage.removeItem(key);
                });
            }
        },
        
        improveErrorHandling() {
            window.addEventListener('error', (event) => {
                console.error('Global error:', event.error);
                this.logError(event.error);
            });
            
            window.addEventListener('unhandledrejection', (event) => {
                console.error('Unhandled promise rejection:', event.reason);
                this.logError(event.reason);
            });
        },
        
        logError(error) {
            const errorLog = {
                message: error.message,
                stack: error.stack,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent
            };
            
            const errors = JSON.parse(localStorage.getItem('stl_error_log') || '[]');
            errors.push(errorLog);
            
            if (errors.length > 50) {
                errors.shift();
            }
            
            localStorage.setItem('stl_error_log', JSON.stringify(errors));
        }
    };
    
    // ==================== INITIALIZATION ====================
    function initializeEnhancements() {
        // Wait for DOM and main app to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', startEnhancements);
        } else {
            setTimeout(startEnhancements, 100);
        }
    }
    
    function startEnhancements() {
        console.log('ðŸš€ Starting STL UDHIS performance enhancements...');
        
        EnhancedTransactionSystem.init();
        MemoryManager.init();
        DOMOptimizer.init();
        DataPersistence.init();
        
        // Apply immediate fixes
        applyCriticalFixes();
        
        console.log('âœ… STL UDHIS performance enhancements activated');
    }
    
    function applyCriticalFixes() {
        // Fix transaction form date
        const transactionDate = document.getElementById('transactionDate');
        if (transactionDate && !transactionDate.value) {
            const today = new Date().toISOString().split('T')[0];
            transactionDate.value = today;
        }
        
        // Ensure dashboard is updated
        setTimeout(() => {
            if (window.updateDashboard) {
                window.updateDashboard();
            }
            if (window.renderTransactions) {
                window.renderTransactions();
            }
        }, 500);
    }
    
    // Start the injection
    initializeEnhancements();
    
    // Export for debugging
    window.STLEnhancements = {
        EnhancedTransactionSystem,
        MemoryManager,
        DOMOptimizer,
        DataPersistence
    };
})();
</script>
<script>
  // ========== GLOBAL VIEWPORT PIXEL CONTROL ==========
(function() {
    'use strict';
    
    // Config simpel tapi powerful
    const PIXEL_MODES = {
        'auto': { name: 'Auto', scale: 1.0, maxScale: 1.0 },
        'light': { name: 'Light', scale: 0.9, maxScale: 2.0 },
        'balanced': { name: 'Balanced', scale: 1.0, maxScale: 3.0 },
        'quality': { name: 'Quality', scale: 1.1, maxScale: 3.0 },
        'ultra': { name: 'Ultra', scale: 1.2, maxScale: 4.0 }
    };

    let currentMode = 'auto';

    // ========== CORE FUNCTION - VIEWPORT CONTROL ==========
    function applyViewportControl(mode) {
        const preset = PIXEL_MODES[mode];
        const viewport = document.querySelector('meta[name="viewport"]');
        
        if (!viewport) return;
        
        // Powerful viewport control - ini yang akan mempengaruhi SEMUA element
        viewport.setAttribute('content', 
            `width=device-width, initial-scale=${preset.scale}, maximum-scale=${preset.maxScale}, user-scalable=yes`
        );
        
        // Set global CSS variable untuk konsistensi
        document.documentElement.style.setProperty('--pixel-scale', preset.scale);
        document.documentElement.style.setProperty('--pixel-max-scale', preset.maxScale);
        
        currentMode = mode;
        localStorage.setItem('stl-global-pixel-mode', mode);
        
        // Force reflow untuk apply changes
        document.body.style.display = 'none';
        document.body.offsetHeight; // Trigger reflow
        document.body.style.display = '';
        
        showNotification(`ðŸ–¥ï¸ ${preset.name} Mode Active`);
    }

    // ========== AUTO DETECTION ==========
    function autoDetectBestMode() {
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isLowEnd = navigator.deviceMemory < 4;
        const screenWidth = window.screen.width;
        
        if (isMobile && isLowEnd) return 'light';
        if (isMobile) return 'balanced';
        if (screenWidth > 1920) return 'ultra';
        if (screenWidth > 1366) return 'quality';
        return 'balanced';
    }

    // ========== SIMPLE UI INTEGRATION ==========
    function injectPixelControlToScanDevice() {
        const scanOverlay = document.getElementById('stl-block-overlay');
        if (!scanOverlay) return;
        
        const existingControl = scanOverlay.querySelector('.pixel-global-control');
        if (existingControl) return;
        
        const controlHTML = `
            <div class="pixel-global-control" style="margin:15px 0; padding:15px; background:rgba(0,0,0,0.3); border-radius:10px; border:1px solid rgba(255,255,255,0.1);">
                <div style="font-size:14px; color:#fff; margin-bottom:8px; text-align:center;">ðŸŽ›ï¸ Global Pixel Control</div>
                <div style="display:flex; gap:5px; justify-content:center; flex-wrap:wrap;">
                    ${Object.entries(PIXEL_MODES).map(([key, preset]) => `
                        <button onclick="window.globalPixelControl.setMode('${key}')" 
                                style="padding:6px 10px; border-radius:6px; border:1px solid ${currentMode === key ? '#667eea' : 'rgba(255,255,255,0.2)'}; 
                                       background:${currentMode === key ? 'rgba(102,126,234,0.4)' : 'rgba(255,255,255,0.1)'}; 
                                       color:white; cursor:pointer; font-size:11px; transition:all 0.2s;">
                            ${preset.name}
                        </button>
                    `).join('')}
                </div>
                <div style="text-align:center; font-size:10px; color:rgba(255,255,255,0.6); margin-top:8px;">
                    Scale: ${PIXEL_MODES[currentMode].scale}x â€¢ Max: ${PIXEL_MODES[currentMode].maxScale}x
                </div>
            </div>
        `;
        
        const overlayContent = scanOverlay.querySelector('div');
        if (overlayContent) {
            overlayContent.insertAdjacentHTML('beforeend', controlHTML);
        }
    }

    // ========== GLOBAL CONTROL API ==========
    window.globalPixelControl = {
        setMode: function(mode) {
            if (PIXEL_MODES[mode]) {
                applyViewportControl(mode);
                this.updateUI();
            }
        },
        
        getCurrentMode: function() {
            return { mode: currentMode, preset: PIXEL_MODES[currentMode] };
        },
        
        updateUI: function() {
            injectPixelControlToScanDevice();
        },
        
        // Auto optimize based on device
        autoOptimize: function() {
            const bestMode = autoDetectBestMode();
            this.setMode(bestMode);
        }
    };

    // ========== NOTIFICATION ==========
    function showNotification(message) {
        if (window.updateDynamicIsland) {
            window.updateDynamicIsland(message, 2000);
        } else {
            console.log('Pixel Control:', message);
        }
    }

    // ========== INITIALIZATION ==========
    function initGlobalPixelControl() {
        // Load saved preference
        const saved = localStorage.getItem('stl-global-pixel-mode');
        if (saved && PIXEL_MODES[saved]) {
            applyViewportControl(saved);
        } else {
            // Auto detect first time
            window.globalPixelControl.autoOptimize();
        }
        
        // Watch for scan device overlay
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1 && (node.id === 'stl-block-overlay' || node.querySelector?.('#stl-block-overlay'))) {
                        setTimeout(injectPixelControlToScanDevice, 100);
                    }
                });
            });
        });
        
        observer.observe(document.body, { childList: true, subtree: true });
        
        console.log('ðŸŽ¯ Global Pixel Control: READY');
    }

    // Start when ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initGlobalPixelControl);
    } else {
        initGlobalPixelControl();
    }

})();
</script>
<!-- ==================== SUPER PERFORMANCE INJECTION SCRIPT ==================== -->
<script>
(function() {
    'use strict';
    
    // ========== ULTRA PERFORMANCE CONFIGURATION ==========
    const PERFORMANCE_CONFIG = {
        // Memory Management
        MAX_MEMORY_CACHE: 50, // MB
        CLEANUP_INTERVAL: 30000, // 30 seconds
        LAZY_LOAD_THRESHOLD: 0.8, // 80% viewport
        
        // Rendering Optimization
        USE_VIRTUAL_DOM: true,
        DEBOUNCE_RENDER: 16, // ~60fps
        BATCH_UPDATES: true,
        
        // Network Optimization
        CACHE_STRATEGY: 'stale-while-revalidate',
        PRELOAD_CRITICAL: true,
        CONNECTION_OPTIMIZATION: true
    };

    // ========== ADVANCED PLATFORM DETECTION ==========
    class SuperPlatformDetector {
        constructor() {
            this.ua = navigator.userAgent;
            this.platform = this.detectPlatform();
            this.browser = this.detectBrowser();
            this.engine = this.detectEngine();
            this.capabilities = this.detectCapabilities();
        }

        detectPlatform() {
            const ua = this.ua.toLowerCase();
            
            // OS Detection
            if (ua.includes('windows')) return 'windows';
            if (ua.includes('mac os') || ua.includes('macos')) return 'macos';
            if (ua.includes('linux')) return 'linux';
            if (ua.includes('android')) return 'android';
            if (ua.includes('ios') || ua.includes('iphone') || ua.includes('ipad')) return 'ios';
            if (ua.includes('cros')) return 'chromeos';
            
            // Additional mobile detection
            if (/Mobile|Android|iP(hone|od|ad)/.test(ua)) {
                if (ua.includes('android')) return 'android';
                if (ua.includes('iphone') || ua.includes('ipad')) return 'ios';
                return 'mobile';
            }
            
            return 'unknown';
        }

        detectBrowser() {
            const ua = this.ua.toLowerCase();
            
            if (ua.includes('chrome') && !ua.includes('edg')) return 'chrome';
            if (ua.includes('firefox')) return 'firefox';
            if (ua.includes('safari') && !ua.includes('chrome')) return 'safari';
            if (ua.includes('edg')) return 'edge';
            if (ua.includes('opera') || ua.includes('opr')) return 'opera';
            if (ua.includes('samsung')) return 'samsung';
            if (ua.includes('ucbrowser')) return 'uc';
            
            return 'unknown';
        }

        detectEngine() {
            const ua = this.ua.toLowerCase();
            
            if (ua.includes('applewebkit')) return 'webkit';
            if (ua.includes('gecko') && !ua.includes('like gecko')) return 'gecko';
            if (ua.includes('blink')) return 'blink';
            if (ua.includes('trident') || ua.includes('msie')) return 'trident';
            
            return 'unknown';
        }

        detectCapabilities() {
            return {
                // Web APIs
                serviceWorker: 'serviceWorker' in navigator,
                webGL: !!document.createElement('canvas').getContext('webgl'),
                webGPU: 'gpu' in navigator,
                wasm: 'WebAssembly' in window,
                
                // Storage
                localStorage: 'localStorage' in window,
                sessionStorage: 'sessionStorage' in window,
                indexedDB: 'indexedDB' in window,
                
                // Media
                webRTC: 'RTCPeerConnection' in window,
                webAudio: 'AudioContext' in window,
                webSpeech: 'speechSynthesis' in window,
                
                // Performance
                memory: 'memory' in performance,
                hardwareConcurrency: 'hardwareConcurrency' in navigator,
                deviceMemory: 'deviceMemory' in navigator,
                
                // Modern APIs
                intersectionObserver: 'IntersectionObserver' in window,
                mutationObserver: 'MutationObserver' in window,
                resizeObserver: 'ResizeObserver' in window,
                performanceObserver: 'PerformanceObserver' in window
            };
        }

        getOptimizationProfile() {
            const profile = {
                platform: this.platform,
                browser: this.browser,
                engine: this.engine,
                isMobile: ['android', 'ios', 'mobile'].includes(this.platform),
                isTouch: 'ontouchstart' in window || navigator.maxTouchPoints > 0,
                capabilities: this.capabilities
            };

            // Platform-specific optimizations
            if (profile.isMobile) {
                profile.optimizations = {
                    useTransform3d: true,
                    minimizeRepaints: true,
                    touchOptimized: true,
                    memoryConservative: true
                };
            } else {
                profile.optimizations = {
                    useTransform3d: true,
                    maximizePerformance: true,
                    preloadAssets: true
                };
            }

            // Browser-specific optimizations
            if (profile.browser === 'safari') {
                profile.optimizations.safariSpecific = true;
                profile.optimizations.avoidCertainTransforms = true;
            }

            return profile;
        }
    }

    // ========== MEMORY MANAGEMENT SYSTEM ==========
    class MemoryManager {
        constructor() {
            this.cache = new Map();
            this.cleanupInterval = setInterval(() => this.cleanup(), PERFORMANCE_CONFIG.CLEANUP_INTERVAL);
            this.memoryUsage = 0;
        }

        set(key, value, size = 1) {
            if (this.memoryUsage + size > PERFORMANCE_CONFIG.MAX_MEMORY_CACHE) {
                this.evictLRU();
            }
            
            this.cache.set(key, {
                value: value,
                size: size,
                lastAccessed: Date.now()
            });
            
            this.memoryUsage += size;
        }

        get(key) {
            const item = this.cache.get(key);
            if (item) {
                item.lastAccessed = Date.now();
                return item.value;
            }
            return null;
        }

        evictLRU() {
            let oldestKey = null;
            let oldestTime = Date.now();
            
            for (const [key, item] of this.cache) {
                if (item.lastAccessed < oldestTime) {
                    oldestTime = item.lastAccessed;
                    oldestKey = key;
                }
            }
            
            if (oldestKey) {
                const item = this.cache.get(oldestKey);
                this.memoryUsage -= item.size;
                this.cache.delete(oldestKey);
            }
        }

        cleanup() {
            const now = Date.now();
            const maxAge = 300000; // 5 minutes
            
            for (const [key, item] of this.cache) {
                if (now - item.lastAccessed > maxAge) {
                    this.memoryUsage -= item.size;
                    this.cache.delete(key);
                }
            }
        }

        clear() {
            this.cache.clear();
            this.memoryUsage = 0;
        }
    }

    // ========== RENDERING OPTIMIZER ==========
    class RenderingOptimizer {
        constructor() {
            this.updateQueue = new Set();
            this.isBatching = false;
            this.rafId = null;
        }

        scheduleUpdate(element, updateFn) {
            this.updateQueue.add({ element, updateFn });
            
            if (!this.isBatching) {
                this.isBatching = true;
                this.rafId = requestAnimationFrame(() => this.processUpdates());
            }
        }

        processUpdates() {
            const updates = Array.from(this.updateQueue);
            this.updateQueue.clear();
            
            // Batch DOM reads
            const reads = updates.map(update => ({
                element: update.element,
                metrics: this.getMetrics(update.element)
            }));
            
            // Batch DOM writes
            updates.forEach((update, index) => {
                update.updateFn(update.element, reads[index].metrics);
            });
            
            this.isBatching = false;
        }

        getMetrics(element) {
            return {
                rect: element.getBoundingClientRect(),
                computedStyle: window.getComputedStyle(element)
            };
        }

        cancel() {
            if (this.rafId) {
                cancelAnimationFrame(this.rafId);
                this.rafId = null;
            }
            this.updateQueue.clear();
            this.isBatching = false;
        }
    }

    // ========== NETWORK OPTIMIZER ==========
    class NetworkOptimizer {
        constructor() {
            this.cache = new MemoryManager();
            this.preloadQueue = new Set();
        }

        async fetchWithCache(url, options = {}) {
            const cacheKey = `network:${url}`;
            const cached = this.cache.get(cacheKey);
            
            if (cached && !options.forceRefresh) {
                return cached;
            }

            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Cache-Control': 'max-age=300',
                        ...options.headers
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.cache.set(cacheKey, data, 1);
                    return data;
                }
            } catch (error) {
                console.warn('Network request failed:', error);
                return cached || null;
            }
        }

        preloadResource(url, type = 'script') {
            if (this.preloadQueue.has(url)) return;
            
            this.preloadQueue.add(url);
            
            const link = document.createElement('link');
            link.rel = type === 'script' ? 'preload' : 'prefetch';
            link.href = url;
            link.as = type;
            
            if (type === 'script') {
                link.onload = () => this.preloadQueue.delete(url);
                link.onerror = () => this.preloadQueue.delete(url);
            }
            
            document.head.appendChild(link);
        }

        optimizeImages() {
            const images = document.querySelectorAll('img[data-src], img[data-srcset]');
            
            const io = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        this.loadImage(img);
                        io.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px 0px',
                threshold: 0.1
            });
            
            images.forEach(img => io.observe(img));
        }

        loadImage(img) {
            const src = img.getAttribute('data-src');
            const srcset = img.getAttribute('data-srcset');
            
            if (src) img.src = src;
            if (srcset) img.srcset = srcset;
            
            img.removeAttribute('data-src');
            img.removeAttribute('data-srcset');
        }
    }

    // ========== EVENT OPTIMIZER ==========
    class EventOptimizer {
        constructor() {
            this.handlers = new Map();
            this.passiveEvents = ['touchstart', 'touchmove', 'wheel', 'mousewheel'];
        }

        addEventListener(element, event, handler, options = {}) {
            const optimizedOptions = this.getOptimizedOptions(options);
            const wrappedHandler = this.wrapHandler(handler, element, event);
            
            element.addEventListener(event, wrappedHandler, optimizedOptions);
            
            const key = `${event}-${handler.toString().hashCode()}`;
            this.handlers.set(key, { element, event, handler: wrappedHandler, options: optimizedOptions });
            
            return () => this.removeEventListener(key);
        }

        removeEventListener(key) {
            const handlerInfo = this.handlers.get(key);
            if (handlerInfo) {
                handlerInfo.element.removeEventListener(
                    handlerInfo.event, 
                    handlerInfo.handler, 
                    handlerInfo.options
                );
                this.handlers.delete(key);
            }
        }

        getOptimizedOptions(options) {
            if (this.passiveEvents.includes(options.event) && options.passive === undefined) {
                return { ...options, passive: true };
            }
            return options;
        }

        wrapHandler(handler, element, event) {
            return function optimizedHandler(e) {
                // Prevent default only when necessary
                if (handler.preventDefault && e.cancelable) {
                    e.preventDefault();
                }
                
                // Stop propagation only when necessary
                if (handler.stopPropagation) {
                    e.stopPropagation();
                }
                
                handler.call(element, e);
            };
        }

        debounce(fn, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        throttle(fn, limit) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    fn.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }
    }

    // ========== MAIN PERFORMANCE BOOSTER ==========
    class PerformanceBooster {
        constructor() {
            this.detector = new SuperPlatformDetector();
            this.memoryManager = new MemoryManager();
            this.renderOptimizer = new RenderingOptimizer();
            this.networkOptimizer = new NetworkOptimizer();
            this.eventOptimizer = new EventOptimizer();
            this.profile = this.detector.getOptimizationProfile();
            
            this.init();
        }

        init() {
            this.applyPlatformOptimizations();
            this.setupPerformanceMonitoring();
            this.optimizeCriticalPath();
            this.setupMemoryProtection();
            this.injectCSSOptimizations();
        }

        applyPlatformOptimizations() {
            const { platform, browser, optimizations } = this.profile;
            
            // Add platform classes to HTML
            document.documentElement.classList.add(
                `platform-${platform}`,
                `browser-${browser}`,
                optimizations.isMobile ? 'mobile-device' : 'desktop-device',
                optimizations.isTouch ? 'touch-device' : 'pointer-device`
            );

            // Platform-specific optimizations
            if (optimizations.isMobile) {
                this.optimizeForMobile();
            } else {
                this.optimizeForDesktop();
            }

            // Browser-specific fixes
            if (browser === 'safari') {
                this.applySafariFixes();
            }
        }

        optimizeForMobile() {
            // Touch optimization
            this.eventOptimizer.addEventListener(document, 'touchstart', () => {}, { passive: true });
            this.eventOptimizer.addEventListener(document, 'touchmove', () => {}, { passive: true });
            
            // Viewport optimization
            this.setViewportOptimization();
            
            // Memory optimization
            this.setupMemoryWatcher();
        }

        optimizeForDesktop() {
            // Enable hardware acceleration
            this.enableHardwareAcceleration();
            
            // Preload critical resources
            this.preloadCriticalAssets();
        }

        applySafariFixes() {
            // Safari-specific CSS fixes
            const style = document.createElement('style');
            style.textContent = `
                .safari-fix {
                    -webkit-transform: translateZ(0);
                    transform: translateZ(0);
                }
                input, textarea {
                    -webkit-appearance: none;
                    border-radius: 0;
                }
            `;
            document.head.appendChild(style);
        }

        setViewportOptimization() {
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                viewport.setAttribute('content', 
                    'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no'
                );
            }
        }

        enableHardwareAcceleration() {
            const style = document.createElement('style');
            style.textContent = `
                .hardware-accelerated {
                    transform: translateZ(0);
                    backface-visibility: hidden;
                    perspective: 1000px;
                }
                .will-change {
                    will-change: transform, opacity;
                }
            `;
            document.head.appendChild(style);
        }

        preloadCriticalAssets() {
            // Preload critical fonts
            this.networkOptimizer.preloadResource('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap', 'style');
            
            // Preload critical images
            const criticalImages = [
                'https://pfst.cf2.poecdn.net/base/image/d6d81ade0a0eeac8cf2315ace4420bf84df883795c9513b9b3af822e0d0730ae?w=1563&h=1563'
            ];
            
            criticalImages.forEach(img => this.networkOptimizer.preloadResource(img, 'image'));
        }

        setupPerformanceMonitoring() {
            // Monitor long tasks
            if ('PerformanceObserver' in window) {
                const observer = new PerformanceObserver((list) => {
                    for (const entry of list.getEntries()) {
                        if (entry.duration > 50) {
                            console.warn('Long task detected:', entry);
                            this.optimizeLongTask(entry);
                        }
                    }
                });
                
                observer.observe({ entryTypes: ['longtask'] });
            }

            // Monitor memory usage
            this.setupMemoryWatcher();
        }

        setupMemoryWatcher() {
            if ('memory' in performance) {
                setInterval(() => {
                    const memory = performance.memory;
                    const used = memory.usedJSHeapSize / 1048576; // Convert to MB
                    
                    if (used > PERFORMANCE_CONFIG.MAX_MEMORY_CACHE * 0.8) {
                        this.memoryManager.cleanup();
                        this.forceGarbageCollection();
                    }
                }, 10000);
            }
        }

        forceGarbageCollection() {
            if (window.gc) {
                window.gc();
            } else if (window.GCController) {
                window.GCController.collect();
            } else {
                // Force GC by allocating and releasing memory
                try {
                    const garbage = new Array(1000000).fill(null);
                    setTimeout(() => garbage.length = 0, 0);
                } catch (e) {}
            }
        }

        optimizeCriticalPath() {
            // Defer non-critical CSS
            this.deferNonCriticalCSS();
            
            // Optimize images
            this.networkOptimizer.optimizeImages();
            
            // Remove unused CSS/JS
            this.removeUnusedResources();
        }

        deferNonCriticalCSS() {
            const nonCriticalLinks = Array.from(document.querySelectorAll('link[rel="stylesheet"]'))
                .filter(link => !link.media || link.media === 'all');
            
            nonCriticalLinks.forEach(link => {
                link.media = 'print';
                link.onload = () => link.media = 'all';
            });
        }

        removeUnusedResources() {
            // Remove duplicate or unused resources
            const resources = {
                scripts: new Set(),
                styles: new Set()
            };
            
            Array.from(document.querySelectorAll('script[src]')).forEach(script => {
                const src = script.src;
                if (resources.scripts.has(src)) {
                    script.remove();
                } else {
                    resources.scripts.add(src);
                }
            });
            
            Array.from(document.querySelectorAll('link[rel="stylesheet"]')).forEach(link => {
                const href = link.href;
                if (resources.styles.has(href)) {
                    link.remove();
                } else {
                    resources.styles.add(href);
                }
            });
        }

        setupMemoryProtection() {
            // Protect against memory leaks
            window.addEventListener('beforeunload', () => {
                this.cleanup();
            });

            // Handle page visibility changes
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    this.reduceMemoryUsage();
                }
            });
        }

        reduceMemoryUsage() {
            this.memoryManager.cleanup();
            this.renderOptimizer.cancel();
            this.forceGarbageCollection();
        }

        injectCSSOptimizations() {
            const optimizedCSS = `
                /* Performance Optimized CSS */
                .performance-optimized {
                    /* Containment for better performance */
                    contain: layout style paint;
                    /* Optimize scrolling */
                    -webkit-overflow-scrolling: touch;
                    /* Reduce repaints */
                    backface-visibility: hidden;
                }
                
                /* Optimize animations */
                @media (prefers-reduced-motion: no-preference) {
                    .optimized-animation {
                        animation-duration: 0.3s;
                        animation-fill-mode: both;
                        animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                    }
                }
                
                /* Critical above-the-fold styles */
                .critical-render {
                    opacity: 1 !important;
                    visibility: visible !important;
                    display: block !important;
                }
                
                /* Hardware acceleration layers */
                .gpu-layer {
                    transform: translateZ(0);
                    -webkit-transform: translateZ(0);
                }
            `;
            
            const style = document.createElement('style');
            style.textContent = optimizedCSS;
            style.setAttribute('data-performance', 'optimized');
            document.head.appendChild(style);
        }

        optimizeLongTask(entry) {
            console.log('Optimizing long task:', entry.name);
            
            // Split long tasks
            if (entry.duration > 100) {
                setTimeout(() => {
                    this.forceGarbageCollection();
                }, 0);
            }
        }

        cleanup() {
            this.memoryManager.clear();
            this.renderOptimizer.cancel();
            clearInterval(this.memoryManager.cleanupInterval);
        }
    }

    // ========== HELPER FUNCTIONS ==========
    
    // String hash function for handler keys
    String.prototype.hashCode = function() {
        let hash = 0;
        for (let i = 0; i < this.length; i++) {
            const char = this.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // Convert to 32bit integer
        }
        return hash;
    };

    // ========== INITIALIZATION ==========
    
    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            window.SUPER_PERFORMANCE = new PerformanceBooster();
        });
    } else {
        window.SUPER_PERFORMANCE = new PerformanceBooster();
    }

    // Expose to global scope for debugging
    window.PerformanceBooster = PerformanceBooster;
    window.SuperPlatformDetector = SuperPlatformDetector;

    console.log('ðŸš€ Super Performance Booster Activated!');
})();
</script>

<!-- ==================== CRITICAL PERFORMANCE CSS ==================== -->
<style>
/* Critical rendering path optimizations */
html.super-perf {
    /* Force hardware acceleration */
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
}

body.super-perf {
    /* Contain layout */
    contain: layout style paint;
    /* Optimize text rendering */
    text-rendering: optimizeSpeed;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    /* Improve scrolling */
    -webkit-overflow-scrolling: touch;
}

/* Platform-specific optimizations */
.platform-ios body {
    /* iOS specific optimizations */
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
}

.platform-android body {
    /* Android specific optimizations */
    -webkit-user-select: none;
    user-select: none;
}

.browser-safari .enhanced-card {
    /* Safari rendering fixes */
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
}

/* Performance-critical animations */
@media (prefers-reduced-motion: no-preference) {
    .performance-animation {
        animation-duration: 0.2s;
        animation-fill-mode: both;
        animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        /* Use transforms for animations */
        will-change: transform, opacity;
    }
}

/* Optimize images and media */
img.performance-optimized {
    content-visibility: auto;
    contain-intrinsic-size: 1px 1000px;
}

/* Reduce layout thrashing */
.stable-layout {
    contain: layout style paint;
}

/* Memory efficient shadows */
.memory-shadow {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

@media (min-width: 768px) {
    .memory-shadow {
        box-shadow: 0 4px 8px rgba(0,0,0,0.12);
    }
}

/* Optimize expensive CSS properties */
.performance-paint {
    /* Avoid expensive properties */
    box-shadow: none;
    border-radius: 0;
    opacity: 1;
}

.performance-paint.expensive {
    /* Only apply when necessary */
    box-shadow: var(--shadow-sm);
    border-radius: var(--radius-lg);
}
</style>
<script>
  // ==================== INJEKSI mongoDB: AUTH + FIRESTORE + STORAGE ====================
// LETAKKAN INI DI BAWAH SEMUA SCRIPT LAIN SEBELUM </body>
// Pastikan SDK mongoDB-app-compat, mongoDB-auth-compat, mongoDB-firestore-compat sudah ada di <head>.

(function(){
  'use strict';

  // --------- 1) CONFIG: masukkan mongoDBConfig Anda di sini ---------
  const mongoDBConfig = {
    apiKey: "GANTI_DENGAN_API_KEY_ANDA",
    authDomain: "GANTI_DENGAN_AUTH_DOMAIN_ANDA",
    projectId: "GANTI_DENGAN_PROJECT_ID_ANDA",
    storageBucket: "GANTI_DENGAN_STORAGE_BUCKET_ANDA",
    messagingSenderId: "GANTI_DENGAN_SENDER_ID_ANDA",
    appId: "GANTI_DENGAN_APP_ID_ANDA"
  };

  // --------- 2) INIT mongoDB (compat) ---------
  let fb_app, fb_auth, fb_db, fb_storage;
  try {
    fb_app = mongoDB.initializeApp(mongoDBConfig);
    fb_auth = mongoDB.auth();
    fb_db = mongoDB.firestore();
    fb_storage = mongoDB.storage();
    console.log('ðŸ”¥ mongoDB initialized (inject)');
  } catch (err) {
    console.error('âŒ mongoDB init fail:', err);
    // non-fatal: fall back to local-only mode (we'll still keep existing localStorage)
  }

  // --------- 3) Helpers: AES encrypt/decrypt using CryptoJS (keamanan tetap di client) ---------
  function aesEncrypt(obj, pass) {
    try {
      return CryptoJS.AES.encrypt(JSON.stringify(obj), pass).toString();
    } catch (e) { console.error('aesEncrypt', e); return null; }
  }
  function aesDecrypt(cipherText, pass) {
    try {
      const plain = CryptoJS.AES.decrypt(cipherText, pass).toString(CryptoJS.enc.Utf8);
      return plain ? JSON.parse(plain) : null;
    } catch (e) { console.warn('aesDecrypt fail', e); return null; }
  }

  // --------- 4) mongoDB Auth wrapper (Google) ---------
  const mongoDBAuthenticator = {
    currentUser: null,
    initAuthListener() {
      if(!fb_auth) return;
      fb_auth.onAuthStateChanged(user => {
        this.currentUser = user || null;
        if(user) {
          console.log('ðŸ” mongoDB user:', user.uid, user.email);
          // UI swap: sembunyikan layar passphrase, tampilkan content jika ada
          try {
            document.getElementById('rekeningAuth').style.display = 'none';
            document.getElementById('rekeningContent').style.display = 'block';
          } catch(e){}
          mongoDBDataManager.loadAllData(user.uid);
        } else {
          console.log('ðŸ”“ No mongoDB user');
          try {
            document.getElementById('rekeningAuth').style.display = 'block';
            document.getElementById('rekeningContent').style.display = 'none';
          } catch(e){}
        }
      });
    },
    signInWithGoogle() {
      if(!fb_auth) { showAccountMessage('mongoDB tidak tersedia', 'error'); return; }
      const provider = new mongoDB.auth.GoogleAuthProvider();
      fb_auth.signInWithPopup(provider).catch(err => {
        console.error('Google signIn failed', err);
        showAccountMessage('Login Google gagal: ' + (err.message || err), 'error');
      });
    },
    signOut() {
      if(!fb_auth) return;
      fb_auth.signOut().then(() => {
        // clear sensitive in-memory
        ACCOUNT_STATE.isAuthenticated = false;
        ACCOUNT_STATE.passphrase = '';
        window.FINANCIAL_STATE = window.FINANCIAL_STATE || {transactions:[], categories:{}, currentBalance:0};
        if(typeof updateDashboard === 'function') try{ updateDashboard(); }catch(e){}
      }).catch(err => console.error('signOut err', err));
    }
  };

  // --------- 5) mongoDB Data Manager: Firestore for JSON state, Storage for large backups ---------
  const mongoDBDataManager = {
    async saveAllData(uid, pass) {
      if(!fb_db || !uid) return;
      // Build payload: encrypt both states with user-provided passphrase (pass required for re-encryption)
      const finance = {
        transactions: window.FINANCIAL_STATE?.transactions || [],
        categories: window.FINANCIAL_STATE?.categories || {},
        currentBalance: window.FINANCIAL_STATE?.currentBalance || 0,
        monthlyIncome: window.FINANCIAL_STATE?.monthlyIncome || 0,
        monthlyExpense: window.FINANCIAL_STATE?.monthlyExpense || 0
      };
      const accounts = {
        accounts: window.ACCOUNT_STATE?.accounts || []
      };

      // We store encrypted blobs so even Firestore content is ciphertext
      const encFinance = aesEncrypt(finance, pass);
      const encAccounts = aesEncrypt(accounts, pass);

      try {
        await fb_db.collection('userData').doc(uid).set({
          finance: encFinance,
          accounts: encAccounts,
          meta: { updatedAt: mongoDB.firestore.FieldValue.serverTimestamp(), version: 1 }
        }, { merge: true });
        console.log('â˜ï¸ saveAllData -> Firestore OK');
        if(window.updateDynamicIsland) updateDynamicIsland('â˜ï¸ Data tersinkronisasi ke cloud', 1400);
      } catch (e) {
        console.error('Firestore saveAllData err', e);
        showAccountMessage('Gagal simpan cloud: ' + (e.message||e), 'error');
      }
    },

    async loadAllData(uid) {
      if(!fb_db || !uid) return;
      try {
        const doc = await fb_db.collection('userData').doc(uid).get();
        if(!doc.exists) {
          console.log('â˜ï¸ userData doc not found');
          return;
        }
        const d = doc.data();
        // d.finance & d.accounts are encrypted strings (AES by client)
        // We do NOT have passphrase here; caller must provide passphrase (we'll call decryptAttempt)
        window.__STL__mongoDBPayload = d; // temporarily store for decryption attempt
        console.log('â˜ï¸ userData payload loaded (encrypted)');
        // Caller expected to call decryptUsingPassphrase(pass)
      } catch (e) {
        console.error('Firestore loadAllData err', e);
        showAccountMessage('Gagal memuat cloud: ' + (e.message||e), 'error');
      }
    },

    // Upload encrypted backup blob to mongoDB Storage and return download URL
    async uploadBackupBlob(uid, filename, blob) {
      if(!fb_storage || !uid) throw new Error('mongoDB Storage unavailable');
      const ref = fb_storage.ref().child(`backups/${uid}/${filename}`);
      const snapshot = await ref.put(blob);
      const url = await snapshot.ref.getDownloadURL();
      return url;
    },

    // Download backup blob reference (if you saved URL previously)
    async deleteBackup(uid, filename) {
      if(!fb_storage || !uid) throw new Error('mongoDB Storage unavailable');
      const ref = fb_storage.ref().child(`backups/${uid}/${filename}`);
      return ref.delete();
    }
  };

  // --------- 6) Bridge: replace local save/load with cloud-enabled flows ---------
  // Hijack global saveData if present in page â€” ensure it saves to cloud if user logged in, else localStorage as fallback.
  const originalSaveData = window.saveData || (() => { /*no-op*/ });

  window.saveData = function() {
    try {
      // If user authenticated with mongoDB AND ACCOUNT_STATE.passphrase exists -> save encrypted to Firestore
      const uid = mongoDBAuthenticator.currentUser?.uid;
      const passphrase = ACCOUNT_STATE.passphrase || null;

      if(uid && passphrase) {
        // Save both FINANCIAL_STATE & ACCOUNT_STATE encrypted
        mongoDBDataManager.saveAllData(uid, passphrase);
        // Also keep local encrypted backup for offline resilience
        try {
          encryptAndSaveAccounts(passphrase); // existing function that writes localStorage (we will patch it below)
        } catch(e){}
        return;
      }

      // Fallback: call original local save (kept for backward compatibility)
      originalSaveData();
    } catch (e) {
      console.error('saveData wrapper err', e);
      originalSaveData();
    }
  };

  // --------- 7) Decrypt mongoDB payload (when available) using user's passphrase ---------
  async function decryptmongoDBPayloadWithPass(passphrase) {
    const payload = window.__STL__mongoDBPayload;
    if(!payload) return false;
    try {
      const financePlain = aesDecrypt(payload.finance, passphrase);
      const accountsPlain = aesDecrypt(payload.accounts, passphrase);
      if(!financePlain || !accountsPlain) {
        console.warn('decryptmongoDBPayload: decrypt returned null (bad pass?)');
        return false;
      }
      // Merge into existing states
      Object.assign(window.FINANCIAL_STATE, financePlain);
      Object.assign(window.ACCOUNT_STATE, accountsPlain);
      // Re-render app
      if(typeof recalculateBalances === 'function') try{ recalculateBalances(); }catch(e){}
      if(typeof renderTransactions === 'function') try{ renderTransactions(); }catch(e){}
      if(typeof updateDashboard === 'function') try{ updateDashboard(); }catch(e){}
      console.log('â˜ï¸ Data cloud didekripsi dan dimuat ke state');
      return true;
    } catch (e) {
      console.error('decryptmongoDBPayloadWithPass err', e);
      return false;
    }
  }

  // --------- 8) Patch/augment existing account functions to use cloud when available ---------
  // Replace encryptAndSaveAccounts (local) to also optionally push to cloud
  const old_encryptAndSaveAccounts = window.encryptAndSaveAccounts;
  window.encryptAndSaveAccounts = function(passphrase = ACCOUNT_STATE.passphrase) {
    try {
      if(!passphrase) return;
      // existing local encryption: keep for offline fallback
      try { old_encryptAndSaveAccounts(passphrase); } catch(e) {}
      // if mongoDB logged in, upload encrypted accounts into Firestore doc
      const uid = mongoDBAuthenticator.currentUser?.uid;
      if(uid && fb_db) {
        // Save structured accounts encrypted
        const accounts = { accounts: ACCOUNT_STATE.accounts, lastUpdated: new Date().toISOString() };
        const enc = aesEncrypt(accounts, passphrase);
        fb_db.collection('userData').doc(uid).set({ accounts: enc, meta: { lastAccountSave: mongoDB.firestore.FieldValue.serverTimestamp() } }, { merge: true })
          .then(()=> console.log('â˜ï¸ accounts saved to firestore'))
          .catch(e=> console.warn('firestore accounts save err', e));
      }
    } catch (e) { console.error('patched encryptAndSaveAccounts err', e); }
  };

  // Replace loadAndDecryptAccounts to prefer firestore payload when user logged in
  const old_loadAndDecryptAccounts = window.loadAndDecryptAccounts;
  window.loadAndDecryptAccounts = function() {
    const uid = mongoDBAuthenticator.currentUser?.uid;
    const pass = ACCOUNT_STATE.passphrase;
    // If mongoDB user exists, try to fetch doc and decrypt
    if(uid && fb_db && pass) {
      fb_db.collection('userData').doc(uid).get().then(doc => {
        if(!doc.exists) {
          console.log('No cloud doc, fallback to local');
          try { old_loadAndDecryptAccounts(); } catch(e) {}
          return;
        }
        const d = doc.data();
        const encAccounts = d.accounts || null;
        const encFinance = d.finance || null;
        let ok = false;
        if(encAccounts) {
          const decA = aesDecrypt(encAccounts, pass);
          if(decA && decA.accounts) {
            ACCOUNT_STATE.accounts = decA.accounts;
            ok = true;
          }
        }
        if(encFinance) {
          const decF = aesDecrypt(encFinance, pass);
          if(decF && decF.transactions) {
            Object.assign(window.FINANCIAL_STATE, decF);
            ok = true;
          }
        }
        if(ok) {
          console.log('â˜ï¸ loadAndDecryptAccounts: loaded from cloud');
          if(typeof updateAccountsDisplay === 'function') try{ updateAccountsDisplay(); }catch(e){}
          if(typeof renderTransactions === 'function') try{ renderTransactions(); }catch(e){}
          if(typeof updateDashboard === 'function') try{ updateDashboard(); }catch(e){}
        } else {
          console.log('â˜ï¸ cloud data decrypt failed/fallback to local');
          try { old_loadAndDecryptAccounts(); } catch(e) {}
        }
      }).catch(err => {
        console.error('loadAndDecryptAccounts firestore err', err);
        try { old_loadAndDecryptAccounts(); } catch(e) {}
      });
    } else {
      try { old_loadAndDecryptAccounts(); } catch(e) {}
    }
  };

  // --------- 9) Backup / Restore integration: upload encrypted .enc to mongoDB Storage ---------
  // Patch existing backupData / restoreData if present
  const old_backupData = window.backupCloud;
  window.backupCloud = async function() {
    try {
      const password = document.getElementById('backupPassword')?.value || '';
      if(!password) { updateDynamicIsland?.('Masukkan password backup',2000); return; }
      const data = {
        transactions: FINANCIAL_STATE.transactions,
        categories: FINANCIAL_STATE.categories,
        config: CONFIG,
        accounts: ACCOUNT_STATE.accounts,
        timestamp: new Date().toISOString()
      };
      const enc = aesEncrypt(data, password);
      const blob = new Blob([enc], { type: 'application/octet-stream' });
      // If mongoDB available & user logged in -> upload and return url
      const uid = mongoDBAuthenticator.currentUser?.uid;
      if(uid && fb_storage) {
        const filename = `stl-backup-${new Date().toISOString()}.enc`;
        try {
          const url = await mongoDBDataManager.uploadBackupBlob(uid, filename, blob);
          // optionally save metadata in Firestore
          if(fb_db) {
            await fb_db.collection('userData').doc(uid).collection('backups').add({ filename, url, createdAt: mongoDB.firestore.FieldValue.serverTimestamp() });
          }
          updateDynamicIsland?.('âœ… Backup berhasil dan tersimpan di cloud',2000);
          return url;
        } catch (e) {
          console.warn('Storage upload err, fallback to local download', e);
        }
      }
      // fallback: download file to user device
      saveAs(blob, `stl-backup-${new Date().toISOString().split('T')[0]}.enc`);
      updateDynamicIsland?.('âœ… Backup tersimpan lokal',2000);
    } catch (e) {
      console.error('backupData err', e);
      updateDynamicIsland?.('âŒ Backup gagal',2000);
    }
  };

  // Restore: allow user to pick .enc file then attempt decrypt with provided password; optionally upload to firestore
  window.restoreCloud = function() {
    const password = document.getElementById('backupPassword')?.value || '';
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.enc';
    input.onchange = async (e) => {
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(ev) {
        try {
          const enc = ev.target.result;
          const dec = aesDecrypt(enc, password);
          if(!dec) { updateDynamicIsland?.('âŒ Password restore salah',2000); return; }
          // Restore into states
          FINANCIAL_STATE.transactions = dec.transactions || [];
          FINANCIAL_STATE.categories = dec.categories || FINANCIAL_STATE.categories || {};
          Object.assign(CONFIG, dec.config || {});
          ACCOUNT_STATE.accounts = dec.accounts || [];
          // Recalculate and render
          try { recalculateBalances(); } catch(e){}
          try { renderTransactions(); } catch(e){}
          try { updateDashboard(); } catch(e){}
          // Persist: call saveData() wrapper
          window.saveData();
          updateDynamicIsland?.('âœ… Data berhasil direstore',2000);
        } catch (err) {
          console.error('restoreData err', err);
          updateDynamicIsland?.('âŒ Gagal restore',2000);
        }
      };
      reader.readAsText(file);
    };
    input.click();
  };

  // --------- 10) Wire UI buttons (existing IDs in your HTML) to mongoDB flows ---------
  document.addEventListener('DOMContentLoaded', function() {
    // Init auth listener
    if(fb_auth) mongoDBAuthenticator.initAuthListener();

    // Hijack unlock button -> if user is signed in, attempt decrypt using passphrase; else prompt user to sign-in via Google
    const unlockButton = document.getElementById('unlockRekening');
    if(unlockButton) {
      unlockButton.addEventListener('click', async function() {
        const pass = document.getElementById('rekeningPassphrase')?.value || '';
        if(!pass) { showAccountMessage('Masukkan passphrase terlebih dahulu', 'error'); return; }

        // If mongoDB user present -> try to load cloud payload and decrypt
        const uid = mongoDBAuthenticator.currentUser?.uid;
        if(uid && fb_db) {
          try {
            // fetch doc; decrypt
            const doc = await fb_db.collection('userData').doc(uid).get();
            if(doc.exists) {
              const data = doc.data();
              const encA = data.accounts || null;
              const encF = data.finance || null;
              let ok = false;
              if(encA) {
                const decA = aesDecrypt(encA, pass);
                if(decA && decA.accounts) {
                  ACCOUNT_STATE.accounts = decA.accounts;
                  ok = true;
                }
              }
              if(encF) {
                const decF = aesDecrypt(encF, pass);
                if(decF && decF.transactions) {
                  Object.assign(FINANCIAL_STATE, decF);
                  ok = true;
                }
              }
              if(ok) {
                ACCOUNT_STATE.isAuthenticated = true;
                ACCOUNT_STATE.passphrase = pass;
                document.getElementById('rekeningAuth').style.display = 'none';
                document.getElementById('rekeningContent').style.display = 'block';
                if(typeof updateAccountsDisplay === 'function') updateAccountsDisplay();
                if(typeof renderTransactions === 'function') renderTransactions();
                if(typeof updateDashboard === 'function') updateDashboard();
                showAccountMessage('Akses REKENING berhasil dibuka (cloud)', 'success');
                // Also persist local encrypted copy
                try { encryptAndSaveAccounts(pass); } catch(e){}
                return;
              }
            }
            // if cloud fails or not found -> fallback to local decrypt (existing behavior)
          } catch (err) {
            console.warn('unlockRekening cloud attempt err', err);
          }
        }

        // If not logged-in to mongoDB or cloud decrypt failed: call original unlockRekening behavior
        if(typeof window.unlockRekening === 'function') {
          // note: original implementation reads passphrase and decrypts localStorage
          try { window.unlockRekening(); return; } catch(e){ console.error(e); }
        } else {
          showAccountMessage('Fungsi unlockRekening tidak ditemukan', 'error');
        }
      });
    }

    // Bind Login/Logout buttons to mongoDB auth if present
    // Replace any existing "Login with Google" mechanism â€” add a small auth button if needed
    const existingLoginTrigger = document.getElementById('unlockWithGoogle') || null;
    // optional: if user wants a dedicated login button, dev can add <button id="loginGoogle">Login Google</button> in UI
    const loginButton = document.getElementById('loginGoogle');
    if(loginButton) {
      loginButton.addEventListener('click', () => mongoDBAuthenticator.signInWithGoogle());
    }
    // Bind logout
    const lockButton = document.getElementById('lockRekening');
    if(lockButton) {
      lockButton.addEventListener('click', () => {
        // prefer mongoDB signout if logged in
        if(mongoDBAuthenticator.currentUser) {
          mongoDBAuthenticator.signOut();
        } else {
          // fallback: existing lockRekening
          if(typeof window.lockRekening === 'function') window.lockRekening();
        }
      });
    }

    // Wire other buttons: backup/restore/sync
    const backupBtn = document.getElementById('backupData');
    if(backupBtn) backupBtn.addEventListener('click', window.backupCloud);
    const restoreBtn = document.getElementById('restoreData');
    if(restoreBtn) restoreBtn.addEventListener('click', window.restoreData);
    const syncBtn = document.getElementById('syncData');
    if(syncBtn) syncBtn.addEventListener('click', () => {
      // call saveData wrapper
      window.saveData();
    });

    // hide old 'forgotPassphrase' flow if you wish (we keep it but you can disable)
    const forgotBtn = document.getElementById('forgotPassphrase');
    if(forgotBtn) {
      // Optional: offer mongoDB passwordless recovery flow instruction
      // For now keep original behavior
      // forgotBtn.style.display = 'none';
    }
  });

  // Expose small APIs for debugging
  window.FB_INJECT = {
    auth: mongoDBAuthenticator,
    dataManager: mongoDBDataManager,
    decryptPayloadWithPass: decryptmongoDBPayloadWithPass
  };

  console.log('âœ… mongoDB injection script loaded. Replace mongoDBConfig and test flows.');
})();
</script>
<!-- ==================== AUTH LOGIN MODAL ==================== -->
<div id="authModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:999999;place-items:center;">
  <div style="width:90%;max-width:360px;background:#fff;padding:18px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.2)">
    <h3 style="margin-bottom:10px">Login Cloud Protection</h3>
    <input id="authEmail" type="email" placeholder="Email" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;margin-bottom:8px">
    <input id="authPassword" type="password" placeholder="Password" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;margin-bottom:8px">
    <p id="authMsg" style="color:red;font-size:13px;margin-bottom:8px"></p>
    <div style="display:flex;justify-content:space-between">
      <button onclick="hideLogin()" style="padding:8px 14px;border:none;border-radius:6px;background:#999;color:#fff">Batal</button>
      <button onclick="doLogin()" style="padding:8px 14px;border:none;border-radius:6px;background:#10b981;color:#fff">Login</button>
    </div>
  </div>
</div>

<script>
/* ==================== CONFIG ==================== */
const PY_BACKEND = "http://localhost:5000"; // ganti saat deploy
const TOKEN_KEY = "user_jwt_token";

/* ==================== LOGIN SYSTEM ==================== */
function showLogin(){ document.getElementById("authModal").style.display="grid" }
function hideLogin(){ document.getElementById("authModal").style.display="none" }

async function doLogin(){
    const email = authEmail.value.trim();
    const pass  = authPassword.value.trim();
    authMsg.textContent = "";
    if(!email || !pass) return authMsg.textContent = "Isi email dan password";

    try {
        const r = await fetch(`${PY_BACKEND}/auth/login`, {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({email,password:pass})
        });
        const j = await r.json();
        if(!r.ok) return authMsg.textContent = j.message || "Login gagal";

        localStorage.setItem(TOKEN_KEY, j.token);
        hideLogin();
        updateDynamicIsland?.("âœ… Login Berhasil",2000);
    } catch(e){
        authMsg.textContent = "Server tidak terjangkau";
    }
}

/* ==================== GATE BACKUP / RESTORE / SYNC ==================== */
function requireLogin(){
    if(!localStorage.getItem(TOKEN_KEY)){
        showLogin();
        return false;
    }
    return true;
}

/* ==================== KIRIM DATA KE BACKEND PYTHON ==================== */
async function sendToBackend(endpoint, body){
    const token = localStorage.getItem(TOKEN_KEY);
    try {
        const r = await fetch(`${PY_BACKEND}${endpoint}`,{
            method:"POST",
            headers:{
                "Content-Type":"application/json",
                "x-access-token": token
            },
            body: JSON.stringify(body)
        });
        return r.json();
    } catch(e){
        return {error:true,message:"Koneksi gagal"};
    }
}

function collectAppData(){
    return {
        FINANCIAL_STATE: window.FINANCIAL_STATE || {},
        ACCOUNT_STATE: window.ACCOUNT_STATE || {},
        TIME: new Date().toISOString()
    }
}

/* ==================== AKSI TOMBOL UTAMA ==================== */
async function backupCloud(){
    if(!requireLogin()) return;
    updateDynamicIsland?.("â˜ Backup ke server...",2000);
    const res = await sendToBackend("/api/sync/upload", collectAppData());
    if(res.error) return updateDynamicIsland?.("âŒ Backup gagal",2000);
    updateDynamicIsland?.("âœ… Backup sukses ke cloud",2000);
}

async function restoreCloud(){
    if(!requireLogin()) return;
    updateDynamicIsland?.("â˜ Memuat data...",2000);
    try {
        const r = await fetch(`${PY_BACKEND}/api/sync/download`,{
            headers:{ "x-access-token": localStorage.getItem(TOKEN_KEY) }
        });
        const j = await r.json();
        if(!r.ok) throw j;
        Object.assign(window.FINANCIAL_STATE, j.data.FINANCIAL_STATE);
        Object.assign(window.ACCOUNT_STATE, j.data.ACCOUNT_STATE);
        updateDynamicIsland?.("âœ… Data dipulihkan",2000);
    } catch(e){
        updateDynamicIsland?.("âŒ Restore gagal",2000);
    }
}

async function syncCloud(){
    if(!requireLogin()) return;
    await backupCloud();
}

/* ==================== TEBAS FUNGSI LAMA, GANTI KE BACKEND ==================== */
window.backupData  = backupCloud;
window.restoreData = restoreCloud;
window.syncData    = syncCloud;

/* ==================== PASANG LISTENER KE TOMBOL UI KAMU ==================== */
document.addEventListener("DOMContentLoaded",()=>{
    document.getElementById("backupToMongoDB")?.addEventListener("click",backupCloud);
    document.getElementById("restoreFromMongoDB")?.addEventListener("click",restoreCloud);
    document.getElementById("syncToMongoDB")?.addEventListener("click",syncCloud);
});
</script>
<!-- Login/Register Modal -->
<div id="authModal" class="auth-modal">
    <div class="auth-modal-content">
        <div class="auth-header">
            <h2><i class="fas fa-lock"></i> STL - UDHIS Authentication</h2>
            <button id="closeAuthModal" class="enhanced-btn btn-error compact-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="auth-tabs">
            <button class="auth-tab active" data-tab="login">Login</button>
            <button class="auth-tab" data-tab="register">Register</button>
        </div>
        
        <!-- Login Form -->
        <div id="loginForm" class="auth-form active">
            <div class="form-group">
                <label for="loginEmail">Email:</label>
                <input type="email" id="loginEmail" class="enhanced-input compact-input" placeholder="masukkan email Anda">
            </div>
            <div class="form-group">
                <label for="loginPassword">Password:</label>
                <input type="password" id="loginPassword" class="enhanced-input compact-input" placeholder="masukkan password">
            </div>
            <button id="submitLogin" class="enhanced-btn btn-primary compact-btn w-full">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
            <div class="auth-status" id="loginStatus"></div>
        </div>
        
        <!-- Register Form -->
        <div id="registerForm" class="auth-form">
            <div class="form-group">
                <label for="registerEmail">Email:</label>
                <input type="email" id="registerEmail" class="enhanced-input compact-input" placeholder="masukkan email baru">
            </div>
            <div class="form-group">
                <label for="registerPassword">Password:</label>
                <input type="password" id="registerPassword" class="enhanced-input compact-input" placeholder="buat password minimal 6 karakter">
            </div>
            <div class="form-group">
                <label for="confirmPassword">Konfirmasi Password:</label>
                <input type="password" id="confirmPassword" class="enhanced-input compact-input" placeholder="ulangi password">
            </div>
            <button id="submitRegister" class="enhanced-btn btn-success compact-btn w-full">
                <i class="fas fa-user-plus"></i> Daftar
            </button>
            <div class="auth-status" id="registerStatus"></div>
        </div>
        
        <div class="auth-footer">
            <p>Login diperlukan untuk backup/restore data ke cloud</p>
        </div>
    </div>
</div>
<style>
  /* ==================== AUTH MODAL STYLES ==================== */
.auth-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
    z-index: 10002;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: var(--ios-transition);
}

.auth-modal.active {
    opacity: 1;
    visibility: visible;
}

.auth-modal-content {
    background: var(--theme-card);
    border-radius: var(--radius-2xl);
    padding: 0;
    width: 90%;
    max-width: 400px;
    box-shadow: var(--ios-shadow);
    border: 1px solid var(--theme-border);
}

.auth-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    background: linear-gradient(135deg, var(--layer1) 0%, var(--layer2) 100%);
    color: white;
    border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
}

.auth-header h2 {
    margin: 0;
    font-size: 18px;
    font-weight: 700;
}

.auth-tabs {
    display: flex;
    border-bottom: 1px solid var(--theme-border);
}

.auth-tab {
    flex: 1;
    padding: 15px;
    background: none;
    border: none;
    cursor: pointer;
    transition: var(--ios-transition);
    font-weight: 600;
    color: var(--theme-text);
}

.auth-tab.active {
    background: var(--theme-primary);
    color: white;
}

.auth-form {
    padding: 20px;
    display: none;
}

.auth-form.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: var(--theme-text);
}

.auth-status {
    margin-top: 15px;
    padding: 10px;
    border-radius: var(--radius-lg);
    text-align: center;
    font-size: 14px;
}

.auth-status.success {
    background: rgba(16, 185, 129, 0.1);
    color: #10b981;
    border: 1px solid rgba(16, 185, 129, 0.2);
}

.auth-status.error {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.2);
}

.auth-footer {
    padding: 15px 20px;
    text-align: center;
    border-top: 1px solid var(--theme-border);
    font-size: 12px;
    color: var(--theme-text);
    opacity: 0.7;
}
</style>
<script>
  // ==================== AUTHENTICATION SYSTEM ====================
const AUTH_SYSTEM = {
    // Konfigurasi backend - sesuaikan dengan URL Python backend Anda
    BACKEND_URL: 'http://localhost:5000', // Ganti dengan URL backend Python
    
    // Inisialisasi sistem auth
    init() {
        this.setupAuthEventListeners();
        this.checkAutoLogin();
    },
    
    // Setup event listeners untuk modal auth
    setupAuthEventListeners() {
        // Modal toggle
        document.addEventListener('click', (e) => {
            if (e.target.closest('#openAuthModal') || e.target.closest('#openLogin')) {
                this.openAuthModal();
            }
        });
        
        document.getElementById('closeAuthModal').addEventListener('click', () => {
            this.closeAuthModal();
        });
        
        // Tab switching
        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');
                this.switchAuthTab(tabName);
            });
        });
        
        // Form submissions
        document.getElementById('submitLogin').addEventListener('click', () => {
            this.handleLogin();
        });
        
        document.getElementById('submitRegister').addEventListener('click', () => {
            this.handleRegister();
        });
        
        // Enter key support
        document.getElementById('loginPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.handleLogin();
        });
        
        document.getElementById('confirmPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') this.handleRegister();
        });
    },
    
    // Buka modal auth
    openAuthModal() {
        document.getElementById('authModal').classList.add('active');
        this.switchAuthTab('login');
    },
    
    // Tutup modal auth
    closeAuthModal() {
        document.getElementById('authModal').classList.remove('active');
    },
    
    // Ganti tab login/register
    switchAuthTab(tabName) {
        // Update tabs
        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        
        // Update forms
        document.querySelectorAll('.auth-form').forEach(form => {
            form.classList.remove('active');
        });
        document.getElementById(`${tabName}Form`).classList.add('active');
        
        // Clear status messages
        this.clearAuthStatus();
    },
    
    // Handle login
    async handleLogin() {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value;
        
        if (!email || !password) {
            this.showAuthStatus('login', 'Harap isi email dan password', 'error');
            return;
        }
        
        this.showAuthStatus('login', 'ðŸ”„ Memproses login...', 'info');
        
        try {
            const response = await fetch(`${this.BACKEND_URL}/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email, password })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                // Simpan token dan email
                localStorage.setItem(TOKEN_KEY, result.token);
                localStorage.setItem(EMAIL_KEY, result.email);
                
                this.showAuthStatus('login', 'âœ… Login berhasil!', 'success');
                this.closeAuthModal();
                
                // Update UI untuk status login
                this.updateLoginUI(true, result.email);
                
                // Sync data dari cloud setelah login
                setTimeout(() => {
                    if (typeof MONGODB_STORAGE_MANAGER !== 'undefined') {
                        MONGODB_STORAGE_MANAGER.syncToMongoDB();
                    }
                }, 1000);
                
            } else {
                this.showAuthStatus('login', `âŒ ${result.message}`, 'error');
            }
            
        } catch (error) {
            console.error('Login error:', error);
            this.showAuthStatus('login', 'âŒ Gagal terhubung ke server', 'error');
        }
    },
    
    // Handle register
    async handleRegister() {
        const email = document.getElementById('registerEmail').value.trim();
        const password = document.getElementById('registerPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        
        if (!email || !password || !confirmPassword) {
            this.showAuthStatus('register', 'Harap isi semua field', 'error');
            return;
        }
        
        if (password.length < 6) {
            this.showAuthStatus('register', 'Password minimal 6 karakter', 'error');
            return;
        }
        
        if (password !== confirmPassword) {
            this.showAuthStatus('register', 'Password tidak cocok', 'error');
            return;
        }
        
        this.showAuthStatus('register', 'ðŸ”„ Membuat akun baru...', 'info');
        
        try {
            const response = await fetch(`${this.BACKEND_URL}/auth/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email, password })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                this.showAuthStatus('register', 'âœ… Registrasi berhasil! Silakan login.', 'success');
                
                // Switch ke tab login setelah registrasi berhasil
                setTimeout(() => {
                    this.switchAuthTab('login');
                    document.getElementById('loginEmail').value = email;
                    document.getElementById('loginPassword').value = '';
                    document.getElementById('loginPassword').focus();
                }, 1500);
                
            } else {
                this.showAuthStatus('register', `âŒ ${result.message}`, 'error');
            }
            
        } catch (error) {
            console.error('Register error:', error);
            this.showAuthStatus('register', 'âŒ Gagal terhubung ke server', 'error');
        }
    },
    
    // Tampilkan status auth
    showAuthStatus(formType, message, type) {
        const statusElement = document.getElementById(`${formType}Status`);
        statusElement.textContent = message;
        statusElement.className = `auth-status ${type}`;
    },
    
    // Clear status messages
    clearAuthStatus() {
        document.getElementById('loginStatus').textContent = '';
        document.getElementById('loginStatus').className = 'auth-status';
        document.getElementById('registerStatus').textContent = '';
        document.getElementById('registerStatus').className = 'auth-status';
    },
    
    // Update UI berdasarkan status login
    updateLoginUI(isLoggedIn, email = null) {
        if (isLoggedIn) {
            // Update dynamic island
            if (typeof updateDynamicIsland === 'function') {
                updateDynamicIsland(`ðŸ‘‹ Selamat datang, ${email}`, 3000);
            }
            
            // Enable backup/restore buttons
            const backupBtn = document.getElementById('backupData');
            const restoreBtn = document.getElementById('restoreData');
            const syncBtn = document.getElementById('syncData');
            
            if (backupBtn) backupBtn.disabled = false;
            if (restoreBtn) restoreBtn.disabled = false;
            if (syncBtn) syncBtn.disabled = false;
            
        } else {
            // Disable backup/restore buttons
            const backupBtn = document.getElementById('backupData');
            const restoreBtn = document.getElementById('restoreData');
            const syncBtn = document.getElementById('syncData');
            
            if (backupBtn) backupBtn.disabled = true;
            if (restoreBtn) restoreBtn.disabled = true;
            if (syncBtn) syncBtn.disabled = true;
        }
    },
    
    // Cek auto login dari localStorage
    checkAutoLogin() {
        const token = localStorage.getItem(TOKEN_KEY);
        const email = localStorage.getItem(EMAIL_KEY);
        
        if (token && email) {
            this.updateLoginUI(true, email);
            console.log('Auto-login detected for:', email);
        } else {
            this.updateLoginUI(false);
        }
    },
    
    // Logout function
    logout() {
        localStorage.removeItem(TOKEN_KEY);
        localStorage.removeItem(EMAIL_KEY);
        this.updateLoginUI(false);
        
        if (typeof updateDynamicIsland === 'function') {
            updateDynamicIsland('ðŸ‘‹ Berhasil logout', 2000);
        }
    },
    
    // Get auth headers untuk API calls
    getAuthHeaders() {
        const token = localStorage.getItem(TOKEN_KEY);
        return {
            'Content-Type': 'application/json',
            'x-access-token': token || ''
        };
    },
    
    // Upload data ke backend Python
    async uploadToBackend(data) {
        const token = localStorage.getItem(TOKEN_KEY);
        if (!token) {
            throw new Error('User not logged in');
        }
        
        try {
            const response = await fetch(`${this.BACKEND_URL}/api/sync/upload`, {
                method: 'POST',
                headers: this.getAuthHeaders(),
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.message);
            }
            
            return result;
            
        } catch (error) {
            console.error('Upload to backend failed:', error);
            throw error;
        }
    },
    
    // Download data dari backend Python
    async downloadFromBackend() {
        const token = localStorage.getItem(TOKEN_KEY);
        if (!token) {
            throw new Error('User not logged in');
        }
        
        try {
            const response = await fetch(`${this.BACKEND_URL}/api/sync/download`, {
                method: 'GET',
                headers: this.getAuthHeaders()
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.message);
            }
            
            return result.data || {};
            
        } catch (error) {
            console.error('Download from backend failed:', error);
            throw error;
        }
    }
};

// ==================== CLIENT-SIDE ENCRYPTION ====================
const CLIENT_ENCRYPTION = {
    // Encrypt data sebelum dikirim ke backend
    encryptData(data, password = null) {
        try {
            const dataStr = JSON.stringify(data);
            
            // Gunakan password dari input atau token sebagai key
            const encryptionKey = password || localStorage.getItem(TOKEN_KEY) || 'default-key';
            
            // Simple encryption menggunakan CryptoJS (sudah diinclude di project)
            const encrypted = CryptoJS.AES.encrypt(dataStr, encryptionKey).toString();
            return encrypted;
            
        } catch (error) {
            console.warn('Encryption failed, returning plain data:', error);
            return data;
        }
    },
    
    // Decrypt data setelah diterima dari backend
    decryptData(encryptedData, password = null) {
        try {
            // Jika data tidak terenkripsi, return as-is
            if (typeof encryptedData === 'object') {
                return encryptedData;
            }
            
            const encryptionKey = password || localStorage.getItem(TOKEN_KEY) || 'default-key';
            
            const decrypted = CryptoJS.AES.decrypt(encryptedData, encryptionKey);
            const decryptedStr = decrypted.toString(CryptoJS.enc.Utf8);
            
            return JSON.parse(decryptedStr);
            
        } catch (error) {
            console.warn('Decryption failed, returning original data:', error);
            return encryptedData;
        }
    }
};

// ==================== MODIFIED REQUIRE LOGIN FUNCTION ====================
function requireLogin() {
    const token = localStorage.getItem(TOKEN_KEY);
    if (!token) {
        AUTH_SYSTEM.openAuthModal();
        return false;
    }
    
    // Optional: Validasi token expiry (basic check)
    try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        const expiry = payload.exp * 1000; // Convert to milliseconds
        if (Date.now() > expiry) {
            localStorage.removeItem(TOKEN_KEY);
            localStorage.removeItem(EMAIL_KEY);
            AUTH_SYSTEM.openAuthModal();
            return false;
        }
    } catch (error) {
        console.warn('Token validation error:', error);
    }
    
    return true;
}

// ==================== INTEGRASI DENGAN EXISTING SYSTEMS ====================

// Override backupData function untuk include authentication
const originalBackupData = window.backupData;
window.backupData = function() {
    if (!requireLogin()) {
        updateDynamicIsland('âš ï¸ Harap login terlebih dahulu', 2000);
        return;
    }
    
    const password = document.getElementById('backupPassword').value;
    if (password !== 'b4ckupmyd4t4') {
        updateDynamicIsland('âŒ Password backup salah', 2000);
        return;
    }
    
    // Panggil fungsi backup original
    if (originalBackupData) {
        originalBackupData();
    }
    
    // Juga backup ke Python backend
    AUTH_SYSTEM.uploadToBackend(window.FINANCIAL_STATE)
        .then(() => {
            updateDynamicIsland('âœ… Backup berhasil ke cloud', 2000);
        })
        .catch(error => {
            console.error('Backup to cloud failed:', error);
            updateDynamicIsland('âš ï¸ Backup lokal berhasil, cloud gagal', 2000);
        });
};

// Override restoreData function
const originalRestoreData = window.restoreData;
window.restoreData = function() {
    if (!requireLogin()) {
        updateDynamicIsland('âš ï¸ Harap login terlebih dahulu', 2000);
        return;
    }
    
    const password = document.getElementById('backupPassword').value;
    if (password !== 'b4ckupmyd4t4') {
        updateDynamicIsland('âŒ Password restore salah', 2000);
        return;
    }
    
    // Coba restore dari cloud terlebih dahulu
    AUTH_SYSTEM.downloadFromBackend()
        .then(cloudData => {
            if (cloudData && Object.keys(cloudData).length > 0) {
                // Gunakan data dari cloud
                Object.assign(window.FINANCIAL_STATE, cloudData);
                updateDynamicIsland('âœ… Data restored dari cloud', 2000);
            } else {
                // Fallback ke restore lokal
                if (originalRestoreData) {
                    originalRestoreData();
                }
                updateDynamicIsland('â„¹ï¸ Menggunakan data lokal', 2000);
            }
            
            // Refresh UI
            if (window.renderTransactions) renderTransactions();
            if (window.updateDashboard) updateDashboard();
        })
        .catch(error => {
            console.error('Restore from cloud failed:', error);
            // Fallback ke restore lokal
            if (originalRestoreData) {
                originalRestoreData();
            }
            updateDynamicIsland('âš ï¸ Restore cloud gagal, menggunakan lokal', 2000);
        });
};

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', function() {
    // Inisialisasi auth system
    AUTH_SYSTEM.init();
    
    // Auto-buka modal auth jika belum login saat mencoba backup/sync
    const backupBtn = document.getElementById('backupData');
    const restoreBtn = document.getElementById('restoreData');
    const syncBtn = document.getElementById('syncData');
    
    if (backupBtn) {
        backupBtn.addEventListener('click', function(e) {
            if (!requireLogin()) {
                e.preventDefault();
                e.stopPropagation();
            }
        });
    }
    
    if (restoreBtn) {
        restoreBtn.addEventListener('click', function(e) {
            if (!requireLogin()) {
                e.preventDefault();
                e.stopPropagation();
            }
        });
    }
    
    if (syncBtn) {
        syncBtn.addEventListener('click', function(e) {
            if (!requireLogin()) {
                e.preventDefault();
                e.stopPropagation();
            }
        });
    }
    
    // Tambahkan tombol login di header
    const header = document.querySelector('.main-content .flex.justify-between.items-center');
    if (header) {
        const loginButton = document.createElement('button');
        loginButton.id = 'openAuthModal';
        loginButton.className = 'enhanced-btn compact-btn';
        loginButton.innerHTML = '<i class="fas fa-user"></i> Login';
        loginButton.style.marginLeft = '10px';
        
        header.appendChild(loginButton);
    }
});

// Export untuk global access
window.AUTH_SYSTEM = AUTH_SYSTEM;
window.CLIENT_ENCRYPTION = CLIENT_ENCRYPTION;
window.requireLogin = requireLogin;
</script>
<script>
  // ==================== FUNGSI AUTENTIKASI CLOUD BARU ====================

/**
 * Mengirim kredensial ke Backend Python untuk Login dan menyimpan token.
 * @param {string} email
 * @param {string} password
 */
async function loginCloud(email, password) {
    if (!email || !password) {
        return updateDynamicIsland?.("Email dan Password harus diisi.", 3000);
    }
    try {
        updateDynamicIsland?.("â˜ Memproses Login...", 2000);
        
        const r = await fetch(`${PY_BACKEND}/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });
        const j = await r.json();

        if (!r.ok) throw new Error(j.message || 'Login gagal.');

        // ðŸ” KEBERHASILAN: Simpan Token dan Email
        localStorage.setItem(TOKEN_KEY, j.token);
        localStorage.setItem(EMAIL_KEY, j.email);

        updateDynamicIsland?.(`âœ… Login Sukses: ${j.email}`, 3000);
        // Panggil fungsi untuk me-refresh UI dan memuat data (opsional: langsung restore)
        restoreCloud(); 

    } catch (e) {
        updateDynamicIsland?.(`âŒ Login Gagal: ${e.message}`, 3000);
    }
}

/**
 * Mengirim kredensial untuk registrasi akun baru.
 * @param {string} email
 * @param {string} password
 */
async function registerCloud(email, password) {
    if (!email || !password) {
        return updateDynamicIsland?.("Email dan Password harus diisi.", 3000);
    }
    try {
        updateDynamicIsland?.("â˜ Memproses Registrasi...", 2000);

        const r = await fetch(`${PY_BACKEND}/auth/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });
        const j = await r.json();

        if (!r.ok) throw new Error(j.message || 'Registrasi gagal.');

        updateDynamicIsland?.("âœ… Registrasi Sukses! Silakan Login.", 4000);
    } catch (e) {
        updateDynamicIsland?.(`âŒ Registrasi Gagal: ${e.message}`, 3000);
    }
}

function signOutCloud() {
    localStorage.removeItem(TOKEN_KEY);
    localStorage.removeItem(EMAIL_KEY);
    // Panggil fungsi kunci UI (jika ada)
    if(typeof window.lockRekening === 'function') window.lockRekening(); 
    updateDynamicIsland?.("â˜ Anda telah logout", 2000);
}

// ==================== KONEKSI KE UI ====================
// Anda harus mengganti kaitan ke tombol-tombol Login/Signout lama Anda:

document.addEventListener("DOMContentLoaded",() => {
    // ... (Listener Sync/Backup/Restore yang sudah Anda buat) ...

    // GANTI SEMUA LISTENER FIREBASE LAMA DENGAN INI!
    const loginBtn = document.getElementById('loginButtonIDAnda'); 
    if(loginBtn) loginBtn.addEventListener('click', () => {
        const email = document.getElementById('loginEmailInputID').value; 
        const password = document.getElementById('loginPasswordInputID').value;
        loginCloud(email, password);
    });

    const registerBtn = document.getElementById('registerButtonIDAnda'); 
    if(registerBtn) registerBtn.addEventListener('click', () => {
        const email = document.getElementById('registerEmailInputID').value; 
        const password = document.getElementById('registerPasswordInputID').value;
        registerCloud(email, password);
    });

    const signoutBtn = document.getElementById('signOutButtonIDAnda');
    if(signoutBtn) signoutBtn.addEventListener('click', signOutCloud);
});
</script>

<!-- STL NON-INTRUSIVE BACKEND INTEGRATION -->
<script>
(function(){
  'use strict';
  // Non-intrusive helper: expose safe functions without modifying UI or text.
  if (!window.STL_backend) {
    const apiRequest = async (endpoint, method='GET', data=null, tokenRequired=true) => {
      const headers = {'Content-Type':'application/json'};
      if (tokenRequired) {
        const token = localStorage.getItem('user_jwt_token');
        if (!token) throw new Error('Belum login / token hilang');
        headers['x-access-token'] = token;
      }
      const res = await fetch((typeof PY_BACKEND !== 'undefined' ? PY_BACKEND : '') + endpoint, {
        method,
        headers,
        body: data ? JSON.stringify(data) : null
      });
      let json = {};
      try { json = await res.json(); } catch(e){}
      if (!res.ok) throw new Error(json.message || ('Network error: '+res.status));
      return json;
    };

    const syncUpload = async () => {
      const appData = localStorage.getItem('financialData');
      if (!appData) throw new Error('Belum ada data lokal untuk diupload');
      let parsed = null;
      try { parsed = JSON.parse(appData); } catch(e){ parsed = appData; }
      return await apiRequest('/api/sync/upload','POST', parsed);
    };

    const syncDownload = async () => {
      return await apiRequest('/api/sync/download','GET');
    };

    // expose but do not auto-run or alter DOM
    window.STL_backend = { apiRequest, syncUpload, syncDownload };
  }
})();
</script>
<!-- END STL NON-INTRUSIVE BACKEND INTEGRATION -->

<!-- START: LOCAL TRUST OVERRIDE - keeps UI running on trusted devices without intrusive login notices -->
<script>
(function(){
  try{
    // Remove known intrusive text occurrences (best-effort)
    try {
      document.addEventListener('DOMContentLoaded', function(){
        var nodes = document.querySelectorAll('body *');
        nodes.forEach(function(n){
          if(n.childNodes && n.childNodes.length===1 && n.childNodes[0].nodeType===3){
            var txt = n.textContent || '';
            if(/Silakan login untuk menyimpan data ke cloud/i.test(txt) || /
              n.textContent = '';
            }
          }
        });
      });
    }catch(e){}

    // Trusted hostnames: allow UI to run without forcing login prompt
    var trustedHosts = ['localhost','127.0.0.1','::1'];
    // Also treat file:// as trusted
    var isTrusted = (location.protocol === 'file:') || (trustedHosts.indexOf(location.hostname) !== -1);

    // If you want to add more trusted hosts, set window.STL_TRUSTED_HOSTS = [...];
    if(Array.isArray(window.STL_TRUSTED_HOSTS)){
      try { window.STL_TRUSTED_HOSTS.forEach(function(h){ if(trustedHosts.indexOf(h)===-1) trustedHosts.push(h); }); } catch(e){}
      isTrusted = isTrusted || (window.STL_TRUSTED_HOSTS.indexOf(location.hostname)!==-1);
    }

    // Local access key stored so modal doesn't reappear on trusted devices
    var ACCESS_KEY = 'stl_protect_access_v1';

    // If trusted, ensure localStorage has access to bypass modal and allow requireLogin to return true
    if(isTrusted){
      try {
        var access = localStorage.getItem(ACCESS_KEY);
        if(!access){
          // set a basic access token tied to hostname/time (non-secret)
          localStorage.setItem(ACCESS_KEY, JSON.stringify({host: location.hostname, ts: Date.now()}));
        }
      } catch(e){}
    }

    // Override global requireLogin if exists, else create safe version
    try{
      var originalRequire = window.requireLogin;
    }catch(e){ originalRequire = null; }
    window.requireLogin = function(){
      try{
        // if trusted host or local access flag exists -> allow UI
        var a = null;
        try { a = JSON.parse(localStorage.getItem(ACCESS_KEY) || 'null'); } catch(e){ a = null; }
        if(isTrusted || (a && a.host && a.ts)){
          return true;
        }
        // else, fallback to original if present
        if(typeof originalRequire === 'function'){
          return originalRequire();
        }
        return false;
      } catch(e){
        return false;
      }
    };
  } catch(err){
    console.warn('Local trust override error', err);
  }
})();
</script>
<!-- END: LOCAL TRUST OVERRIDE -->
</body>
</html>